<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  背景与挑战
  #

随着腾讯自研上云及公有云用户的迅速增长，一方面，腾讯云容器服务TKE服务数量和核数大幅增长, 另一方面我们提供的容器服务类型（TKE托管及独立集群、EKS弹性集群、edge边缘计算集群、mesh服务网格、serverless knative）也越来越丰富。各类容器服务类型背后的核心都是K8s，K8s核心的存储etcd又统一由我们基于K8s构建的etcd平台进行管理。基于它我们目前管理了千级etcd集群，背后支撑了万级K8s集群。
在万级K8s集群规模下的我们如何高效保障etcd集群的稳定性?
etcd集群的稳定性风险又来自哪里？
我们通过基于业务场景、历史遗留问题、现网运营经验等进行稳定性风险模型分析，风险主要来自旧TKE etcd架构设计不合理、etcd稳定性、etcd性能部分场景无法满足业务、测试用例覆盖不足、变更管理不严谨、监控是否全面覆盖、隐患点是否能自动巡检发现、极端灾难故障数据安全是否能保障。
前面所描述的etcd平台已经从架构设计上、变更管理上、监控及巡检、数据迁移、备份几个方面程度解决了我们管理的各类容器服务的etcd可扩展性、可运维性、可观测性以及数据安全性，因此本文将重点描述我们在万级K8s场景下面临的etcd内核稳定性及性能挑战，比如:

数据不一致
内存泄露
死锁
进程Crash
大包请求导致etcd OOM及丢包
较大数据量场景下启动慢
鉴权及查询key数量、查询指定数量记录接口性能较差


本文将简易描述我们是如何发现、分析、复现、解决以上问题及挑战，以及从以上过程中我们获得了哪些经验及教训，并将之应用到我们的各类容器服务存储稳定性保障中。
同时，我们将解决方案全部贡献、回馈给etcd开源社区， 截止目前我们贡献的30+ pr已全部合并到社区。腾讯云TKE etcd团队是etcd社区2020年上半年最活跃的贡献团队之一, 为etcd的发展贡献我们的一点力量, 在这过程中特别感谢社区AWS、Google、Ali等maintainer的支持与帮助。

  稳定性优化案例剖析
  #

从GitLab误删主库丢失部分数据到GitHub数据不一致导致中断24小时，再到号称"不沉航母"的AWS S3故障数小时等，无一例外都是存储服务。稳定性对于一个存储服务、乃至一个公司的口碑而言至关重要，它决定着一个产品生与死。稳定性优化案例我们将从数据不一致的严重性、两个etcd数据不一致的bug、lease内存泄露、mvcc 死锁、wal crash方面阐述，我们是如何发现、分析、复现、解决以上case，并分享我们从每个case中的获得的收获和反思，从中汲取经验，防患于未然。

  数据不一致（Data Inconsistency）
  #


  谈到数据不一致导致的大故障，就不得不详细提下GitHub在18年一次因网络设备的例行维护工作导致的美国东海岸网络中心与东海岸主要数据中心之间的连接断开。虽然网络的连通性在43秒内得以恢复，但是短暂的中断引发了一系列事件，最终导致GitHub 24小时11分钟的服务降级，部分功能不可用。
  #


  GitHub使用了大量的MySQL集群存储GitHub的meta data,如issue、pr、page等等，同时做了东西海岸跨城级别的容灾。故障核心原因是网络异常时GitHub的MySQL仲裁服务Orchestrator进行了故障转移，将写入数据定向到美国西海岸的MySQL集群(故障前primary在东海岸)，然而美国东海岸的MySQL包含一小段写入，尚未复制到美国西海岸集群，同时故障转移后由于两个数据中心的集群现在都包含另一个数据中心中不存在的写入，因此又无法安全地将主数据库故障转移回美国东海岸。
  #


  最终, 为了保证保证用户数据不丢失，GitHub不得不以24小时的服务降级为代价来修复数据一致性。
  #


  数据不一致的故障严重性不言而喻，然而etcd是基于raft协议实现的分布式高可靠存储系统，我们也并未做跨城容灾，按理数据不一致这种看起来高大上bug我们是很难遇到的。然而梦想是美好的，现实是残酷的，我们不仅遇到了不可思议的数据不一致bug, 还一踩就是两个，一个是重启etcd有较低的概率触发，一个是升级etcd版本时如果开启了鉴权，在K8s场景下较大概率触发。在详细讨论这两个bug前，我们先看看在K8s场景下etcd数据不一致会导致哪些问题呢？
  #




  数据不一致最恐怖之处在于client写入是成功的，但可能在部分节点读取到空或者是旧数据,client无法感知到写入在部分节点是失败的和可能读到旧数据
  #




  读到空可能会导致业务Node消失、Pod消失、Node上Service路由规则消失，一般场景下，只会影响用户变更的服务
  #




  读到老数据会导致业务变更不生效，如服务扩缩容、Service rs替换、变更镜像异常等待，一般场景下，只会影响用户变更的服务
  #




  在etcd平台迁移场景下，client无法感知到写入失败，若校验数据一致性也无异常时（校验时连接到了正常节点），会导致迁移后整个集群全面故障（apiserver连接到了异常节点），用户的Node、部署的服务、lb等会被全部删除，严重影响用户业务
  #




  首先第一个不一致bug是重启etcd过程中遇到的，人工尝试复现多次皆失败，分析、定位、复现、解决这个bug之路几经波折，过程很有趣并充满挑战，最终通过我对关键点增加debug日志，编写chaos monkey模拟各种异常场景、边界条件，实现复现成功。最后的真凶竟然是一个授权接口在重启后重放导致鉴权版本号不一致，然后放大导致多版本数据库不一致, 部分节点无法写入新数据, 影响所有v3版本的3年之久bug。
  #


  随后我们提交若干个相关pr到社区, 并全部合并了, 最新的etcd v3.4.9[1]，v3.3.22[2]已修复此问题, 同时google的jingyih也已经提K8s issue和pr[3]将K8s 1.19的etcd client及server版本升级到最新的v3.4.9。此bug详细可参考超凡同学写的文章三年之久的 etcd3 数据不一致 bug 分析。
  #

'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://qq547475331.github.io/docs/etcd%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%8F%8A%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5-etcd-wen-ding-xing-ji-xing-neng-you-hua-shi-jian/"><meta property="og:site_name" content="Guichen's Blog"><meta property="og:title" content="2024-04-03 ETCD稳定性及性能优化实践"><meta property="og:description" content='背景与挑战 # 随着腾讯自研上云及公有云用户的迅速增长，一方面，腾讯云容器服务TKE服务数量和核数大幅增长, 另一方面我们提供的容器服务类型（TKE托管及独立集群、EKS弹性集群、edge边缘计算集群、mesh服务网格、serverless knative）也越来越丰富。各类容器服务类型背后的核心都是K8s，K8s核心的存储etcd又统一由我们基于K8s构建的etcd平台进行管理。基于它我们目前管理了千级etcd集群，背后支撑了万级K8s集群。
在万级K8s集群规模下的我们如何高效保障etcd集群的稳定性?
etcd集群的稳定性风险又来自哪里？
我们通过基于业务场景、历史遗留问题、现网运营经验等进行稳定性风险模型分析，风险主要来自旧TKE etcd架构设计不合理、etcd稳定性、etcd性能部分场景无法满足业务、测试用例覆盖不足、变更管理不严谨、监控是否全面覆盖、隐患点是否能自动巡检发现、极端灾难故障数据安全是否能保障。
前面所描述的etcd平台已经从架构设计上、变更管理上、监控及巡检、数据迁移、备份几个方面程度解决了我们管理的各类容器服务的etcd可扩展性、可运维性、可观测性以及数据安全性，因此本文将重点描述我们在万级K8s场景下面临的etcd内核稳定性及性能挑战，比如:
数据不一致 内存泄露 死锁 进程Crash 大包请求导致etcd OOM及丢包 较大数据量场景下启动慢 鉴权及查询key数量、查询指定数量记录接口性能较差 本文将简易描述我们是如何发现、分析、复现、解决以上问题及挑战，以及从以上过程中我们获得了哪些经验及教训，并将之应用到我们的各类容器服务存储稳定性保障中。
同时，我们将解决方案全部贡献、回馈给etcd开源社区， 截止目前我们贡献的30+ pr已全部合并到社区。腾讯云TKE etcd团队是etcd社区2020年上半年最活跃的贡献团队之一, 为etcd的发展贡献我们的一点力量, 在这过程中特别感谢社区AWS、Google、Ali等maintainer的支持与帮助。
稳定性优化案例剖析 # 从GitLab误删主库丢失部分数据到GitHub数据不一致导致中断24小时，再到号称"不沉航母"的AWS S3故障数小时等，无一例外都是存储服务。稳定性对于一个存储服务、乃至一个公司的口碑而言至关重要，它决定着一个产品生与死。稳定性优化案例我们将从数据不一致的严重性、两个etcd数据不一致的bug、lease内存泄露、mvcc 死锁、wal crash方面阐述，我们是如何发现、分析、复现、解决以上case，并分享我们从每个case中的获得的收获和反思，从中汲取经验，防患于未然。
数据不一致（Data Inconsistency） # 谈到数据不一致导致的大故障，就不得不详细提下GitHub在18年一次因网络设备的例行维护工作导致的美国东海岸网络中心与东海岸主要数据中心之间的连接断开。虽然网络的连通性在43秒内得以恢复，但是短暂的中断引发了一系列事件，最终导致GitHub 24小时11分钟的服务降级，部分功能不可用。 # GitHub使用了大量的MySQL集群存储GitHub的meta data,如issue、pr、page等等，同时做了东西海岸跨城级别的容灾。故障核心原因是网络异常时GitHub的MySQL仲裁服务Orchestrator进行了故障转移，将写入数据定向到美国西海岸的MySQL集群(故障前primary在东海岸)，然而美国东海岸的MySQL包含一小段写入，尚未复制到美国西海岸集群，同时故障转移后由于两个数据中心的集群现在都包含另一个数据中心中不存在的写入，因此又无法安全地将主数据库故障转移回美国东海岸。 # 最终, 为了保证保证用户数据不丢失，GitHub不得不以24小时的服务降级为代价来修复数据一致性。 # 数据不一致的故障严重性不言而喻，然而etcd是基于raft协议实现的分布式高可靠存储系统，我们也并未做跨城容灾，按理数据不一致这种看起来高大上bug我们是很难遇到的。然而梦想是美好的，现实是残酷的，我们不仅遇到了不可思议的数据不一致bug, 还一踩就是两个，一个是重启etcd有较低的概率触发，一个是升级etcd版本时如果开启了鉴权，在K8s场景下较大概率触发。在详细讨论这两个bug前，我们先看看在K8s场景下etcd数据不一致会导致哪些问题呢？ # 数据不一致最恐怖之处在于client写入是成功的，但可能在部分节点读取到空或者是旧数据,client无法感知到写入在部分节点是失败的和可能读到旧数据 # 读到空可能会导致业务Node消失、Pod消失、Node上Service路由规则消失，一般场景下，只会影响用户变更的服务 # 读到老数据会导致业务变更不生效，如服务扩缩容、Service rs替换、变更镜像异常等待，一般场景下，只会影响用户变更的服务 # 在etcd平台迁移场景下，client无法感知到写入失败，若校验数据一致性也无异常时（校验时连接到了正常节点），会导致迁移后整个集群全面故障（apiserver连接到了异常节点），用户的Node、部署的服务、lb等会被全部删除，严重影响用户业务 # 首先第一个不一致bug是重启etcd过程中遇到的，人工尝试复现多次皆失败，分析、定位、复现、解决这个bug之路几经波折，过程很有趣并充满挑战，最终通过我对关键点增加debug日志，编写chaos monkey模拟各种异常场景、边界条件，实现复现成功。最后的真凶竟然是一个授权接口在重启后重放导致鉴权版本号不一致，然后放大导致多版本数据库不一致, 部分节点无法写入新数据, 影响所有v3版本的3年之久bug。 # 随后我们提交若干个相关pr到社区, 并全部合并了, 最新的etcd v3.4.9[1]，v3.3.22[2]已修复此问题, 同时google的jingyih也已经提K8s issue和pr[3]将K8s 1.19的etcd client及server版本升级到最新的v3.4.9。此bug详细可参考超凡同学写的文章三年之久的 etcd3 数据不一致 bug 分析。 #'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>2024-04-03 ETCD稳定性及性能优化实践 | Guichen's Blog</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://qq547475331.github.io/docs/etcd%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%8F%8A%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5-etcd-wen-ding-xing-ji-xing-neng-you-hua-shi-jian/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.f95c6b9a60666b7048cee04630cfc1e8d9370fb96c18c5c4d047db5e7a5d2e18.js integrity="sha256-+VxrmmBma3BIzuBGMM/B6Nk3D7lsGMXE0EfbXnpdLhg=" crossorigin=anonymous></script></head><script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){mermaid.initialize({startOnLoad:!0});let e=document.querySelectorAll("pre > code.language-mermaid");e.forEach(e=>{let t=document.createElement("div");t.classList.add("mermaid"),t.innerHTML=e.innerText,e.parentNode.replaceWith(t)}),mermaid.init(void 0,document.querySelectorAll(".mermaid"))})</script><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Guichen's Blog</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/docs/2025-4-16-%E8%87%AA%E7%A0%94k8s%E5%B9%B3%E5%8F%B0/>2025-4-16 自研k8s平台</a></li><li><a href=/docs/2025-4-16-sleep%E7%9D%A1%E7%9C%A0%E5%BA%94%E7%94%A8/>2025-4-16 sleep睡眠应用</a></li><li><a href=/docs/2025-4-16-paas%E8%AE%BE%E8%AE%A1/>2025-4-16 paas开发记录</a></li><li><a href=/docs/2025-4-16-cursoe-free-vip/>2025-4-16 Cursor Free VIP</a></li><li><a href=/docs/2025-4-16-boss%E7%9B%B4%E8%81%98%E8%87%AA%E5%8A%A8%E6%8A%95%E9%80%92/>2025-4-16 BOSS直聘自动投递</a></li><li><a href=/docs/2025-3-30-metallb/>2025-3-30 metallb</a></li><li><a href=/docs/2025-3-24-%E8%87%AA%E6%88%91%E4%BB%8B%E7%BB%8D/>2025-3-24 自我介绍</a></li><li><a href=/docs/2025-3-20-victoriametrics-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84/>2025-3-20 victoriametrics高可用架构</a></li><li><a href=/docs/2025-3-20-victoriametrics%E6%9E%B6%E6%9E%84/>2025-3-20 victoriametrics 架构</a></li><li><a href=/docs/2025-3-20-victoriametrics%E5%92%8Cthanos%E5%AF%B9%E6%AF%94/>2025-3-20 VictoriaMetrics 和 Thanos 对比</a></li><li><a href=/docs/2025-3-20-thanos%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84/>2025-3-20 thanos高可用架构</a></li><li><a href=/docs/2025-3-20-thanos%E6%9E%B6%E6%9E%84/>2025-3-20 thanos架构</a></li><li><a href=/docs/2025-3-18-5w-pod%E5%8E%8B%E6%B5%8B%E5%A4%8D%E7%9B%98/>2025-3-18 5w pod压测复盘</a></li><li><a href=/docs/2025-3-14-%E7%81%AB%E5%B1%B1%E4%BA%91%E8%BF%81%E7%A7%BB%E5%B7%A5%E7%A8%8B%E5%B8%88%E9%9D%A2%E8%AF%95%E8%AE%B0%E5%BD%95/>2025-3-14 火山云迁移工程师面试记录</a></li><li><a href=/docs/2025-3-14-vivo%E9%9D%A2%E8%AF%95/>2025-3-14 vivo面试</a></li><li><a href=/docs/2025-3-13-istio%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/>2025-3-13 istio流量分析</a></li><li><a href=/docs/2025-3-13-calico%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%B5%81%E9%87%8F%E4%BC%A0%E8%BE%93%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90/>2025-3-13 calico三种模式下流量传输</a></li><li><a href=/docs/2025-3-12-%E5%A1%94%E8%B5%9E%E9%9D%A2%E8%AF%95/>2025-3-12 塔赞面试</a></li><li><a href=/docs/2025-3-12-%E8%BF%BD%E8%A7%85%E9%9D%A2%E8%AF%95/>2025-3-12 追觅面试</a></li><li><a href=/docs/2025-3-8-k8s%E5%88%A0%E9%99%A4pod-deployment%E7%9A%84%E6%B5%81%E7%A8%8B%E5%9B%BE%E8%AF%A6%E8%A7%A3/>2025-3-08 k8s删除pod或deployment的流程图详解</a></li><li><a href=/docs/2025-3-8-k8s%E5%88%9B%E5%BB%BApod-deployment%E6%B5%81%E7%A8%8B%E5%9B%BE%E8%AF%A6%E8%A7%A3/>2025-3-08 k8s创建pod流程图详解</a></li><li><a href=/docs/2025-2-28-prometheus%E9%A2%98%E7%9B%AE/>2025-2-28 prometheus面试题</a></li><li><a href=/docs/2025-2-26-%E9%9D%A2%E8%AF%950225/>2025-2-25 面试0225</a></li><li><a href=/docs/2025-2-24-%E9%AB%98%E7%BA%A7%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98_ai_linux%E9%83%A8%E5%88%86/>2025-2-24 高级运维面试题-linux部分</a></li><li><a href=/docs/2025-2-24-%E4%B8%AD%E7%BA%A7%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98_%E9%A2%98%E7%9B%AE/>2025-2-24 中级运维面试题</a></li><li><a href=/docs/2025-2-24-%E9%9D%A2%E8%AF%950224/>2025-2-24 0224面试</a></li><li><a href=/docs/2025-2-20-%E9%9D%A2%E8%AF%950220/>2025-2-20 面试0220</a></li><li><a href=/docs/2025-2-19-%E9%9D%A2%E8%AF%950219/>2025-2-19 面试0219</a></li><li><a href=/docs/2025-2-18-%E9%9D%A2%E8%AF%95/>2025-2-18 面试2025-0218</a></li><li><a href=/docs/2025-2-26-k8s%E7%9B%B8%E5%85%B3/>2025-2-16 k8s题目</a></li><li><a href=/docs/2025-2-12-%E9%9D%A2%E8%AF%950212/>2025-2-12 面试0212</a></li><li><a href=/docs/2025-2-11-%E9%9D%A2%E8%AF%950211/>2025-2-11 面试2025-02-11</a></li><li><a href=/docs/2025-2-7-%E8%AE%A1%E5%88%922/>2025-2-07 美国码农计划</a></li><li><a href=/docs/2025-2-7-%E8%AE%A1%E5%88%92/>2025-2-07 美国码农薪酬</a></li><li><a href=/docs/2025-2-7-k8s%E7%BB%84%E4%BB%B6/>2025-2-07 k8s组件</a></li><li><a href=/docs/2025-1-16-k8s%E5%B8%B8%E8%A7%81%E6%95%85%E9%9A%9C%E6%8C%87%E5%8D%97/>2025-1-16 k8s常见故障指南</a></li><li><a href=/docs/2025-1-1-%E8%A6%81%E4%B8%8D%E8%A6%81%E5%88%9B%E4%B8%9A/>2025-1-1 要不要创业</a></li><li><a href=/docs/2025-1-1-%E6%97%A9%E6%9C%9F%E6%A8%A1%E5%BC%8F/>2025-1-1 早期模式</a></li><li><a href=/docs/2025-1-1-%E5%A4%A7%E5%A0%B0%E6%B2%B3-%E6%88%91%E7%9A%84%E4%BF%9D%E5%A7%86/>2025-1-1 大堰河-我的保姆</a></li><li><a href=/docs/2025-1-1-%E5%88%9D%E5%88%9B%E5%85%AC%E5%8F%B8/>2025-1-1 初创公司</a></li><li><a href=/docs/2025-1-1-%E5%88%9B%E4%B8%9A%E8%80%85%E4%BA%A4%E6%B5%81/>2025-1-1 创业者交流</a></li><li><a href=/docs/2025-1-1-%E5%88%9B%E4%B8%9A%E7%82%B9%E5%AD%90/>2025-1-1 创业点子</a></li><li><a href=/docs/2025-1-1-sealos%E8%8E%B7%E6%8A%95/>2025-1-1 sealos获投</a></li><li><a href=/docs/2024-12-10-docker-registrry/>2024-12-10 docker registrry</a></li><li><a href=/docs/2024-12-09-openstack-ssh%E8%BF%9E%E6%8E%A5/>2024-12-09 openstack ssh连接</a></li><li><a href=/docs/2024-12-08-mutilpass%E9%83%A8%E7%BD%B2openstack/>2024-12-09 mutilpass部署openstack devstack形式</a></li><li><a href=/docs/2024-12-09-helmchart-%E9%83%A8%E7%BD%B2flask%E5%BA%94%E7%94%A8/>2024-12-09 helmchart 部署flask应用</a></li><li><a href=/docs/2024-12-09-docker-daemon.json/>2024-12-09 docker daemon.json</a></li><li><a href=/docs/2024-12-08-%E5%9D%97%E5%AD%98%E5%82%A8%E5%92%8C%E5%AF%B9%E8%B1%A1%E5%82%A8%E5%AD%98%E5%8C%BA%E5%88%AB/>2024-12-08 块存储和对象储存区别</a></li><li><a href=/docs/2024-12-08-openstack%E9%9C%80%E8%A6%81%E5%87%A0%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA/>2024-12-08 openstack需要几台虚拟机</a></li><li><a href=/docs/2024-12-08-openstack%E5%92%8Ckubernetes%E5%8C%BA%E5%88%AB/>2024-12-08 openstack和kubernetes区别</a></li><li><a href=/docs/2024-12-08-nano%E6%93%8D%E4%BD%9C/>2024-12-08 nano操作</a></li><li><a href=/docs/2024-12-08-mutilpass%E6%93%8D%E4%BD%9C/>2024-12-08 mutilpass操作</a></li><li><a href=/docs/2024-12-08-devstack/>2024-12-08 devstack</a></li><li><a href=/docs/2024-12-07-microk8s/>2024-12-07 microk8s</a></li><li><a href=/docs/2024-12-05-kubeasz%E9%83%A8%E7%BD%B2k8s/>2024-12-05 kubeasz部署k8s</a></li><li><a href=/docs/2024-10-20-%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/>2024-10-20 使用 Keepalived 和 HAproxy 创建高可用 Kubernetes 集群</a></li><li><a href=/docs/%E9%A1%B6%E7%BA%A7devops%E5%B7%A5%E5%85%B7%E5%A4%A7%E7%9B%98%E7%82%B9-ding-ji-devops-gong-ju-da-pan-dian/>2024-08-02 顶级devops工具大盘点</a></li><li><a href=/docs/%E6%B8%85%E7%90%86docker%E9%95%9C%E5%83%8F-qing-li-docker-jing-xiang/>2024-08-02 清理docker镜像</a></li><li><a href=/docs/%E6%9E%84%E5%BB%BA%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%88%A9%E5%99%A8buildkit-gou-jian-rong-qi-jing-xiang-li-qi-buildkit/>2024-08-02 构建容器镜像利器buildkit</a></li><li><a href=/docs/%E6%98%AF%E6%8A%80%E6%9C%AF%E5%A4%A7%E7%A5%9E%E8%BF%98%E6%98%AF%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E9%83%A8%E7%9A%84%E7%A5%B8%E5%AE%B3-shi-ji-shu-da-shen-hai-shi-ji-chu-jia-gou-bu-de-huo-hai/>2024-08-02 是技术大神还是基础架构部的祸害</a></li><li><a href=/docs/%E6%90%AD%E4%B8%AA%E6%97%A5%E5%BF%97%E6%89%8B%E6%9C%BA%E7%B3%BB%E7%BB%9F%E4%B8%8D%E9%A6%99%E5%90%97-da-ge-ri-zhi-shou-ji-xi-tong-bu-xiang-ma/>2024-08-02 搭个日志手机系统不香吗</a></li><li><a href=/docs/%E6%88%91%E5%8F%AA%E6%83%B3%E5%81%9A%E6%8A%80%E6%9C%AF-%E8%B5%B0%E6%8A%80%E6%9C%AF%E8%B7%AF%E7%BA%BF-wo-zhi-xiang-zuo-ji-shu-zou-ji-shu-lu-xian/>2024-08-02 我只想做技术 走技术路线</a></li><li><a href=/docs/%E5%B8%B8%E8%A7%81linux%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98-chang-jian-linux-yun-wei-mian-shi-ti/>2024-08-02 常见linux运维面试题</a></li><li><a href=/docs/%E5%A4%A7%E5%8E%82%E6%80%BB%E7%BB%93nginx%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E7%AC%94%E8%AE%B0-da-chang-zong-jie-nginx-gao-bing-fa-you-hua-bi-ji/>2024-08-02 大厂总结nginx高并发优化笔记</a></li><li><a href=/docs/%E5%8F%B2%E4%B8%8A%E6%9C%80%E7%89%9Bjenkins-pipeline%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%A6%E8%A7%A3-shi-shang-zui-niu-jenkinspipeline-liu-shui-xian-xiang-jie/>2024-08-02 史上最牛jenkins pipeline流水线详解</a></li><li><a href=/docs/teg%E4%B8%8Eistio%E9%9B%86%E6%88%90-teg-yu-istio-ji-cheng/>2024-08-02 TEG与istio集成</a></li><li><a href=/docs/prometheus-stack-prometheus-stack/>2024-08-02 prometheus-stack</a></li><li><a href=/docs/pixie-pixie/>2024-08-02 pixie</a></li><li><a href=/docs/nginx%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%83%8A%E7%BE%A4%E6%95%88%E5%BA%94-nginx-ru-he-jie-jue-jing-qun-xiao-ying/>2024-08-02 nginx如何解决惊群效应</a></li><li><a href=/docs/netctl%E6%A3%80%E6%B5%8B%E9%9B%86%E7%BE%A4pod%E9%97%B4%E8%BF%9E%E9%80%9A%E6%80%A7-netctl-jian-ce-ji-qun-pod-jian-lian-tong-xing/>2024-08-02 netctl检测集群pod间连通性</a></li><li><a href=/docs/linux%E8%BF%90%E7%BB%B4%E5%B7%A5%E7%A8%8B%E5%B8%8850%E4%B8%AA%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-linux-yun-wei-gong-cheng-shi-50-ge-chang-jian-mian-shi-ti/>2024-08-02 linux运维工程师50个常见面试题</a></li><li><a href=/docs/linux%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E4%B8%83%E4%B8%AA%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C-linux-xi-tong-xing-neng-you-hua-qi-ge-shi-zhan-jing-yan/>2024-08-02 linux系统性能优化 七个实战经验</a></li><li><a href=/docs/linux-awk%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E5%99%A8-8%E4%B8%AA%E6%A1%88%E4%BE%8B-linuxawk-wen-ben-chu-li-qi-8-ge-an-li/>2024-08-02 linux awk文本处理器 8个案例</a></li><li><a href=/docs/kubewharf-kubewharf/>2024-08-02 kubewharf</a></li><li><a href=/docs/kruise%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7%E8%A7%A3%E6%9E%90-kruise-yuan-de-sheng-ji-jie-xi/>2024-08-02 kruise原地升级解析</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E9%A2%98-k8s-mian-shi-ti/>2024-08-02 K8S面试题</a></li><li><a href=/docs/k8s%E8%83%8C%E5%90%8Eservice%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84-k8s-bei-hou-service-shi-ru-he-gong-zuo-de/>2024-08-02 k8s背后service是如何工作的</a></li><li><a href=/docs/k8s%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E5%9D%97%E6%8B%BC%E5%9B%BE-dbpaas-k8s-de-zui-hou-yi-kuai-pin-tu-dbpaas/>2024-08-02 K8S的最后一块拼图</a></li><li><a href=/docs/istio%E9%83%A8%E7%BD%B2-istio-bu-shu/>2024-08-02 istio部署</a></li><li><a href=/docs/istio-ingress-gateway-istio-ingress-gateway/>2024-08-02 istio-ingress-gateway</a></li><li><a href=/docs/godel-scheduler-godel-scheduler/>2024-08-02 godel-scheduler</a></li><li><a href=/docs/dockerfile%E5%AE%9A%E5%88%B6%E4%B8%93%E5%B1%9E%E9%95%9C%E5%83%8F-dockerfile-ding-zhi-zhuan-shu-jing-xiang/>2024-08-02 dockerfile定制专属镜像</a></li><li><a href=/docs/33%E6%AC%BEgitops%E4%B8%8Edevops%E4%B8%BB%E6%B5%81%E7%B3%BB%E7%BB%9F-33-kuan-gitops-yu-devops-zhu-liu-xi-tong/>2024-08-02 33款gitops与devops主流系统</a></li><li><a href=/docs/2024-8-1-linux%E8%BF%90%E7%BB%B4%E5%B7%A5%E7%A8%8B%E5%B8%8850%E4%B8%AA%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/>2024-08-01 linux面试题</a></li><li><a href=/docs/2024-8-1-%E5%B8%B8%E8%A7%81linux%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98%E6%89%BE%E5%B7%A5%E4%BD%9C%E7%9A%84%E5%BF%85%E7%9C%8B/>2024-08-01 linux运维面试题</a></li><li><a href=/docs/2024-8-1-kubernetes%E9%9D%A2%E8%AF%95%E9%A2%98/>2024-08-01 k8s面试题</a></li><li><a href=/docs/openkruise%E8%AF%A6%E7%BB%86%E8%A7%A3%E9%87%8A%E4%BB%A5%E5%8F%8A%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7%E5%8F%8A%E5%85%A8%E9%93%BE%E8%B7%AF%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%E6%96%B9%E6%A1%88-openkruise-xiang-xi-jie-shi-yi-ji-yuan-de-sheng-ji-ji-quan-lian-lu-hui-du-fa-bu-fang-an/>2024-07-22 OpenKruise详细解释以及原地升级及全链路灰度发布方案</a></li><li><a href=/docs/k8s%E4%B9%8Bingress-nginx%E5%8E%9F%E7%90%86%E5%8F%8A%E9%85%8D%E7%BD%AE-k8s-zhi-ingress-nginx-yuan-li-ji-pei-zhi/>2024-07-05 K8S之ingress-nginx原理及配置</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8cloudflarecf%E6%90%AD%E5%BB%BAdockerhub%E4%BB%A3%E7%90%86-shi-yong-cloudflarecf-da-jian-dockerhub-dai-li/>2024-06-28 使用cloudflare(CF)搭建dockerhub代理</a></li><li><a href=/docs/2024-5-14-%E5%8D%95master%E5%8D%95etcd%E6%94%B9%E9%80%A0/>2024-05-01 单master单etcd改造为3master3etcd</a></li><li><a href=/docs/2024-4-17-%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/>2024-04-17 面试总结</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E4%B8%BAk8s%E4%BF%9D%E9%A9%BE%E6%8A%A4%E8%88%AA-ru-he-wei-k8s-bao-jia-hu-hang/>2024-04-16 如何为K8S保驾护航</a></li><li><a href=/docs/k8s%E5%A6%82%E4%BD%95%E8%8E%B7%E5%BE%97-ip-k8s-ru-he-huo-de-ip/>2024-04-16 K8S如何获得 IP</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_setgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_set_status_updatego%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetstatusupdatego-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set_status_update.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_set_controlgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetcontrolgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set_control.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_pod_controlgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulpodcontrolgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_pod_control.go源码解读</a></li><li><a href=/docs/k8s%E8%B0%83%E5%BA%A6%E5%99%A8-extendergo-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-diao-du-qi-extendergo-yuan-ma-jie-du/>2024-04-09 K8S调度器 extender.go 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bsyncgo-%E5%90%8C%E6%AD%A5-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-syncgo-tong-bu-yuan-ma-jie-du/>2024-04-09 K8S控制器之sync.go 同步 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Brollbackgo-%E5%9B%9E%E6%BB%9A-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-rollbackgo-hui-gun-yuan-ma-jie-du/>2024-04-09 K8S控制器之rollback.go 回滚 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Brecreatego-%E9%87%8D%E5%BB%BA-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-recreatego-zhong-jian-yuan-ma-jie-du/>2024-04-09 K8S控制器之recreate.go 重建 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-schedulergo-%E8%B0%83%E5%BA%A6%E5%99%A8-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-schedulergo-diao-du-qi-yuan-ma-jie-du/>2024-04-09 K8S控制器之 scheduler.go 调度器 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-rollinggo-%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-rollinggo-gun-dong-geng-xin-yuan-ma-jie-du/>2024-04-09 K8S控制器之 rolling.go 滚动更新 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-progressgo-%E8%BF%9B%E5%BA%A6-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-progressgo-jin-du-yuan-ma-jie-du/>2024-04-09 K8S控制器之 progress.go 进度 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-deployment_controllergo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-deploymentcontrollergo-yuan-ma-jie-du/>2024-04-09 K8S控制器之 deployment_controller.go源码解读</a></li><li><a href=/docs/k8s-%E8%B0%83%E5%BA%A6%E5%99%A8-scheduler_onego-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-diao-du-qi-scheduleronego-yuan-ma-jie-du/>2024-04-09 K8S 调度器 scheduler_one.go 源码解读</a></li><li><a href=/docs/%E5%BD%BB%E6%82%9F%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C-che-wu-rong-qi-wang-luo/>2024-04-07 彻悟容器网络</a></li><li><a href=/docs/%E9%9D%A2%E8%AF%95%E7%94%A8-golang-%E6%89%8B%E6%92%B8-lru-mian-shi-yong-golang-shou-lu-lru/>2024-04-03 面试用 Golang 手撸 LRU</a></li><li><a href=/docs/%E8%87%AA%E5%8A%A8%E5%B1%8F%E8%94%BDip%E6%94%BB%E5%87%BB-zi-dong-ping-bi-ip-gong-ji/>2024-04-03 自动屏蔽IP攻击</a></li><li><a href=/docs/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85kubephere-li-xian-an-zhuang-kubephere/>2024-04-03 离线安装kubephere</a></li><li><a href=/docs/%E7%A3%81%E7%9B%98%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D-ci-pan-shu-ju-hui-fu/>2024-04-03 磁盘数据恢复</a></li><li><a href=/docs/%E6%B8%85%E7%90%86%E6%AE%8B%E7%95%99%E7%9A%84calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6-qing-li-can-liu-de-calico-wang-luo/>2024-04-03 清理残留的calico网络插件</a></li><li><a href=/docs/%E6%B5%81%E9%87%8F%E4%BD%95%E5%A4%84%E6%9D%A5%E4%BD%95%E5%A4%84%E5%8E%BB-liu-liang-he-chu-lai-he-chu-qu/>2024-04-03 流量何处来何处去</a></li><li><a href=/docs/%E6%9E%81%E5%A4%A7%E6%8F%90%E9%AB%98%E5%B7%A5%E4%BD%9C%E6%95%88%E7%8E%87%E7%9A%84-linux-%E5%91%BD%E4%BB%A4-ji-da-ti-gao-gong-zuo-xiao-lv-de-linux-ming-ling/>2024-04-03 极大提高工作效率的 Linux 命令</a></li><li><a href=/docs/%E6%96%87%E5%AD%A6%E7%9A%84%E6%95%85%E4%B9%A1-wen-xue-de-gu-xiang/>2024-04-03 文学的故乡</a></li><li><a href=/docs/%E6%90%9E%E6%87%82k8s%E9%89%B4%E6%9D%83-gao-dong-k8s-jian-quan/>2024-04-03 搞懂K8S鉴权</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86-rong-qi-wang-luo-yuan-li/>2024-04-03 容器网络原理</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%80-overlayfs-%E5%8E%9F%E7%90%86-rong-qi-de-wen-jian-xi-tong--yi-overlayfs-yuan-li/>2024-04-03 容器的文件系统 OverlayFS 原理</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E5%8E%9F%E7%90%86-rong-qi-yuan-li/>2024-04-03 容器原理</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E5%86%85%E7%9A%84-1-%E5%8F%B7%E8%BF%9B%E7%A8%8B-rong-qi-nei-de-1-hao-jin-cheng/>2024-04-03 容器内的 1 号进程</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E4%BB%A5%E5%8F%8A%E4%B8%8D%E5%90%8Cdnspolicy%E5%AF%B9%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E7%9A%84%E5%BD%B1%E5%93%8D-rong-qi-zhong-yu-ming-jie-xi-yi-ji-bu-tong-dnspolicy-dui-yu-ming-jie-xi-de-ying-xiang/>2024-04-03 容器中域名解析以及不同dnspolicy对域名解析的影响</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95-crash-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C-ru-he-diao-shi-crash-rong-qi-de-wang-luo/>2024-04-03 如何调试 crash 容器的网络</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8tekton%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BAcicd%E5%B9%B3%E5%8F%B0-ru-he-shi-yong-tekton-kuai-su-da-jian-cicd-ping-tai/>2024-04-03 如何使用tekton快速搭建CI/CD平台</a></li><li><a href=/docs/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%B9%B6%E5%8F%91%E4%B8%8B%E5%A6%82%E4%BD%95%E5%8A%A0%E5%BF%AB-pod-%E5%90%AF%E5%8A%A8%E9%80%9F%E5%BA%A6-da-gui-mo-bing-fa-xia-ru-he-jia-kuai-pod-qi-dong-su-du/>2024-04-03 大规模并发下如何加快 Pod 启动速度</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8kubernees-leases-%E8%BD%BB%E6%9D%BE%E5%AE%9E%E7%8E%B0leader-election-shi-yong-kuberneesleases-qing-song-shi-xian-leaderelection/>2024-04-03 使用kubernees leases 轻松实现leader election</a></li><li><a href=/docs/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2k8s%E5%8A%A0%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C-er-jin-zhi-bu-shu-k8s-jia-jie-dian-cao-zuo/>2024-04-03 二进制部署K8S加节点操作</a></li><li><a href=/docs/%E4%B8%A4%E5%BC%A0%E5%9B%BE%E5%85%A8%E9%9D%A2%E7%90%86%E8%A7%A3k8s%E5%8E%9F%E7%90%86-liang-zhang-tu-quan-mian-li-jie-k8s-yuan-li/>2024-04-03 两张图全面理解K8S原理</a></li><li><a href=/docs/ssl%E8%AF%81%E4%B9%A6%E8%87%AA%E7%AD%BE%E5%8F%91-ssl-zheng-shu-zi-qian-fa/>2024-04-03 ssl证书自签发</a></li><li><a href=/docs/prometheus%E4%BC%81%E4%B8%9A%E7%BA%A7%E7%9B%91%E6%8E%A7%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93-prometheus-qi-ye-ji-jian-kong-shi-yong-zong-jie/>2024-04-03 prometheus企业级监控使用总结</a></li><li><a href=/docs/metallb-l2-%E5%8E%9F%E7%90%86-metallbl2-yuan-li/>2024-04-03 MetalLB L2 原理</a></li><li><a href=/docs/linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%A4%A7%E5%85%A8-linux-xing-neng-you-hua-da-quan/>2024-04-03 Linux 性能优化大全</a></li><li><a href=/docs/kubernetes-%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3%E9%89%B4%E6%9D%83-kubernetes-zheng-shu-xiang-jie--jian-quan-/>2024-04-03 Kubernetes 证书详解(鉴权)</a></li><li><a href=/docs/kubernetes-%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3%E8%AE%A4%E8%AF%81-kubernetes-zheng-shu-xiang-jie--ren-zheng-/>2024-04-03 Kubernetes 证书详解(认证)</a></li><li><a href=/docs/kubernetes-%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84-kubernetes-yuan-ma-jie-gou/>2024-04-03 Kubernetes 源码结构</a></li><li><a href=/docs/kubernetes-api-kubernetesapi/>2024-04-03 Kubernetes API</a></li><li><a href=/docs/kubekey%E6%B7%BB%E5%8A%A0%E6%96%B0%E8%8A%82%E7%82%B9-kubekey-tian-jia-xin-jie-dian/>2024-04-03 kubekey添加新节点</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E5%AE%9D%E5%85%B8-k8s-mian-shi-bao-dian/>2024-04-03 K8S面试宝典</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E5%A4%A7%E5%85%A8-k8s-mian-shi-da-quan/>2024-04-03 K8S面试大全</a></li><li><a href=/docs/k8s%E8%BF%90%E7%BB%B4%E4%B9%8B%E6%B8%85%E7%90%86%E7%A3%81%E7%9B%98-k8s-yun-wei-zhi-qing-li-ci-pan/>2024-04-03 k8s运维之清理磁盘</a></li><li><a href=/docs/k8s%E8%B0%83%E8%AF%95pod-k8s-diao-shi-pod/>2024-04-03 K8S调试POD</a></li><li><a href=/docs/k8s%E7%9A%84pod%E7%B1%BB%E5%9E%8B-k8s-de-pod-lei-xing/>2024-04-03 K8S的POD类型</a></li><li><a href=/docs/k8s%E5%BA%94%E7%94%A8%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-k8s-ying-yong-de-zui-jia-shi-jian/>2024-04-03 k8s应用的最佳实践</a></li><li><a href=/docs/k8s%E5%91%BD%E4%BB%A4%E6%8C%87%E5%8D%97-k8s-ming-ling-zhi-nan/>2024-04-03 K8S命令指南</a></li><li><a href=/docs/k8s%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7-k8s-yuan-de-sheng-ji/>2024-04-03 K8S原地升级</a></li><li><a href=/docs/k8s-%E6%8E%A2%E9%92%88%E5%8E%9F%E7%90%86-k8s-tan-zhen-yuan-li/>2024-04-03 K8S 探针原理</a></li><li><a href=/docs/k8s-%E5%BC%80%E5%8F%91%E5%8F%AF%E4%B8%8D%E6%AD%A2-crud-k8s-kai-fa-ke-bu-zhi-crud/>2024-04-03 K8S 开发可不止 CRUD</a></li><li><a href=/docs/k8s-gpt-k8sgpt/>2024-04-03 K8S GPT</a></li><li><a href=/docs/k8s-csi-openebs%E5%8E%9F%E7%90%86-k8scsiopenebs-yuan-li/>2024-04-03 K8S csi openebs原理</a></li><li><a href=/docs/helm-chart%E5%92%8Crepo-helmchart-he-repo/>2024-04-03 helm chart和repo</a></li><li><a href=/docs/flanel%E7%BD%91%E7%BB%9C-flanel-wang-luo/>2024-04-03 flanel网络</a></li><li><a href=/docs/etcd%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%8F%8A%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5-etcd-wen-ding-xing-ji-xing-neng-you-hua-shi-jian/ class=active>2024-04-03 ETCD稳定性及性能优化实践</a></li><li><a href=/docs/etcd%E5%A4%87%E4%BB%BD-etcd-bei-fen/>2024-04-03 ETCD备份</a></li><li><a href=/docs/docker%E9%87%8D%E8%A6%81%E7%9A%84%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E7%82%B9-docker-zhong-yao-de-wang-luo-zhi-shi-dian/>2024-04-03 Docker重要的网络知识点</a></li><li><a href=/docs/dockerfile%E7%9A%84copy%E5%92%8Cadd%E7%9A%84%E5%8C%BA%E5%88%AB-dockerfile-de-copy-he-add-de-qu-bie/>2024-04-03 dockerfile的copy和add的区别</a></li><li><a href=/docs/coredns%E4%B9%8B%E5%85%89-coredns-zhi-guang/>2024-04-03 COREDNS之光</a></li><li><a href=/docs/containerd-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-containerd-ji-ben-cao-zuo/>2024-04-03 Containerd 基本操作</a></li><li><a href=/docs/cni%E6%8F%92%E4%BB%B6%E9%80%89%E5%9E%8B-cni-cha-jian-xuan-xing/>2024-04-03 CNI插件选型</a></li><li><a href=/docs/client-go-%E6%9E%B6%E6%9E%84-client-go-jia-gou/>2024-04-03 Client-go 架构</a></li><li><a href=/docs/client-go-%E5%9B%9B%E7%A7%8D%E5%AE%A2%E6%88%B7%E7%AB%AF-client-go-si-zhong-ke-hu-duan/>2024-04-03 Client-go 四种客户端</a></li><li><a href=/docs/cicd%E6%80%9D%E8%80%83-cicd-si-kao/>2024-04-03 CICD思考</a></li><li><a href=/docs/calico%E7%BD%91%E7%BB%9C%E8%87%AA%E5%AE%9A%E4%B9%89-calico-wang-luo-zi-ding-yi/>2024-04-03 Calico网络自定义</a></li><li><a href=/docs/acme%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E8%AF%81%E4%B9%A6-acme-zi-dong-geng-xin-zheng-shu/>2024-04-03 acme自动更新证书</a></li><li><a href=/docs/16%E4%B8%AA%E6%A6%82%E5%BF%B5%E5%B8%A6%E4%BD%A0%E5%85%A5%E9%97%A8-kubernetes-16-ge-gai-nian-dai-ni-ru-men-kubernetes/>2024-04-03 16个概念带你入门 Kubernetes</a></li><li><a href=/docs/%E9%9D%A2%E8%AF%950308-mian-shi-0308/>2024-04-03 面试0308</a></li><li><a href=/docs/600%E6%9D%A1%E6%9C%80%E5%BC%BAlinux%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-600-tiao-zui-qiang-linux-ming-ling-zong-jie/>2024-04-03 600条最强linux命令总结</a></li><li><a href=/docs/16%E5%BC%A0%E7%A1%AC%E6%A0%B8%E5%9B%BE%E8%A7%A3k8s%E7%BD%91%E7%BB%9C-16-zhang-ying-he-tu-jie-k8s-wang-luo/>2024-04-03 16张硬核图解k8s网络</a></li><li><a href=/docs/k8s%E4%B9%8Bkubelet%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-zhi-kubelet-yuan-ma-jie-du/>2024-03-28 k8s之kubelet源码解读</a></li><li><a href=/docs/2024-3-19-%E4%B8%A4%E5%BC%A0%E5%9B%BE%E5%85%A8%E9%9D%A2%E7%90%86%E8%A7%A3k8s%E5%8E%9F%E7%90%86/>2024-03-19 两张图全面理解k8s原理</a></li><li><a href=/docs/2024-3-8-%E9%9D%A2%E8%AF%950308/>2024-03-08 面试</a></li><li><a href=/docs/2024-3-4-k8s%E6%B5%81%E9%87%8F%E9%93%BE%E8%B7%AF%E5%89%96%E6%9E%90/>2024-03-04 k8s流量链路剖析</a></li><li><a href=/docs/k8s-%E6%B5%81%E9%87%8F%E9%93%BE%E8%B7%AF%E5%89%96%E6%9E%90-k8s-liu-liang-lian-lu-pou-xi/>2024-03-04 K8S 流量链路剖析</a></li><li><a href=/docs/k8s-csi%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B-k8scsi-pou-xi-yan-jin/>2024-03-04 K8S CSI剖析演进</a></li><li><a href=/docs/k8s-cni%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B-k8scni-pou-xi-yan-jin/>2024-03-04 K8S CNI剖析演进</a></li><li><a href=/docs/2024-3-4-k8s-csi%E5%89%96%E6%9E%90/>2024-03-04 CSI剖析演进</a></li><li><a href=/docs/2024-3-4-cni%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B/>2024-03-04 CNI剖析演进</a></li><li><a href=/docs/2024-2-26-%E9%9D%A2%E8%AF%95/>2024-02-26 面试</a></li><li><a href=/docs/2024-2-22-k8s%E9%9D%A2%E8%AF%95%E5%AE%9D%E5%85%B8/>2024-02-22 k8s面试宝典</a></li><li><a href=/docs/2024-2-22-k8s%E6%9E%B6%E6%9E%84%E5%B8%88%E9%9D%A2%E8%AF%95%E5%A4%A7%E5%85%A8/>2024-02-22 k8s架构师面试大全</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8-openfunction-%E5%9C%A8%E4%BB%BB%E4%BD%95%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E4%B8%8A%E8%BF%90%E8%A1%8C%E6%97%A0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD-shi-yong-openfunction-zai-ren-he-ji-chu-she-shi-shang-yun-xing-wu-fu-wu-qi-gong-zuo-fu-zai/>2024-01-21 使用 OpenFunction 在任何基础设施上运行无服务器工作负载</a></li><li><a href=/docs/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4-li-xian-an-zhuang-ji-qun/>2023-09-28 离线安装集群</a></li><li><a href=/docs/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%B4%E6%98%8E-cao-zuo-xi-tong-shuo-ming/>2023-09-28 操作系统说明</a></li><li><a href=/docs/%E5%BF%AB%E9%80%9F%E6%8C%87%E5%8D%97-kuai-su-zhi-nan/>2023-09-28 快速指南</a></li><li><a href=/docs/%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8-cilium-kai-shi-shi-yong-cilium/>2023-09-28 开始使用 cilium</a></li><li><a href=/docs/%E5%A4%9A%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81-duo-jia-gou-zhi-chi/>2023-09-28 多架构支持</a></li><li><a href=/docs/%E5%85%AC%E6%9C%89%E4%BA%91%E4%B8%8A%E9%83%A8%E7%BD%B2-kubeasz-gong-you-yun-shang-bu-shu-kubeasz/>2023-09-28 公有云上部署</a></li><li><a href=/docs/%E4%B8%AA%E6%80%A7%E5%8C%96%E9%9B%86%E7%BE%A4%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE-ge-xing-hua-ji-qun-can-shu-pei-zhi/>2023-09-28 个性化集群参数配置</a></li><li><a href=/docs/network-check-network-check/>2023-09-28 network-check</a></li><li><a href=/docs/kube-router-%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-kube-router-wang-luo-zu-jian/>2023-09-28 kube-router 网络组件</a></li><li><a href=/docs/ezctl-%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BB%8B%E7%BB%8D-ezctl-ming-ling-xing-jie-shao/>2023-09-28 ezctl 命令行介绍</a></li><li><a href=/docs/ex-lb-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%83%A8%E7%BD%B2-ex-lb-fu-zai-jun-heng-bu-shu/>2023-09-28 EX-LB 负载均衡部署</a></li><li><a href=/docs/calico-%E9%85%8D%E7%BD%AE-bgp-route-reflectors-calico-pei-zhi-bgproutereflectors/>2023-09-28 calico 配置 BGP Route Reflectors</a></li><li><a href=/docs/07-%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4%E4%B8%BB%E8%A6%81%E6%8F%92%E4%BB%B6-07--an-zhuang-ji-qun-zhu-yao-cha-jian/>2023-09-28 15:26:42.651 07-安装集群主要插件</a></li><li><a href=/docs/08-k8s-%E9%9B%86%E7%BE%A4%E5%AD%98%E5%82%A8--k8s-ji-qun-cun-chu/>2023-09-28 08-K8S 集群存储</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-wang-luo-zu-jian/>2023-09-28 06-安装网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85kube-ovn%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-kube-ovn-wang-luo-zu-jian/>2023-09-28 06-安装kube-ovn网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85flannel%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-flannel-wang-luo-zu-jian/>2023-09-28 06-安装flannel网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85cilium%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-cilium-wang-luo-zu-jian/>2023-09-28 06-安装cilium网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85calico%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-calico-wang-luo-zu-jian/>2023-09-28 06-安装calico网络组件</a></li><li><a href=/docs/02-%E5%AE%89%E8%A3%85etcd%E9%9B%86%E7%BE%A4-02--an-zhuang-etcd-ji-qun/>2023-09-28 02-安装etcd集群</a></li><li><a href=/docs/00-%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%92%8C%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E8%AE%BE%E5%AE%9A-00--ji-qun-gui-hua-he-ji-chu-can-shu-she-ding/>2023-09-28 00-集群规划和基础参数设定</a></li><li><a href=/docs/05-%E5%AE%89%E8%A3%85kube_node%E8%8A%82%E7%82%B9-05--an-zhuang-kubenode-jie-dian/>2023-09-28 05-安装kube_node节点</a></li><li><a href=/docs/04-%E5%AE%89%E8%A3%85kube_master%E8%8A%82%E7%82%B9-04--an-zhuang-kubemaster-jie-dian/>2023-09-28 04-安装kube_master节点</a></li><li><a href=/docs/03-%E5%AE%89%E8%A3%85%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6-03--an-zhuang-rong-qi-yun-xing-shi/>2023-09-28 03-安装容器运行时</a></li><li><a href=/docs/01-%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6%E5%92%8C%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-01--chuang-jian-zheng-shu-he-huan-jing-zhun-bei/>2023-09-28 01-创建证书和环境准备</a></li><li><a href=/docs/%E6%9C%89%E8%BF%993%E4%B8%AA%E8%BF%B9%E8%B1%A1%E4%BD%A0%E5%B0%B1%E8%AF%A5%E7%A6%BB%E8%81%8C%E4%BA%86-you-zhe-3-ge-ji-xiang--ni-jiu-gai-li-zhi-le/>2023-09-21 思考</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8-keepalived-%E5%92%8C-haproxy-%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8-kubernetes-%E9%9B%86%E7%BE%A4-shi-yong-keepalived-he-haproxy-chuang-jian-gao-ke-yong-kubernetes-ji-qun/>2023-04-12 使用 Keepalived 和 HAproxy 创建高可用 Kubernetes 集群</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>2024-04-03 ETCD稳定性及性能优化实践</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#背景与挑战>背景与挑战</a></li><li><a href=#稳定性优化案例剖析>稳定性优化案例剖析</a><ul><li><a href=#数据不一致data-inconsistency><strong>数据不一致（Data Inconsistency）</strong></a></li><li><a href=#内存泄露oom><strong>内存泄露（OOM）</strong></a></li><li><a href=#存储层死锁mvcc-deadlock><strong>存储层死锁（Mvcc Deadlock）</strong></a></li><li><a href=#wal-crashpanic><strong>Wal crash（Panic）</strong></a></li><li><a href=#配额及限速quotaqos><strong>配额及限速（Quota&amp;QoS）</strong></a></li></ul></li><li><a href=#性能优化案例剖析>性能优化案例剖析</a><ul><li></li><li><a href=#启动耗时及查询key数量查询指定记录数性能优化><strong>启动耗时及查询key数量、查询指定记录数性能优化</strong></a></li><li><a href=#密码鉴权性能提升12倍><strong>密码鉴权性能提升12倍</strong></a></li></ul></li><li><a href=#总结>总结</a><ul><li></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h2 id=背景与挑战>背景与挑战
<a class=anchor href=#%e8%83%8c%e6%99%af%e4%b8%8e%e6%8c%91%e6%88%98>#</a></h2><p>随着腾讯自研上云及公有云用户的迅速增长，一方面，腾讯云容器服务TKE服务数量和核数大幅增长, 另一方面我们提供的容器服务类型（TKE托管及独立集群、EKS弹性集群、edge边缘计算集群、mesh服务网格、serverless knative）也越来越丰富。各类容器服务类型背后的核心都是K8s，K8s核心的存储etcd又统一由我们基于K8s构建的etcd平台进行管理。基于它我们目前管理了千级etcd集群，背后支撑了万级K8s集群。</p><p><strong>在万级K8s集群规模下的我们如何高效保障etcd集群的稳定性?</strong></p><p>etcd集群的稳定性风险又来自哪里？</p><p>我们通过基于业务场景、历史遗留问题、现网运营经验等进行稳定性风险模型分析，<strong>风险主要来自旧TKE etcd架构设计不合理、etcd稳定性、etcd性能部分场景无法满足业务、测试用例覆盖不足、变更管理不严谨、监控是否全面覆盖、隐患点是否能自动巡检发现、极端灾难故障数据安全是否能保障。</strong></p><p>前面所描述的etcd平台已经从架构设计上、变更管理上、监控及巡检、数据迁移、备份几个方面程度解决了我们管理的各类容器服务的etcd可扩展性、可运维性、可观测性以及数据安全性，因此<strong>本文将重点描述我们在万级K8s场景下面临的etcd内核稳定性及性能挑战</strong>，比如:</p><ul><li>数据不一致</li><li>内存泄露</li><li>死锁</li><li>进程Crash</li><li>大包请求导致etcd OOM及丢包</li><li>较大数据量场景下启动慢</li><li>鉴权及查询key数量、查询指定数量记录接口性能较差</li></ul><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011117394.png alt=image-20240301111728306></p><p>本文将简易描述我们是如何发现、分析、复现、解决以上问题及挑战，以及从以上过程中我们获得了哪些经验及教训，并将之应用到我们的各类容器服务存储稳定性保障中。</p><p>同时，<strong>我们将解决方案全部贡献、回馈给etcd开源社区， 截止目前我们贡献的30+ pr已全部合并到社区。腾讯云TKE etcd团队是etcd社区2020年上半年最活跃的贡献团队之一, 为etcd的发展贡献我们的一点力量, 在这过程中特别感谢社区AWS、Google、Ali等maintainer的支持与帮助。</strong></p><h2 id=稳定性优化案例剖析>稳定性优化案例剖析
<a class=anchor href=#%e7%a8%b3%e5%ae%9a%e6%80%a7%e4%bc%98%e5%8c%96%e6%a1%88%e4%be%8b%e5%89%96%e6%9e%90>#</a></h2><p>从GitLab误删主库丢失部分数据到GitHub数据不一致导致中断24小时，再到号称"不沉航母"的AWS S3故障数小时等，无一例外都是存储服务。稳定性对于一个存储服务、乃至一个公司的口碑而言至关重要，它决定着一个产品生与死。稳定性优化案例我们将从数据不一致的严重性、两个etcd数据不一致的bug、lease内存泄露、mvcc 死锁、wal crash方面阐述，我们是如何发现、分析、复现、解决以上case，并分享我们从每个case中的获得的收获和反思，从中汲取经验，防患于未然。</p><h3 id=数据不一致data-inconsistency><strong>数据不一致（Data Inconsistency）</strong>
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4data-inconsistency>#</a></h3><h5 id=谈到数据不一致导致的大故障就不得不详细提下github在18年一次因网络设备的例行维护工作导致的美国东海岸网络中心与东海岸主要数据中心之间的连接断开虽然网络的连通性在43秒内得以恢复但是短暂的中断引发了一系列事件最终导致github-24小时11分钟的服务降级部分功能不可用>谈到数据不一致导致的大故障，就不得不详细提下GitHub在18年一次因网络设备的例行维护工作导致的美国东海岸网络中心与东海岸主要数据中心之间的连接断开。虽然网络的连通性在43秒内得以恢复，但是短暂的中断引发了一系列事件，最终导致GitHub 24小时11分钟的服务降级，部分功能不可用。
<a class=anchor href=#%e8%b0%88%e5%88%b0%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e5%af%bc%e8%87%b4%e7%9a%84%e5%a4%a7%e6%95%85%e9%9a%9c%e5%b0%b1%e4%b8%8d%e5%be%97%e4%b8%8d%e8%af%a6%e7%bb%86%e6%8f%90%e4%b8%8bgithub%e5%9c%a818%e5%b9%b4%e4%b8%80%e6%ac%a1%e5%9b%a0%e7%bd%91%e7%bb%9c%e8%ae%be%e5%a4%87%e7%9a%84%e4%be%8b%e8%a1%8c%e7%bb%b4%e6%8a%a4%e5%b7%a5%e4%bd%9c%e5%af%bc%e8%87%b4%e7%9a%84%e7%be%8e%e5%9b%bd%e4%b8%9c%e6%b5%b7%e5%b2%b8%e7%bd%91%e7%bb%9c%e4%b8%ad%e5%bf%83%e4%b8%8e%e4%b8%9c%e6%b5%b7%e5%b2%b8%e4%b8%bb%e8%a6%81%e6%95%b0%e6%8d%ae%e4%b8%ad%e5%bf%83%e4%b9%8b%e9%97%b4%e7%9a%84%e8%bf%9e%e6%8e%a5%e6%96%ad%e5%bc%80%e8%99%bd%e7%84%b6%e7%bd%91%e7%bb%9c%e7%9a%84%e8%bf%9e%e9%80%9a%e6%80%a7%e5%9c%a843%e7%a7%92%e5%86%85%e5%be%97%e4%bb%a5%e6%81%a2%e5%a4%8d%e4%bd%86%e6%98%af%e7%9f%ad%e6%9a%82%e7%9a%84%e4%b8%ad%e6%96%ad%e5%bc%95%e5%8f%91%e4%ba%86%e4%b8%80%e7%b3%bb%e5%88%97%e4%ba%8b%e4%bb%b6%e6%9c%80%e7%bb%88%e5%af%bc%e8%87%b4github-24%e5%b0%8f%e6%97%b611%e5%88%86%e9%92%9f%e7%9a%84%e6%9c%8d%e5%8a%a1%e9%99%8d%e7%ba%a7%e9%83%a8%e5%88%86%e5%8a%9f%e8%83%bd%e4%b8%8d%e5%8f%af%e7%94%a8>#</a></h5><h5 id=github使用了大量的mysql集群存储github的meta-data如issueprpage等等同时做了东西海岸跨城级别的容灾故障核心原因是网络异常时github的mysql仲裁服务orchestrator进行了故障转移将写入数据定向到美国西海岸的mysql集群故障前primary在东海岸然而美国东海岸的mysql包含一小段写入尚未复制到美国西海岸集群同时故障转移后由于两个数据中心的集群现在都包含另一个数据中心中不存在的写入因此又无法安全地将主数据库故障转移回美国东海岸>GitHub使用了大量的MySQL集群存储GitHub的meta data,如issue、pr、page等等，同时做了东西海岸跨城级别的容灾。故障核心原因是网络异常时GitHub的MySQL仲裁服务Orchestrator进行了故障转移，将写入数据定向到美国西海岸的MySQL集群(故障前primary在东海岸)，然而美国东海岸的MySQL包含一小段写入，尚未复制到美国西海岸集群，同时故障转移后由于两个数据中心的集群现在都包含另一个数据中心中不存在的写入，因此又无法安全地将主数据库故障转移回美国东海岸。
<a class=anchor href=#github%e4%bd%bf%e7%94%a8%e4%ba%86%e5%a4%a7%e9%87%8f%e7%9a%84mysql%e9%9b%86%e7%be%a4%e5%ad%98%e5%82%a8github%e7%9a%84meta-data%e5%a6%82issueprpage%e7%ad%89%e7%ad%89%e5%90%8c%e6%97%b6%e5%81%9a%e4%ba%86%e4%b8%9c%e8%a5%bf%e6%b5%b7%e5%b2%b8%e8%b7%a8%e5%9f%8e%e7%ba%a7%e5%88%ab%e7%9a%84%e5%ae%b9%e7%81%be%e6%95%85%e9%9a%9c%e6%a0%b8%e5%bf%83%e5%8e%9f%e5%9b%a0%e6%98%af%e7%bd%91%e7%bb%9c%e5%bc%82%e5%b8%b8%e6%97%b6github%e7%9a%84mysql%e4%bb%b2%e8%a3%81%e6%9c%8d%e5%8a%a1orchestrator%e8%bf%9b%e8%a1%8c%e4%ba%86%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb%e5%b0%86%e5%86%99%e5%85%a5%e6%95%b0%e6%8d%ae%e5%ae%9a%e5%90%91%e5%88%b0%e7%be%8e%e5%9b%bd%e8%a5%bf%e6%b5%b7%e5%b2%b8%e7%9a%84mysql%e9%9b%86%e7%be%a4%e6%95%85%e9%9a%9c%e5%89%8dprimary%e5%9c%a8%e4%b8%9c%e6%b5%b7%e5%b2%b8%e7%84%b6%e8%80%8c%e7%be%8e%e5%9b%bd%e4%b8%9c%e6%b5%b7%e5%b2%b8%e7%9a%84mysql%e5%8c%85%e5%90%ab%e4%b8%80%e5%b0%8f%e6%ae%b5%e5%86%99%e5%85%a5%e5%b0%9a%e6%9c%aa%e5%a4%8d%e5%88%b6%e5%88%b0%e7%be%8e%e5%9b%bd%e8%a5%bf%e6%b5%b7%e5%b2%b8%e9%9b%86%e7%be%a4%e5%90%8c%e6%97%b6%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb%e5%90%8e%e7%94%b1%e4%ba%8e%e4%b8%a4%e4%b8%aa%e6%95%b0%e6%8d%ae%e4%b8%ad%e5%bf%83%e7%9a%84%e9%9b%86%e7%be%a4%e7%8e%b0%e5%9c%a8%e9%83%bd%e5%8c%85%e5%90%ab%e5%8f%a6%e4%b8%80%e4%b8%aa%e6%95%b0%e6%8d%ae%e4%b8%ad%e5%bf%83%e4%b8%ad%e4%b8%8d%e5%ad%98%e5%9c%a8%e7%9a%84%e5%86%99%e5%85%a5%e5%9b%a0%e6%ad%a4%e5%8f%88%e6%97%a0%e6%b3%95%e5%ae%89%e5%85%a8%e5%9c%b0%e5%b0%86%e4%b8%bb%e6%95%b0%e6%8d%ae%e5%ba%93%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb%e5%9b%9e%e7%be%8e%e5%9b%bd%e4%b8%9c%e6%b5%b7%e5%b2%b8>#</a></h5><h5 id=最终-为了保证保证用户数据不丢失github不得不以24小时的服务降级为代价来修复数据一致性>最终, 为了保证保证用户数据不丢失，GitHub不得不以24小时的服务降级为代价来修复数据一致性。
<a class=anchor href=#%e6%9c%80%e7%bb%88-%e4%b8%ba%e4%ba%86%e4%bf%9d%e8%af%81%e4%bf%9d%e8%af%81%e7%94%a8%e6%88%b7%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%a2%e5%a4%b1github%e4%b8%8d%e5%be%97%e4%b8%8d%e4%bb%a524%e5%b0%8f%e6%97%b6%e7%9a%84%e6%9c%8d%e5%8a%a1%e9%99%8d%e7%ba%a7%e4%b8%ba%e4%bb%a3%e4%bb%b7%e6%9d%a5%e4%bf%ae%e5%a4%8d%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4%e6%80%a7>#</a></h5><h5 id=数据不一致的故障严重性不言而喻然而etcd是基于raft协议实现的分布式高可靠存储系统我们也并未做跨城容灾按理数据不一致这种看起来高大上bug我们是很难遇到的然而梦想是美好的现实是残酷的我们不仅遇到了不可思议的数据不一致bug-还一踩就是两个一个是重启etcd有较低的概率触发一个是升级etcd版本时如果开启了鉴权在k8s场景下较大概率触发在详细讨论这两个bug前我们先看看在k8s场景下etcd数据不一致会导致哪些问题呢>数据不一致的故障严重性不言而喻，然而etcd是基于raft协议实现的分布式高可靠存储系统，我们也并未做跨城容灾，按理数据不一致这种看起来高大上bug我们是很难遇到的。然而梦想是美好的，现实是残酷的，我们不仅遇到了不可思议的数据不一致bug, 还一踩就是两个，一个是重启etcd有较低的概率触发，一个是升级etcd版本时如果开启了鉴权，在K8s场景下较大概率触发。在详细讨论这两个bug前，我们先看看在K8s场景下etcd数据不一致会导致哪些问题呢？
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e7%9a%84%e6%95%85%e9%9a%9c%e4%b8%a5%e9%87%8d%e6%80%a7%e4%b8%8d%e8%a8%80%e8%80%8c%e5%96%bb%e7%84%b6%e8%80%8cetcd%e6%98%af%e5%9f%ba%e4%ba%8eraft%e5%8d%8f%e8%ae%ae%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e9%ab%98%e5%8f%af%e9%9d%a0%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f%e6%88%91%e4%bb%ac%e4%b9%9f%e5%b9%b6%e6%9c%aa%e5%81%9a%e8%b7%a8%e5%9f%8e%e5%ae%b9%e7%81%be%e6%8c%89%e7%90%86%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e8%bf%99%e7%a7%8d%e7%9c%8b%e8%b5%b7%e6%9d%a5%e9%ab%98%e5%a4%a7%e4%b8%8abug%e6%88%91%e4%bb%ac%e6%98%af%e5%be%88%e9%9a%be%e9%81%87%e5%88%b0%e7%9a%84%e7%84%b6%e8%80%8c%e6%a2%a6%e6%83%b3%e6%98%af%e7%be%8e%e5%a5%bd%e7%9a%84%e7%8e%b0%e5%ae%9e%e6%98%af%e6%ae%8b%e9%85%b7%e7%9a%84%e6%88%91%e4%bb%ac%e4%b8%8d%e4%bb%85%e9%81%87%e5%88%b0%e4%ba%86%e4%b8%8d%e5%8f%af%e6%80%9d%e8%ae%ae%e7%9a%84%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4bug-%e8%bf%98%e4%b8%80%e8%b8%a9%e5%b0%b1%e6%98%af%e4%b8%a4%e4%b8%aa%e4%b8%80%e4%b8%aa%e6%98%af%e9%87%8d%e5%90%afetcd%e6%9c%89%e8%be%83%e4%bd%8e%e7%9a%84%e6%a6%82%e7%8e%87%e8%a7%a6%e5%8f%91%e4%b8%80%e4%b8%aa%e6%98%af%e5%8d%87%e7%ba%a7etcd%e7%89%88%e6%9c%ac%e6%97%b6%e5%a6%82%e6%9e%9c%e5%bc%80%e5%90%af%e4%ba%86%e9%89%b4%e6%9d%83%e5%9c%a8k8s%e5%9c%ba%e6%99%af%e4%b8%8b%e8%be%83%e5%a4%a7%e6%a6%82%e7%8e%87%e8%a7%a6%e5%8f%91%e5%9c%a8%e8%af%a6%e7%bb%86%e8%ae%a8%e8%ae%ba%e8%bf%99%e4%b8%a4%e4%b8%aabug%e5%89%8d%e6%88%91%e4%bb%ac%e5%85%88%e7%9c%8b%e7%9c%8b%e5%9c%a8k8s%e5%9c%ba%e6%99%af%e4%b8%8betcd%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e4%bc%9a%e5%af%bc%e8%87%b4%e5%93%aa%e4%ba%9b%e9%97%ae%e9%a2%98%e5%91%a2>#</a></h5><ul><li><h5 id=数据不一致最恐怖之处在于client写入是成功的但可能在部分节点读取到空或者是旧数据client无法感知到写入在部分节点是失败的和可能读到旧数据>数据不一致最恐怖之处在于client写入是成功的，但可能在部分节点读取到空或者是旧数据,client无法感知到写入在部分节点是失败的和可能读到旧数据
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e6%9c%80%e6%81%90%e6%80%96%e4%b9%8b%e5%a4%84%e5%9c%a8%e4%ba%8eclient%e5%86%99%e5%85%a5%e6%98%af%e6%88%90%e5%8a%9f%e7%9a%84%e4%bd%86%e5%8f%af%e8%83%bd%e5%9c%a8%e9%83%a8%e5%88%86%e8%8a%82%e7%82%b9%e8%af%bb%e5%8f%96%e5%88%b0%e7%a9%ba%e6%88%96%e8%80%85%e6%98%af%e6%97%a7%e6%95%b0%e6%8d%aeclient%e6%97%a0%e6%b3%95%e6%84%9f%e7%9f%a5%e5%88%b0%e5%86%99%e5%85%a5%e5%9c%a8%e9%83%a8%e5%88%86%e8%8a%82%e7%82%b9%e6%98%af%e5%a4%b1%e8%b4%a5%e7%9a%84%e5%92%8c%e5%8f%af%e8%83%bd%e8%af%bb%e5%88%b0%e6%97%a7%e6%95%b0%e6%8d%ae>#</a></h5></li><li><h5 id=读到空可能会导致业务node消失pod消失node上service路由规则消失一般场景下只会影响用户变更的服务>读到空可能会导致业务Node消失、Pod消失、Node上Service路由规则消失，一般场景下，只会影响用户变更的服务
<a class=anchor href=#%e8%af%bb%e5%88%b0%e7%a9%ba%e5%8f%af%e8%83%bd%e4%bc%9a%e5%af%bc%e8%87%b4%e4%b8%9a%e5%8a%a1node%e6%b6%88%e5%a4%b1pod%e6%b6%88%e5%a4%b1node%e4%b8%8aservice%e8%b7%af%e7%94%b1%e8%a7%84%e5%88%99%e6%b6%88%e5%a4%b1%e4%b8%80%e8%88%ac%e5%9c%ba%e6%99%af%e4%b8%8b%e5%8f%aa%e4%bc%9a%e5%bd%b1%e5%93%8d%e7%94%a8%e6%88%b7%e5%8f%98%e6%9b%b4%e7%9a%84%e6%9c%8d%e5%8a%a1>#</a></h5></li><li><h5 id=读到老数据会导致业务变更不生效如服务扩缩容service-rs替换变更镜像异常等待一般场景下只会影响用户变更的服务>读到老数据会导致业务变更不生效，如服务扩缩容、Service rs替换、变更镜像异常等待，一般场景下，只会影响用户变更的服务
<a class=anchor href=#%e8%af%bb%e5%88%b0%e8%80%81%e6%95%b0%e6%8d%ae%e4%bc%9a%e5%af%bc%e8%87%b4%e4%b8%9a%e5%8a%a1%e5%8f%98%e6%9b%b4%e4%b8%8d%e7%94%9f%e6%95%88%e5%a6%82%e6%9c%8d%e5%8a%a1%e6%89%a9%e7%bc%a9%e5%ae%b9service-rs%e6%9b%bf%e6%8d%a2%e5%8f%98%e6%9b%b4%e9%95%9c%e5%83%8f%e5%bc%82%e5%b8%b8%e7%ad%89%e5%be%85%e4%b8%80%e8%88%ac%e5%9c%ba%e6%99%af%e4%b8%8b%e5%8f%aa%e4%bc%9a%e5%bd%b1%e5%93%8d%e7%94%a8%e6%88%b7%e5%8f%98%e6%9b%b4%e7%9a%84%e6%9c%8d%e5%8a%a1>#</a></h5></li><li><h5 id=在etcd平台迁移场景下client无法感知到写入失败若校验数据一致性也无异常时校验时连接到了正常节点会导致迁移后整个集群全面故障apiserver连接到了异常节点用户的node部署的服务lb等会被全部删除严重影响用户业务>在etcd平台迁移场景下，client无法感知到写入失败，若校验数据一致性也无异常时（校验时连接到了正常节点），会导致迁移后整个集群全面故障（apiserver连接到了异常节点），用户的Node、部署的服务、lb等会被全部删除，严重影响用户业务
<a class=anchor href=#%e5%9c%a8etcd%e5%b9%b3%e5%8f%b0%e8%bf%81%e7%a7%bb%e5%9c%ba%e6%99%af%e4%b8%8bclient%e6%97%a0%e6%b3%95%e6%84%9f%e7%9f%a5%e5%88%b0%e5%86%99%e5%85%a5%e5%a4%b1%e8%b4%a5%e8%8b%a5%e6%a0%a1%e9%aa%8c%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4%e6%80%a7%e4%b9%9f%e6%97%a0%e5%bc%82%e5%b8%b8%e6%97%b6%e6%a0%a1%e9%aa%8c%e6%97%b6%e8%bf%9e%e6%8e%a5%e5%88%b0%e4%ba%86%e6%ad%a3%e5%b8%b8%e8%8a%82%e7%82%b9%e4%bc%9a%e5%af%bc%e8%87%b4%e8%bf%81%e7%a7%bb%e5%90%8e%e6%95%b4%e4%b8%aa%e9%9b%86%e7%be%a4%e5%85%a8%e9%9d%a2%e6%95%85%e9%9a%9capiserver%e8%bf%9e%e6%8e%a5%e5%88%b0%e4%ba%86%e5%bc%82%e5%b8%b8%e8%8a%82%e7%82%b9%e7%94%a8%e6%88%b7%e7%9a%84node%e9%83%a8%e7%bd%b2%e7%9a%84%e6%9c%8d%e5%8a%a1lb%e7%ad%89%e4%bc%9a%e8%a2%ab%e5%85%a8%e9%83%a8%e5%88%a0%e9%99%a4%e4%b8%a5%e9%87%8d%e5%bd%b1%e5%93%8d%e7%94%a8%e6%88%b7%e4%b8%9a%e5%8a%a1>#</a></h5></li></ul><h5 id=首先第一个不一致bug是重启etcd过程中遇到的人工尝试复现多次皆失败分析定位复现解决这个bug之路几经波折过程很有趣并充满挑战最终通过我对关键点增加debug日志编写chaos-monkey模拟各种异常场景边界条件实现复现成功最后的真凶竟然是一个授权接口在重启后重放导致鉴权版本号不一致然后放大导致多版本数据库不一致-部分节点无法写入新数据-影响所有v3版本的3年之久bug>首先第一个不一致bug是重启etcd过程中遇到的，人工尝试复现多次皆失败，分析、定位、复现、解决这个bug之路几经波折，过程很有趣并充满挑战，最终通过我对关键点增加debug日志，编写chaos monkey模拟各种异常场景、边界条件，实现复现成功。最后的真凶竟然是一个授权接口在重启后重放导致鉴权版本号不一致，然后放大导致多版本数据库不一致, 部分节点无法写入新数据, 影响所有v3版本的3年之久bug。
<a class=anchor href=#%e9%a6%96%e5%85%88%e7%ac%ac%e4%b8%80%e4%b8%aa%e4%b8%8d%e4%b8%80%e8%87%b4bug%e6%98%af%e9%87%8d%e5%90%afetcd%e8%bf%87%e7%a8%8b%e4%b8%ad%e9%81%87%e5%88%b0%e7%9a%84%e4%ba%ba%e5%b7%a5%e5%b0%9d%e8%af%95%e5%a4%8d%e7%8e%b0%e5%a4%9a%e6%ac%a1%e7%9a%86%e5%a4%b1%e8%b4%a5%e5%88%86%e6%9e%90%e5%ae%9a%e4%bd%8d%e5%a4%8d%e7%8e%b0%e8%a7%a3%e5%86%b3%e8%bf%99%e4%b8%aabug%e4%b9%8b%e8%b7%af%e5%87%a0%e7%bb%8f%e6%b3%a2%e6%8a%98%e8%bf%87%e7%a8%8b%e5%be%88%e6%9c%89%e8%b6%a3%e5%b9%b6%e5%85%85%e6%bb%a1%e6%8c%91%e6%88%98%e6%9c%80%e7%bb%88%e9%80%9a%e8%bf%87%e6%88%91%e5%af%b9%e5%85%b3%e9%94%ae%e7%82%b9%e5%a2%9e%e5%8a%a0debug%e6%97%a5%e5%bf%97%e7%bc%96%e5%86%99chaos-monkey%e6%a8%a1%e6%8b%9f%e5%90%84%e7%a7%8d%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%e8%be%b9%e7%95%8c%e6%9d%a1%e4%bb%b6%e5%ae%9e%e7%8e%b0%e5%a4%8d%e7%8e%b0%e6%88%90%e5%8a%9f%e6%9c%80%e5%90%8e%e7%9a%84%e7%9c%9f%e5%87%b6%e7%ab%9f%e7%84%b6%e6%98%af%e4%b8%80%e4%b8%aa%e6%8e%88%e6%9d%83%e6%8e%a5%e5%8f%a3%e5%9c%a8%e9%87%8d%e5%90%af%e5%90%8e%e9%87%8d%e6%94%be%e5%af%bc%e8%87%b4%e9%89%b4%e6%9d%83%e7%89%88%e6%9c%ac%e5%8f%b7%e4%b8%8d%e4%b8%80%e8%87%b4%e7%84%b6%e5%90%8e%e6%94%be%e5%a4%a7%e5%af%bc%e8%87%b4%e5%a4%9a%e7%89%88%e6%9c%ac%e6%95%b0%e6%8d%ae%e5%ba%93%e4%b8%8d%e4%b8%80%e8%87%b4-%e9%83%a8%e5%88%86%e8%8a%82%e7%82%b9%e6%97%a0%e6%b3%95%e5%86%99%e5%85%a5%e6%96%b0%e6%95%b0%e6%8d%ae-%e5%bd%b1%e5%93%8d%e6%89%80%e6%9c%89v3%e7%89%88%e6%9c%ac%e7%9a%843%e5%b9%b4%e4%b9%8b%e4%b9%85bug>#</a></h5><h5 id=随后我们提交若干个相关pr到社区-并全部合并了-最新的etcd-v3491v33222已修复此问题-同时google的jingyih也已经提k8s-issue和pr3将k8s-119的etcd-client及server版本升级到最新的v349此bug详细可参考超凡同学写的文章三年之久的-etcd3-数据不一致-bug-分析>随后我们提交若干个相关pr到社区, 并全部合并了, 最新的etcd <strong>v3.4.9</strong>[1]，<strong>v3.3.22</strong>[2]已修复此问题, 同时google的jingyih也已经提<strong>K8s issue和pr</strong>[3]将K8s 1.19的etcd client及server版本升级到最新的v3.4.9。此bug详细可参考超凡同学写的文章<a href="http://mp.weixin.qq.com/s?__biz=Mzg5NjA1MjkxNw==&amp;mid=2247483930&amp;idx=1&amp;sn=536046b272038b92a4ddf4ec30f8aad4&amp;chksm=c007b9c0f77030d6bf9a5038906dfb553b5a618d95578bfa65798ff1bf418c8dde216806a861&amp;scene=21#wechat_redirect">三年之久的 etcd3 数据不一致 bug 分析</a>。
<a class=anchor href=#%e9%9a%8f%e5%90%8e%e6%88%91%e4%bb%ac%e6%8f%90%e4%ba%a4%e8%8b%a5%e5%b9%b2%e4%b8%aa%e7%9b%b8%e5%85%b3pr%e5%88%b0%e7%a4%be%e5%8c%ba-%e5%b9%b6%e5%85%a8%e9%83%a8%e5%90%88%e5%b9%b6%e4%ba%86-%e6%9c%80%e6%96%b0%e7%9a%84etcd-v3491v33222%e5%b7%b2%e4%bf%ae%e5%a4%8d%e6%ad%a4%e9%97%ae%e9%a2%98-%e5%90%8c%e6%97%b6google%e7%9a%84jingyih%e4%b9%9f%e5%b7%b2%e7%bb%8f%e6%8f%90k8s-issue%e5%92%8cpr3%e5%b0%86k8s-119%e7%9a%84etcd-client%e5%8f%8aserver%e7%89%88%e6%9c%ac%e5%8d%87%e7%ba%a7%e5%88%b0%e6%9c%80%e6%96%b0%e7%9a%84v349%e6%ad%a4bug%e8%af%a6%e7%bb%86%e5%8f%af%e5%8f%82%e8%80%83%e8%b6%85%e5%87%a1%e5%90%8c%e5%ad%a6%e5%86%99%e7%9a%84%e6%96%87%e7%ab%a0%e4%b8%89%e5%b9%b4%e4%b9%8b%e4%b9%85%e7%9a%84-etcd3-%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4-bug-%e5%88%86%e6%9e%90>#</a></h5><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011117778.png alt=image-20240301111757719></p><h5 id=第二个不一致bug是在升级etcd过程中遇到的因etcd缺少关键的错误日志故障现场有效信息不多定位较困难只能通过分析代码和复现解决然而人工尝试复现多次皆失败于是我们通过chaos-monkey模拟client行为场景将测试环境所有k8s集群的etcd分配请求调度到我们复现集群以及对比32与33版本差异在可疑点如lease和txn模块增加大量的关键日志并对etcd-apply-request失败场景打印错误日志>第二个不一致bug是在升级etcd过程中遇到的，因etcd缺少关键的错误日志，故障现场有效信息不多，定位较困难，只能通过分析代码和复现解决。然而人工尝试复现多次皆失败，于是我们通过chaos monkey模拟client行为场景，将测试环境所有K8s集群的etcd分配请求调度到我们复现集群，以及对比3.2与3.3版本差异，在可疑点如lease和txn模块增加大量的关键日志，并对etcd apply request失败场景打印错误日志。
<a class=anchor href=#%e7%ac%ac%e4%ba%8c%e4%b8%aa%e4%b8%8d%e4%b8%80%e8%87%b4bug%e6%98%af%e5%9c%a8%e5%8d%87%e7%ba%a7etcd%e8%bf%87%e7%a8%8b%e4%b8%ad%e9%81%87%e5%88%b0%e7%9a%84%e5%9b%a0etcd%e7%bc%ba%e5%b0%91%e5%85%b3%e9%94%ae%e7%9a%84%e9%94%99%e8%af%af%e6%97%a5%e5%bf%97%e6%95%85%e9%9a%9c%e7%8e%b0%e5%9c%ba%e6%9c%89%e6%95%88%e4%bf%a1%e6%81%af%e4%b8%8d%e5%a4%9a%e5%ae%9a%e4%bd%8d%e8%be%83%e5%9b%b0%e9%9a%be%e5%8f%aa%e8%83%bd%e9%80%9a%e8%bf%87%e5%88%86%e6%9e%90%e4%bb%a3%e7%a0%81%e5%92%8c%e5%a4%8d%e7%8e%b0%e8%a7%a3%e5%86%b3%e7%84%b6%e8%80%8c%e4%ba%ba%e5%b7%a5%e5%b0%9d%e8%af%95%e5%a4%8d%e7%8e%b0%e5%a4%9a%e6%ac%a1%e7%9a%86%e5%a4%b1%e8%b4%a5%e4%ba%8e%e6%98%af%e6%88%91%e4%bb%ac%e9%80%9a%e8%bf%87chaos-monkey%e6%a8%a1%e6%8b%9fclient%e8%a1%8c%e4%b8%ba%e5%9c%ba%e6%99%af%e5%b0%86%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83%e6%89%80%e6%9c%89k8s%e9%9b%86%e7%be%a4%e7%9a%84etcd%e5%88%86%e9%85%8d%e8%af%b7%e6%b1%82%e8%b0%83%e5%ba%a6%e5%88%b0%e6%88%91%e4%bb%ac%e5%a4%8d%e7%8e%b0%e9%9b%86%e7%be%a4%e4%bb%a5%e5%8f%8a%e5%af%b9%e6%af%9432%e4%b8%8e33%e7%89%88%e6%9c%ac%e5%b7%ae%e5%bc%82%e5%9c%a8%e5%8f%af%e7%96%91%e7%82%b9%e5%a6%82lease%e5%92%8ctxn%e6%a8%a1%e5%9d%97%e5%a2%9e%e5%8a%a0%e5%a4%a7%e9%87%8f%e7%9a%84%e5%85%b3%e9%94%ae%e6%97%a5%e5%bf%97%e5%b9%b6%e5%af%b9etcd-apply-request%e5%a4%b1%e8%b4%a5%e5%9c%ba%e6%99%af%e6%89%93%e5%8d%b0%e9%94%99%e8%af%af%e6%97%a5%e5%bf%97>#</a></h5><h5 id=通过以上措施我们比较快就复现成功了-最终通过代码和日志发现是32版本与33版本在revoke-lease权限上出现了差异32无权限33需要写权限当lease过期的时候如果leader是32那么请求在33节点就会因无权限导致失败进而导致key数量不一致mvcc版本号不一致导致txn事务部分场景执行失败等最新的32分支也已合并我们提交的修复方案同时我们增加了etcd核心过程失败的错误日志以提高数据不一致问题定位效率完善了升级文档详细说明了lease会在此场景下引起数据不一致性避免大家再次采坑>通过以上措施，我们比较快就复现成功了, 最终通过代码和日志发现是3.2版本与3.3版本在revoke lease权限上出现了差异，3.2无权限，3.3需要写权限。当lease过期的时候，如果leader是3.2，那么请求在3.3节点就会因无权限导致失败，进而导致key数量不一致，mvcc版本号不一致，导致txn事务部分场景执行失败等。最新的3.2分支也已合并我们提交的修复方案，同时我们增加了etcd核心过程失败的错误日志以提高数据不一致问题定位效率，完善了升级文档，详细说明了lease会在此场景下引起数据不一致性，避免大家再次采坑。
<a class=anchor href=#%e9%80%9a%e8%bf%87%e4%bb%a5%e4%b8%8a%e6%8e%aa%e6%96%bd%e6%88%91%e4%bb%ac%e6%af%94%e8%be%83%e5%bf%ab%e5%b0%b1%e5%a4%8d%e7%8e%b0%e6%88%90%e5%8a%9f%e4%ba%86-%e6%9c%80%e7%bb%88%e9%80%9a%e8%bf%87%e4%bb%a3%e7%a0%81%e5%92%8c%e6%97%a5%e5%bf%97%e5%8f%91%e7%8e%b0%e6%98%af32%e7%89%88%e6%9c%ac%e4%b8%8e33%e7%89%88%e6%9c%ac%e5%9c%a8revoke-lease%e6%9d%83%e9%99%90%e4%b8%8a%e5%87%ba%e7%8e%b0%e4%ba%86%e5%b7%ae%e5%bc%8232%e6%97%a0%e6%9d%83%e9%99%9033%e9%9c%80%e8%a6%81%e5%86%99%e6%9d%83%e9%99%90%e5%bd%93lease%e8%bf%87%e6%9c%9f%e7%9a%84%e6%97%b6%e5%80%99%e5%a6%82%e6%9e%9cleader%e6%98%af32%e9%82%a3%e4%b9%88%e8%af%b7%e6%b1%82%e5%9c%a833%e8%8a%82%e7%82%b9%e5%b0%b1%e4%bc%9a%e5%9b%a0%e6%97%a0%e6%9d%83%e9%99%90%e5%af%bc%e8%87%b4%e5%a4%b1%e8%b4%a5%e8%bf%9b%e8%80%8c%e5%af%bc%e8%87%b4key%e6%95%b0%e9%87%8f%e4%b8%8d%e4%b8%80%e8%87%b4mvcc%e7%89%88%e6%9c%ac%e5%8f%b7%e4%b8%8d%e4%b8%80%e8%87%b4%e5%af%bc%e8%87%b4txn%e4%ba%8b%e5%8a%a1%e9%83%a8%e5%88%86%e5%9c%ba%e6%99%af%e6%89%a7%e8%a1%8c%e5%a4%b1%e8%b4%a5%e7%ad%89%e6%9c%80%e6%96%b0%e7%9a%8432%e5%88%86%e6%94%af%e4%b9%9f%e5%b7%b2%e5%90%88%e5%b9%b6%e6%88%91%e4%bb%ac%e6%8f%90%e4%ba%a4%e7%9a%84%e4%bf%ae%e5%a4%8d%e6%96%b9%e6%a1%88%e5%90%8c%e6%97%b6%e6%88%91%e4%bb%ac%e5%a2%9e%e5%8a%a0%e4%ba%86etcd%e6%a0%b8%e5%bf%83%e8%bf%87%e7%a8%8b%e5%a4%b1%e8%b4%a5%e7%9a%84%e9%94%99%e8%af%af%e6%97%a5%e5%bf%97%e4%bb%a5%e6%8f%90%e9%ab%98%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e9%97%ae%e9%a2%98%e5%ae%9a%e4%bd%8d%e6%95%88%e7%8e%87%e5%ae%8c%e5%96%84%e4%ba%86%e5%8d%87%e7%ba%a7%e6%96%87%e6%a1%a3%e8%af%a6%e7%bb%86%e8%af%b4%e6%98%8e%e4%ba%86lease%e4%bc%9a%e5%9c%a8%e6%ad%a4%e5%9c%ba%e6%99%af%e4%b8%8b%e5%bc%95%e8%b5%b7%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e6%80%a7%e9%81%bf%e5%85%8d%e5%a4%a7%e5%ae%b6%e5%86%8d%e6%ac%a1%e9%87%87%e5%9d%91>#</a></h5><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011118843.png alt=image-20240301111836792></p><h5 id=从这两个数据不一致bug中我们获得了以下收获和最佳实践>从这两个数据不一致bug中我们获得了以下收获和最佳实践:
<a class=anchor href=#%e4%bb%8e%e8%bf%99%e4%b8%a4%e4%b8%aa%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4bug%e4%b8%ad%e6%88%91%e4%bb%ac%e8%8e%b7%e5%be%97%e4%ba%86%e4%bb%a5%e4%b8%8b%e6%94%b6%e8%8e%b7%e5%92%8c%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h5><ul><li><h5 id=算法理论数据一致性不代表整体服务实现能保证数据一致性目前业界对于这种基于日志复制状态机实现的分布式存储系统没有一个核心的机制能保证raftwalmvccsnapshot等模块协作不出问题raft只能保证日志状态机的一致性不能保证应用层去执行这些日志对应的command都会成功>算法理论数据一致性，不代表整体服务实现能保证数据一致性，目前业界对于这种基于日志复制状态机实现的分布式存储系统，没有一个核心的机制能保证raft、wal、mvcc、snapshot等模块协作不出问题，raft只能保证日志状态机的一致性，不能保证应用层去执行这些日志对应的command都会成功
<a class=anchor href=#%e7%ae%97%e6%b3%95%e7%90%86%e8%ae%ba%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4%e6%80%a7%e4%b8%8d%e4%bb%a3%e8%a1%a8%e6%95%b4%e4%bd%93%e6%9c%8d%e5%8a%a1%e5%ae%9e%e7%8e%b0%e8%83%bd%e4%bf%9d%e8%af%81%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4%e6%80%a7%e7%9b%ae%e5%89%8d%e4%b8%9a%e7%95%8c%e5%af%b9%e4%ba%8e%e8%bf%99%e7%a7%8d%e5%9f%ba%e4%ba%8e%e6%97%a5%e5%bf%97%e5%a4%8d%e5%88%b6%e7%8a%b6%e6%80%81%e6%9c%ba%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f%e6%b2%a1%e6%9c%89%e4%b8%80%e4%b8%aa%e6%a0%b8%e5%bf%83%e7%9a%84%e6%9c%ba%e5%88%b6%e8%83%bd%e4%bf%9d%e8%af%81raftwalmvccsnapshot%e7%ad%89%e6%a8%a1%e5%9d%97%e5%8d%8f%e4%bd%9c%e4%b8%8d%e5%87%ba%e9%97%ae%e9%a2%98raft%e5%8f%aa%e8%83%bd%e4%bf%9d%e8%af%81%e6%97%a5%e5%bf%97%e7%8a%b6%e6%80%81%e6%9c%ba%e7%9a%84%e4%b8%80%e8%87%b4%e6%80%a7%e4%b8%8d%e8%83%bd%e4%bf%9d%e8%af%81%e5%ba%94%e7%94%a8%e5%b1%82%e5%8e%bb%e6%89%a7%e8%a1%8c%e8%bf%99%e4%ba%9b%e6%97%a5%e5%bf%97%e5%af%b9%e5%ba%94%e7%9a%84command%e9%83%bd%e4%bc%9a%e6%88%90%e5%8a%9f>#</a></h5></li><li><h5 id=etcd版本升级存在一定的风险需要仔细review代码评估是否存在不兼容的特性如若存在是否影响鉴权版本号及mvcc版本号若影响则升级过程中可能会导致数据不一致性同时一定要灰度变更现网集群>etcd版本升级存在一定的风险，需要仔细review代码评估是否存在不兼容的特性，如若存在是否影响鉴权版本号及mvcc版本号，若影响则升级过程中可能会导致数据不一致性，同时一定要灰度变更现网集群
<a class=anchor href=#etcd%e7%89%88%e6%9c%ac%e5%8d%87%e7%ba%a7%e5%ad%98%e5%9c%a8%e4%b8%80%e5%ae%9a%e7%9a%84%e9%a3%8e%e9%99%a9%e9%9c%80%e8%a6%81%e4%bb%94%e7%bb%86review%e4%bb%a3%e7%a0%81%e8%af%84%e4%bc%b0%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a8%e4%b8%8d%e5%85%bc%e5%ae%b9%e7%9a%84%e7%89%b9%e6%80%a7%e5%a6%82%e8%8b%a5%e5%ad%98%e5%9c%a8%e6%98%af%e5%90%a6%e5%bd%b1%e5%93%8d%e9%89%b4%e6%9d%83%e7%89%88%e6%9c%ac%e5%8f%b7%e5%8f%8amvcc%e7%89%88%e6%9c%ac%e5%8f%b7%e8%8b%a5%e5%bd%b1%e5%93%8d%e5%88%99%e5%8d%87%e7%ba%a7%e8%bf%87%e7%a8%8b%e4%b8%ad%e5%8f%af%e8%83%bd%e4%bc%9a%e5%af%bc%e8%87%b4%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e6%80%a7%e5%90%8c%e6%97%b6%e4%b8%80%e5%ae%9a%e8%a6%81%e7%81%b0%e5%ba%a6%e5%8f%98%e6%9b%b4%e7%8e%b0%e7%bd%91%e9%9b%86%e7%be%a4>#</a></h5></li><li><h5 id=对所有etcd集群增加了一致性巡检告警如revision差异监控key数量差异监控等>对所有etcd集群增加了一致性巡检告警，如revision差异监控、key数量差异监控等
<a class=anchor href=#%e5%af%b9%e6%89%80%e6%9c%89etcd%e9%9b%86%e7%be%a4%e5%a2%9e%e5%8a%a0%e4%ba%86%e4%b8%80%e8%87%b4%e6%80%a7%e5%b7%a1%e6%a3%80%e5%91%8a%e8%ad%a6%e5%a6%82revision%e5%b7%ae%e5%bc%82%e7%9b%91%e6%8e%a7key%e6%95%b0%e9%87%8f%e5%b7%ae%e5%bc%82%e7%9b%91%e6%8e%a7%e7%ad%89>#</a></h5></li><li><h5 id=定时对etcd集群数据进行备份再小概率的故障根据墨菲定律都可能会发生即便etcd本身虽具备完备的自动化测试单元测试集成测试e2e测试故障注入测试等但测试用例仍有不少场景无法覆盖我们需要为最坏的场景做准备如3个节点walsnapdb文件同时损坏降低极端情况下的损失-做到可用备份数据快速恢复>定时对etcd集群数据进行备份，再小概率的故障，根据墨菲定律都可能会发生，即便etcd本身虽具备完备的自动化测试(单元测试、集成测试、e2e测试、故障注入测试等)，但测试用例仍有不少场景无法覆盖，我们需要为最坏的场景做准备(如3个节点wal、snap、db文件同时损坏)，降低极端情况下的损失, 做到可用备份数据快速恢复
<a class=anchor href=#%e5%ae%9a%e6%97%b6%e5%af%b9etcd%e9%9b%86%e7%be%a4%e6%95%b0%e6%8d%ae%e8%bf%9b%e8%a1%8c%e5%a4%87%e4%bb%bd%e5%86%8d%e5%b0%8f%e6%a6%82%e7%8e%87%e7%9a%84%e6%95%85%e9%9a%9c%e6%a0%b9%e6%8d%ae%e5%a2%a8%e8%8f%b2%e5%ae%9a%e5%be%8b%e9%83%bd%e5%8f%af%e8%83%bd%e4%bc%9a%e5%8f%91%e7%94%9f%e5%8d%b3%e4%be%bfetcd%e6%9c%ac%e8%ba%ab%e8%99%bd%e5%85%b7%e5%a4%87%e5%ae%8c%e5%a4%87%e7%9a%84%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e9%9b%86%e6%88%90%e6%b5%8b%e8%af%95e2e%e6%b5%8b%e8%af%95%e6%95%85%e9%9a%9c%e6%b3%a8%e5%85%a5%e6%b5%8b%e8%af%95%e7%ad%89%e4%bd%86%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b%e4%bb%8d%e6%9c%89%e4%b8%8d%e5%b0%91%e5%9c%ba%e6%99%af%e6%97%a0%e6%b3%95%e8%a6%86%e7%9b%96%e6%88%91%e4%bb%ac%e9%9c%80%e8%a6%81%e4%b8%ba%e6%9c%80%e5%9d%8f%e7%9a%84%e5%9c%ba%e6%99%af%e5%81%9a%e5%87%86%e5%a4%87%e5%a6%823%e4%b8%aa%e8%8a%82%e7%82%b9walsnapdb%e6%96%87%e4%bb%b6%e5%90%8c%e6%97%b6%e6%8d%9f%e5%9d%8f%e9%99%8d%e4%bd%8e%e6%9e%81%e7%ab%af%e6%83%85%e5%86%b5%e4%b8%8b%e7%9a%84%e6%8d%9f%e5%a4%b1-%e5%81%9a%e5%88%b0%e5%8f%af%e7%94%a8%e5%a4%87%e4%bb%bd%e6%95%b0%e6%8d%ae%e5%bf%ab%e9%80%9f%e6%81%a2%e5%a4%8d>#</a></h5></li><li><h5 id=etcd-v344后的集群灰度开启data-corruption检测功能当集群出现不一致时拒绝集群写入读取及时止损控制不一致的数据范围>etcd v3.4.4后的集群灰度开启data corruption检测功能，当集群出现不一致时，拒绝集群写入、读取，及时止损，控制不一致的数据范围
<a class=anchor href=#etcd-v344%e5%90%8e%e7%9a%84%e9%9b%86%e7%be%a4%e7%81%b0%e5%ba%a6%e5%bc%80%e5%90%afdata-corruption%e6%a3%80%e6%b5%8b%e5%8a%9f%e8%83%bd%e5%bd%93%e9%9b%86%e7%be%a4%e5%87%ba%e7%8e%b0%e4%b8%8d%e4%b8%80%e8%87%b4%e6%97%b6%e6%8b%92%e7%bb%9d%e9%9b%86%e7%be%a4%e5%86%99%e5%85%a5%e8%af%bb%e5%8f%96%e5%8f%8a%e6%97%b6%e6%ad%a2%e6%8d%9f%e6%8e%a7%e5%88%b6%e4%b8%8d%e4%b8%80%e8%87%b4%e7%9a%84%e6%95%b0%e6%8d%ae%e8%8c%83%e5%9b%b4>#</a></h5></li><li><h5 id=继续完善我们的chaos-monkey和使用etcd本身的故障注入测试框架functional以协助我们验证压测新版本稳定性长时间持续跑复现隐藏极深的bug-降低线上采坑的概率>继续完善我们的chaos monkey和使用etcd本身的故障注入测试框架functional，以协助我们验证、压测新版本稳定性（长时间持续跑），复现隐藏极深的bug, 降低线上采坑的概率
<a class=anchor href=#%e7%bb%a7%e7%bb%ad%e5%ae%8c%e5%96%84%e6%88%91%e4%bb%ac%e7%9a%84chaos-monkey%e5%92%8c%e4%bd%bf%e7%94%a8etcd%e6%9c%ac%e8%ba%ab%e7%9a%84%e6%95%85%e9%9a%9c%e6%b3%a8%e5%85%a5%e6%b5%8b%e8%af%95%e6%a1%86%e6%9e%b6functional%e4%bb%a5%e5%8d%8f%e5%8a%a9%e6%88%91%e4%bb%ac%e9%aa%8c%e8%af%81%e5%8e%8b%e6%b5%8b%e6%96%b0%e7%89%88%e6%9c%ac%e7%a8%b3%e5%ae%9a%e6%80%a7%e9%95%bf%e6%97%b6%e9%97%b4%e6%8c%81%e7%bb%ad%e8%b7%91%e5%a4%8d%e7%8e%b0%e9%9a%90%e8%97%8f%e6%9e%81%e6%b7%b1%e7%9a%84bug-%e9%99%8d%e4%bd%8e%e7%ba%bf%e4%b8%8a%e9%87%87%e5%9d%91%e7%9a%84%e6%a6%82%e7%8e%87>#</a></h5></li></ul><h3 id=内存泄露oom><strong>内存泄露（OOM）</strong>
<a class=anchor href=#%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2oom>#</a></h3><h5 id=众所周知etcd是golang写的而golang自带垃圾回收机制也会内存泄露吗首先我们得搞清楚golang垃圾回收的原理它是通过后台运行一个守护线程监控各个对象的状态识别并且丢弃不再使用的对象来释放和重用资源若你迟迟未释放对象golang垃圾回收不是万能的不泄露才怪比如以下场景会导致内存泄露>众所周知etcd是golang写的，而golang自带垃圾回收机制也会内存泄露吗？首先我们得搞清楚golang垃圾回收的原理，它是通过后台运行一个守护线程，监控各个对象的状态，识别并且丢弃不再使用的对象来释放和重用资源，若你迟迟未释放对象，golang垃圾回收不是万能的，不泄露才怪。比如以下场景会导致内存泄露:
<a class=anchor href=#%e4%bc%97%e6%89%80%e5%91%a8%e7%9f%a5etcd%e6%98%afgolang%e5%86%99%e7%9a%84%e8%80%8cgolang%e8%87%aa%e5%b8%a6%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e6%9c%ba%e5%88%b6%e4%b9%9f%e4%bc%9a%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2%e5%90%97%e9%a6%96%e5%85%88%e6%88%91%e4%bb%ac%e5%be%97%e6%90%9e%e6%b8%85%e6%a5%9agolang%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e7%9a%84%e5%8e%9f%e7%90%86%e5%ae%83%e6%98%af%e9%80%9a%e8%bf%87%e5%90%8e%e5%8f%b0%e8%bf%90%e8%a1%8c%e4%b8%80%e4%b8%aa%e5%ae%88%e6%8a%a4%e7%ba%bf%e7%a8%8b%e7%9b%91%e6%8e%a7%e5%90%84%e4%b8%aa%e5%af%b9%e8%b1%a1%e7%9a%84%e7%8a%b6%e6%80%81%e8%af%86%e5%88%ab%e5%b9%b6%e4%b8%94%e4%b8%a2%e5%bc%83%e4%b8%8d%e5%86%8d%e4%bd%bf%e7%94%a8%e7%9a%84%e5%af%b9%e8%b1%a1%e6%9d%a5%e9%87%8a%e6%94%be%e5%92%8c%e9%87%8d%e7%94%a8%e8%b5%84%e6%ba%90%e8%8b%a5%e4%bd%a0%e8%bf%9f%e8%bf%9f%e6%9c%aa%e9%87%8a%e6%94%be%e5%af%b9%e8%b1%a1golang%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e4%b8%8d%e6%98%af%e4%b8%87%e8%83%bd%e7%9a%84%e4%b8%8d%e6%b3%84%e9%9c%b2%e6%89%8d%e6%80%aa%e6%af%94%e5%a6%82%e4%bb%a5%e4%b8%8b%e5%9c%ba%e6%99%af%e4%bc%9a%e5%af%bc%e8%87%b4%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2>#</a></h5><ul><li><h5 id=goroutine泄露>goroutine泄露
<a class=anchor href=#goroutine%e6%b3%84%e9%9c%b2>#</a></h5></li><li><h5 id=deferring-function-calls如for循环里面未使用匿名函数及时调用defer释放资源而是整个for循环结束才调用>deferring function calls（如for循环里面未使用匿名函数及时调用defer释放资源，而是整个for循环结束才调用）
<a class=anchor href=#deferring-function-calls%e5%a6%82for%e5%be%aa%e7%8e%af%e9%87%8c%e9%9d%a2%e6%9c%aa%e4%bd%bf%e7%94%a8%e5%8c%bf%e5%90%8d%e5%87%bd%e6%95%b0%e5%8f%8a%e6%97%b6%e8%b0%83%e7%94%a8defer%e9%87%8a%e6%94%be%e8%b5%84%e6%ba%90%e8%80%8c%e6%98%af%e6%95%b4%e4%b8%aafor%e5%be%aa%e7%8e%af%e7%bb%93%e6%9d%9f%e6%89%8d%e8%b0%83%e7%94%a8>#</a></h5></li><li><h5 id=获取stringslice中的一段导致长stringslice未释放会共享相同的底层内存块>获取string/slice中的一段导致长string/slice未释放（会共享相同的底层内存块）
<a class=anchor href=#%e8%8e%b7%e5%8f%96stringslice%e4%b8%ad%e7%9a%84%e4%b8%80%e6%ae%b5%e5%af%bc%e8%87%b4%e9%95%bfstringslice%e6%9c%aa%e9%87%8a%e6%94%be%e4%bc%9a%e5%85%b1%e4%ba%ab%e7%9b%b8%e5%90%8c%e7%9a%84%e5%ba%95%e5%b1%82%e5%86%85%e5%ad%98%e5%9d%97>#</a></h5></li><li><h5 id=应用内存数据结构管理不周导致内存泄露如为及时清理过期无效的数据>应用内存数据结构管理不周导致内存泄露（如为及时清理过期、无效的数据）
<a class=anchor href=#%e5%ba%94%e7%94%a8%e5%86%85%e5%ad%98%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e7%ae%a1%e7%90%86%e4%b8%8d%e5%91%a8%e5%af%bc%e8%87%b4%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2%e5%a6%82%e4%b8%ba%e5%8f%8a%e6%97%b6%e6%b8%85%e7%90%86%e8%bf%87%e6%9c%9f%e6%97%a0%e6%95%88%e7%9a%84%e6%95%b0%e6%8d%ae>#</a></h5></li></ul><h5 id=接下来看看我们遇到的这个etcd内存泄露属于哪种情况呢事情起源于3月末的一个周末起床后收到现网34集群大量内存超过安全阈值告警立刻排查了下发现以下现象>接下来看看我们遇到的这个etcd内存泄露属于哪种情况呢？事情起源于3月末的一个周末起床后收到现网3.4集群大量内存超过安全阈值告警，立刻排查了下发现以下现象:
<a class=anchor href=#%e6%8e%a5%e4%b8%8b%e6%9d%a5%e7%9c%8b%e7%9c%8b%e6%88%91%e4%bb%ac%e9%81%87%e5%88%b0%e7%9a%84%e8%bf%99%e4%b8%aaetcd%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2%e5%b1%9e%e4%ba%8e%e5%93%aa%e7%a7%8d%e6%83%85%e5%86%b5%e5%91%a2%e4%ba%8b%e6%83%85%e8%b5%b7%e6%ba%90%e4%ba%8e3%e6%9c%88%e6%9c%ab%e7%9a%84%e4%b8%80%e4%b8%aa%e5%91%a8%e6%9c%ab%e8%b5%b7%e5%ba%8a%e5%90%8e%e6%94%b6%e5%88%b0%e7%8e%b0%e7%bd%9134%e9%9b%86%e7%be%a4%e5%a4%a7%e9%87%8f%e5%86%85%e5%ad%98%e8%b6%85%e8%bf%87%e5%ae%89%e5%85%a8%e9%98%88%e5%80%bc%e5%91%8a%e8%ad%a6%e7%ab%8b%e5%88%bb%e6%8e%92%e6%9f%a5%e4%ba%86%e4%b8%8b%e5%8f%91%e7%8e%b0%e4%bb%a5%e4%b8%8b%e7%8e%b0%e8%b1%a1>#</a></h5><ul><li><h5 id=qps及流量监控显示都较低因此排除高负载及慢查询因素>QPS及流量监控显示都较低，因此排除高负载及慢查询因素
<a class=anchor href=#qps%e5%8f%8a%e6%b5%81%e9%87%8f%e7%9b%91%e6%8e%a7%e6%98%be%e7%a4%ba%e9%83%bd%e8%be%83%e4%bd%8e%e5%9b%a0%e6%ad%a4%e6%8e%92%e9%99%a4%e9%ab%98%e8%b4%9f%e8%bd%bd%e5%8f%8a%e6%85%a2%e6%9f%a5%e8%af%a2%e5%9b%a0%e7%b4%a0>#</a></h5></li><li><h5 id=一个集群3个节点只有两个follower节点出现异常leader-4gfollower节点高达23g>一个集群3个节点只有两个follower节点出现异常,leader 4g,follower节点高达23G
<a class=anchor href=#%e4%b8%80%e4%b8%aa%e9%9b%86%e7%be%a43%e4%b8%aa%e8%8a%82%e7%82%b9%e5%8f%aa%e6%9c%89%e4%b8%a4%e4%b8%aafollower%e8%8a%82%e7%82%b9%e5%87%ba%e7%8e%b0%e5%bc%82%e5%b8%b8leader-4gfollower%e8%8a%82%e7%82%b9%e9%ab%98%e8%be%be23g>#</a></h5></li><li><h5 id=goroutinefd等资源未出现泄漏>goroutine、fd等资源未出现泄漏
<a class=anchor href=#goroutinefd%e7%ad%89%e8%b5%84%e6%ba%90%e6%9c%aa%e5%87%ba%e7%8e%b0%e6%b3%84%e6%bc%8f>#</a></h5></li><li><h5 id=go-runtime-memstats指标显示各个节点申请的内存是一致的但是follower节点go_memstats_heap_release_bytes远低于leader节点说明某数据结构可能长期未释放>go runtime memstats指标显示各个节点申请的内存是一致的，但是follower节点go_memstats_heap_release_bytes远低于leader节点，说明某数据结构可能长期未释放
<a class=anchor href=#go-runtime-memstats%e6%8c%87%e6%a0%87%e6%98%be%e7%a4%ba%e5%90%84%e4%b8%aa%e8%8a%82%e7%82%b9%e7%94%b3%e8%af%b7%e7%9a%84%e5%86%85%e5%ad%98%e6%98%af%e4%b8%80%e8%87%b4%e7%9a%84%e4%bd%86%e6%98%affollower%e8%8a%82%e7%82%b9go_memstats_heap_release_bytes%e8%bf%9c%e4%bd%8e%e4%ba%8eleader%e8%8a%82%e7%82%b9%e8%af%b4%e6%98%8e%e6%9f%90%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e5%8f%af%e8%83%bd%e9%95%bf%e6%9c%9f%e6%9c%aa%e9%87%8a%e6%94%be>#</a></h5></li><li><h5 id=生产集群默认关闭了pprof开启pprof等待复现-并在社区上搜索释放有类似案例-结果发现有多个用户1月份就报了没引起社区重视使用场景和现象跟我们一样>生产集群默认关闭了pprof,开启pprof,等待复现, 并在社区上搜索释放有类似案例, 结果发现有多个用户1月份就报了，没引起社区重视，使用场景和现象跟我们一样
<a class=anchor href=#%e7%94%9f%e4%ba%a7%e9%9b%86%e7%be%a4%e9%bb%98%e8%ae%a4%e5%85%b3%e9%97%ad%e4%ba%86pprof%e5%bc%80%e5%90%afpprof%e7%ad%89%e5%be%85%e5%a4%8d%e7%8e%b0-%e5%b9%b6%e5%9c%a8%e7%a4%be%e5%8c%ba%e4%b8%8a%e6%90%9c%e7%b4%a2%e9%87%8a%e6%94%be%e6%9c%89%e7%b1%bb%e4%bc%bc%e6%a1%88%e4%be%8b-%e7%bb%93%e6%9e%9c%e5%8f%91%e7%8e%b0%e6%9c%89%e5%a4%9a%e4%b8%aa%e7%94%a8%e6%88%b71%e6%9c%88%e4%bb%bd%e5%b0%b1%e6%8a%a5%e4%ba%86%e6%b2%a1%e5%bc%95%e8%b5%b7%e7%a4%be%e5%8c%ba%e9%87%8d%e8%a7%86%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af%e5%92%8c%e7%8e%b0%e8%b1%a1%e8%b7%9f%e6%88%91%e4%bb%ac%e4%b8%80%e6%a0%b7>#</a></h5></li><li><h5 id=通过社区的heap堆栈快速定位到了是由于etcd通过一个heap堆来管理lease的状态当lease过期时需要从堆中删除但是follower节点却无此操作因此导致follower内存泄露-影响所有34版本>通过社区的heap堆栈快速定位到了是由于etcd通过一个heap堆来管理lease的状态，当lease过期时需要从堆中删除，但是follower节点却无此操作，因此导致follower内存泄露, 影响所有3.4版本。
<a class=anchor href=#%e9%80%9a%e8%bf%87%e7%a4%be%e5%8c%ba%e7%9a%84heap%e5%a0%86%e6%a0%88%e5%bf%ab%e9%80%9f%e5%ae%9a%e4%bd%8d%e5%88%b0%e4%ba%86%e6%98%af%e7%94%b1%e4%ba%8eetcd%e9%80%9a%e8%bf%87%e4%b8%80%e4%b8%aaheap%e5%a0%86%e6%9d%a5%e7%ae%a1%e7%90%86lease%e7%9a%84%e7%8a%b6%e6%80%81%e5%bd%93lease%e8%bf%87%e6%9c%9f%e6%97%b6%e9%9c%80%e8%a6%81%e4%bb%8e%e5%a0%86%e4%b8%ad%e5%88%a0%e9%99%a4%e4%bd%86%e6%98%affollower%e8%8a%82%e7%82%b9%e5%8d%b4%e6%97%a0%e6%ad%a4%e6%93%8d%e4%bd%9c%e5%9b%a0%e6%ad%a4%e5%af%bc%e8%87%b4follower%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2-%e5%bd%b1%e5%93%8d%e6%89%80%e6%9c%8934%e7%89%88%e6%9c%ac>#</a></h5></li><li><h5 id=问题分析清楚后我提交的修复方案是follower节点不需要维护lease-heap当leader发生选举时确保新的follower节点能重建lease-heap老的leader节点则清空lease-heap>问题分析清楚后，我提交的修复方案是follower节点不需要维护lease heap,当leader发生选举时确保新的follower节点能重建lease heap,老的leader节点则清空lease heap.
<a class=anchor href=#%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e6%b8%85%e6%a5%9a%e5%90%8e%e6%88%91%e6%8f%90%e4%ba%a4%e7%9a%84%e4%bf%ae%e5%a4%8d%e6%96%b9%e6%a1%88%e6%98%affollower%e8%8a%82%e7%82%b9%e4%b8%8d%e9%9c%80%e8%a6%81%e7%bb%b4%e6%8a%a4lease-heap%e5%bd%93leader%e5%8f%91%e7%94%9f%e9%80%89%e4%b8%be%e6%97%b6%e7%a1%ae%e4%bf%9d%e6%96%b0%e7%9a%84follower%e8%8a%82%e7%82%b9%e8%83%bd%e9%87%8d%e5%bb%balease-heap%e8%80%81%e7%9a%84leader%e8%8a%82%e7%82%b9%e5%88%99%e6%b8%85%e7%a9%balease-heap>#</a></h5></li></ul><p><strong>此内存泄露bug属于内存数据结构管理不周导致的，问题修复后，etcd社区立即发布了新的版本（v3.4.6+）以及K8s都立即进行了etcd版本更新。</strong></p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011119313.png alt=image-20240301111945250></p><p>从这个<strong>内存泄露bug中我们获得了以下收获和最佳实践:</strong></p><ul><li><h5 id=持续关注社区issue和pr-别人今天的问题很可能我们明天就会遇到>持续关注社区issue和pr, 别人今天的问题很可能我们明天就会遇到
<a class=anchor href=#%e6%8c%81%e7%bb%ad%e5%85%b3%e6%b3%a8%e7%a4%be%e5%8c%baissue%e5%92%8cpr-%e5%88%ab%e4%ba%ba%e4%bb%8a%e5%a4%a9%e7%9a%84%e9%97%ae%e9%a2%98%e5%be%88%e5%8f%af%e8%83%bd%e6%88%91%e4%bb%ac%e6%98%8e%e5%a4%a9%e5%b0%b1%e4%bc%9a%e9%81%87%e5%88%b0>#</a></h5></li><li><h5 id=etcd本身测试无法覆盖此类需要一定时间运行的才能触发的资源泄露bug我们内部需要加强此类场景的测试与压测>etcd本身测试无法覆盖此类需要一定时间运行的才能触发的资源泄露bug,我们内部需要加强此类场景的测试与压测
<a class=anchor href=#etcd%e6%9c%ac%e8%ba%ab%e6%b5%8b%e8%af%95%e6%97%a0%e6%b3%95%e8%a6%86%e7%9b%96%e6%ad%a4%e7%b1%bb%e9%9c%80%e8%a6%81%e4%b8%80%e5%ae%9a%e6%97%b6%e9%97%b4%e8%bf%90%e8%a1%8c%e7%9a%84%e6%89%8d%e8%83%bd%e8%a7%a6%e5%8f%91%e7%9a%84%e8%b5%84%e6%ba%90%e6%b3%84%e9%9c%b2bug%e6%88%91%e4%bb%ac%e5%86%85%e9%83%a8%e9%9c%80%e8%a6%81%e5%8a%a0%e5%bc%ba%e6%ad%a4%e7%b1%bb%e5%9c%ba%e6%99%af%e7%9a%84%e6%b5%8b%e8%af%95%e4%b8%8e%e5%8e%8b%e6%b5%8b>#</a></h5></li><li><h5 id=持续完善丰富etcd平台的各类监控告警机器留足足够的内存buffer以扛各种意外的因素>持续完善、丰富etcd平台的各类监控告警，机器留足足够的内存buffer以扛各种意外的因素。
<a class=anchor href=#%e6%8c%81%e7%bb%ad%e5%ae%8c%e5%96%84%e4%b8%b0%e5%af%8cetcd%e5%b9%b3%e5%8f%b0%e7%9a%84%e5%90%84%e7%b1%bb%e7%9b%91%e6%8e%a7%e5%91%8a%e8%ad%a6%e6%9c%ba%e5%99%a8%e7%95%99%e8%b6%b3%e8%b6%b3%e5%a4%9f%e7%9a%84%e5%86%85%e5%ad%98buffer%e4%bb%a5%e6%89%9b%e5%90%84%e7%a7%8d%e6%84%8f%e5%a4%96%e7%9a%84%e5%9b%a0%e7%b4%a0>#</a></h5></li></ul><h3 id=存储层死锁mvcc-deadlock><strong>存储层死锁（Mvcc Deadlock）</strong>
<a class=anchor href=#%e5%ad%98%e5%82%a8%e5%b1%82%e6%ad%bb%e9%94%81mvcc-deadlock>#</a></h3><h5 id=死锁是指两个或两个以上的goroutine的执行过程中由于竞争资源相互等待一般是锁或由于彼此通信chan引起而造成的一种程序卡死现象无法对外提供服务deadlock问题因为往往是在并发状态下资源竞争导致的-一般比较难定位和复现-死锁的性质决定着我们必须保留好分析现场否则分析复现及其困难>死锁是指两个或两个以上的goroutine的执行过程中，由于竞争资源相互等待（一般是锁）或由于彼此通信（chan引起）而造成的一种程序卡死现象，无法对外提供服务。deadlock问题因为往往是在并发状态下资源竞争导致的, 一般比较难定位和复现, 死锁的性质决定着我们必须保留好分析现场，否则分析、复现及其困难。
<a class=anchor href=#%e6%ad%bb%e9%94%81%e6%98%af%e6%8c%87%e4%b8%a4%e4%b8%aa%e6%88%96%e4%b8%a4%e4%b8%aa%e4%bb%a5%e4%b8%8a%e7%9a%84goroutine%e7%9a%84%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b%e4%b8%ad%e7%94%b1%e4%ba%8e%e7%ab%9e%e4%ba%89%e8%b5%84%e6%ba%90%e7%9b%b8%e4%ba%92%e7%ad%89%e5%be%85%e4%b8%80%e8%88%ac%e6%98%af%e9%94%81%e6%88%96%e7%94%b1%e4%ba%8e%e5%bd%bc%e6%ad%a4%e9%80%9a%e4%bf%a1chan%e5%bc%95%e8%b5%b7%e8%80%8c%e9%80%a0%e6%88%90%e7%9a%84%e4%b8%80%e7%a7%8d%e7%a8%8b%e5%ba%8f%e5%8d%a1%e6%ad%bb%e7%8e%b0%e8%b1%a1%e6%97%a0%e6%b3%95%e5%af%b9%e5%a4%96%e6%8f%90%e4%be%9b%e6%9c%8d%e5%8a%a1deadlock%e9%97%ae%e9%a2%98%e5%9b%a0%e4%b8%ba%e5%be%80%e5%be%80%e6%98%af%e5%9c%a8%e5%b9%b6%e5%8f%91%e7%8a%b6%e6%80%81%e4%b8%8b%e8%b5%84%e6%ba%90%e7%ab%9e%e4%ba%89%e5%af%bc%e8%87%b4%e7%9a%84-%e4%b8%80%e8%88%ac%e6%af%94%e8%be%83%e9%9a%be%e5%ae%9a%e4%bd%8d%e5%92%8c%e5%a4%8d%e7%8e%b0-%e6%ad%bb%e9%94%81%e7%9a%84%e6%80%a7%e8%b4%a8%e5%86%b3%e5%ae%9a%e7%9d%80%e6%88%91%e4%bb%ac%e5%bf%85%e9%a1%bb%e4%bf%9d%e7%95%99%e5%a5%bd%e5%88%86%e6%9e%90%e7%8e%b0%e5%9c%ba%e5%90%a6%e5%88%99%e5%88%86%e6%9e%90%e5%a4%8d%e7%8e%b0%e5%8f%8a%e5%85%b6%e5%9b%b0%e9%9a%be>#</a></h5><h5 id=那么我们是如何发现解决这个deadlock-bug呢问题起源于内部团队在压测etcd集群时发现一个节点突然故障了而且一直无法恢复无法正常获取key数等信息收到反馈后我通过分析卡住的etcd进程和查看监控得到以下结论>**那么我们是如何发现解决这个deadlock bug呢？**问题起源于内部团队在压测etcd集群时，发现一个节点突然故障了，而且一直无法恢复，无法正常获取key数等信息。收到反馈后，我通过分析卡住的etcd进程和查看监控，得到以下结论:
<a class=anchor href=#%e9%82%a3%e4%b9%88%e6%88%91%e4%bb%ac%e6%98%af%e5%a6%82%e4%bd%95%e5%8f%91%e7%8e%b0%e8%a7%a3%e5%86%b3%e8%bf%99%e4%b8%aadeadlock-bug%e5%91%a2%e9%97%ae%e9%a2%98%e8%b5%b7%e6%ba%90%e4%ba%8e%e5%86%85%e9%83%a8%e5%9b%a2%e9%98%9f%e5%9c%a8%e5%8e%8b%e6%b5%8betcd%e9%9b%86%e7%be%a4%e6%97%b6%e5%8f%91%e7%8e%b0%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e7%aa%81%e7%84%b6%e6%95%85%e9%9a%9c%e4%ba%86%e8%80%8c%e4%b8%94%e4%b8%80%e7%9b%b4%e6%97%a0%e6%b3%95%e6%81%a2%e5%a4%8d%e6%97%a0%e6%b3%95%e6%ad%a3%e5%b8%b8%e8%8e%b7%e5%8f%96key%e6%95%b0%e7%ad%89%e4%bf%a1%e6%81%af%e6%94%b6%e5%88%b0%e5%8f%8d%e9%a6%88%e5%90%8e%e6%88%91%e9%80%9a%e8%bf%87%e5%88%86%e6%9e%90%e5%8d%a1%e4%bd%8f%e7%9a%84etcd%e8%bf%9b%e7%a8%8b%e5%92%8c%e6%9f%a5%e7%9c%8b%e7%9b%91%e6%8e%a7%e5%be%97%e5%88%b0%e4%bb%a5%e4%b8%8b%e7%bb%93%e8%ae%ba>#</a></h5><ul><li><h5 id=不经过raft及mvcc模块的rpc请求如member-list可以正常返回结果而经过的rpc请求全部context-timeout>不经过raft及mvcc模块的rpc请求如member list可以正常返回结果，而经过的rpc请求全部context timeout
<a class=anchor href=#%e4%b8%8d%e7%bb%8f%e8%bf%87raft%e5%8f%8amvcc%e6%a8%a1%e5%9d%97%e7%9a%84rpc%e8%af%b7%e6%b1%82%e5%a6%82member-list%e5%8f%af%e4%bb%a5%e6%ad%a3%e5%b8%b8%e8%bf%94%e5%9b%9e%e7%bb%93%e6%9e%9c%e8%80%8c%e7%bb%8f%e8%bf%87%e7%9a%84rpc%e8%af%b7%e6%b1%82%e5%85%a8%e9%83%a8context-timeout>#</a></h5></li><li><h5 id=etcd-health健康监测返回503503的报错逻辑也是经过了raft及mvcc>etcd health健康监测返回503,503的报错逻辑也是经过了raft及mvcc
<a class=anchor href=#etcd-health%e5%81%a5%e5%ba%b7%e7%9b%91%e6%b5%8b%e8%bf%94%e5%9b%9e503503%e7%9a%84%e6%8a%a5%e9%94%99%e9%80%bb%e8%be%91%e4%b9%9f%e6%98%af%e7%bb%8f%e8%bf%87%e4%ba%86raft%e5%8f%8amvcc>#</a></h5></li><li><h5 id=通过tcpdump和netstat排除raft网络模块异常可疑目标缩小到mvcc>通过tcpdump和netstat排除raft网络模块异常，可疑目标缩小到mvcc
<a class=anchor href=#%e9%80%9a%e8%bf%87tcpdump%e5%92%8cnetstat%e6%8e%92%e9%99%a4raft%e7%bd%91%e7%bb%9c%e6%a8%a1%e5%9d%97%e5%bc%82%e5%b8%b8%e5%8f%af%e7%96%91%e7%9b%ae%e6%a0%87%e7%bc%a9%e5%b0%8f%e5%88%b0mvcc>#</a></h5></li><li><h5 id=分析日志发现卡住的时候因数据落后leader较多接收了一个数据快照然后执行更新快照的时候卡住了没有输出快照加载完毕的日志同时确认日志未丢失>分析日志发现卡住的时候因数据落后leader较多，接收了一个数据快照，然后执行更新快照的时候卡住了，没有输出快照加载完毕的日志，同时确认日志未丢失
<a class=anchor href=#%e5%88%86%e6%9e%90%e6%97%a5%e5%bf%97%e5%8f%91%e7%8e%b0%e5%8d%a1%e4%bd%8f%e7%9a%84%e6%97%b6%e5%80%99%e5%9b%a0%e6%95%b0%e6%8d%ae%e8%90%bd%e5%90%8eleader%e8%be%83%e5%a4%9a%e6%8e%a5%e6%94%b6%e4%ba%86%e4%b8%80%e4%b8%aa%e6%95%b0%e6%8d%ae%e5%bf%ab%e7%85%a7%e7%84%b6%e5%90%8e%e6%89%a7%e8%a1%8c%e6%9b%b4%e6%96%b0%e5%bf%ab%e7%85%a7%e7%9a%84%e6%97%b6%e5%80%99%e5%8d%a1%e4%bd%8f%e4%ba%86%e6%b2%a1%e6%9c%89%e8%be%93%e5%87%ba%e5%bf%ab%e7%85%a7%e5%8a%a0%e8%bd%bd%e5%ae%8c%e6%af%95%e7%9a%84%e6%97%a5%e5%bf%97%e5%90%8c%e6%97%b6%e7%a1%ae%e8%ae%a4%e6%97%a5%e5%bf%97%e6%9c%aa%e4%b8%a2%e5%a4%b1>#</a></h5></li><li><h5 id=排查快照加载的代码锁定几个可疑的锁和相关goroutine准备获取卡住的goroutine堆栈>排查快照加载的代码，锁定几个可疑的锁和相关goroutine,准备获取卡住的goroutine堆栈
<a class=anchor href=#%e6%8e%92%e6%9f%a5%e5%bf%ab%e7%85%a7%e5%8a%a0%e8%bd%bd%e7%9a%84%e4%bb%a3%e7%a0%81%e9%94%81%e5%ae%9a%e5%87%a0%e4%b8%aa%e5%8f%af%e7%96%91%e7%9a%84%e9%94%81%e5%92%8c%e7%9b%b8%e5%85%b3goroutine%e5%87%86%e5%a4%87%e8%8e%b7%e5%8f%96%e5%8d%a1%e4%bd%8f%e7%9a%84goroutine%e5%a0%86%e6%a0%88>#</a></h5></li><li><h5 id=通过kill或pprof获取goroutine堆栈根据goroutine卡住的时间和相关可疑点的代码逻辑成功找到两个相互竞争资源的goroutine其中一个正是执行快照加载重建db的主goroutine它获取了一把mvcc锁等待所有异步任务结束而另外一个goroutine则是执行历史key压缩任务当它收到stop的信号后立刻退出调用一个compactbarrier逻辑而这个逻辑又恰恰需要获取mvcc锁因此出现死锁堆栈如下>通过kill或pprof获取goroutine堆栈，根据goroutine卡住的时间和相关可疑点的代码逻辑，成功找到两个相互竞争资源的goroutine，其中一个正是执行快照加载,重建db的主goroutine，它获取了一把mvcc锁等待所有异步任务结束，而另外一个goroutine则是执行历史key压缩任务，当它收到stop的信号后，立刻退出，调用一个compactBarrier逻辑，而这个逻辑又恰恰需要获取mvcc锁，因此出现死锁，堆栈如下。
<a class=anchor href=#%e9%80%9a%e8%bf%87kill%e6%88%96pprof%e8%8e%b7%e5%8f%96goroutine%e5%a0%86%e6%a0%88%e6%a0%b9%e6%8d%aegoroutine%e5%8d%a1%e4%bd%8f%e7%9a%84%e6%97%b6%e9%97%b4%e5%92%8c%e7%9b%b8%e5%85%b3%e5%8f%af%e7%96%91%e7%82%b9%e7%9a%84%e4%bb%a3%e7%a0%81%e9%80%bb%e8%be%91%e6%88%90%e5%8a%9f%e6%89%be%e5%88%b0%e4%b8%a4%e4%b8%aa%e7%9b%b8%e4%ba%92%e7%ab%9e%e4%ba%89%e8%b5%84%e6%ba%90%e7%9a%84goroutine%e5%85%b6%e4%b8%ad%e4%b8%80%e4%b8%aa%e6%ad%a3%e6%98%af%e6%89%a7%e8%a1%8c%e5%bf%ab%e7%85%a7%e5%8a%a0%e8%bd%bd%e9%87%8d%e5%bb%badb%e7%9a%84%e4%b8%bbgoroutine%e5%ae%83%e8%8e%b7%e5%8f%96%e4%ba%86%e4%b8%80%e6%8a%8amvcc%e9%94%81%e7%ad%89%e5%be%85%e6%89%80%e6%9c%89%e5%bc%82%e6%ad%a5%e4%bb%bb%e5%8a%a1%e7%bb%93%e6%9d%9f%e8%80%8c%e5%8f%a6%e5%a4%96%e4%b8%80%e4%b8%aagoroutine%e5%88%99%e6%98%af%e6%89%a7%e8%a1%8c%e5%8e%86%e5%8f%b2key%e5%8e%8b%e7%bc%a9%e4%bb%bb%e5%8a%a1%e5%bd%93%e5%ae%83%e6%94%b6%e5%88%b0stop%e7%9a%84%e4%bf%a1%e5%8f%b7%e5%90%8e%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba%e8%b0%83%e7%94%a8%e4%b8%80%e4%b8%aacompactbarrier%e9%80%bb%e8%be%91%e8%80%8c%e8%bf%99%e4%b8%aa%e9%80%bb%e8%be%91%e5%8f%88%e6%81%b0%e6%81%b0%e9%9c%80%e8%a6%81%e8%8e%b7%e5%8f%96mvcc%e9%94%81%e5%9b%a0%e6%ad%a4%e5%87%ba%e7%8e%b0%e6%ad%bb%e9%94%81%e5%a0%86%e6%a0%88%e5%a6%82%e4%b8%8b>#</a></h5></li></ul><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011120792.png alt=image-20240301112007722></p><h5 id=这个bug也隐藏了很久影响所有etcd3版本在集群中写入量较大某落后的较多的节点执行了快照重建同时此时又恰恰在做历史版本压缩那就会触发我提交的修复pr目前也已经合并到33和34分支中新的版本已经发布v3321v348>这个bug也隐藏了很久，影响所有etcd3版本，在集群中写入量较大，某落后的较多的节点执行了快照重建，同时此时又恰恰在做历史版本压缩，那就会触发。我提交的修复PR目前也已经合并到3.3和3.4分支中，新的版本已经发布（v3.3.21+/v3.4.8+）。
<a class=anchor href=#%e8%bf%99%e4%b8%aabug%e4%b9%9f%e9%9a%90%e8%97%8f%e4%ba%86%e5%be%88%e4%b9%85%e5%bd%b1%e5%93%8d%e6%89%80%e6%9c%89etcd3%e7%89%88%e6%9c%ac%e5%9c%a8%e9%9b%86%e7%be%a4%e4%b8%ad%e5%86%99%e5%85%a5%e9%87%8f%e8%be%83%e5%a4%a7%e6%9f%90%e8%90%bd%e5%90%8e%e7%9a%84%e8%be%83%e5%a4%9a%e7%9a%84%e8%8a%82%e7%82%b9%e6%89%a7%e8%a1%8c%e4%ba%86%e5%bf%ab%e7%85%a7%e9%87%8d%e5%bb%ba%e5%90%8c%e6%97%b6%e6%ad%a4%e6%97%b6%e5%8f%88%e6%81%b0%e6%81%b0%e5%9c%a8%e5%81%9a%e5%8e%86%e5%8f%b2%e7%89%88%e6%9c%ac%e5%8e%8b%e7%bc%a9%e9%82%a3%e5%b0%b1%e4%bc%9a%e8%a7%a6%e5%8f%91%e6%88%91%e6%8f%90%e4%ba%a4%e7%9a%84%e4%bf%ae%e5%a4%8dpr%e7%9b%ae%e5%89%8d%e4%b9%9f%e5%b7%b2%e7%bb%8f%e5%90%88%e5%b9%b6%e5%88%b033%e5%92%8c34%e5%88%86%e6%94%af%e4%b8%ad%e6%96%b0%e7%9a%84%e7%89%88%e6%9c%ac%e5%b7%b2%e7%bb%8f%e5%8f%91%e5%b8%83v3321v348>#</a></h5><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011120851.png alt=image-20240301112024794></p><p>从这个<strong>死锁bug中我们获得了以下收获和最佳实践:</strong></p><ul><li><h5 id=多并发场景的组合的etcd自动化测试用例覆盖不到也较难构建因此也容易出bug-是否还有其他类似场景存在同样的问题需要参与社区一起继续提高etcd测试覆盖率etcd之前官方博客介绍一大半代码已经是测试代码才能避免此类问题>多并发场景的组合的etcd自动化测试用例覆盖不到，也较难构建，因此也容易出bug, 是否还有其他类似场景存在同样的问题？需要参与社区一起继续提高etcd测试覆盖率（etcd之前官方博客介绍一大半代码已经是测试代码），才能避免此类问题。
<a class=anchor href=#%e5%a4%9a%e5%b9%b6%e5%8f%91%e5%9c%ba%e6%99%af%e7%9a%84%e7%bb%84%e5%90%88%e7%9a%84etcd%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b%e8%a6%86%e7%9b%96%e4%b8%8d%e5%88%b0%e4%b9%9f%e8%be%83%e9%9a%be%e6%9e%84%e5%bb%ba%e5%9b%a0%e6%ad%a4%e4%b9%9f%e5%ae%b9%e6%98%93%e5%87%babug-%e6%98%af%e5%90%a6%e8%bf%98%e6%9c%89%e5%85%b6%e4%bb%96%e7%b1%bb%e4%bc%bc%e5%9c%ba%e6%99%af%e5%ad%98%e5%9c%a8%e5%90%8c%e6%a0%b7%e7%9a%84%e9%97%ae%e9%a2%98%e9%9c%80%e8%a6%81%e5%8f%82%e4%b8%8e%e7%a4%be%e5%8c%ba%e4%b8%80%e8%b5%b7%e7%bb%a7%e7%bb%ad%e6%8f%90%e9%ab%98etcd%e6%b5%8b%e8%af%95%e8%a6%86%e7%9b%96%e7%8e%87etcd%e4%b9%8b%e5%89%8d%e5%ae%98%e6%96%b9%e5%8d%9a%e5%ae%a2%e4%bb%8b%e7%bb%8d%e4%b8%80%e5%a4%a7%e5%8d%8a%e4%bb%a3%e7%a0%81%e5%b7%b2%e7%bb%8f%e6%98%af%e6%b5%8b%e8%af%95%e4%bb%a3%e7%a0%81%e6%89%8d%e8%83%bd%e9%81%bf%e5%85%8d%e6%ad%a4%e7%b1%bb%e9%97%ae%e9%a2%98>#</a></h5></li><li><h5 id=监控虽然能及时发现异常节点宕机但是死锁这种场景之前我们不会自动重启etcd因此需要完善我们的健康探测机制比如curl-health来判断服务是否正常出现死锁时能够保留堆栈自动重启恢复服务>监控虽然能及时发现异常节点宕机，但是死锁这种场景之前我们不会自动重启etcd,因此需要完善我们的健康探测机制（比如curl /health来判断服务是否正常），出现死锁时能够保留堆栈、自动重启恢复服务。
<a class=anchor href=#%e7%9b%91%e6%8e%a7%e8%99%bd%e7%84%b6%e8%83%bd%e5%8f%8a%e6%97%b6%e5%8f%91%e7%8e%b0%e5%bc%82%e5%b8%b8%e8%8a%82%e7%82%b9%e5%ae%95%e6%9c%ba%e4%bd%86%e6%98%af%e6%ad%bb%e9%94%81%e8%bf%99%e7%a7%8d%e5%9c%ba%e6%99%af%e4%b9%8b%e5%89%8d%e6%88%91%e4%bb%ac%e4%b8%8d%e4%bc%9a%e8%87%aa%e5%8a%a8%e9%87%8d%e5%90%afetcd%e5%9b%a0%e6%ad%a4%e9%9c%80%e8%a6%81%e5%ae%8c%e5%96%84%e6%88%91%e4%bb%ac%e7%9a%84%e5%81%a5%e5%ba%b7%e6%8e%a2%e6%b5%8b%e6%9c%ba%e5%88%b6%e6%af%94%e5%a6%82curl-health%e6%9d%a5%e5%88%a4%e6%96%ad%e6%9c%8d%e5%8a%a1%e6%98%af%e5%90%a6%e6%ad%a3%e5%b8%b8%e5%87%ba%e7%8e%b0%e6%ad%bb%e9%94%81%e6%97%b6%e8%83%bd%e5%a4%9f%e4%bf%9d%e7%95%99%e5%a0%86%e6%a0%88%e8%87%aa%e5%8a%a8%e9%87%8d%e5%90%af%e6%81%a2%e5%a4%8d%e6%9c%8d%e5%8a%a1>#</a></h5></li><li><h5 id=对于读请求较高的场景需评估3节点集群在一节点宕机后剩余两节点提供的qps容量是否能够支持业务若不够则考虑5节点集群>对于读请求较高的场景，需评估3节点集群在一节点宕机后，剩余两节点提供的QPS容量是否能够支持业务，若不够则考虑5节点集群。
<a class=anchor href=#%e5%af%b9%e4%ba%8e%e8%af%bb%e8%af%b7%e6%b1%82%e8%be%83%e9%ab%98%e7%9a%84%e5%9c%ba%e6%99%af%e9%9c%80%e8%af%84%e4%bc%b03%e8%8a%82%e7%82%b9%e9%9b%86%e7%be%a4%e5%9c%a8%e4%b8%80%e8%8a%82%e7%82%b9%e5%ae%95%e6%9c%ba%e5%90%8e%e5%89%a9%e4%bd%99%e4%b8%a4%e8%8a%82%e7%82%b9%e6%8f%90%e4%be%9b%e7%9a%84qps%e5%ae%b9%e9%87%8f%e6%98%af%e5%90%a6%e8%83%bd%e5%a4%9f%e6%94%af%e6%8c%81%e4%b8%9a%e5%8a%a1%e8%8b%a5%e4%b8%8d%e5%a4%9f%e5%88%99%e8%80%83%e8%99%915%e8%8a%82%e7%82%b9%e9%9b%86%e7%be%a4>#</a></h5></li></ul><h3 id=wal-crashpanic><strong>Wal crash（Panic）</strong>
<a class=anchor href=#wal-crashpanic>#</a></h3><h5 id=panic是指出现严重运行时和业务逻辑错误导致整个进程退出panic对于我们而言并不陌生我们在现网遇到过几次最早遭遇的不稳定性因素就是集群运行过程中panic了>panic是指出现严重运行时和业务逻辑错误，导致整个进程退出。panic对于我们而言并不陌生，我们在现网遇到过几次，最早遭遇的不稳定性因素就是集群运行过程中panic了。
<a class=anchor href=#panic%e6%98%af%e6%8c%87%e5%87%ba%e7%8e%b0%e4%b8%a5%e9%87%8d%e8%bf%90%e8%a1%8c%e6%97%b6%e5%92%8c%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e9%94%99%e8%af%af%e5%af%bc%e8%87%b4%e6%95%b4%e4%b8%aa%e8%bf%9b%e7%a8%8b%e9%80%80%e5%87%bapanic%e5%af%b9%e4%ba%8e%e6%88%91%e4%bb%ac%e8%80%8c%e8%a8%80%e5%b9%b6%e4%b8%8d%e9%99%8c%e7%94%9f%e6%88%91%e4%bb%ac%e5%9c%a8%e7%8e%b0%e7%bd%91%e9%81%87%e5%88%b0%e8%bf%87%e5%87%a0%e6%ac%a1%e6%9c%80%e6%97%a9%e9%81%ad%e9%81%87%e7%9a%84%e4%b8%8d%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9b%a0%e7%b4%a0%e5%b0%b1%e6%98%af%e9%9b%86%e7%be%a4%e8%bf%90%e8%a1%8c%e8%bf%87%e7%a8%8b%e4%b8%adpanic%e4%ba%86>#</a></h5><h5 id=虽说我们3节点的etcd集群是可以容忍一个节点故障但是crash瞬间对用户依然有影响甚至出现集群拨测连接失败>虽说我们3节点的etcd集群是可以容忍一个节点故障，但是crash瞬间对用户依然有影响，甚至出现集群拨测连接失败。
<a class=anchor href=#%e8%99%bd%e8%af%b4%e6%88%91%e4%bb%ac3%e8%8a%82%e7%82%b9%e7%9a%84etcd%e9%9b%86%e7%be%a4%e6%98%af%e5%8f%af%e4%bb%a5%e5%ae%b9%e5%bf%8d%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e6%95%85%e9%9a%9c%e4%bd%86%e6%98%afcrash%e7%9e%ac%e9%97%b4%e5%af%b9%e7%94%a8%e6%88%b7%e4%be%9d%e7%84%b6%e6%9c%89%e5%bd%b1%e5%93%8d%e7%94%9a%e8%87%b3%e5%87%ba%e7%8e%b0%e9%9b%86%e7%be%a4%e6%8b%a8%e6%b5%8b%e8%bf%9e%e6%8e%a5%e5%a4%b1%e8%b4%a5>#</a></h5><h5 id=我们遇到的第一个crash-bug是发现集群链接数较多的时候有一定的概率出现crash-然后根据堆栈查看社区已有人报grpc-crashissue4-原因是etcd依赖的组件grpc-go出现了grpc-crashpr5而最近我们遇到的crash-bug6是v348v3321新版本发布引起的这个版本跟我们有很大关系我们贡献了3个pr到这个版本占了一大半以上-那么这个crash-bug是如何产生以及复现呢会不会是我们自己的锅呢>我们遇到的第一个crash bug，是发现集群链接数较多的时候有一定的概率出现crash, 然后根据堆栈查看社区已有人报<strong>grpc crash(issue)</strong>[4], 原因是etcd依赖的组件grpc-go出现了<strong>grpc crash(pr)</strong>[5]，而最近我们遇到的<strong>crash bug</strong>[6]是v3.4.8/v3.3.21新版本发布引起的，这个版本跟我们有很大关系，**我们贡献了3个PR到这个版本，占了一大半以上, 那么这个crash bug是如何产生以及复现呢？**会不会是我们自己的锅呢？
<a class=anchor href=#%e6%88%91%e4%bb%ac%e9%81%87%e5%88%b0%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aacrash-bug%e6%98%af%e5%8f%91%e7%8e%b0%e9%9b%86%e7%be%a4%e9%93%be%e6%8e%a5%e6%95%b0%e8%be%83%e5%a4%9a%e7%9a%84%e6%97%b6%e5%80%99%e6%9c%89%e4%b8%80%e5%ae%9a%e7%9a%84%e6%a6%82%e7%8e%87%e5%87%ba%e7%8e%b0crash-%e7%84%b6%e5%90%8e%e6%a0%b9%e6%8d%ae%e5%a0%86%e6%a0%88%e6%9f%a5%e7%9c%8b%e7%a4%be%e5%8c%ba%e5%b7%b2%e6%9c%89%e4%ba%ba%e6%8a%a5grpc-crashissue4-%e5%8e%9f%e5%9b%a0%e6%98%afetcd%e4%be%9d%e8%b5%96%e7%9a%84%e7%bb%84%e4%bb%b6grpc-go%e5%87%ba%e7%8e%b0%e4%ba%86grpc-crashpr5%e8%80%8c%e6%9c%80%e8%bf%91%e6%88%91%e4%bb%ac%e9%81%87%e5%88%b0%e7%9a%84crash-bug6%e6%98%afv348v3321%e6%96%b0%e7%89%88%e6%9c%ac%e5%8f%91%e5%b8%83%e5%bc%95%e8%b5%b7%e7%9a%84%e8%bf%99%e4%b8%aa%e7%89%88%e6%9c%ac%e8%b7%9f%e6%88%91%e4%bb%ac%e6%9c%89%e5%be%88%e5%a4%a7%e5%85%b3%e7%b3%bb%e6%88%91%e4%bb%ac%e8%b4%a1%e7%8c%ae%e4%ba%863%e4%b8%aapr%e5%88%b0%e8%bf%99%e4%b8%aa%e7%89%88%e6%9c%ac%e5%8d%a0%e4%ba%86%e4%b8%80%e5%a4%a7%e5%8d%8a%e4%bb%a5%e4%b8%8a-%e9%82%a3%e4%b9%88%e8%bf%99%e4%b8%aacrash-bug%e6%98%af%e5%a6%82%e4%bd%95%e4%ba%a7%e7%94%9f%e4%bb%a5%e5%8f%8a%e5%a4%8d%e7%8e%b0%e5%91%a2%e4%bc%9a%e4%b8%8d%e4%bc%9a%e6%98%af%e6%88%91%e4%bb%ac%e8%87%aa%e5%b7%b1%e7%9a%84%e9%94%85%e5%91%a2>#</a></h5><ul><li><h5 id=首先crash报错是walpb-crc-mismatch-而我们并未提交代码修改wal相关逻辑排除自己的锅>首先crash报错是walpb: crc mismatch, 而我们并未提交代码修改wal相关逻辑，排除自己的锅。
<a class=anchor href=#%e9%a6%96%e5%85%88crash%e6%8a%a5%e9%94%99%e6%98%afwalpb-crc-mismatch-%e8%80%8c%e6%88%91%e4%bb%ac%e5%b9%b6%e6%9c%aa%e6%8f%90%e4%ba%a4%e4%bb%a3%e7%a0%81%e4%bf%ae%e6%94%b9wal%e7%9b%b8%e5%85%b3%e9%80%bb%e8%be%91%e6%8e%92%e9%99%a4%e8%87%aa%e5%b7%b1%e7%9a%84%e9%94%85>#</a></h5></li><li><h5 id=其次通过review新版本pr-目标锁定到google一位大佬在修复一个wal在写入成功后而snapshot写入失败导致的crash-bug的时候引入的>其次通过review新版本pr, 目标锁定到google一位大佬在修复一个wal在写入成功后，而snapshot写入失败导致的crash bug的时候引入的.
<a class=anchor href=#%e5%85%b6%e6%ac%a1%e9%80%9a%e8%bf%87review%e6%96%b0%e7%89%88%e6%9c%acpr-%e7%9b%ae%e6%a0%87%e9%94%81%e5%ae%9a%e5%88%b0google%e4%b8%80%e4%bd%8d%e5%a4%a7%e4%bd%ac%e5%9c%a8%e4%bf%ae%e5%a4%8d%e4%b8%80%e4%b8%aawal%e5%9c%a8%e5%86%99%e5%85%a5%e6%88%90%e5%8a%9f%e5%90%8e%e8%80%8csnapshot%e5%86%99%e5%85%a5%e5%a4%b1%e8%b4%a5%e5%af%bc%e8%87%b4%e7%9a%84crash-bug%e7%9a%84%e6%97%b6%e5%80%99%e5%bc%95%e5%85%a5%e7%9a%84>#</a></h5></li><li><h5 id=但是具体是怎么引入的pr中包含多个测试用例验证新加逻辑本地创建空集群和使用存量集群数据比较小也无法复现>但是具体是怎么引入的？pr中包含多个测试用例验证新加逻辑，本地创建空集群和使用存量集群(数据比较小)也无法复现.
<a class=anchor href=#%e4%bd%86%e6%98%af%e5%85%b7%e4%bd%93%e6%98%af%e6%80%8e%e4%b9%88%e5%bc%95%e5%85%a5%e7%9a%84pr%e4%b8%ad%e5%8c%85%e5%90%ab%e5%a4%9a%e4%b8%aa%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b%e9%aa%8c%e8%af%81%e6%96%b0%e5%8a%a0%e9%80%bb%e8%be%91%e6%9c%ac%e5%9c%b0%e5%88%9b%e5%bb%ba%e7%a9%ba%e9%9b%86%e7%be%a4%e5%92%8c%e4%bd%bf%e7%94%a8%e5%ad%98%e9%87%8f%e9%9b%86%e7%be%a4%e6%95%b0%e6%8d%ae%e6%af%94%e8%be%83%e5%b0%8f%e4%b9%9f%e6%97%a0%e6%b3%95%e5%a4%8d%e7%8e%b0>#</a></h5></li><li><h5 id=错误日志信息太少导致无法确定是哪个函数报的错因此首先还是加日志对各个可疑点增加错误日志后在我们测试集群随便找了个老节点替换版本然后很容易就复现了并确定是新加的验证快照文件合法性的锅那么它为什么会出现crc-mismatch呢-首先我们来简单了解下wal文件>错误日志信息太少，导致无法确定是哪个函数报的错，因此首先还是加日志，对各个可疑点增加错误日志后，在我们测试集群随便找了个老节点替换版本，然后很容易就复现了，并确定是新加的验证快照文件合法性的锅，那么它为什么会出现crc mismatch呢? 首先我们来简单了解下wal文件。
<a class=anchor href=#%e9%94%99%e8%af%af%e6%97%a5%e5%bf%97%e4%bf%a1%e6%81%af%e5%a4%aa%e5%b0%91%e5%af%bc%e8%87%b4%e6%97%a0%e6%b3%95%e7%a1%ae%e5%ae%9a%e6%98%af%e5%93%aa%e4%b8%aa%e5%87%bd%e6%95%b0%e6%8a%a5%e7%9a%84%e9%94%99%e5%9b%a0%e6%ad%a4%e9%a6%96%e5%85%88%e8%bf%98%e6%98%af%e5%8a%a0%e6%97%a5%e5%bf%97%e5%af%b9%e5%90%84%e4%b8%aa%e5%8f%af%e7%96%91%e7%82%b9%e5%a2%9e%e5%8a%a0%e9%94%99%e8%af%af%e6%97%a5%e5%bf%97%e5%90%8e%e5%9c%a8%e6%88%91%e4%bb%ac%e6%b5%8b%e8%af%95%e9%9b%86%e7%be%a4%e9%9a%8f%e4%be%bf%e6%89%be%e4%ba%86%e4%b8%aa%e8%80%81%e8%8a%82%e7%82%b9%e6%9b%bf%e6%8d%a2%e7%89%88%e6%9c%ac%e7%84%b6%e5%90%8e%e5%be%88%e5%ae%b9%e6%98%93%e5%b0%b1%e5%a4%8d%e7%8e%b0%e4%ba%86%e5%b9%b6%e7%a1%ae%e5%ae%9a%e6%98%af%e6%96%b0%e5%8a%a0%e7%9a%84%e9%aa%8c%e8%af%81%e5%bf%ab%e7%85%a7%e6%96%87%e4%bb%b6%e5%90%88%e6%b3%95%e6%80%a7%e7%9a%84%e9%94%85%e9%82%a3%e4%b9%88%e5%ae%83%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bc%9a%e5%87%ba%e7%8e%b0crc-mismatch%e5%91%a2-%e9%a6%96%e5%85%88%e6%88%91%e4%bb%ac%e6%9d%a5%e7%ae%80%e5%8d%95%e4%ba%86%e8%a7%a3%e4%b8%8bwal%e6%96%87%e4%bb%b6>#</a></h5></li><li><h5 id=etcd任何经过raft的模块的请求在写入etcd-mvcc-db前都会通过wal文件持久化若进程在apply-command过程中出现被杀等异常重启时可通过wal文件重放将数据补齐避免数据丢失wal文件包含各种请求命令如成员变化信息涉及key的各个操作等为了保证数据完整性未损坏wal每条记录都会计算其的crc32写入wal文件重启后解析wal文件过程中会校验记录的完整性如果数据出现损坏或crc32计算算法出现变化则会出现crc32-mismatch>etcd任何经过raft的模块的请求在写入etcd mvcc db前都会通过wal文件持久化，若进程在apply command过程中出现被杀等异常,重启时可通过wal文件重放将数据补齐，避免数据丢失。wal文件包含各种请求命令如成员变化信息、涉及key的各个操作等，为了保证数据完整性、未损坏，wal每条记录都会计算其的crc32，写入wal文件。重启后解析wal文件过程中，会校验记录的完整性，如果数据出现损坏或crc32计算算法出现变化则会出现crc32 mismatch.
<a class=anchor href=#etcd%e4%bb%bb%e4%bd%95%e7%bb%8f%e8%bf%87raft%e7%9a%84%e6%a8%a1%e5%9d%97%e7%9a%84%e8%af%b7%e6%b1%82%e5%9c%a8%e5%86%99%e5%85%a5etcd-mvcc-db%e5%89%8d%e9%83%bd%e4%bc%9a%e9%80%9a%e8%bf%87wal%e6%96%87%e4%bb%b6%e6%8c%81%e4%b9%85%e5%8c%96%e8%8b%a5%e8%bf%9b%e7%a8%8b%e5%9c%a8apply-command%e8%bf%87%e7%a8%8b%e4%b8%ad%e5%87%ba%e7%8e%b0%e8%a2%ab%e6%9d%80%e7%ad%89%e5%bc%82%e5%b8%b8%e9%87%8d%e5%90%af%e6%97%b6%e5%8f%af%e9%80%9a%e8%bf%87wal%e6%96%87%e4%bb%b6%e9%87%8d%e6%94%be%e5%b0%86%e6%95%b0%e6%8d%ae%e8%a1%a5%e9%bd%90%e9%81%bf%e5%85%8d%e6%95%b0%e6%8d%ae%e4%b8%a2%e5%a4%b1wal%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e5%90%84%e7%a7%8d%e8%af%b7%e6%b1%82%e5%91%bd%e4%bb%a4%e5%a6%82%e6%88%90%e5%91%98%e5%8f%98%e5%8c%96%e4%bf%a1%e6%81%af%e6%b6%89%e5%8f%8akey%e7%9a%84%e5%90%84%e4%b8%aa%e6%93%8d%e4%bd%9c%e7%ad%89%e4%b8%ba%e4%ba%86%e4%bf%9d%e8%af%81%e6%95%b0%e6%8d%ae%e5%ae%8c%e6%95%b4%e6%80%a7%e6%9c%aa%e6%8d%9f%e5%9d%8fwal%e6%af%8f%e6%9d%a1%e8%ae%b0%e5%bd%95%e9%83%bd%e4%bc%9a%e8%ae%a1%e7%ae%97%e5%85%b6%e7%9a%84crc32%e5%86%99%e5%85%a5wal%e6%96%87%e4%bb%b6%e9%87%8d%e5%90%af%e5%90%8e%e8%a7%a3%e6%9e%90wal%e6%96%87%e4%bb%b6%e8%bf%87%e7%a8%8b%e4%b8%ad%e4%bc%9a%e6%a0%a1%e9%aa%8c%e8%ae%b0%e5%bd%95%e7%9a%84%e5%ae%8c%e6%95%b4%e6%80%a7%e5%a6%82%e6%9e%9c%e6%95%b0%e6%8d%ae%e5%87%ba%e7%8e%b0%e6%8d%9f%e5%9d%8f%e6%88%96crc32%e8%ae%a1%e7%ae%97%e7%ae%97%e6%b3%95%e5%87%ba%e7%8e%b0%e5%8f%98%e5%8c%96%e5%88%99%e4%bc%9a%e5%87%ba%e7%8e%b0crc32-mismatch>#</a></h5></li><li><h5 id=硬盘及文件系统并未出现异常排除了数据损坏经过深入排查crc32算法的计算发现是新增逻辑未处理crc32类型的数据记录它会影响crc32算法的值导致出现差异而且只有在当etcd集群创建产生后的第一个wal文件被回收才会触发因此对存量运行一段时间的集群100复现>硬盘及文件系统并未出现异常，排除了数据损坏，经过深入排查crc32算法的计算，发现是新增逻辑未处理crc32类型的数据记录，它会影响crc32算法的值，导致出现差异，而且只有在当etcd集群创建产生后的第一个wal文件被回收才会触发，因此对存量运行一段时间的集群，100%复现。
<a class=anchor href=#%e7%a1%ac%e7%9b%98%e5%8f%8a%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e5%b9%b6%e6%9c%aa%e5%87%ba%e7%8e%b0%e5%bc%82%e5%b8%b8%e6%8e%92%e9%99%a4%e4%ba%86%e6%95%b0%e6%8d%ae%e6%8d%9f%e5%9d%8f%e7%bb%8f%e8%bf%87%e6%b7%b1%e5%85%a5%e6%8e%92%e6%9f%a5crc32%e7%ae%97%e6%b3%95%e7%9a%84%e8%ae%a1%e7%ae%97%e5%8f%91%e7%8e%b0%e6%98%af%e6%96%b0%e5%a2%9e%e9%80%bb%e8%be%91%e6%9c%aa%e5%a4%84%e7%90%86crc32%e7%b1%bb%e5%9e%8b%e7%9a%84%e6%95%b0%e6%8d%ae%e8%ae%b0%e5%bd%95%e5%ae%83%e4%bc%9a%e5%bd%b1%e5%93%8dcrc32%e7%ae%97%e6%b3%95%e7%9a%84%e5%80%bc%e5%af%bc%e8%87%b4%e5%87%ba%e7%8e%b0%e5%b7%ae%e5%bc%82%e8%80%8c%e4%b8%94%e5%8f%aa%e6%9c%89%e5%9c%a8%e5%bd%93etcd%e9%9b%86%e7%be%a4%e5%88%9b%e5%bb%ba%e4%ba%a7%e7%94%9f%e5%90%8e%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aawal%e6%96%87%e4%bb%b6%e8%a2%ab%e5%9b%9e%e6%94%b6%e6%89%8d%e4%bc%9a%e8%a7%a6%e5%8f%91%e5%9b%a0%e6%ad%a4%e5%af%b9%e5%ad%98%e9%87%8f%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e7%9a%84%e9%9b%86%e7%be%a4100%e5%a4%8d%e7%8e%b0>#</a></h5></li><li><h5 id=解决方案就是通过增加crc32算法的处理逻辑以及增加单元测试覆盖wal文件被回收的场景社区已合并并发布了新的34和33版本v349v3322>解决方案就是通过增加crc32算法的处理逻辑以及增加单元测试覆盖wal文件被回收的场景，社区已合并并发布了新的3.4和3.3版本(v3.4.9/v3.3.22).
<a class=anchor href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e5%b0%b1%e6%98%af%e9%80%9a%e8%bf%87%e5%a2%9e%e5%8a%a0crc32%e7%ae%97%e6%b3%95%e7%9a%84%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91%e4%bb%a5%e5%8f%8a%e5%a2%9e%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e8%a6%86%e7%9b%96wal%e6%96%87%e4%bb%b6%e8%a2%ab%e5%9b%9e%e6%94%b6%e7%9a%84%e5%9c%ba%e6%99%af%e7%a4%be%e5%8c%ba%e5%b7%b2%e5%90%88%e5%b9%b6%e5%b9%b6%e5%8f%91%e5%b8%83%e4%ba%86%e6%96%b0%e7%9a%8434%e5%92%8c33%e7%89%88%e6%9c%acv349v3322>#</a></h5></li></ul><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011120756.png alt=image-20240301112048706></p><h5 id=虽然这个bug是社区用户反馈的但从这个crash-bug中我们获得了以下收获和最佳实践>虽然这个bug是社区用户反馈的，但从这个<strong>crash bug中我们获得了以下收获和最佳实践:</strong>
<a class=anchor href=#%e8%99%bd%e7%84%b6%e8%bf%99%e4%b8%aabug%e6%98%af%e7%a4%be%e5%8c%ba%e7%94%a8%e6%88%b7%e5%8f%8d%e9%a6%88%e7%9a%84%e4%bd%86%e4%bb%8e%e8%bf%99%e4%b8%aacrash-bug%e4%b8%ad%e6%88%91%e4%bb%ac%e8%8e%b7%e5%be%97%e4%ba%86%e4%bb%a5%e4%b8%8b%e6%94%b6%e8%8e%b7%e5%92%8c%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h5><ul><li><h5 id=单元测试用例非常有价值然而编写完备的单元测试用例并不容易需要考虑各类场景>单元测试用例非常有价值，然而编写完备的单元测试用例并不容易，需要考虑各类场景。
<a class=anchor href=#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b%e9%9d%9e%e5%b8%b8%e6%9c%89%e4%bb%b7%e5%80%bc%e7%84%b6%e8%80%8c%e7%bc%96%e5%86%99%e5%ae%8c%e5%a4%87%e7%9a%84%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b%e5%b9%b6%e4%b8%8d%e5%ae%b9%e6%98%93%e9%9c%80%e8%a6%81%e8%80%83%e8%99%91%e5%90%84%e7%b1%bb%e5%9c%ba%e6%99%af>#</a></h5></li><li><h5 id=etcd社区对存量集群升级各版本之间兼容性测试用例几乎是0需要大家一起来为其舔砖加瓦让测试用例覆盖更多场景>etcd社区对存量集群升级、各版本之间兼容性测试用例几乎是0，需要大家一起来为其舔砖加瓦，让测试用例覆盖更多场景。
<a class=anchor href=#etcd%e7%a4%be%e5%8c%ba%e5%af%b9%e5%ad%98%e9%87%8f%e9%9b%86%e7%be%a4%e5%8d%87%e7%ba%a7%e5%90%84%e7%89%88%e6%9c%ac%e4%b9%8b%e9%97%b4%e5%85%bc%e5%ae%b9%e6%80%a7%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b%e5%87%a0%e4%b9%8e%e6%98%af0%e9%9c%80%e8%a6%81%e5%a4%a7%e5%ae%b6%e4%b8%80%e8%b5%b7%e6%9d%a5%e4%b8%ba%e5%85%b6%e8%88%94%e7%a0%96%e5%8a%a0%e7%93%a6%e8%ae%a9%e6%b5%8b%e8%af%95%e7%94%a8%e4%be%8b%e8%a6%86%e7%9b%96%e6%9b%b4%e5%a4%9a%e5%9c%ba%e6%99%af>#</a></h5></li><li><h5 id=新版本上线内部流程标准化自动化-如测试环境压测混沌测试不同版本性能对比优先在非核心场景使用如event灰度上线等流程必不可少>新版本上线内部流程标准化、自动化, 如测试环境压测、混沌测试、不同版本性能对比、优先在非核心场景使用(如event)、灰度上线等流程必不可少。
<a class=anchor href=#%e6%96%b0%e7%89%88%e6%9c%ac%e4%b8%8a%e7%ba%bf%e5%86%85%e9%83%a8%e6%b5%81%e7%a8%8b%e6%a0%87%e5%87%86%e5%8c%96%e8%87%aa%e5%8a%a8%e5%8c%96-%e5%a6%82%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83%e5%8e%8b%e6%b5%8b%e6%b7%b7%e6%b2%8c%e6%b5%8b%e8%af%95%e4%b8%8d%e5%90%8c%e7%89%88%e6%9c%ac%e6%80%a7%e8%83%bd%e5%af%b9%e6%af%94%e4%bc%98%e5%85%88%e5%9c%a8%e9%9d%9e%e6%a0%b8%e5%bf%83%e5%9c%ba%e6%99%af%e4%bd%bf%e7%94%a8%e5%a6%82event%e7%81%b0%e5%ba%a6%e4%b8%8a%e7%ba%bf%e7%ad%89%e6%b5%81%e7%a8%8b%e5%bf%85%e4%b8%8d%e5%8f%af%e5%b0%91>#</a></h5></li></ul><h3 id=配额及限速quotaqos><strong>配额及限速（Quota&amp;QoS）</strong>
<a class=anchor href=#%e9%85%8d%e9%a2%9d%e5%8f%8a%e9%99%90%e9%80%9fquotaqos>#</a></h3><h5 id=etcd面对一些大数据量的查询expensive-read和写入操作时expensive-write如全key遍历full-keyspace-fetch大量event查询-list-all-pod-configmap写入等会消耗大量的cpu内存带宽资源极其容易导致过载乃至雪崩>etcd面对一些大数据量的查询（expensive read）和写入操作时（expensive write），如全key遍历（full keyspace fetch）、大量event查询, list all Pod, configmap写入等会消耗大量的cpu、内存、带宽资源，极其容易导致过载，乃至雪崩。
<a class=anchor href=#etcd%e9%9d%a2%e5%af%b9%e4%b8%80%e4%ba%9b%e5%a4%a7%e6%95%b0%e6%8d%ae%e9%87%8f%e7%9a%84%e6%9f%a5%e8%af%a2expensive-read%e5%92%8c%e5%86%99%e5%85%a5%e6%93%8d%e4%bd%9c%e6%97%b6expensive-write%e5%a6%82%e5%85%a8key%e9%81%8d%e5%8e%86full-keyspace-fetch%e5%a4%a7%e9%87%8fevent%e6%9f%a5%e8%af%a2-list-all-pod-configmap%e5%86%99%e5%85%a5%e7%ad%89%e4%bc%9a%e6%b6%88%e8%80%97%e5%a4%a7%e9%87%8f%e7%9a%84cpu%e5%86%85%e5%ad%98%e5%b8%a6%e5%ae%bd%e8%b5%84%e6%ba%90%e6%9e%81%e5%85%b6%e5%ae%b9%e6%98%93%e5%af%bc%e8%87%b4%e8%bf%87%e8%bd%bd%e4%b9%83%e8%87%b3%e9%9b%aa%e5%b4%a9>#</a></h5><h5 id=然而etcd目前只有一个极其简单的限速保护当etcd的commited-index大于applied-index的阈值大于5000时会拒绝一切请求返回too-many-request其缺陷很明显无法精确的对expensive-readwrite进行限速无法有效防止集群过载不可用>然而，etcd目前只有一个极其简单的限速保护，<strong>当etcd的commited index大于applied index的阈值大于5000时，会拒绝一切请求，返回Too Many Request，其缺陷很明显，无法精确的对expensive read/write进行限速，无法有效防止集群过载不可用。</strong>
<a class=anchor href=#%e7%84%b6%e8%80%8cetcd%e7%9b%ae%e5%89%8d%e5%8f%aa%e6%9c%89%e4%b8%80%e4%b8%aa%e6%9e%81%e5%85%b6%e7%ae%80%e5%8d%95%e7%9a%84%e9%99%90%e9%80%9f%e4%bf%9d%e6%8a%a4%e5%bd%93etcd%e7%9a%84commited-index%e5%a4%a7%e4%ba%8eapplied-index%e7%9a%84%e9%98%88%e5%80%bc%e5%a4%a7%e4%ba%8e5000%e6%97%b6%e4%bc%9a%e6%8b%92%e7%bb%9d%e4%b8%80%e5%88%87%e8%af%b7%e6%b1%82%e8%bf%94%e5%9b%9etoo-many-request%e5%85%b6%e7%bc%ba%e9%99%b7%e5%be%88%e6%98%8e%e6%98%be%e6%97%a0%e6%b3%95%e7%b2%be%e7%a1%ae%e7%9a%84%e5%af%b9expensive-readwrite%e8%bf%9b%e8%a1%8c%e9%99%90%e9%80%9f%e6%97%a0%e6%b3%95%e6%9c%89%e6%95%88%e9%98%b2%e6%ad%a2%e9%9b%86%e7%be%a4%e8%bf%87%e8%bd%bd%e4%b8%8d%e5%8f%af%e7%94%a8>#</a></h5><p><strong>为了解决以上挑战，避免集群过载目前我们通过以下方案来保障集群稳定性:</strong></p><ul><li><h5 id=基于k8s-apiserver上层限速能力如apiserver默认写100s读200s>基于K8s apiserver上层限速能力，如apiserver默认写100/s,读200/s
<a class=anchor href=#%e5%9f%ba%e4%ba%8ek8s-apiserver%e4%b8%8a%e5%b1%82%e9%99%90%e9%80%9f%e8%83%bd%e5%8a%9b%e5%a6%82apiserver%e9%bb%98%e8%ae%a4%e5%86%99100s%e8%af%bb200s>#</a></h5></li><li><h5 id=基于k8s-resource-quota控制不合理的podconfigmapcrd数>基于K8s resource quota控制不合理的Pod/configmap/crd数
<a class=anchor href=#%e5%9f%ba%e4%ba%8ek8s-resource-quota%e6%8e%a7%e5%88%b6%e4%b8%8d%e5%90%88%e7%90%86%e7%9a%84podconfigmapcrd%e6%95%b0>#</a></h5></li><li><h5 id=基于k8s-controller-manager的-terminated-pod-gc-threshold参数控制无效pod数量此参数默认值高达12500有很大优化空间>基于K8s controller-manager的-terminated-Pod-gc-threshold参数控制无效Pod数量（此参数默认值高达12500，有很大优化空间）
<a class=anchor href=#%e5%9f%ba%e4%ba%8ek8s-controller-manager%e7%9a%84-terminated-pod-gc-threshold%e5%8f%82%e6%95%b0%e6%8e%a7%e5%88%b6%e6%97%a0%e6%95%88pod%e6%95%b0%e9%87%8f%e6%ad%a4%e5%8f%82%e6%95%b0%e9%bb%98%e8%ae%a4%e5%80%bc%e9%ab%98%e8%be%be12500%e6%9c%89%e5%be%88%e5%a4%a7%e4%bc%98%e5%8c%96%e7%a9%ba%e9%97%b4>#</a></h5></li><li><h5 id=基于k8s的apiserver各类资源可独立的存储的特性-将eventconfigmap以及其他核心数据分别使用不同的etcd集群在提高存储性能的同时减少核心主etcd故障因素>基于K8s的apiserver各类资源可独立的存储的特性, 将event/configmap以及其他核心数据分别使用不同的etcd集群，在提高存储性能的同时，减少核心主etcd故障因素
<a class=anchor href=#%e5%9f%ba%e4%ba%8ek8s%e7%9a%84apiserver%e5%90%84%e7%b1%bb%e8%b5%84%e6%ba%90%e5%8f%af%e7%8b%ac%e7%ab%8b%e7%9a%84%e5%ad%98%e5%82%a8%e7%9a%84%e7%89%b9%e6%80%a7-%e5%b0%86eventconfigmap%e4%bb%a5%e5%8f%8a%e5%85%b6%e4%bb%96%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e5%88%86%e5%88%ab%e4%bd%bf%e7%94%a8%e4%b8%8d%e5%90%8c%e7%9a%84etcd%e9%9b%86%e7%be%a4%e5%9c%a8%e6%8f%90%e9%ab%98%e5%ad%98%e5%82%a8%e6%80%a7%e8%83%bd%e7%9a%84%e5%90%8c%e6%97%b6%e5%87%8f%e5%b0%91%e6%a0%b8%e5%bf%83%e4%b8%bbetcd%e6%95%85%e9%9a%9c%e5%9b%a0%e7%b4%a0>#</a></h5></li><li><h5 id=基于event-admission-webhook对读写event的apiserver请求进行速率控制>基于event admission webhook对读写event的apiserver请求进行速率控制
<a class=anchor href=#%e5%9f%ba%e4%ba%8eevent-admission-webhook%e5%af%b9%e8%af%bb%e5%86%99event%e7%9a%84apiserver%e8%af%b7%e6%b1%82%e8%bf%9b%e8%a1%8c%e9%80%9f%e7%8e%87%e6%8e%a7%e5%88%b6>#</a></h5></li><li><h5 id=基于不同业务情况灵活调整event-ttl时间尽量减少event数>基于不同业务情况，灵活调整event-ttl时间，尽量减少event数
<a class=anchor href=#%e5%9f%ba%e4%ba%8e%e4%b8%8d%e5%90%8c%e4%b8%9a%e5%8a%a1%e6%83%85%e5%86%b5%e7%81%b5%e6%b4%bb%e8%b0%83%e6%95%b4event-ttl%e6%97%b6%e9%97%b4%e5%b0%bd%e9%87%8f%e5%87%8f%e5%b0%91event%e6%95%b0>#</a></h5></li><li><h5 id=基于etcd开发qos特性目前也已经向社区提交了初步设计方案支持基于多种对象类型设置qos规则如按grpcmethodgrpcmethod请求key前缀路径trafficcpu-intensivelatency>基于etcd开发QoS特性，目前也已经向社区提交了初步设计方案，支持基于多种对象类型设置QoS规则（如按grpcMethod、grpcMethod+请求key前缀路径、traffic、cpu-intensive、latency）
<a class=anchor href=#%e5%9f%ba%e4%ba%8eetcd%e5%bc%80%e5%8f%91qos%e7%89%b9%e6%80%a7%e7%9b%ae%e5%89%8d%e4%b9%9f%e5%b7%b2%e7%bb%8f%e5%90%91%e7%a4%be%e5%8c%ba%e6%8f%90%e4%ba%a4%e4%ba%86%e5%88%9d%e6%ad%a5%e8%ae%be%e8%ae%a1%e6%96%b9%e6%a1%88%e6%94%af%e6%8c%81%e5%9f%ba%e4%ba%8e%e5%a4%9a%e7%a7%8d%e5%af%b9%e8%b1%a1%e7%b1%bb%e5%9e%8b%e8%ae%be%e7%bd%aeqos%e8%a7%84%e5%88%99%e5%a6%82%e6%8c%89grpcmethodgrpcmethod%e8%af%b7%e6%b1%82key%e5%89%8d%e7%bc%80%e8%b7%af%e5%be%84trafficcpu-intensivelatency>#</a></h5></li><li><h5 id=通过多维度的集群告警etcd集群lb及节点本身出入流量告警内存告警精细化到每个k8s集群的资源容量异常增长告警集群资源读写qps异常增长告警来提前防范规避可能出现的集群稳定性问题>通过多维度的集群告警（etcd集群lb及节点本身出入流量告警、内存告警、精细化到每个K8s集群的资源容量异常增长告警、集群资源读写QPS异常增长告警）来提前防范、规避可能出现的集群稳定性问题
<a class=anchor href=#%e9%80%9a%e8%bf%87%e5%a4%9a%e7%bb%b4%e5%ba%a6%e7%9a%84%e9%9b%86%e7%be%a4%e5%91%8a%e8%ad%a6etcd%e9%9b%86%e7%be%a4lb%e5%8f%8a%e8%8a%82%e7%82%b9%e6%9c%ac%e8%ba%ab%e5%87%ba%e5%85%a5%e6%b5%81%e9%87%8f%e5%91%8a%e8%ad%a6%e5%86%85%e5%ad%98%e5%91%8a%e8%ad%a6%e7%b2%be%e7%bb%86%e5%8c%96%e5%88%b0%e6%af%8f%e4%b8%aak8s%e9%9b%86%e7%be%a4%e7%9a%84%e8%b5%84%e6%ba%90%e5%ae%b9%e9%87%8f%e5%bc%82%e5%b8%b8%e5%a2%9e%e9%95%bf%e5%91%8a%e8%ad%a6%e9%9b%86%e7%be%a4%e8%b5%84%e6%ba%90%e8%af%bb%e5%86%99qps%e5%bc%82%e5%b8%b8%e5%a2%9e%e9%95%bf%e5%91%8a%e8%ad%a6%e6%9d%a5%e6%8f%90%e5%89%8d%e9%98%b2%e8%8c%83%e8%a7%84%e9%81%bf%e5%8f%af%e8%83%bd%e5%87%ba%e7%8e%b0%e7%9a%84%e9%9b%86%e7%be%a4%e7%a8%b3%e5%ae%9a%e6%80%a7%e9%97%ae%e9%a2%98>#</a></h5></li></ul><h5 id=多维度的集群告警在我们的etcd稳定性保障中发挥了重要作用多次帮助我们发现用户和我们自身集群组件问题用户问题如内部某k8s平台之前出现bug-写入大量的集群crd资源和client读写crd-qps明显偏高我们自身组件问题如某旧日志组件当集群规模增大后因日志组件不合理的频繁调用list-pod导致etcd集群流量高达3gbps-同时apiserver本身也出现5xx错误>**多维度的集群告警在我们的etcd稳定性保障中发挥了重要作用，多次帮助我们发现用户和我们自身集群组件问题。**用户问题如内部某K8s平台之前出现bug, 写入大量的集群CRD资源和client读写CRD QPS明显偏高。我们自身组件问题如某旧日志组件，当集群规模增大后，因日志组件不合理的频繁调用list Pod，导致etcd集群流量高达3Gbps, 同时apiserver本身也出现5XX错误。
<a class=anchor href=#%e5%a4%9a%e7%bb%b4%e5%ba%a6%e7%9a%84%e9%9b%86%e7%be%a4%e5%91%8a%e8%ad%a6%e5%9c%a8%e6%88%91%e4%bb%ac%e7%9a%84etcd%e7%a8%b3%e5%ae%9a%e6%80%a7%e4%bf%9d%e9%9a%9c%e4%b8%ad%e5%8f%91%e6%8c%a5%e4%ba%86%e9%87%8d%e8%a6%81%e4%bd%9c%e7%94%a8%e5%a4%9a%e6%ac%a1%e5%b8%ae%e5%8a%a9%e6%88%91%e4%bb%ac%e5%8f%91%e7%8e%b0%e7%94%a8%e6%88%b7%e5%92%8c%e6%88%91%e4%bb%ac%e8%87%aa%e8%ba%ab%e9%9b%86%e7%be%a4%e7%bb%84%e4%bb%b6%e9%97%ae%e9%a2%98%e7%94%a8%e6%88%b7%e9%97%ae%e9%a2%98%e5%a6%82%e5%86%85%e9%83%a8%e6%9f%90k8s%e5%b9%b3%e5%8f%b0%e4%b9%8b%e5%89%8d%e5%87%ba%e7%8e%b0bug-%e5%86%99%e5%85%a5%e5%a4%a7%e9%87%8f%e7%9a%84%e9%9b%86%e7%be%a4crd%e8%b5%84%e6%ba%90%e5%92%8cclient%e8%af%bb%e5%86%99crd-qps%e6%98%8e%e6%98%be%e5%81%8f%e9%ab%98%e6%88%91%e4%bb%ac%e8%87%aa%e8%ba%ab%e7%bb%84%e4%bb%b6%e9%97%ae%e9%a2%98%e5%a6%82%e6%9f%90%e6%97%a7%e6%97%a5%e5%bf%97%e7%bb%84%e4%bb%b6%e5%bd%93%e9%9b%86%e7%be%a4%e8%a7%84%e6%a8%a1%e5%a2%9e%e5%a4%a7%e5%90%8e%e5%9b%a0%e6%97%a5%e5%bf%97%e7%bb%84%e4%bb%b6%e4%b8%8d%e5%90%88%e7%90%86%e7%9a%84%e9%a2%91%e7%b9%81%e8%b0%83%e7%94%a8list-pod%e5%af%bc%e8%87%b4etcd%e9%9b%86%e7%be%a4%e6%b5%81%e9%87%8f%e9%ab%98%e8%be%be3gbps-%e5%90%8c%e6%97%b6apiserver%e6%9c%ac%e8%ba%ab%e4%b9%9f%e5%87%ba%e7%8e%b05xx%e9%94%99%e8%af%af>#</a></h5><h5 id=虽然通过以上措施我们能极大的减少因expensive-read导致的稳定性问题然而从线上实践效果看目前我们仍然比较依赖集群告警帮助我们定位一些异常client调用行为无法自动化的对异常client的进行精准智能限速etcd层因无法区分是哪个client调用如果在etcd侧限速会误杀正常client的请求-因此依赖apiserver精细化的限速功能实现社区目前已在118中引入了一个api-priority-and-fairness目前是alpha版本期待此特性早日稳定>虽然通过以上措施，我们能极大的减少因expensive read导致的稳定性问题，然而从线上实践效果看，目前我们仍然比较依赖集群告警帮助我们定位一些异常client调用行为，无法自动化的对异常client的进行精准智能限速,。etcd层因无法区分是哪个client调用，如果在etcd侧限速会误杀正常client的请求, 因此依赖apiserver精细化的限速功能实现。社区目前已在1.18中引入了一个<strong>API Priority and Fairness[7]</strong>，目前是alpha版本，期待此特性早日稳定。
<a class=anchor href=#%e8%99%bd%e7%84%b6%e9%80%9a%e8%bf%87%e4%bb%a5%e4%b8%8a%e6%8e%aa%e6%96%bd%e6%88%91%e4%bb%ac%e8%83%bd%e6%9e%81%e5%a4%a7%e7%9a%84%e5%87%8f%e5%b0%91%e5%9b%a0expensive-read%e5%af%bc%e8%87%b4%e7%9a%84%e7%a8%b3%e5%ae%9a%e6%80%a7%e9%97%ae%e9%a2%98%e7%84%b6%e8%80%8c%e4%bb%8e%e7%ba%bf%e4%b8%8a%e5%ae%9e%e8%b7%b5%e6%95%88%e6%9e%9c%e7%9c%8b%e7%9b%ae%e5%89%8d%e6%88%91%e4%bb%ac%e4%bb%8d%e7%84%b6%e6%af%94%e8%be%83%e4%be%9d%e8%b5%96%e9%9b%86%e7%be%a4%e5%91%8a%e8%ad%a6%e5%b8%ae%e5%8a%a9%e6%88%91%e4%bb%ac%e5%ae%9a%e4%bd%8d%e4%b8%80%e4%ba%9b%e5%bc%82%e5%b8%b8client%e8%b0%83%e7%94%a8%e8%a1%8c%e4%b8%ba%e6%97%a0%e6%b3%95%e8%87%aa%e5%8a%a8%e5%8c%96%e7%9a%84%e5%af%b9%e5%bc%82%e5%b8%b8client%e7%9a%84%e8%bf%9b%e8%a1%8c%e7%b2%be%e5%87%86%e6%99%ba%e8%83%bd%e9%99%90%e9%80%9fetcd%e5%b1%82%e5%9b%a0%e6%97%a0%e6%b3%95%e5%8c%ba%e5%88%86%e6%98%af%e5%93%aa%e4%b8%aaclient%e8%b0%83%e7%94%a8%e5%a6%82%e6%9e%9c%e5%9c%a8etcd%e4%be%a7%e9%99%90%e9%80%9f%e4%bc%9a%e8%af%af%e6%9d%80%e6%ad%a3%e5%b8%b8client%e7%9a%84%e8%af%b7%e6%b1%82-%e5%9b%a0%e6%ad%a4%e4%be%9d%e8%b5%96apiserver%e7%b2%be%e7%bb%86%e5%8c%96%e7%9a%84%e9%99%90%e9%80%9f%e5%8a%9f%e8%83%bd%e5%ae%9e%e7%8e%b0%e7%a4%be%e5%8c%ba%e7%9b%ae%e5%89%8d%e5%b7%b2%e5%9c%a8118%e4%b8%ad%e5%bc%95%e5%85%a5%e4%ba%86%e4%b8%80%e4%b8%aaapi-priority-and-fairness%e7%9b%ae%e5%89%8d%e6%98%afalpha%e7%89%88%e6%9c%ac%e6%9c%9f%e5%be%85%e6%ad%a4%e7%89%b9%e6%80%a7%e6%97%a9%e6%97%a5%e7%a8%b3%e5%ae%9a>#</a></h5><h2 id=性能优化案例剖析>性能优化案例剖析
<a class=anchor href=#%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e6%a1%88%e4%be%8b%e5%89%96%e6%9e%90>#</a></h2><h5 id=etcd读写性能决定着我们能支撑多大规模的集群多少client并发调用启动耗时决定着我们当重启一个节点或因落后leader太多收到leader的快照重建时它重新提供服务需要多久性能优化案例剖析我们将从启动耗时减少一半密码鉴权性能提升12倍查询key数量性能提升3倍等来简单介绍下如何对etcd进行性能优化>etcd读写性能决定着我们能支撑多大规模的集群、多少client并发调用，启动耗时决定着我们当重启一个节点或因落后leader太多，收到leader的快照重建时，它重新提供服务需要多久？<strong>性能优化案例剖析我们将从启动耗时减少一半、密码鉴权性能提升12倍、查询key数量性能提升3倍等来简单介绍下如何对etcd进行性能优化。</strong>
<a class=anchor href=#etcd%e8%af%bb%e5%86%99%e6%80%a7%e8%83%bd%e5%86%b3%e5%ae%9a%e7%9d%80%e6%88%91%e4%bb%ac%e8%83%bd%e6%94%af%e6%92%91%e5%a4%9a%e5%a4%a7%e8%a7%84%e6%a8%a1%e7%9a%84%e9%9b%86%e7%be%a4%e5%a4%9a%e5%b0%91client%e5%b9%b6%e5%8f%91%e8%b0%83%e7%94%a8%e5%90%af%e5%8a%a8%e8%80%97%e6%97%b6%e5%86%b3%e5%ae%9a%e7%9d%80%e6%88%91%e4%bb%ac%e5%bd%93%e9%87%8d%e5%90%af%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e6%88%96%e5%9b%a0%e8%90%bd%e5%90%8eleader%e5%a4%aa%e5%a4%9a%e6%94%b6%e5%88%b0leader%e7%9a%84%e5%bf%ab%e7%85%a7%e9%87%8d%e5%bb%ba%e6%97%b6%e5%ae%83%e9%87%8d%e6%96%b0%e6%8f%90%e4%be%9b%e6%9c%8d%e5%8a%a1%e9%9c%80%e8%a6%81%e5%a4%9a%e4%b9%85%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e6%a1%88%e4%be%8b%e5%89%96%e6%9e%90%e6%88%91%e4%bb%ac%e5%b0%86%e4%bb%8e%e5%90%af%e5%8a%a8%e8%80%97%e6%97%b6%e5%87%8f%e5%b0%91%e4%b8%80%e5%8d%8a%e5%af%86%e7%a0%81%e9%89%b4%e6%9d%83%e6%80%a7%e8%83%bd%e6%8f%90%e5%8d%8712%e5%80%8d%e6%9f%a5%e8%af%a2key%e6%95%b0%e9%87%8f%e6%80%a7%e8%83%bd%e6%8f%90%e5%8d%873%e5%80%8d%e7%ad%89%e6%9d%a5%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e4%b8%8b%e5%a6%82%e4%bd%95%e5%af%b9etcd%e8%bf%9b%e8%a1%8c%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96>#</a></h5><h3 id=启动耗时及查询key数量查询指定记录数性能优化><strong>启动耗时及查询key数量、查询指定记录数性能优化</strong>
<a class=anchor href=#%e5%90%af%e5%8a%a8%e8%80%97%e6%97%b6%e5%8f%8a%e6%9f%a5%e8%af%a2key%e6%95%b0%e9%87%8f%e6%9f%a5%e8%af%a2%e6%8c%87%e5%ae%9a%e8%ae%b0%e5%bd%95%e6%95%b0%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96>#</a></h3><h5 id=当db-size达到4g时key数量百万级别时发现重启一个集群耗时竟然高达5分钟-key数量查询也是超时调整超时时间后发现高达21秒内存暴涨6g同时查询只返回有限的记录数的场景如业务使用etcd-grpc-proxy来减少watch数etcd-grpc-proxy在默认创建watch的时候会发起对watch路径的一次limit读查询依然耗时很高且有巨大的内存开销于是周末空闲的时候我对这几个问题进行了深入调查分析启动耗时到底花在了哪里是否有优化空间查询key数量为何如何耗时内存开销如此之大>当db size达到4g时，key数量百万级别时，发现重启一个集群耗时竟然高达5分钟, key数量查询也是超时，调整超时时间后，发现高达21秒，内存暴涨6G。同时查询只返回有限的记录数的场景（如业务使用etcd grpc-proxy来减少watch数,etcd grpc proxy在默认创建watch的时候，会发起对watch路径的一次limit读查询），依然耗时很高且有巨大的内存开销。于是周末空闲的时候我对这几个问题进行了深入调查分析，启动耗时到底花在了哪里？是否有优化空间？查询key数量为何如何耗时，内存开销如此之大？
<a class=anchor href=#%e5%bd%93db-size%e8%be%be%e5%88%b04g%e6%97%b6key%e6%95%b0%e9%87%8f%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e6%97%b6%e5%8f%91%e7%8e%b0%e9%87%8d%e5%90%af%e4%b8%80%e4%b8%aa%e9%9b%86%e7%be%a4%e8%80%97%e6%97%b6%e7%ab%9f%e7%84%b6%e9%ab%98%e8%be%be5%e5%88%86%e9%92%9f-key%e6%95%b0%e9%87%8f%e6%9f%a5%e8%af%a2%e4%b9%9f%e6%98%af%e8%b6%85%e6%97%b6%e8%b0%83%e6%95%b4%e8%b6%85%e6%97%b6%e6%97%b6%e9%97%b4%e5%90%8e%e5%8f%91%e7%8e%b0%e9%ab%98%e8%be%be21%e7%a7%92%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a86g%e5%90%8c%e6%97%b6%e6%9f%a5%e8%af%a2%e5%8f%aa%e8%bf%94%e5%9b%9e%e6%9c%89%e9%99%90%e7%9a%84%e8%ae%b0%e5%bd%95%e6%95%b0%e7%9a%84%e5%9c%ba%e6%99%af%e5%a6%82%e4%b8%9a%e5%8a%a1%e4%bd%bf%e7%94%a8etcd-grpc-proxy%e6%9d%a5%e5%87%8f%e5%b0%91watch%e6%95%b0etcd-grpc-proxy%e5%9c%a8%e9%bb%98%e8%ae%a4%e5%88%9b%e5%bb%bawatch%e7%9a%84%e6%97%b6%e5%80%99%e4%bc%9a%e5%8f%91%e8%b5%b7%e5%af%b9watch%e8%b7%af%e5%be%84%e7%9a%84%e4%b8%80%e6%ac%a1limit%e8%af%bb%e6%9f%a5%e8%af%a2%e4%be%9d%e7%84%b6%e8%80%97%e6%97%b6%e5%be%88%e9%ab%98%e4%b8%94%e6%9c%89%e5%b7%a8%e5%a4%a7%e7%9a%84%e5%86%85%e5%ad%98%e5%bc%80%e9%94%80%e4%ba%8e%e6%98%af%e5%91%a8%e6%9c%ab%e7%a9%ba%e9%97%b2%e7%9a%84%e6%97%b6%e5%80%99%e6%88%91%e5%af%b9%e8%bf%99%e5%87%a0%e4%b8%aa%e9%97%ae%e9%a2%98%e8%bf%9b%e8%a1%8c%e4%ba%86%e6%b7%b1%e5%85%a5%e8%b0%83%e6%9f%a5%e5%88%86%e6%9e%90%e5%90%af%e5%8a%a8%e8%80%97%e6%97%b6%e5%88%b0%e5%ba%95%e8%8a%b1%e5%9c%a8%e4%ba%86%e5%93%aa%e9%87%8c%e6%98%af%e5%90%a6%e6%9c%89%e4%bc%98%e5%8c%96%e7%a9%ba%e9%97%b4%e6%9f%a5%e8%af%a2key%e6%95%b0%e9%87%8f%e4%b8%ba%e4%bd%95%e5%a6%82%e4%bd%95%e8%80%97%e6%97%b6%e5%86%85%e5%ad%98%e5%bc%80%e9%94%80%e5%a6%82%e6%ad%a4%e4%b9%8b%e5%a4%a7>#</a></h5><h5 id=带着这些问题对源码进行了深入分析和定位首先来看查询key数和查询只返回指定记录数的耗时和内存开销极大的问题分析结论如下>带着这些问题对源码进行了深入分析和定位，首先来看查询key数和查询只返回指定记录数的耗时和内存开销极大的问题，分析结论如下：
<a class=anchor href=#%e5%b8%a6%e7%9d%80%e8%bf%99%e4%ba%9b%e9%97%ae%e9%a2%98%e5%af%b9%e6%ba%90%e7%a0%81%e8%bf%9b%e8%a1%8c%e4%ba%86%e6%b7%b1%e5%85%a5%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9a%e4%bd%8d%e9%a6%96%e5%85%88%e6%9d%a5%e7%9c%8b%e6%9f%a5%e8%af%a2key%e6%95%b0%e5%92%8c%e6%9f%a5%e8%af%a2%e5%8f%aa%e8%bf%94%e5%9b%9e%e6%8c%87%e5%ae%9a%e8%ae%b0%e5%bd%95%e6%95%b0%e7%9a%84%e8%80%97%e6%97%b6%e5%92%8c%e5%86%85%e5%ad%98%e5%bc%80%e9%94%80%e6%9e%81%e5%a4%a7%e7%9a%84%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e7%bb%93%e8%ae%ba%e5%a6%82%e4%b8%8b>#</a></h5><ul><li><h5 id=查询key数量时etcd之前实现是遍历整个内存btree把key对应的revision存放在slice数组里面>查询key数量时etcd之前实现是遍历整个内存btree,把key对应的revision存放在slice数组里面
<a class=anchor href=#%e6%9f%a5%e8%af%a2key%e6%95%b0%e9%87%8f%e6%97%b6etcd%e4%b9%8b%e5%89%8d%e5%ae%9e%e7%8e%b0%e6%98%af%e9%81%8d%e5%8e%86%e6%95%b4%e4%b8%aa%e5%86%85%e5%ad%98btree%e6%8a%8akey%e5%af%b9%e5%ba%94%e7%9a%84revision%e5%ad%98%e6%94%be%e5%9c%a8slice%e6%95%b0%e7%bb%84%e9%87%8c%e9%9d%a2>#</a></h5></li><li><h5 id=问题就在于key数量较多时slice扩容涉及到数据拷贝以及slice也需要大量的内存开销>问题就在于key数量较多时，slice扩容涉及到数据拷贝，以及slice也需要大量的内存开销
<a class=anchor href=#%e9%97%ae%e9%a2%98%e5%b0%b1%e5%9c%a8%e4%ba%8ekey%e6%95%b0%e9%87%8f%e8%be%83%e5%a4%9a%e6%97%b6slice%e6%89%a9%e5%ae%b9%e6%b6%89%e5%8f%8a%e5%88%b0%e6%95%b0%e6%8d%ae%e6%8b%b7%e8%b4%9d%e4%bb%a5%e5%8f%8aslice%e4%b9%9f%e9%9c%80%e8%a6%81%e5%a4%a7%e9%87%8f%e7%9a%84%e5%86%85%e5%ad%98%e5%bc%80%e9%94%80>#</a></h5></li><li><h5 id=因此优化方案是新增一个countrevision来统计key的数量即可不需要使用slice此方案优化后性能从21s降低到了7s同时无任何内存开销>因此优化方案是新增一个CountRevision来统计key的数量即可，不需要使用slice，此方案优化后性能从21s降低到了7s,同时无任何内存开销
<a class=anchor href=#%e5%9b%a0%e6%ad%a4%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88%e6%98%af%e6%96%b0%e5%a2%9e%e4%b8%80%e4%b8%aacountrevision%e6%9d%a5%e7%bb%9f%e8%ae%a1key%e7%9a%84%e6%95%b0%e9%87%8f%e5%8d%b3%e5%8f%af%e4%b8%8d%e9%9c%80%e8%a6%81%e4%bd%bf%e7%94%a8slice%e6%ad%a4%e6%96%b9%e6%a1%88%e4%bc%98%e5%8c%96%e5%90%8e%e6%80%a7%e8%83%bd%e4%bb%8e21s%e9%99%8d%e4%bd%8e%e5%88%b0%e4%ba%867s%e5%90%8c%e6%97%b6%e6%97%a0%e4%bb%bb%e4%bd%95%e5%86%85%e5%ad%98%e5%bc%80%e9%94%80>#</a></h5></li><li><h5 id=对于查询指定记录数据耗时和内存开销非常大的问题通过分析发现是limit记录数并未下推到索引层通过将查询limit参数下推到索引层大数据场景下limit查询性能提升百倍同时无额外的内存开销>对于查询指定记录数据耗时和内存开销非常大的问题，通过分析发现是limit记录数并未下推到索引层，<strong>通过将查询limit参数下推到索引层，大数据场景下limit查询性能提升百倍，同时无额外的内存开销。</strong>
<a class=anchor href=#%e5%af%b9%e4%ba%8e%e6%9f%a5%e8%af%a2%e6%8c%87%e5%ae%9a%e8%ae%b0%e5%bd%95%e6%95%b0%e6%8d%ae%e8%80%97%e6%97%b6%e5%92%8c%e5%86%85%e5%ad%98%e5%bc%80%e9%94%80%e9%9d%9e%e5%b8%b8%e5%a4%a7%e7%9a%84%e9%97%ae%e9%a2%98%e9%80%9a%e8%bf%87%e5%88%86%e6%9e%90%e5%8f%91%e7%8e%b0%e6%98%aflimit%e8%ae%b0%e5%bd%95%e6%95%b0%e5%b9%b6%e6%9c%aa%e4%b8%8b%e6%8e%a8%e5%88%b0%e7%b4%a2%e5%bc%95%e5%b1%82%e9%80%9a%e8%bf%87%e5%b0%86%e6%9f%a5%e8%af%a2limit%e5%8f%82%e6%95%b0%e4%b8%8b%e6%8e%a8%e5%88%b0%e7%b4%a2%e5%bc%95%e5%b1%82%e5%a4%a7%e6%95%b0%e6%8d%ae%e5%9c%ba%e6%99%af%e4%b8%8blimit%e6%9f%a5%e8%af%a2%e6%80%a7%e8%83%bd%e6%8f%90%e5%8d%87%e7%99%be%e5%80%8d%e5%90%8c%e6%97%b6%e6%97%a0%e9%a2%9d%e5%a4%96%e7%9a%84%e5%86%85%e5%ad%98%e5%bc%80%e9%94%80>#</a></h5></li></ul><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011121460.png alt=image-20240301112118393></p><h5 id=再看启动耗时问题过高的问题通过对启动耗时各阶段增加日志得到以下结论>再看启动耗时问题过高的问题，通过对启动耗时各阶段增加日志，得到以下结论：
<a class=anchor href=#%e5%86%8d%e7%9c%8b%e5%90%af%e5%8a%a8%e8%80%97%e6%97%b6%e9%97%ae%e9%a2%98%e8%bf%87%e9%ab%98%e7%9a%84%e9%97%ae%e9%a2%98%e9%80%9a%e8%bf%87%e5%af%b9%e5%90%af%e5%8a%a8%e8%80%97%e6%97%b6%e5%90%84%e9%98%b6%e6%ae%b5%e5%a2%9e%e5%8a%a0%e6%97%a5%e5%bf%97%e5%be%97%e5%88%b0%e4%bb%a5%e4%b8%8b%e7%bb%93%e8%ae%ba>#</a></h5><ul><li><p><strong>启动的时候机器上的cpu资源etcd进程未能充分利用</strong></p></li><li><h5 id=9耗时在打开后端db时如将整个db文件mmap到内存><strong>9%耗时在打开后端db时</strong>，如将整个db文件mmap到内存
<a class=anchor href=#9%e8%80%97%e6%97%b6%e5%9c%a8%e6%89%93%e5%bc%80%e5%90%8e%e7%ab%afdb%e6%97%b6%e5%a6%82%e5%b0%86%e6%95%b4%e4%b8%aadb%e6%96%87%e4%bb%b6mmap%e5%88%b0%e5%86%85%e5%ad%98>#</a></h5></li><li><h5 id=91耗时在重建内存索引btree上当etcd收到一个请求get-key时请求被层层传递到了mvcc层后它首先需要从内存索引btree中查找key对应的版本号随后从boltdb里面根据版本号查出对应的value-然后返回给client-重建内存索引btree数的时候恰恰是相反的流程遍历boltdb从版本号0到最大版本号不断遍历从value里面解析出对应的keyrevision等信息重建btree因为这个是个串行操作所以操作及其耗时>**91%耗时在重建内存索引btree上。**当etcd收到一个请求Get Key时，请求被层层传递到了mvcc层后，它首先需要从内存索引btree中查找key对应的版本号，随后从boltdb里面根据版本号查出对应的value, 然后返回给client. 重建内存索引btree数的时候，恰恰是相反的流程，遍历boltdb,从版本号0到最大版本号不断遍历，从value里面解析出对应的key、revision等信息，重建btree，因为这个是个串行操作，所以操作及其耗时
<a class=anchor href=#91%e8%80%97%e6%97%b6%e5%9c%a8%e9%87%8d%e5%bb%ba%e5%86%85%e5%ad%98%e7%b4%a2%e5%bc%95btree%e4%b8%8a%e5%bd%93etcd%e6%94%b6%e5%88%b0%e4%b8%80%e4%b8%aa%e8%af%b7%e6%b1%82get-key%e6%97%b6%e8%af%b7%e6%b1%82%e8%a2%ab%e5%b1%82%e5%b1%82%e4%bc%a0%e9%80%92%e5%88%b0%e4%ba%86mvcc%e5%b1%82%e5%90%8e%e5%ae%83%e9%a6%96%e5%85%88%e9%9c%80%e8%a6%81%e4%bb%8e%e5%86%85%e5%ad%98%e7%b4%a2%e5%bc%95btree%e4%b8%ad%e6%9f%a5%e6%89%bekey%e5%af%b9%e5%ba%94%e7%9a%84%e7%89%88%e6%9c%ac%e5%8f%b7%e9%9a%8f%e5%90%8e%e4%bb%8eboltdb%e9%87%8c%e9%9d%a2%e6%a0%b9%e6%8d%ae%e7%89%88%e6%9c%ac%e5%8f%b7%e6%9f%a5%e5%87%ba%e5%af%b9%e5%ba%94%e7%9a%84value-%e7%84%b6%e5%90%8e%e8%bf%94%e5%9b%9e%e7%bb%99client-%e9%87%8d%e5%bb%ba%e5%86%85%e5%ad%98%e7%b4%a2%e5%bc%95btree%e6%95%b0%e7%9a%84%e6%97%b6%e5%80%99%e6%81%b0%e6%81%b0%e6%98%af%e7%9b%b8%e5%8f%8d%e7%9a%84%e6%b5%81%e7%a8%8b%e9%81%8d%e5%8e%86boltdb%e4%bb%8e%e7%89%88%e6%9c%ac%e5%8f%b70%e5%88%b0%e6%9c%80%e5%a4%a7%e7%89%88%e6%9c%ac%e5%8f%b7%e4%b8%8d%e6%96%ad%e9%81%8d%e5%8e%86%e4%bb%8evalue%e9%87%8c%e9%9d%a2%e8%a7%a3%e6%9e%90%e5%87%ba%e5%af%b9%e5%ba%94%e7%9a%84keyrevision%e7%ad%89%e4%bf%a1%e6%81%af%e9%87%8d%e5%bb%babtree%e5%9b%a0%e4%b8%ba%e8%bf%99%e4%b8%aa%e6%98%af%e4%b8%aa%e4%b8%b2%e8%a1%8c%e6%93%8d%e4%bd%9c%e6%89%80%e4%bb%a5%e6%93%8d%e4%bd%9c%e5%8f%8a%e5%85%b6%e8%80%97%e6%97%b6>#</a></h5></li><li><h5 id=尝试将串行构建btree优化成高并发构建尽量把所有核计算力利用起来编译新版本测试后发现效果甚微于是编译新版本打印重建内存索引各阶段的详细耗时分析结果发现瓶颈在内存btree的插入上而这个插入拥有一个全局锁因此几乎无优化空间><strong>尝试将串行构建btree优化成高并发构建，尽量把所有核计算力利用起来</strong>，编译新版本测试后发现效果甚微，于是编译新版本打印重建内存索引各阶段的详细耗时分析，结果发现瓶颈在内存btree的插入上，而这个插入拥有一个全局锁，因此几乎无优化空间
<a class=anchor href=#%e5%b0%9d%e8%af%95%e5%b0%86%e4%b8%b2%e8%a1%8c%e6%9e%84%e5%bb%babtree%e4%bc%98%e5%8c%96%e6%88%90%e9%ab%98%e5%b9%b6%e5%8f%91%e6%9e%84%e5%bb%ba%e5%b0%bd%e9%87%8f%e6%8a%8a%e6%89%80%e6%9c%89%e6%a0%b8%e8%ae%a1%e7%ae%97%e5%8a%9b%e5%88%a9%e7%94%a8%e8%b5%b7%e6%9d%a5%e7%bc%96%e8%af%91%e6%96%b0%e7%89%88%e6%9c%ac%e6%b5%8b%e8%af%95%e5%90%8e%e5%8f%91%e7%8e%b0%e6%95%88%e6%9e%9c%e7%94%9a%e5%be%ae%e4%ba%8e%e6%98%af%e7%bc%96%e8%af%91%e6%96%b0%e7%89%88%e6%9c%ac%e6%89%93%e5%8d%b0%e9%87%8d%e5%bb%ba%e5%86%85%e5%ad%98%e7%b4%a2%e5%bc%95%e5%90%84%e9%98%b6%e6%ae%b5%e7%9a%84%e8%af%a6%e7%bb%86%e8%80%97%e6%97%b6%e5%88%86%e6%9e%90%e7%bb%93%e6%9e%9c%e5%8f%91%e7%8e%b0%e7%93%b6%e9%a2%88%e5%9c%a8%e5%86%85%e5%ad%98btree%e7%9a%84%e6%8f%92%e5%85%a5%e4%b8%8a%e8%80%8c%e8%bf%99%e4%b8%aa%e6%8f%92%e5%85%a5%e6%8b%a5%e6%9c%89%e4%b8%80%e4%b8%aa%e5%85%a8%e5%b1%80%e9%94%81%e5%9b%a0%e6%ad%a4%e5%87%a0%e4%b9%8e%e6%97%a0%e4%bc%98%e5%8c%96%e7%a9%ba%e9%97%b4>#</a></h5></li><li><h5 id=继续分析91耗时发现重建内存索引竟然被调用了两次第一处是为了获取一个mvcc的关键的consistent-index变量它是用来保证etcd命令不会被重复执行的关键数据结构而我们前面提到的一个数据不一致bug恰好也是跟consistent-index有密切关系><strong>继续分析91%耗时发现重建内存索引竟然被调用了两次</strong>，第一处是为了获取一个mvcc的关键的consistent index变量，它是用来保证etcd命令不会被重复执行的关键数据结构，而我们前面提到的一个数据不一致bug恰好也是跟consistent index有密切关系。
<a class=anchor href=#%e7%bb%a7%e7%bb%ad%e5%88%86%e6%9e%9091%e8%80%97%e6%97%b6%e5%8f%91%e7%8e%b0%e9%87%8d%e5%bb%ba%e5%86%85%e5%ad%98%e7%b4%a2%e5%bc%95%e7%ab%9f%e7%84%b6%e8%a2%ab%e8%b0%83%e7%94%a8%e4%ba%86%e4%b8%a4%e6%ac%a1%e7%ac%ac%e4%b8%80%e5%a4%84%e6%98%af%e4%b8%ba%e4%ba%86%e8%8e%b7%e5%8f%96%e4%b8%80%e4%b8%aamvcc%e7%9a%84%e5%85%b3%e9%94%ae%e7%9a%84consistent-index%e5%8f%98%e9%87%8f%e5%ae%83%e6%98%af%e7%94%a8%e6%9d%a5%e4%bf%9d%e8%af%81etcd%e5%91%bd%e4%bb%a4%e4%b8%8d%e4%bc%9a%e8%a2%ab%e9%87%8d%e5%a4%8d%e6%89%a7%e8%a1%8c%e7%9a%84%e5%85%b3%e9%94%ae%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e8%80%8c%e6%88%91%e4%bb%ac%e5%89%8d%e9%9d%a2%e6%8f%90%e5%88%b0%e7%9a%84%e4%b8%80%e4%b8%aa%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4bug%e6%81%b0%e5%a5%bd%e4%b9%9f%e6%98%af%e8%b7%9fconsistent-index%e6%9c%89%e5%af%86%e5%88%87%e5%85%b3%e7%b3%bb>#</a></h5></li><li><h5 id=consistent-index实现不合理封装在mvcc层因此我前面提了一个pr将此特性重构做为了一个独立的包提供各类方法给etcdservermvccauthlease等模块调用><strong>consistent index实现不合理，封装在mvcc层</strong>，因此我前面提了一个pr将此特性重构，做为了一个独立的包，提供各类方法给etcdserver、mvcc、auth、lease等模块调用。
<a class=anchor href=#consistent-index%e5%ae%9e%e7%8e%b0%e4%b8%8d%e5%90%88%e7%90%86%e5%b0%81%e8%a3%85%e5%9c%a8mvcc%e5%b1%82%e5%9b%a0%e6%ad%a4%e6%88%91%e5%89%8d%e9%9d%a2%e6%8f%90%e4%ba%86%e4%b8%80%e4%b8%aapr%e5%b0%86%e6%ad%a4%e7%89%b9%e6%80%a7%e9%87%8d%e6%9e%84%e5%81%9a%e4%b8%ba%e4%ba%86%e4%b8%80%e4%b8%aa%e7%8b%ac%e7%ab%8b%e7%9a%84%e5%8c%85%e6%8f%90%e4%be%9b%e5%90%84%e7%b1%bb%e6%96%b9%e6%b3%95%e7%bb%99etcdservermvccauthlease%e7%ad%89%e6%a8%a1%e5%9d%97%e8%b0%83%e7%94%a8>#</a></h5></li><li><h5 id=特性重构后的consistent-index在启动的时候就不再需要通过重建内存索引数等逻辑来获取了优化成调用cindex包的方法快速获取到consistent-index就将整个耗时从5min从缩短到2分30秒左右因此优化同时依赖的consistent-index特性重构改动较大暂未backport到3433分支在未来35版本中数据量较大时可以享受到启动耗时的显著提升>特性重构后的consistent index在启动的时候就不再需要通过重建内存索引数等逻辑来获取了，优化成调用cindex包的方法快速获取到consistent index，就将整个耗时从5min从缩短到2分30秒左右。因此优化同时依赖的consistent index特性重构，改动较大暂未backport到3.4/3.3分支，在未来3.5版本中、数据量较大时可以享受到启动耗时的显著提升。
<a class=anchor href=#%e7%89%b9%e6%80%a7%e9%87%8d%e6%9e%84%e5%90%8e%e7%9a%84consistent-index%e5%9c%a8%e5%90%af%e5%8a%a8%e7%9a%84%e6%97%b6%e5%80%99%e5%b0%b1%e4%b8%8d%e5%86%8d%e9%9c%80%e8%a6%81%e9%80%9a%e8%bf%87%e9%87%8d%e5%bb%ba%e5%86%85%e5%ad%98%e7%b4%a2%e5%bc%95%e6%95%b0%e7%ad%89%e9%80%bb%e8%be%91%e6%9d%a5%e8%8e%b7%e5%8f%96%e4%ba%86%e4%bc%98%e5%8c%96%e6%88%90%e8%b0%83%e7%94%a8cindex%e5%8c%85%e7%9a%84%e6%96%b9%e6%b3%95%e5%bf%ab%e9%80%9f%e8%8e%b7%e5%8f%96%e5%88%b0consistent-index%e5%b0%b1%e5%b0%86%e6%95%b4%e4%b8%aa%e8%80%97%e6%97%b6%e4%bb%8e5min%e4%bb%8e%e7%bc%a9%e7%9f%ad%e5%88%b02%e5%88%8630%e7%a7%92%e5%b7%a6%e5%8f%b3%e5%9b%a0%e6%ad%a4%e4%bc%98%e5%8c%96%e5%90%8c%e6%97%b6%e4%be%9d%e8%b5%96%e7%9a%84consistent-index%e7%89%b9%e6%80%a7%e9%87%8d%e6%9e%84%e6%94%b9%e5%8a%a8%e8%be%83%e5%a4%a7%e6%9a%82%e6%9c%aabackport%e5%88%b03433%e5%88%86%e6%94%af%e5%9c%a8%e6%9c%aa%e6%9d%a535%e7%89%88%e6%9c%ac%e4%b8%ad%e6%95%b0%e6%8d%ae%e9%87%8f%e8%be%83%e5%a4%a7%e6%97%b6%e5%8f%af%e4%bb%a5%e4%ba%ab%e5%8f%97%e5%88%b0%e5%90%af%e5%8a%a8%e8%80%97%e6%97%b6%e7%9a%84%e6%98%be%e8%91%97%e6%8f%90%e5%8d%87>#</a></h5></li></ul><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011121867.png alt=image-20240301112139797></p><h3 id=密码鉴权性能提升12倍><strong>密码鉴权性能提升12倍</strong>
<a class=anchor href=#%e5%af%86%e7%a0%81%e9%89%b4%e6%9d%83%e6%80%a7%e8%83%bd%e6%8f%90%e5%8d%8712%e5%80%8d>#</a></h3><h5 id=某内部业务服务一直跑的好好的某天client略微增多后突然现网etcd集群出现大量超时各种折腾切换云盘类型切换部署环境调整参数都不发挥作用收到求助后索要metrics和日志后经过一番排查后得到以下结论>某内部业务服务一直跑的好好的，某天client略微增多后，突然现网etcd集群出现大量超时，各种折腾，切换云盘类型、切换部署环境、调整参数都不发挥作用，收到求助后，索要metrics和日志后，经过一番排查后，得到以下结论:
<a class=anchor href=#%e6%9f%90%e5%86%85%e9%83%a8%e4%b8%9a%e5%8a%a1%e6%9c%8d%e5%8a%a1%e4%b8%80%e7%9b%b4%e8%b7%91%e7%9a%84%e5%a5%bd%e5%a5%bd%e7%9a%84%e6%9f%90%e5%a4%a9client%e7%95%a5%e5%be%ae%e5%a2%9e%e5%a4%9a%e5%90%8e%e7%aa%81%e7%84%b6%e7%8e%b0%e7%bd%91etcd%e9%9b%86%e7%be%a4%e5%87%ba%e7%8e%b0%e5%a4%a7%e9%87%8f%e8%b6%85%e6%97%b6%e5%90%84%e7%a7%8d%e6%8a%98%e8%85%be%e5%88%87%e6%8d%a2%e4%ba%91%e7%9b%98%e7%b1%bb%e5%9e%8b%e5%88%87%e6%8d%a2%e9%83%a8%e7%bd%b2%e7%8e%af%e5%a2%83%e8%b0%83%e6%95%b4%e5%8f%82%e6%95%b0%e9%83%bd%e4%b8%8d%e5%8f%91%e6%8c%a5%e4%bd%9c%e7%94%a8%e6%94%b6%e5%88%b0%e6%b1%82%e5%8a%a9%e5%90%8e%e7%b4%a2%e8%a6%81metrics%e5%92%8c%e6%97%a5%e5%bf%97%e5%90%8e%e7%bb%8f%e8%bf%87%e4%b8%80%e7%95%aa%e6%8e%92%e6%9f%a5%e5%90%8e%e5%be%97%e5%88%b0%e4%bb%a5%e4%b8%8b%e7%bb%93%e8%ae%ba>#</a></h5><ul><li><h5 id=现象的确很诡异db延时相关指标显示没任何异常日志无任何有效信息>现象的确很诡异，db延时相关指标显示没任何异常,日志无任何有效信息
<a class=anchor href=#%e7%8e%b0%e8%b1%a1%e7%9a%84%e7%a1%ae%e5%be%88%e8%af%a1%e5%bc%82db%e5%bb%b6%e6%97%b6%e7%9b%b8%e5%85%b3%e6%8c%87%e6%a0%87%e6%98%be%e7%a4%ba%e6%b2%a1%e4%bb%bb%e4%bd%95%e5%bc%82%e5%b8%b8%e6%97%a5%e5%bf%97%e6%97%a0%e4%bb%bb%e4%bd%95%e6%9c%89%e6%95%88%e4%bf%a1%e6%81%af>#</a></h5></li><li><h5 id=业务反馈大量读请求超时甚至可以通过etcdctl客户端工具简单复现可是metric对应的读请求相关指标数竟然是0>业务反馈大量读请求超时，甚至可以通过etcdctl客户端工具简单复现，可是metric对应的读请求相关指标数竟然是0
<a class=anchor href=#%e4%b8%9a%e5%8a%a1%e5%8f%8d%e9%a6%88%e5%a4%a7%e9%87%8f%e8%af%bb%e8%af%b7%e6%b1%82%e8%b6%85%e6%97%b6%e7%94%9a%e8%87%b3%e5%8f%af%e4%bb%a5%e9%80%9a%e8%bf%87etcdctl%e5%ae%a2%e6%88%b7%e7%ab%af%e5%b7%a5%e5%85%b7%e7%ae%80%e5%8d%95%e5%a4%8d%e7%8e%b0%e5%8f%af%e6%98%afmetric%e5%af%b9%e5%ba%94%e7%9a%84%e8%af%bb%e8%af%b7%e6%b1%82%e7%9b%b8%e5%85%b3%e6%8c%87%e6%a0%87%e6%95%b0%e7%ab%9f%e7%84%b6%e6%98%af0>#</a></h5></li><li><h5 id=引导用户开启trace日志和metrics开启extensive模式开启后发现无任何trace日志然而开启extensive后我发现耗时竟然全部花在了authenticate接口业务反馈是通过密码鉴权而不是基于证书的鉴权>引导用户开启trace日志和metrics开启extensive模式，开启后发现无任何trace日志，然而开启extensive后，我发现耗时竟然全部花在了Authenticate接口，业务反馈是通过密码鉴权，而不是基于证书的鉴权
<a class=anchor href=#%e5%bc%95%e5%af%bc%e7%94%a8%e6%88%b7%e5%bc%80%e5%90%aftrace%e6%97%a5%e5%bf%97%e5%92%8cmetrics%e5%bc%80%e5%90%afextensive%e6%a8%a1%e5%bc%8f%e5%bc%80%e5%90%af%e5%90%8e%e5%8f%91%e7%8e%b0%e6%97%a0%e4%bb%bb%e4%bd%95trace%e6%97%a5%e5%bf%97%e7%84%b6%e8%80%8c%e5%bc%80%e5%90%afextensive%e5%90%8e%e6%88%91%e5%8f%91%e7%8e%b0%e8%80%97%e6%97%b6%e7%ab%9f%e7%84%b6%e5%85%a8%e9%83%a8%e8%8a%b1%e5%9c%a8%e4%ba%86authenticate%e6%8e%a5%e5%8f%a3%e4%b8%9a%e5%8a%a1%e5%8f%8d%e9%a6%88%e6%98%af%e9%80%9a%e8%bf%87%e5%af%86%e7%a0%81%e9%89%b4%e6%9d%83%e8%80%8c%e4%b8%8d%e6%98%af%e5%9f%ba%e4%ba%8e%e8%af%81%e4%b9%a6%e7%9a%84%e9%89%b4%e6%9d%83>#</a></h5></li><li><h5 id=尝试让业务同学短暂关闭鉴权测试业务是否恢复业务同学找了一个节点关闭鉴权后此节点立刻恢复了正常于是选择临时通过关闭鉴权来恢复现网业务>尝试让业务同学短暂关闭鉴权测试业务是否恢复，业务同学找了一个节点关闭鉴权后，此节点立刻恢复了正常，于是选择临时通过关闭鉴权来恢复现网业务
<a class=anchor href=#%e5%b0%9d%e8%af%95%e8%ae%a9%e4%b8%9a%e5%8a%a1%e5%90%8c%e5%ad%a6%e7%9f%ad%e6%9a%82%e5%85%b3%e9%97%ad%e9%89%b4%e6%9d%83%e6%b5%8b%e8%af%95%e4%b8%9a%e5%8a%a1%e6%98%af%e5%90%a6%e6%81%a2%e5%a4%8d%e4%b8%9a%e5%8a%a1%e5%90%8c%e5%ad%a6%e6%89%be%e4%ba%86%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e5%85%b3%e9%97%ad%e9%89%b4%e6%9d%83%e5%90%8e%e6%ad%a4%e8%8a%82%e7%82%b9%e7%ab%8b%e5%88%bb%e6%81%a2%e5%a4%8d%e4%ba%86%e6%ad%a3%e5%b8%b8%e4%ba%8e%e6%98%af%e9%80%89%e6%8b%a9%e4%b8%b4%e6%97%b6%e9%80%9a%e8%bf%87%e5%85%b3%e9%97%ad%e9%89%b4%e6%9d%83%e6%9d%a5%e6%81%a2%e5%a4%8d%e7%8e%b0%e7%bd%91%e4%b8%9a%e5%8a%a1>#</a></h5></li><li><h5 id=那鉴权为什么耗时这么慢我们对可疑之处增加了日志打印了鉴权各个步骤的耗时结果发现是在等待锁的过程中出现了超时而这个锁为什么耗时这么久呢排查发现是因为加锁过程中会调用bcrpt加密函数计算密码hash值每次耗费60ms左右数百并发下等待此锁的最高耗时高达5s>那鉴权为什么耗时这么慢？我们对可疑之处增加了日志，打印了鉴权各个步骤的耗时，结果发现是在等待锁的过程中出现了超时，而这个锁为什么耗时这么久呢？排查发现是因为加锁过程中会调用bcrpt加密函数计算密码hash值，每次耗费60ms左右，数百并发下等待此锁的最高耗时高达5s+。
<a class=anchor href=#%e9%82%a3%e9%89%b4%e6%9d%83%e4%b8%ba%e4%bb%80%e4%b9%88%e8%80%97%e6%97%b6%e8%bf%99%e4%b9%88%e6%85%a2%e6%88%91%e4%bb%ac%e5%af%b9%e5%8f%af%e7%96%91%e4%b9%8b%e5%a4%84%e5%a2%9e%e5%8a%a0%e4%ba%86%e6%97%a5%e5%bf%97%e6%89%93%e5%8d%b0%e4%ba%86%e9%89%b4%e6%9d%83%e5%90%84%e4%b8%aa%e6%ad%a5%e9%aa%a4%e7%9a%84%e8%80%97%e6%97%b6%e7%bb%93%e6%9e%9c%e5%8f%91%e7%8e%b0%e6%98%af%e5%9c%a8%e7%ad%89%e5%be%85%e9%94%81%e7%9a%84%e8%bf%87%e7%a8%8b%e4%b8%ad%e5%87%ba%e7%8e%b0%e4%ba%86%e8%b6%85%e6%97%b6%e8%80%8c%e8%bf%99%e4%b8%aa%e9%94%81%e4%b8%ba%e4%bb%80%e4%b9%88%e8%80%97%e6%97%b6%e8%bf%99%e4%b9%88%e4%b9%85%e5%91%a2%e6%8e%92%e6%9f%a5%e5%8f%91%e7%8e%b0%e6%98%af%e5%9b%a0%e4%b8%ba%e5%8a%a0%e9%94%81%e8%bf%87%e7%a8%8b%e4%b8%ad%e4%bc%9a%e8%b0%83%e7%94%a8bcrpt%e5%8a%a0%e5%af%86%e5%87%bd%e6%95%b0%e8%ae%a1%e7%ae%97%e5%af%86%e7%a0%81hash%e5%80%bc%e6%af%8f%e6%ac%a1%e8%80%97%e8%b4%b960ms%e5%b7%a6%e5%8f%b3%e6%95%b0%e7%99%be%e5%b9%b6%e5%8f%91%e4%b8%8b%e7%ad%89%e5%be%85%e6%ad%a4%e9%94%81%e7%9a%84%e6%9c%80%e9%ab%98%e8%80%97%e6%97%b6%e9%ab%98%e8%be%be5s>#</a></h5></li><li><h5 id=于是我们编写新版本将锁的范围减少降低持锁阻塞时间用户使用新版本后开启鉴权后业务不再超时恢复正常>于是我们编写新版本将锁的范围减少，降低持锁阻塞时间，用户使用新版本后，开启鉴权后，业务不再超时，恢复正常。
<a class=anchor href=#%e4%ba%8e%e6%98%af%e6%88%91%e4%bb%ac%e7%bc%96%e5%86%99%e6%96%b0%e7%89%88%e6%9c%ac%e5%b0%86%e9%94%81%e7%9a%84%e8%8c%83%e5%9b%b4%e5%87%8f%e5%b0%91%e9%99%8d%e4%bd%8e%e6%8c%81%e9%94%81%e9%98%bb%e5%a1%9e%e6%97%b6%e9%97%b4%e7%94%a8%e6%88%b7%e4%bd%bf%e7%94%a8%e6%96%b0%e7%89%88%e6%9c%ac%e5%90%8e%e5%bc%80%e5%90%af%e9%89%b4%e6%9d%83%e5%90%8e%e4%b8%9a%e5%8a%a1%e4%b8%8d%e5%86%8d%e8%b6%85%e6%97%b6%e6%81%a2%e5%a4%8d%e6%ad%a3%e5%b8%b8>#</a></h5></li><li><h5 id=随后我们将修复方案提交给了社区并编写了压测工具测试提升后的性能高达近12倍8核32g机器从18s提升到202s但是依然是比较慢主要是鉴权过程中涉及密码校验计算-社区上也有用户反馈密码鉴权慢问题-目前最新的v349版本已经包含此优化-同时可以通过调整bcrpt-cost参数来进一步提升性能>随后我们将修复方案提交给了社区，并编写了压测工具，测试提升后的性能高达近12倍（8核32G机器，从18/s提升到202/s），但是依然是比较慢，主要是鉴权过程中涉及密码校验计算, 社区上也有用户反馈密码鉴权慢问题, 目前最新的v3.4.9版本已经包含此优化, 同时可以通过调整bcrpt-cost参数来进一步提升性能。
<a class=anchor href=#%e9%9a%8f%e5%90%8e%e6%88%91%e4%bb%ac%e5%b0%86%e4%bf%ae%e5%a4%8d%e6%96%b9%e6%a1%88%e6%8f%90%e4%ba%a4%e7%bb%99%e4%ba%86%e7%a4%be%e5%8c%ba%e5%b9%b6%e7%bc%96%e5%86%99%e4%ba%86%e5%8e%8b%e6%b5%8b%e5%b7%a5%e5%85%b7%e6%b5%8b%e8%af%95%e6%8f%90%e5%8d%87%e5%90%8e%e7%9a%84%e6%80%a7%e8%83%bd%e9%ab%98%e8%be%be%e8%bf%9112%e5%80%8d8%e6%a0%b832g%e6%9c%ba%e5%99%a8%e4%bb%8e18s%e6%8f%90%e5%8d%87%e5%88%b0202s%e4%bd%86%e6%98%af%e4%be%9d%e7%84%b6%e6%98%af%e6%af%94%e8%be%83%e6%85%a2%e4%b8%bb%e8%a6%81%e6%98%af%e9%89%b4%e6%9d%83%e8%bf%87%e7%a8%8b%e4%b8%ad%e6%b6%89%e5%8f%8a%e5%af%86%e7%a0%81%e6%a0%a1%e9%aa%8c%e8%ae%a1%e7%ae%97-%e7%a4%be%e5%8c%ba%e4%b8%8a%e4%b9%9f%e6%9c%89%e7%94%a8%e6%88%b7%e5%8f%8d%e9%a6%88%e5%af%86%e7%a0%81%e9%89%b4%e6%9d%83%e6%85%a2%e9%97%ae%e9%a2%98-%e7%9b%ae%e5%89%8d%e6%9c%80%e6%96%b0%e7%9a%84v349%e7%89%88%e6%9c%ac%e5%b7%b2%e7%bb%8f%e5%8c%85%e5%90%ab%e6%ad%a4%e4%bc%98%e5%8c%96-%e5%90%8c%e6%97%b6%e5%8f%af%e4%bb%a5%e9%80%9a%e8%bf%87%e8%b0%83%e6%95%b4bcrpt-cost%e5%8f%82%e6%95%b0%e6%9d%a5%e8%bf%9b%e4%b8%80%e6%ad%a5%e6%8f%90%e5%8d%87%e6%80%a7%e8%83%bd>#</a></h5></li></ul><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202403011122488.png alt=image-20240301112202437></p><h2 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h2><h5 id=本文简单描述了我们在管理万级k8s集群和其他业务过程中遇到的etcd稳定性和性能挑战以及我们是如何定位分析复现解决这些挑战并将解决方案贡献给社区>本文简单描述了我们在管理万级K8s集群和其他业务过程中遇到的etcd稳定性和性能挑战，以及我们是如何定位、分析、复现、解决这些挑战，并将解决方案贡献给社区。
<a class=anchor href=#%e6%9c%ac%e6%96%87%e7%ae%80%e5%8d%95%e6%8f%8f%e8%bf%b0%e4%ba%86%e6%88%91%e4%bb%ac%e5%9c%a8%e7%ae%a1%e7%90%86%e4%b8%87%e7%ba%a7k8s%e9%9b%86%e7%be%a4%e5%92%8c%e5%85%b6%e4%bb%96%e4%b8%9a%e5%8a%a1%e8%bf%87%e7%a8%8b%e4%b8%ad%e9%81%87%e5%88%b0%e7%9a%84etcd%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%92%8c%e6%80%a7%e8%83%bd%e6%8c%91%e6%88%98%e4%bb%a5%e5%8f%8a%e6%88%91%e4%bb%ac%e6%98%af%e5%a6%82%e4%bd%95%e5%ae%9a%e4%bd%8d%e5%88%86%e6%9e%90%e5%a4%8d%e7%8e%b0%e8%a7%a3%e5%86%b3%e8%bf%99%e4%ba%9b%e6%8c%91%e6%88%98%e5%b9%b6%e5%b0%86%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e8%b4%a1%e7%8c%ae%e7%bb%99%e7%a4%be%e5%8c%ba>#</a></h5><h5 id=同时详细描述了我们从这些挑战中收获了哪些宝贵的经验和教训并将之应用到后续的etcd稳定性保障中以支持更大规模的单集群和总集群数>同时，详细描述了我们从这些挑战中收获了哪些宝贵的经验和教训，并将之应用到后续的etcd稳定性保障中，以支持更大规模的单集群和总集群数。
<a class=anchor href=#%e5%90%8c%e6%97%b6%e8%af%a6%e7%bb%86%e6%8f%8f%e8%bf%b0%e4%ba%86%e6%88%91%e4%bb%ac%e4%bb%8e%e8%bf%99%e4%ba%9b%e6%8c%91%e6%88%98%e4%b8%ad%e6%94%b6%e8%8e%b7%e4%ba%86%e5%93%aa%e4%ba%9b%e5%ae%9d%e8%b4%b5%e7%9a%84%e7%bb%8f%e9%aa%8c%e5%92%8c%e6%95%99%e8%ae%ad%e5%b9%b6%e5%b0%86%e4%b9%8b%e5%ba%94%e7%94%a8%e5%88%b0%e5%90%8e%e7%bb%ad%e7%9a%84etcd%e7%a8%b3%e5%ae%9a%e6%80%a7%e4%bf%9d%e9%9a%9c%e4%b8%ad%e4%bb%a5%e6%94%af%e6%8c%81%e6%9b%b4%e5%a4%a7%e8%a7%84%e6%a8%a1%e7%9a%84%e5%8d%95%e9%9b%86%e7%be%a4%e5%92%8c%e6%80%bb%e9%9b%86%e7%be%a4%e6%95%b0>#</a></h5><p>最后我们<strong>面对万级K8s集群数, 千级的etcd集群数, 10几个版本分布，其中不少低版本包含重要的潜在可能触发的严重bug, 我们还需要投入大量工作不断优化我们的etcd平台</strong>，使其更智能、变更更加高效、安全、可控（如支持自动化、可控的集群升级等）, 同时数据安全也至关重要，<strong>目前腾讯云TKE托管集群我们已经全面备份，独立集群的用户后续将引导通过应用市场的etcd备份插件开启定时备份到腾讯云对象存储COS上。</strong></p><p>未来我们将继续紧密融入etcd的社区，为etcd社区的发展贡献我们的力量，与社区一块提升etcd的各个功能。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#背景与挑战>背景与挑战</a></li><li><a href=#稳定性优化案例剖析>稳定性优化案例剖析</a><ul><li><a href=#数据不一致data-inconsistency><strong>数据不一致（Data Inconsistency）</strong></a></li><li><a href=#内存泄露oom><strong>内存泄露（OOM）</strong></a></li><li><a href=#存储层死锁mvcc-deadlock><strong>存储层死锁（Mvcc Deadlock）</strong></a></li><li><a href=#wal-crashpanic><strong>Wal crash（Panic）</strong></a></li><li><a href=#配额及限速quotaqos><strong>配额及限速（Quota&amp;QoS）</strong></a></li></ul></li><li><a href=#性能优化案例剖析>性能优化案例剖析</a><ul><li></li><li><a href=#启动耗时及查询key数量查询指定记录数性能优化><strong>启动耗时及查询key数量、查询指定记录数性能优化</strong></a></li><li><a href=#密码鉴权性能提升12倍><strong>密码鉴权性能提升12倍</strong></a></li></ul></li><li><a href=#总结>总结</a><ul><li></li></ul></li></ul></nav></div></aside></main></body></html>