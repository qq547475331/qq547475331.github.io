<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  一文学会Calico网络自定义
  #


  一、确定最佳的网络选项
  #

Calico支持多个容器网络选项，用于可伸缩性、网络性能和与现有基础设施的互操作性。

  1. 值
  #

不同的网络实现更适合不同的环境。Calico提供了几种不需要封装的基于IP路由的网络实现。如果您的部署需要封装，Calico提供覆盖网络(IP in IP或VXLAN)。Calico还支持使用其他Kubernetes网络选项来执行策略。本文档帮助您为集群选择最佳的网络选项。

  2. 概念
  #


  2.1 关于calico networking
  #

Calico提供了一些方法，允许pod连接到其他pod、主机和外部网络(例如internet)。
Calico网络：

使用Calico的IP地址管理(IPAM)将IP地址分配给pods
编写本地节点的路由表
将路由分配给其他节点和网络设备


  2.2 关于BGP
  #

Calico支持使用边界网关协议(BGP)将路由信息共享到网络中。Calico支持节点到节点的全网格部署(有和没有路由反射器)，以及BGP直接对机架(ToR)路由器顶部的现场部署;允许流量直接路由到工作负载，而不需要NAT或封装。

  2.3 其它Kubernetes 网络选项
  #

Calico可以使用许多其他Kubernetes网络选项执行网络策略强制。

Flannel
Amazon AWS VPC CNI
Azure CNI
Google cloud networking

下表显示了使用Calico时常见的网络选项。

网络选项

  3. 基本说明
  #

本节提供更多关于Calico的内置网络选项的细节:

Unencapsulated, peered with physical infrastructure
Unencapsulated, not peered with physical infrastructure
IP in IP or VXLAN encapsulation


  3.1 Unencapsulated, peered with physical infrastructure
  #

Calico可以与你的路由器使用BGP对等。这提供了出色的性能和易于调试的非封装流量，以及广泛的网络拓扑和连接选项。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://qq547475331.github.io/docs/calico%E7%BD%91%E7%BB%9C%E8%87%AA%E5%AE%9A%E4%B9%89-calico-wang-luo-zi-ding-yi/"><meta property="og:site_name" content="Guichen's Blog"><meta property="og:title" content="2024-04-03 Calico网络自定义"><meta property="og:description" content="一文学会Calico网络自定义 # 一、确定最佳的网络选项 # Calico支持多个容器网络选项，用于可伸缩性、网络性能和与现有基础设施的互操作性。
1. 值 # 不同的网络实现更适合不同的环境。Calico提供了几种不需要封装的基于IP路由的网络实现。如果您的部署需要封装，Calico提供覆盖网络(IP in IP或VXLAN)。Calico还支持使用其他Kubernetes网络选项来执行策略。本文档帮助您为集群选择最佳的网络选项。
2. 概念 # 2.1 关于calico networking # Calico提供了一些方法，允许pod连接到其他pod、主机和外部网络(例如internet)。
Calico网络：
使用Calico的IP地址管理(IPAM)将IP地址分配给pods 编写本地节点的路由表 将路由分配给其他节点和网络设备 2.2 关于BGP # Calico支持使用边界网关协议(BGP)将路由信息共享到网络中。Calico支持节点到节点的全网格部署(有和没有路由反射器)，以及BGP直接对机架(ToR)路由器顶部的现场部署;允许流量直接路由到工作负载，而不需要NAT或封装。
2.3 其它Kubernetes 网络选项 # Calico可以使用许多其他Kubernetes网络选项执行网络策略强制。
Flannel Amazon AWS VPC CNI Azure CNI Google cloud networking 下表显示了使用Calico时常见的网络选项。
网络选项
3. 基本说明 # 本节提供更多关于Calico的内置网络选项的细节:
Unencapsulated, peered with physical infrastructure Unencapsulated, not peered with physical infrastructure IP in IP or VXLAN encapsulation 3.1 Unencapsulated, peered with physical infrastructure # Calico可以与你的路由器使用BGP对等。这提供了出色的性能和易于调试的非封装流量，以及广泛的网络拓扑和连接选项。"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>2024-04-03 Calico网络自定义 | Guichen's Blog</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://qq547475331.github.io/docs/calico%E7%BD%91%E7%BB%9C%E8%87%AA%E5%AE%9A%E4%B9%89-calico-wang-luo-zi-ding-yi/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.6aba36266e2246fa3160d5a6274f368c78cdd25abc4193444422f3f77150ad74.js integrity="sha256-aro2Jm4iRvoxYNWmJ082jHjN0lq8QZNERCLz93FQrXQ=" crossorigin=anonymous></script></head><script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){mermaid.initialize({startOnLoad:!0});let e=document.querySelectorAll("pre > code.language-mermaid");e.forEach(e=>{let t=document.createElement("div");t.classList.add("mermaid"),t.innerHTML=e.innerText,e.parentNode.replaceWith(t)}),mermaid.init(void 0,document.querySelectorAll(".mermaid"))})</script><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Guichen's Blog</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/docs/%E4%BD%BF%E7%94%A8-keepalived-%E5%92%8C-haproxy-%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8-kubernetes-%E9%9B%86%E7%BE%A4-shi-yong-keepalived-he-haproxy-chuang-jian-gao-ke-yong-kubernetes-ji-qun/>2023-04-12 使用 Keepalived 和 HAproxy 创建高可用 Kubernetes 集群</a></li><li><a href=/docs/%E6%9C%89%E8%BF%993%E4%B8%AA%E8%BF%B9%E8%B1%A1%E4%BD%A0%E5%B0%B1%E8%AF%A5%E7%A6%BB%E8%81%8C%E4%BA%86-you-zhe-3-ge-ji-xiang--ni-jiu-gai-li-zhi-le/>2023-09-21 思考</a></li><li><a href=/docs/01-%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6%E5%92%8C%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-01--chuang-jian-zheng-shu-he-huan-jing-zhun-bei/>2023-09-28 01-创建证书和环境准备</a></li><li><a href=/docs/03-%E5%AE%89%E8%A3%85%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6-03--an-zhuang-rong-qi-yun-xing-shi/>2023-09-28 03-安装容器运行时</a></li><li><a href=/docs/04-%E5%AE%89%E8%A3%85kube_master%E8%8A%82%E7%82%B9-04--an-zhuang-kubemaster-jie-dian/>2023-09-28 04-安装kube_master节点</a></li><li><a href=/docs/05-%E5%AE%89%E8%A3%85kube_node%E8%8A%82%E7%82%B9-05--an-zhuang-kubenode-jie-dian/>2023-09-28 05-安装kube_node节点</a></li><li><a href=/docs/00-%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%92%8C%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E8%AE%BE%E5%AE%9A-00--ji-qun-gui-hua-he-ji-chu-can-shu-she-ding/>2023-09-28 00-集群规划和基础参数设定</a></li><li><a href=/docs/02-%E5%AE%89%E8%A3%85etcd%E9%9B%86%E7%BE%A4-02--an-zhuang-etcd-ji-qun/>2023-09-28 02-安装etcd集群</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85calico%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-calico-wang-luo-zu-jian/>2023-09-28 06-安装calico网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85cilium%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-cilium-wang-luo-zu-jian/>2023-09-28 06-安装cilium网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85flannel%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-flannel-wang-luo-zu-jian/>2023-09-28 06-安装flannel网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85kube-ovn%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-kube-ovn-wang-luo-zu-jian/>2023-09-28 06-安装kube-ovn网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-wang-luo-zu-jian/>2023-09-28 06-安装网络组件</a></li><li><a href=/docs/08-k8s-%E9%9B%86%E7%BE%A4%E5%AD%98%E5%82%A8--k8s-ji-qun-cun-chu/>2023-09-28 08-K8S 集群存储</a></li><li><a href=/docs/07-%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4%E4%B8%BB%E8%A6%81%E6%8F%92%E4%BB%B6-07--an-zhuang-ji-qun-zhu-yao-cha-jian/>2023-09-28 15:26:42.651 07-安装集群主要插件</a></li><li><a href=/docs/calico-%E9%85%8D%E7%BD%AE-bgp-route-reflectors-calico-pei-zhi-bgproutereflectors/>2023-09-28 calico 配置 BGP Route Reflectors</a></li><li><a href=/docs/ex-lb-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%83%A8%E7%BD%B2-ex-lb-fu-zai-jun-heng-bu-shu/>2023-09-28 EX-LB 负载均衡部署</a></li><li><a href=/docs/ezctl-%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BB%8B%E7%BB%8D-ezctl-ming-ling-xing-jie-shao/>2023-09-28 ezctl 命令行介绍</a></li><li><a href=/docs/kube-router-%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-kube-router-wang-luo-zu-jian/>2023-09-28 kube-router 网络组件</a></li><li><a href=/docs/network-check-network-check/>2023-09-28 network-check</a></li><li><a href=/docs/%E4%B8%AA%E6%80%A7%E5%8C%96%E9%9B%86%E7%BE%A4%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE-ge-xing-hua-ji-qun-can-shu-pei-zhi/>2023-09-28 个性化集群参数配置</a></li><li><a href=/docs/%E5%85%AC%E6%9C%89%E4%BA%91%E4%B8%8A%E9%83%A8%E7%BD%B2-kubeasz-gong-you-yun-shang-bu-shu-kubeasz/>2023-09-28 公有云上部署</a></li><li><a href=/docs/%E5%A4%9A%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81-duo-jia-gou-zhi-chi/>2023-09-28 多架构支持</a></li><li><a href=/docs/%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8-cilium-kai-shi-shi-yong-cilium/>2023-09-28 开始使用 cilium</a></li><li><a href=/docs/%E5%BF%AB%E9%80%9F%E6%8C%87%E5%8D%97-kuai-su-zhi-nan/>2023-09-28 快速指南</a></li><li><a href=/docs/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%B4%E6%98%8E-cao-zuo-xi-tong-shuo-ming/>2023-09-28 操作系统说明</a></li><li><a href=/docs/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4-li-xian-an-zhuang-ji-qun/>2023-09-28 离线安装集群</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8-openfunction-%E5%9C%A8%E4%BB%BB%E4%BD%95%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E4%B8%8A%E8%BF%90%E8%A1%8C%E6%97%A0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD-shi-yong-openfunction-zai-ren-he-ji-chu-she-shi-shang-yun-xing-wu-fu-wu-qi-gong-zuo-fu-zai/>2024-01-21 使用 OpenFunction 在任何基础设施上运行无服务器工作负载</a></li><li><a href=/docs/k8s-cni%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B-k8scni-pou-xi-yan-jin/>2024-03-04 K8S CNI剖析演进</a></li><li><a href=/docs/k8s-csi%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B-k8scsi-pou-xi-yan-jin/>2024-03-04 K8S CSI剖析演进</a></li><li><a href=/docs/k8s-%E6%B5%81%E9%87%8F%E9%93%BE%E8%B7%AF%E5%89%96%E6%9E%90-k8s-liu-liang-lian-lu-pou-xi/>2024-03-04 K8S 流量链路剖析</a></li><li><a href=/docs/k8s%E4%B9%8Bkubelet%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-zhi-kubelet-yuan-ma-jie-du/>2024-03-28 k8s之kubelet源码解读</a></li><li><a href=/docs/16%E5%BC%A0%E7%A1%AC%E6%A0%B8%E5%9B%BE%E8%A7%A3k8s%E7%BD%91%E7%BB%9C-16-zhang-ying-he-tu-jie-k8s-wang-luo/>2024-04-03 16张硬核图解k8s网络</a></li><li><a href=/docs/600%E6%9D%A1%E6%9C%80%E5%BC%BAlinux%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-600-tiao-zui-qiang-linux-ming-ling-zong-jie/>2024-04-03 600条最强linux命令总结</a></li><li><a href=/docs/%E9%9D%A2%E8%AF%950308-mian-shi-0308/>2024-04-03 面试0308</a></li><li><a href=/docs/16%E4%B8%AA%E6%A6%82%E5%BF%B5%E5%B8%A6%E4%BD%A0%E5%85%A5%E9%97%A8-kubernetes-16-ge-gai-nian-dai-ni-ru-men-kubernetes/>2024-04-03 16个概念带你入门 Kubernetes</a></li><li><a href=/docs/acme%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E8%AF%81%E4%B9%A6-acme-zi-dong-geng-xin-zheng-shu/>2024-04-03 acme自动更新证书</a></li><li><a href=/docs/calico%E7%BD%91%E7%BB%9C%E8%87%AA%E5%AE%9A%E4%B9%89-calico-wang-luo-zi-ding-yi/ class=active>2024-04-03 Calico网络自定义</a></li><li><a href=/docs/cicd%E6%80%9D%E8%80%83-cicd-si-kao/>2024-04-03 CICD思考</a></li><li><a href=/docs/client-go-%E5%9B%9B%E7%A7%8D%E5%AE%A2%E6%88%B7%E7%AB%AF-client-go-si-zhong-ke-hu-duan/>2024-04-03 Client-go 四种客户端</a></li><li><a href=/docs/client-go-%E6%9E%B6%E6%9E%84-client-go-jia-gou/>2024-04-03 Client-go 架构</a></li><li><a href=/docs/cni%E6%8F%92%E4%BB%B6%E9%80%89%E5%9E%8B-cni-cha-jian-xuan-xing/>2024-04-03 CNI插件选型</a></li><li><a href=/docs/containerd-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-containerd-ji-ben-cao-zuo/>2024-04-03 Containerd 基本操作</a></li><li><a href=/docs/coredns%E4%B9%8B%E5%85%89-coredns-zhi-guang/>2024-04-03 COREDNS之光</a></li><li><a href=/docs/dockerfile%E7%9A%84copy%E5%92%8Cadd%E7%9A%84%E5%8C%BA%E5%88%AB-dockerfile-de-copy-he-add-de-qu-bie/>2024-04-03 dockerfile的copy和add的区别</a></li><li><a href=/docs/docker%E9%87%8D%E8%A6%81%E7%9A%84%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E7%82%B9-docker-zhong-yao-de-wang-luo-zhi-shi-dian/>2024-04-03 Docker重要的网络知识点</a></li><li><a href=/docs/etcd%E5%A4%87%E4%BB%BD-etcd-bei-fen/>2024-04-03 ETCD备份</a></li><li><a href=/docs/etcd%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%8F%8A%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5-etcd-wen-ding-xing-ji-xing-neng-you-hua-shi-jian/>2024-04-03 ETCD稳定性及性能优化实践</a></li><li><a href=/docs/flanel%E7%BD%91%E7%BB%9C-flanel-wang-luo/>2024-04-03 flanel网络</a></li><li><a href=/docs/helm-chart%E5%92%8Crepo-helmchart-he-repo/>2024-04-03 helm chart和repo</a></li><li><a href=/docs/k8s-csi-openebs%E5%8E%9F%E7%90%86-k8scsiopenebs-yuan-li/>2024-04-03 K8S csi openebs原理</a></li><li><a href=/docs/k8s-gpt-k8sgpt/>2024-04-03 K8S GPT</a></li><li><a href=/docs/k8s-%E5%BC%80%E5%8F%91%E5%8F%AF%E4%B8%8D%E6%AD%A2-crud-k8s-kai-fa-ke-bu-zhi-crud/>2024-04-03 K8S 开发可不止 CRUD</a></li><li><a href=/docs/k8s-%E6%8E%A2%E9%92%88%E5%8E%9F%E7%90%86-k8s-tan-zhen-yuan-li/>2024-04-03 K8S 探针原理</a></li><li><a href=/docs/k8s%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7-k8s-yuan-de-sheng-ji/>2024-04-03 K8S原地升级</a></li><li><a href=/docs/k8s%E5%91%BD%E4%BB%A4%E6%8C%87%E5%8D%97-k8s-ming-ling-zhi-nan/>2024-04-03 K8S命令指南</a></li><li><a href=/docs/k8s%E5%BA%94%E7%94%A8%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-k8s-ying-yong-de-zui-jia-shi-jian/>2024-04-03 k8s应用的最佳实践</a></li><li><a href=/docs/k8s%E7%9A%84pod%E7%B1%BB%E5%9E%8B-k8s-de-pod-lei-xing/>2024-04-03 K8S的POD类型</a></li><li><a href=/docs/k8s%E8%B0%83%E8%AF%95pod-k8s-diao-shi-pod/>2024-04-03 K8S调试POD</a></li><li><a href=/docs/k8s%E8%BF%90%E7%BB%B4%E4%B9%8B%E6%B8%85%E7%90%86%E7%A3%81%E7%9B%98-k8s-yun-wei-zhi-qing-li-ci-pan/>2024-04-03 k8s运维之清理磁盘</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E5%A4%A7%E5%85%A8-k8s-mian-shi-da-quan/>2024-04-03 K8S面试大全</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E5%AE%9D%E5%85%B8-k8s-mian-shi-bao-dian/>2024-04-03 K8S面试宝典</a></li><li><a href=/docs/kubekey%E6%B7%BB%E5%8A%A0%E6%96%B0%E8%8A%82%E7%82%B9-kubekey-tian-jia-xin-jie-dian/>2024-04-03 kubekey添加新节点</a></li><li><a href=/docs/kubernetes-api-kubernetesapi/>2024-04-03 Kubernetes API</a></li><li><a href=/docs/kubernetes-%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84-kubernetes-yuan-ma-jie-gou/>2024-04-03 Kubernetes 源码结构</a></li><li><a href=/docs/kubernetes-%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3%E8%AE%A4%E8%AF%81-kubernetes-zheng-shu-xiang-jie--ren-zheng-/>2024-04-03 Kubernetes 证书详解(认证)</a></li><li><a href=/docs/kubernetes-%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3%E9%89%B4%E6%9D%83-kubernetes-zheng-shu-xiang-jie--jian-quan-/>2024-04-03 Kubernetes 证书详解(鉴权)</a></li><li><a href=/docs/linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%A4%A7%E5%85%A8-linux-xing-neng-you-hua-da-quan/>2024-04-03 Linux 性能优化大全</a></li><li><a href=/docs/metallb-l2-%E5%8E%9F%E7%90%86-metallbl2-yuan-li/>2024-04-03 MetalLB L2 原理</a></li><li><a href=/docs/prometheus%E4%BC%81%E4%B8%9A%E7%BA%A7%E7%9B%91%E6%8E%A7%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93-prometheus-qi-ye-ji-jian-kong-shi-yong-zong-jie/>2024-04-03 prometheus企业级监控使用总结</a></li><li><a href=/docs/ssl%E8%AF%81%E4%B9%A6%E8%87%AA%E7%AD%BE%E5%8F%91-ssl-zheng-shu-zi-qian-fa/>2024-04-03 ssl证书自签发</a></li><li><a href=/docs/%E4%B8%A4%E5%BC%A0%E5%9B%BE%E5%85%A8%E9%9D%A2%E7%90%86%E8%A7%A3k8s%E5%8E%9F%E7%90%86-liang-zhang-tu-quan-mian-li-jie-k8s-yuan-li/>2024-04-03 两张图全面理解K8S原理</a></li><li><a href=/docs/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2k8s%E5%8A%A0%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C-er-jin-zhi-bu-shu-k8s-jia-jie-dian-cao-zuo/>2024-04-03 二进制部署K8S加节点操作</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8kubernees-leases-%E8%BD%BB%E6%9D%BE%E5%AE%9E%E7%8E%B0leader-election-shi-yong-kuberneesleases-qing-song-shi-xian-leaderelection/>2024-04-03 使用kubernees leases 轻松实现leader election</a></li><li><a href=/docs/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%B9%B6%E5%8F%91%E4%B8%8B%E5%A6%82%E4%BD%95%E5%8A%A0%E5%BF%AB-pod-%E5%90%AF%E5%8A%A8%E9%80%9F%E5%BA%A6-da-gui-mo-bing-fa-xia-ru-he-jia-kuai-pod-qi-dong-su-du/>2024-04-03 大规模并发下如何加快 Pod 启动速度</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8tekton%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BAcicd%E5%B9%B3%E5%8F%B0-ru-he-shi-yong-tekton-kuai-su-da-jian-cicd-ping-tai/>2024-04-03 如何使用tekton快速搭建CI/CD平台</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95-crash-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C-ru-he-diao-shi-crash-rong-qi-de-wang-luo/>2024-04-03 如何调试 crash 容器的网络</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E4%BB%A5%E5%8F%8A%E4%B8%8D%E5%90%8Cdnspolicy%E5%AF%B9%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E7%9A%84%E5%BD%B1%E5%93%8D-rong-qi-zhong-yu-ming-jie-xi-yi-ji-bu-tong-dnspolicy-dui-yu-ming-jie-xi-de-ying-xiang/>2024-04-03 容器中域名解析以及不同dnspolicy对域名解析的影响</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E5%86%85%E7%9A%84-1-%E5%8F%B7%E8%BF%9B%E7%A8%8B-rong-qi-nei-de-1-hao-jin-cheng/>2024-04-03 容器内的 1 号进程</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E5%8E%9F%E7%90%86-rong-qi-yuan-li/>2024-04-03 容器原理</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%80-overlayfs-%E5%8E%9F%E7%90%86-rong-qi-de-wen-jian-xi-tong--yi-overlayfs-yuan-li/>2024-04-03 容器的文件系统 OverlayFS 原理</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86-rong-qi-wang-luo-yuan-li/>2024-04-03 容器网络原理</a></li><li><a href=/docs/%E6%90%9E%E6%87%82k8s%E9%89%B4%E6%9D%83-gao-dong-k8s-jian-quan/>2024-04-03 搞懂K8S鉴权</a></li><li><a href=/docs/%E6%96%87%E5%AD%A6%E7%9A%84%E6%95%85%E4%B9%A1-wen-xue-de-gu-xiang/>2024-04-03 文学的故乡</a></li><li><a href=/docs/%E6%9E%81%E5%A4%A7%E6%8F%90%E9%AB%98%E5%B7%A5%E4%BD%9C%E6%95%88%E7%8E%87%E7%9A%84-linux-%E5%91%BD%E4%BB%A4-ji-da-ti-gao-gong-zuo-xiao-lv-de-linux-ming-ling/>2024-04-03 极大提高工作效率的 Linux 命令</a></li><li><a href=/docs/%E6%B5%81%E9%87%8F%E4%BD%95%E5%A4%84%E6%9D%A5%E4%BD%95%E5%A4%84%E5%8E%BB-liu-liang-he-chu-lai-he-chu-qu/>2024-04-03 流量何处来何处去</a></li><li><a href=/docs/%E6%B8%85%E7%90%86%E6%AE%8B%E7%95%99%E7%9A%84calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6-qing-li-can-liu-de-calico-wang-luo/>2024-04-03 清理残留的calico网络插件</a></li><li><a href=/docs/%E7%A3%81%E7%9B%98%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D-ci-pan-shu-ju-hui-fu/>2024-04-03 磁盘数据恢复</a></li><li><a href=/docs/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85kubephere-li-xian-an-zhuang-kubephere/>2024-04-03 离线安装kubephere</a></li><li><a href=/docs/%E8%87%AA%E5%8A%A8%E5%B1%8F%E8%94%BDip%E6%94%BB%E5%87%BB-zi-dong-ping-bi-ip-gong-ji/>2024-04-03 自动屏蔽IP攻击</a></li><li><a href=/docs/%E9%9D%A2%E8%AF%95%E7%94%A8-golang-%E6%89%8B%E6%92%B8-lru-mian-shi-yong-golang-shou-lu-lru/>2024-04-03 面试用 Golang 手撸 LRU</a></li><li><a href=/docs/%E5%BD%BB%E6%82%9F%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C-che-wu-rong-qi-wang-luo/>2024-04-07 彻悟容器网络</a></li><li><a href=/docs/k8s-%E8%B0%83%E5%BA%A6%E5%99%A8-scheduler_onego-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-diao-du-qi-scheduleronego-yuan-ma-jie-du/>2024-04-09 K8S 调度器 scheduler_one.go 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-deployment_controllergo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-deploymentcontrollergo-yuan-ma-jie-du/>2024-04-09 K8S控制器之 deployment_controller.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-progressgo-%E8%BF%9B%E5%BA%A6-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-progressgo-jin-du-yuan-ma-jie-du/>2024-04-09 K8S控制器之 progress.go 进度 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-rollinggo-%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-rollinggo-gun-dong-geng-xin-yuan-ma-jie-du/>2024-04-09 K8S控制器之 rolling.go 滚动更新 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-schedulergo-%E8%B0%83%E5%BA%A6%E5%99%A8-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-schedulergo-diao-du-qi-yuan-ma-jie-du/>2024-04-09 K8S控制器之 scheduler.go 调度器 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Brecreatego-%E9%87%8D%E5%BB%BA-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-recreatego-zhong-jian-yuan-ma-jie-du/>2024-04-09 K8S控制器之recreate.go 重建 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Brollbackgo-%E5%9B%9E%E6%BB%9A-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-rollbackgo-hui-gun-yuan-ma-jie-du/>2024-04-09 K8S控制器之rollback.go 回滚 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bsyncgo-%E5%90%8C%E6%AD%A5-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-syncgo-tong-bu-yuan-ma-jie-du/>2024-04-09 K8S控制器之sync.go 同步 源码解读</a></li><li><a href=/docs/k8s%E8%B0%83%E5%BA%A6%E5%99%A8-extendergo-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-diao-du-qi-extendergo-yuan-ma-jie-du/>2024-04-09 K8S调度器 extender.go 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_pod_controlgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulpodcontrolgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_pod_control.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_set_controlgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetcontrolgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set_control.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_set_status_updatego%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetstatusupdatego-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set_status_update.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_setgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set.go源码解读</a></li><li><a href=/docs/k8s%E5%A6%82%E4%BD%95%E8%8E%B7%E5%BE%97-ip-k8s-ru-he-huo-de-ip/>2024-04-16 K8S如何获得 IP</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E4%B8%BAk8s%E4%BF%9D%E9%A9%BE%E6%8A%A4%E8%88%AA-ru-he-wei-k8s-bao-jia-hu-hang/>2024-04-16 如何为K8S保驾护航</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8cloudflarecf%E6%90%AD%E5%BB%BAdockerhub%E4%BB%A3%E7%90%86-shi-yong-cloudflarecf-da-jian-dockerhub-dai-li/>2024-06-28 使用cloudflare(CF)搭建dockerhub代理</a></li><li><a href=/docs/k8s%E4%B9%8Bingress-nginx%E5%8E%9F%E7%90%86%E5%8F%8A%E9%85%8D%E7%BD%AE-k8s-zhi-ingress-nginx-yuan-li-ji-pei-zhi/>2024-07-05 K8S之ingress-nginx原理及配置</a></li><li><a href=/docs/openkruise%E8%AF%A6%E7%BB%86%E8%A7%A3%E9%87%8A%E4%BB%A5%E5%8F%8A%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7%E5%8F%8A%E5%85%A8%E9%93%BE%E8%B7%AF%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%E6%96%B9%E6%A1%88-openkruise-xiang-xi-jie-shi-yi-ji-yuan-de-sheng-ji-ji-quan-lian-lu-hui-du-fa-bu-fang-an/>2024-07-22 OpenKruise详细解释以及原地升级及全链路灰度发布方案</a></li><li><a href=/docs/33%E6%AC%BEgitops%E4%B8%8Edevops%E4%B8%BB%E6%B5%81%E7%B3%BB%E7%BB%9F-33-kuan-gitops-yu-devops-zhu-liu-xi-tong/>2024-08-02 33款gitops与devops主流系统</a></li><li><a href=/docs/dockerfile%E5%AE%9A%E5%88%B6%E4%B8%93%E5%B1%9E%E9%95%9C%E5%83%8F-dockerfile-ding-zhi-zhuan-shu-jing-xiang/>2024-08-02 dockerfile定制专属镜像</a></li><li><a href=/docs/godel-scheduler-godel-scheduler/>2024-08-02 godel-scheduler</a></li><li><a href=/docs/istio-ingress-gateway-istio-ingress-gateway/>2024-08-02 istio-ingress-gateway</a></li><li><a href=/docs/istio%E9%83%A8%E7%BD%B2-istio-bu-shu/>2024-08-02 istio部署</a></li><li><a href=/docs/k8s%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E5%9D%97%E6%8B%BC%E5%9B%BE-dbpaas-k8s-de-zui-hou-yi-kuai-pin-tu-dbpaas/>2024-08-02 K8S的最后一块拼图</a></li><li><a href=/docs/k8s%E8%83%8C%E5%90%8Eservice%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84-k8s-bei-hou-service-shi-ru-he-gong-zuo-de/>2024-08-02 k8s背后service是如何工作的</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E9%A2%98-k8s-mian-shi-ti/>2024-08-02 K8S面试题</a></li><li><a href=/docs/kruise%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7%E8%A7%A3%E6%9E%90-kruise-yuan-de-sheng-ji-jie-xi/>2024-08-02 kruise原地升级解析</a></li><li><a href=/docs/kubewharf-kubewharf/>2024-08-02 kubewharf</a></li><li><a href=/docs/linux-awk%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E5%99%A8-8%E4%B8%AA%E6%A1%88%E4%BE%8B-linuxawk-wen-ben-chu-li-qi-8-ge-an-li/>2024-08-02 linux awk文本处理器 8个案例</a></li><li><a href=/docs/linux%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E4%B8%83%E4%B8%AA%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C-linux-xi-tong-xing-neng-you-hua-qi-ge-shi-zhan-jing-yan/>2024-08-02 linux系统性能优化 七个实战经验</a></li><li><a href=/docs/linux%E8%BF%90%E7%BB%B4%E5%B7%A5%E7%A8%8B%E5%B8%8850%E4%B8%AA%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-linux-yun-wei-gong-cheng-shi-50-ge-chang-jian-mian-shi-ti/>2024-08-02 linux运维工程师50个常见面试题</a></li><li><a href=/docs/netctl%E6%A3%80%E6%B5%8B%E9%9B%86%E7%BE%A4pod%E9%97%B4%E8%BF%9E%E9%80%9A%E6%80%A7-netctl-jian-ce-ji-qun-pod-jian-lian-tong-xing/>2024-08-02 netctl检测集群pod间连通性</a></li><li><a href=/docs/nginx%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%83%8A%E7%BE%A4%E6%95%88%E5%BA%94-nginx-ru-he-jie-jue-jing-qun-xiao-ying/>2024-08-02 nginx如何解决惊群效应</a></li><li><a href=/docs/pixie-pixie/>2024-08-02 pixie</a></li><li><a href=/docs/prometheus-stack-prometheus-stack/>2024-08-02 prometheus-stack</a></li><li><a href=/docs/teg%E4%B8%8Eistio%E9%9B%86%E6%88%90-teg-yu-istio-ji-cheng/>2024-08-02 TEG与istio集成</a></li><li><a href=/docs/%E5%8F%B2%E4%B8%8A%E6%9C%80%E7%89%9Bjenkins-pipeline%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%A6%E8%A7%A3-shi-shang-zui-niu-jenkinspipeline-liu-shui-xian-xiang-jie/>2024-08-02 史上最牛jenkins pipeline流水线详解</a></li><li><a href=/docs/%E5%A4%A7%E5%8E%82%E6%80%BB%E7%BB%93nginx%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E7%AC%94%E8%AE%B0-da-chang-zong-jie-nginx-gao-bing-fa-you-hua-bi-ji/>2024-08-02 大厂总结nginx高并发优化笔记</a></li><li><a href=/docs/%E5%B8%B8%E8%A7%81linux%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98-chang-jian-linux-yun-wei-mian-shi-ti/>2024-08-02 常见linux运维面试题</a></li><li><a href=/docs/%E6%88%91%E5%8F%AA%E6%83%B3%E5%81%9A%E6%8A%80%E6%9C%AF-%E8%B5%B0%E6%8A%80%E6%9C%AF%E8%B7%AF%E7%BA%BF-wo-zhi-xiang-zuo-ji-shu-zou-ji-shu-lu-xian/>2024-08-02 我只想做技术 走技术路线</a></li><li><a href=/docs/%E6%90%AD%E4%B8%AA%E6%97%A5%E5%BF%97%E6%89%8B%E6%9C%BA%E7%B3%BB%E7%BB%9F%E4%B8%8D%E9%A6%99%E5%90%97-da-ge-ri-zhi-shou-ji-xi-tong-bu-xiang-ma/>2024-08-02 搭个日志手机系统不香吗</a></li><li><a href=/docs/%E6%98%AF%E6%8A%80%E6%9C%AF%E5%A4%A7%E7%A5%9E%E8%BF%98%E6%98%AF%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E9%83%A8%E7%9A%84%E7%A5%B8%E5%AE%B3-shi-ji-shu-da-shen-hai-shi-ji-chu-jia-gou-bu-de-huo-hai/>2024-08-02 是技术大神还是基础架构部的祸害</a></li><li><a href=/docs/%E6%9E%84%E5%BB%BA%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%88%A9%E5%99%A8buildkit-gou-jian-rong-qi-jing-xiang-li-qi-buildkit/>2024-08-02 构建容器镜像利器buildkit</a></li><li><a href=/docs/%E6%B8%85%E7%90%86docker%E9%95%9C%E5%83%8F-qing-li-docker-jing-xiang/>2024-08-02 清理docker镜像</a></li><li><a href=/docs/%E9%A1%B6%E7%BA%A7devops%E5%B7%A5%E5%85%B7%E5%A4%A7%E7%9B%98%E7%82%B9-ding-ji-devops-gong-ju-da-pan-dian/>2024-08-02 顶级devops工具大盘点</a></li><li><a href=/docs/2024-10-20-%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/>2024-10-20 使用 Keepalived 和 HAproxy 创建高可用 Kubernetes 集群</a></li><li><a href=/docs/2024-12-05-kubeasz%E9%83%A8%E7%BD%B2k8s/>2024-12-05 kubeasz部署k8s</a></li><li><a href=/docs/2024-12-07-microk8s/>2024-12-07 microk8s</a></li><li><a href=/docs/2024-12-08-devstack/>2024-12-08 devstack</a></li><li><a href=/docs/2024-12-08-mutilpass%E6%93%8D%E4%BD%9C/>2024-12-08 mutilpass操作</a></li><li><a href=/docs/2024-12-08-nano%E6%93%8D%E4%BD%9C/>2024-12-08 nano操作</a></li><li><a href=/docs/2024-12-08-openstack%E5%92%8Ckubernetes%E5%8C%BA%E5%88%AB/>2024-12-08 openstack和kubernetes区别</a></li><li><a href=/docs/2024-12-08-openstack%E9%9C%80%E8%A6%81%E5%87%A0%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA/>2024-12-08 openstack需要几台虚拟机</a></li><li><a href=/docs/2024-12-08-%E5%9D%97%E5%AD%98%E5%82%A8%E5%92%8C%E5%AF%B9%E8%B1%A1%E5%82%A8%E5%AD%98%E5%8C%BA%E5%88%AB/>2024-12-08 块存储和对象储存区别</a></li><li><a href=/docs/2024-12-09-docker-daemon.json/>2024-12-09 docker daemon.json</a></li><li><a href=/docs/2024-12-09-helmchart-%E9%83%A8%E7%BD%B2flask%E5%BA%94%E7%94%A8/>2024-12-09 helmchart 部署flask应用</a></li><li><a href=/docs/2024-12-08-mutilpass%E9%83%A8%E7%BD%B2openstack/>2024-12-09 mutilpass部署openstack devstack形式</a></li><li><a href=/docs/2024-12-09-openstack-ssh%E8%BF%9E%E6%8E%A5/>2024-12-09 openstack ssh连接</a></li><li><a href=/docs/2024-12-10-docker-registrry/>2024-12-10 docker registrry</a></li><li><a href=/docs/2024-2-22-k8s%E6%9E%B6%E6%9E%84%E5%B8%88%E9%9D%A2%E8%AF%95%E5%A4%A7%E5%85%A8/>2024-2-22 k8s架构师面试大全</a></li><li><a href=/docs/2024-2-22-k8s%E9%9D%A2%E8%AF%95%E5%AE%9D%E5%85%B8/>2024-2-22 k8s面试宝典</a></li><li><a href=/docs/2024-2-26-%E9%9D%A2%E8%AF%95/>2024-2-26 面试</a></li><li><a href=/docs/2024-3-19-%E4%B8%A4%E5%BC%A0%E5%9B%BE%E5%85%A8%E9%9D%A2%E7%90%86%E8%A7%A3k8s%E5%8E%9F%E7%90%86/>2024-3-19 两张图全面理解k8s原理</a></li><li><a href=/docs/2024-3-4-cni%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B/>2024-3-4 CNI剖析演进</a></li><li><a href=/docs/2024-3-8-%E9%9D%A2%E8%AF%950308/>2024-3-8 面试</a></li><li><a href=/docs/2024-4-17-%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/>2024-4-17 面试总结</a></li><li><a href=/docs/2024-5-14-%E5%8D%95master%E5%8D%95etcd%E6%94%B9%E9%80%A0/>2024-5-1 单master单etcd改造为3master3etcd</a></li><li><a href=/docs/2024-8-1-kubernetes%E9%9D%A2%E8%AF%95%E9%A2%98/>2024-8-1 k8s面试题</a></li><li><a href=/docs/2024-8-1-%E5%B8%B8%E8%A7%81linux%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98%E6%89%BE%E5%B7%A5%E4%BD%9C%E7%9A%84%E5%BF%85%E7%9C%8B/>2024-8-1 linux运维面试题</a></li><li><a href=/docs/2024-8-1-linux%E8%BF%90%E7%BB%B4%E5%B7%A5%E7%A8%8B%E5%B8%8850%E4%B8%AA%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/>2024-8-1 linux面试题</a></li><li><a href=/docs/2025-1-1-sealos%E8%8E%B7%E6%8A%95/>2025-1-1 sealos获投</a></li><li><a href=/docs/2025-1-1-%E5%88%9B%E4%B8%9A%E7%82%B9%E5%AD%90/>2025-1-1 创业点子</a></li><li><a href=/docs/2025-1-1-%E5%88%9B%E4%B8%9A%E8%80%85%E4%BA%A4%E6%B5%81/>2025-1-1 创业者交流</a></li><li><a href=/docs/2025-1-1-%E5%88%9D%E5%88%9B%E5%85%AC%E5%8F%B8/>2025-1-1 初创公司</a></li><li><a href=/docs/2025-1-1-%E5%A4%A7%E5%A0%B0%E6%B2%B3-%E6%88%91%E7%9A%84%E4%BF%9D%E5%A7%86/>2025-1-1 大堰河-我的保姆</a></li><li><a href=/docs/2025-1-1-%E6%97%A9%E6%9C%9F%E6%A8%A1%E5%BC%8F/>2025-1-1 早期模式</a></li><li><a href=/docs/2025-1-1-%E8%A6%81%E4%B8%8D%E8%A6%81%E5%88%9B%E4%B8%9A/>2025-1-1 要不要创业</a></li><li><a href=/docs/2024-3-4-k8s-csi%E5%89%96%E6%9E%90/>2025-1-16 CSI剖析演进</a></li><li><a href=/docs/2025-1-16-k8s%E5%B8%B8%E8%A7%81%E6%95%85%E9%9A%9C%E6%8C%87%E5%8D%97/>2025-1-16 k8s常见故障指南</a></li><li><a href=/docs/2024-3-4-k8s%E6%B5%81%E9%87%8F%E9%93%BE%E8%B7%AF%E5%89%96%E6%9E%90/>2025-1-16 k8s流量链路剖析</a></li><li><a href=/docs/2025-2-11-%E9%9D%A2%E8%AF%950211/>2025-2-11 面试2025-02-11</a></li><li><a href=/docs/2025-2-12-%E9%9D%A2%E8%AF%950212/>2025-2-12 面试0212</a></li><li><a href=/docs/2025-2-26-k8s%E7%9B%B8%E5%85%B3/>2025-2-16 k8s题目</a></li><li><a href=/docs/2025-2-18-%E9%9D%A2%E8%AF%95/>2025-2-18 面试2025-0218</a></li><li><a href=/docs/2025-2-19-%E9%9D%A2%E8%AF%950219/>2025-2-19 面试0219</a></li><li><a href=/docs/2025-2-20-%E9%9D%A2%E8%AF%950220/>2025-2-20 面试0220</a></li><li><a href=/docs/2025-2-24-%E9%9D%A2%E8%AF%950224/>2025-2-24 0224面试</a></li><li><a href=/docs/2025-2-24-%E4%B8%AD%E7%BA%A7%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98_%E9%A2%98%E7%9B%AE/>2025-2-24 中级运维面试题</a></li><li><a href=/docs/2025-2-24-%E9%AB%98%E7%BA%A7%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98_ai_linux%E9%83%A8%E5%88%86/>2025-2-24 高级运维面试题-linux部分</a></li><li><a href=/docs/2025-2-26-%E9%9D%A2%E8%AF%950225/>2025-2-25 面试0225</a></li><li><a href=/docs/2025-2-28-prometheus/>2025-2-28 prometheus 面试题</a></li><li><a href=/docs/2025-2-7-k8s%E7%BB%84%E4%BB%B6/>2025-2-7 k8s组件</a></li><li><a href=/docs/2025-2-7-%E8%AE%A1%E5%88%92/>2025-2-7 美国码农薪酬</a></li><li><a href=/docs/2025-2-7-%E8%AE%A1%E5%88%922/>2025-2-7 美国码农计划</a></li><li><a href=/docs/2025-3-12-%E8%BF%BD%E8%A7%85%E9%9D%A2%E8%AF%95/>2025-3-12 追觅面试</a></li><li><a href=/docs/2025-3-12-%E5%A1%94%E8%B5%9E%E9%9D%A2%E8%AF%95/>2025-3-12 塔赞面试</a></li><li><a href=/docs/2025-3-13-calico%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%B5%81%E9%87%8F%E4%BC%A0%E8%BE%93%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90/>2025-3-13 calico三种模式下流量传输</a></li><li><a href=/docs/2025-3-13-istio%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/>2025-3-13 istio流量分析</a></li><li><a href=/docs/2025-3-8-k8s%E5%88%9B%E5%BB%BApod-deployment%E6%B5%81%E7%A8%8B%E5%9B%BE%E8%AF%A6%E8%A7%A3/>2025-3-8 k8s创建pod 流程图详解</a></li><li><a href=/docs/2025-3-8-k8s%E5%88%A0%E9%99%A4pod-deployment%E7%9A%84%E6%B5%81%E7%A8%8B%E5%9B%BE%E8%AF%A6%E8%A7%A3/>2025-3-8 k8s删除pod deployment的流程图详解</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>2024-04-03 Calico网络自定义</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li><a href=#1取消k8s-master节点不可调度>1.取消k8s master节点不可调度</a></li><li><a href=#calico简介>Calico简介</a></li><li><a href=#calico网络模型主要工作组件>Calico网络模型主要工作组件：###</a></li><li><a href=#calicoctl命令安装与使用>calicoctl命令安装与使用</a></li></ul></li><li><a href=#概述>概述</a></li><li><a href=#calico-切换-bgp-模式>calico 切换 BGP 模式</a></li><li><a href=#calico-切换-cross-subnet-模式>calico 切换 cross-subnet 模式</a></li><li><a href=#配置-route-reflector>配置 Route reflector</a><ul><li><a href=#安装-calicoctl>安装 calicoctl</a></li><li><a href=#calico-node-to-node-mesh>calico node-to-node mesh</a></li><li><a href=#route-reflector-角色介绍>Route reflector 角色介绍</a></li><li><a href=#设置-route-reflector>设置 Route reflector</a></li></ul></li><li><a href=#设置-veth-网卡-mtu>设置 veth 网卡 mtu</a><ul><li><a href=#将工作负载端点-mtu-和隧道-mtu-设置为相同的值>将工作负载端点 MTU 和隧道 MTU 设置为相同的值</a></li></ul></li><li><a href=#设置全局-as-号>设置全局 AS 号</a></li><li><a href=#设置单个主机和-as-号>设置单个主机和 AS 号</a></li><li><a href=#修改节点地址范围>修改节点地址范围</a></li><li><a href=#根据节点标签定义对应的-ippool>根据节点标签定义对应的 ippool</a></li><li><a href=#关闭-snat>关闭 SNAT</a></li><li><a href=#固定-pod-ip>固定 POD IP</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=一文学会calico网络自定义>一文学会Calico网络自定义
<a class=anchor href=#%e4%b8%80%e6%96%87%e5%ad%a6%e4%bc%9acalico%e7%bd%91%e7%bb%9c%e8%87%aa%e5%ae%9a%e4%b9%89>#</a></h1><h1 id=一确定最佳的网络选项>一、确定最佳的网络选项
<a class=anchor href=#%e4%b8%80%e7%a1%ae%e5%ae%9a%e6%9c%80%e4%bd%b3%e7%9a%84%e7%bd%91%e7%bb%9c%e9%80%89%e9%a1%b9>#</a></h1><p>Calico支持多个容器网络选项，用于可伸缩性、网络性能和与现有基础设施的互操作性。</p><h4 id=1-值>1. 值
<a class=anchor href=#1-%e5%80%bc>#</a></h4><p>不同的网络实现更适合不同的环境。Calico提供了几种不需要封装的基于IP路由的网络实现。如果您的部署需要封装，Calico提供覆盖网络(IP in IP或VXLAN)。Calico还支持使用其他Kubernetes网络选项来执行策略。本文档帮助您为集群选择最佳的网络选项。</p><h4 id=2-概念>2. 概念
<a class=anchor href=#2-%e6%a6%82%e5%bf%b5>#</a></h4><h5 id=21-关于calico-networking>2.1 关于calico networking
<a class=anchor href=#21-%e5%85%b3%e4%ba%8ecalico-networking>#</a></h5><p>Calico提供了一些方法，允许pod连接到其他pod、主机和外部网络(例如internet)。</p><p>Calico网络：</p><ul><li>使用Calico的IP地址管理(IPAM)将IP地址分配给pods</li><li>编写本地节点的路由表</li><li>将路由分配给其他节点和网络设备</li></ul><h5 id=22-关于bgp>2.2 关于BGP
<a class=anchor href=#22-%e5%85%b3%e4%ba%8ebgp>#</a></h5><p>Calico支持使用边界网关协议(BGP)将路由信息共享到网络中。Calico支持节点到节点的全网格部署(有和没有路由反射器)，以及BGP直接对机架(ToR)路由器顶部的现场部署;允许流量直接路由到工作负载，而不需要NAT或封装。</p><h5 id=23-其它kubernetes-网络选项>2.3 其它Kubernetes 网络选项
<a class=anchor href=#23-%e5%85%b6%e5%ae%83kubernetes-%e7%bd%91%e7%bb%9c%e9%80%89%e9%a1%b9>#</a></h5><p>Calico可以使用许多其他Kubernetes网络选项执行网络策略强制。</p><ul><li>Flannel</li><li>Amazon AWS VPC CNI</li><li>Azure CNI</li><li>Google cloud networking</li></ul><p>下表显示了使用Calico时常见的网络选项。</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301203127.png alt=image-20230630120304024></p><p>网络选项</p><h4 id=3-基本说明>3. 基本说明
<a class=anchor href=#3-%e5%9f%ba%e6%9c%ac%e8%af%b4%e6%98%8e>#</a></h4><p>本节提供更多关于Calico的内置网络选项的细节:</p><ul><li>Unencapsulated, peered with physical infrastructure</li><li>Unencapsulated, not peered with physical infrastructure</li><li>IP in IP or VXLAN encapsulation</li></ul><h5 id=31-unencapsulated-peered-with-physical-infrastructure>3.1 Unencapsulated, peered with physical infrastructure
<a class=anchor href=#31-unencapsulated-peered-with-physical-infrastructure>#</a></h5><p>Calico可以与你的路由器使用BGP对等。这提供了出色的性能和易于调试的非封装流量，以及广泛的网络拓扑和连接选项。</p><ul><li>您的集群可以跨越多个L2子网，而不需要封装</li><li>集群外的资源可以直接与pod通信，而不需要NAT</li><li>如果你想的话，你甚至可以把pod直接暴露在互联网上!</li></ul><h5 id=32-unencapsulated-not-peered-with-physical-infrastructure>3.2 Unencapsulated, not peered with physical infrastructure
<a class=anchor href=#32-unencapsulated-not-peered-with-physical-infrastructure>#</a></h5><p>此选项还提供了接近主机到主机的性能级别，并允许网络直接看到流量。</p><p>当所有节点都在一个L2子网上时，如果底层网络不强制执行IP地址检查，Calico可以在节点之间路由pod流量，而不需要封装。如果您的网络由多个L2子网组成，那么您可以使用路由器在BGP上进行对等，或者使用跨子网封装来仅封装跨子网边界的流量。</p><p>如果不允许在集群外部进行工作负载访问或使用基础设施进行对等访问，就无法在pod和不属于Calico集群的目的地之间路由流量。</p><h5 id=33-ip-in-ip-or-vxlan-encapsulation>3.3 IP in IP or VXLAN encapsulation
<a class=anchor href=#33-ip-in-ip-or-vxlan-encapsulation>#</a></h5><p>如果可能，我们建议运行Calico没有网络覆盖/封装。这提供了最高的性能和最简单的网络;离开您的工作负载的包是连接到网络上的包。</p><p>但是，当运行在底层网络上时，有选择地使用覆盖(IP中的IP或VXLAN中的IP)是非常有用的，因为底层网络不容易知道工作负载IP。Calico可以对:所有的流量，没有流量，或者只对跨越子网边界的流量进行封装。</p><p>IP中的IP或VXLAN封装也可以在子网之间选择性地使用——这提供了子网中未封装的流量的性能优势，适用于织物包含多个L2网络且无法进行对等连接的环境。例如，如果您在AWS中跨多个VPC/子网使用Calico网络，Calico可以选择性地只封装在VPC/子网之间路由的流量，而不封装在每个VPC/子网中运行。</p><h1 id=二配置bgp路由反射及对等体>二、配置BGP路由反射及对等体
<a class=anchor href=#%e4%ba%8c%e9%85%8d%e7%bd%aebgp%e8%b7%af%e7%94%b1%e5%8f%8d%e5%b0%84%e5%8f%8a%e5%af%b9%e7%ad%89%e4%bd%93>#</a></h1><h4 id=1-bgp协议配置>1. BGP协议配置
<a class=anchor href=#1-bgp%e5%8d%8f%e8%ae%ae%e9%85%8d%e7%bd%ae>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: BGPConfiguration
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  logSeverityScreen: Info
</span></span><span style=display:flex><span>  nodeToNodeMeshEnabled: true
</span></span><span style=display:flex><span>  asNumber: <span style=color:#ae81ff>63400</span>
</span></span><span style=display:flex><span>  serviceClusterIPs:
</span></span><span style=display:flex><span>  - cidr: 10.96.0.0/12
</span></span><span style=display:flex><span>  serviceExternalIPs:
</span></span><span style=display:flex><span>  - cidr: 192.168.20.99/32
</span></span></code></pre></div><h4 id=2-关闭默认的bgp-node-to-node-mesh>2. 关闭默认的BGP node-to-node mesh
<a class=anchor href=#2-%e5%85%b3%e9%97%ad%e9%bb%98%e8%ae%a4%e7%9a%84bgp-node-to-node-mesh>#</a></h4><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301203545.png alt=image-20230630120324478></p><p>BGP网格</p><p>缺省的节点到节点的BGP网格必须关闭，以启用其他BGP拓扑。为此，修改默认的BGP配置资源。</p><ul><li>运行下面的命令去关闭BGP full-mesh</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>calicoctl patch bgpconfiguration default -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;nodeToNodeMeshEnabled&#34;: false}}&#39;</span>
</span></span></code></pre></div><h4 id=2-配置全局的-bgp-对等体>2. 配置全局的 BGP 对等体
<a class=anchor href=#2-%e9%85%8d%e7%bd%ae%e5%85%a8%e5%b1%80%e7%9a%84-bgp-%e5%af%b9%e7%ad%89%e4%bd%93>#</a></h4><ul><li>下面的示例创建一个全局BGP对等点，它将每个Calico节点配置为在AS 64567中使用192.20.30.40的对等点。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: BGPPeer
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-global-peer
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  peerIP: 192.20.30.40
</span></span><span style=display:flex><span>  asNumber: <span style=color:#ae81ff>64567</span>
</span></span></code></pre></div><h4 id=3-配置每节点的-bgp-peer>3. 配置每节点的 BGP peer
<a class=anchor href=#3-%e9%85%8d%e7%bd%ae%e6%af%8f%e8%8a%82%e7%82%b9%e7%9a%84-bgp-peer>#</a></h4><p>每个节点的BGP对等点应用于集群中的一个或多个节点。您可以通过精确地指定节点的名称或使用标签选择器来选择节点。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: BGPPeer
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: rack1-tor
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  peerIP: 192.20.30.40
</span></span><span style=display:flex><span>  asNumber: <span style=color:#ae81ff>64567</span>
</span></span><span style=display:flex><span>  nodeSelector: rack <span style=color:#f92672>==</span> ‘rack-1’
</span></span></code></pre></div><h4 id=4-配置node作为路由反射器>4. 配置node作为路由反射器
<a class=anchor href=#4-%e9%85%8d%e7%bd%aenode%e4%bd%9c%e4%b8%ba%e8%b7%af%e7%94%b1%e5%8f%8d%e5%b0%84%e5%99%a8>#</a></h4><p>Calico 可以配置扮演成一个路由反射器。每个节点要充当路由反射器必须有一个集群ID——通常一个未使用的IPv4地址。</p><ul><li>配置一个节点作为路由反射器，有个集群ID 244.0.0.1， 运行如下命令：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>calicoctl patch node c76085.xiodi.cn -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;bgp&#34;: {&#34;routeReflectorClusterID&#34;: &#34;244.0.0.1&#34;}}}&#39;</span>
</span></span></code></pre></div><ul><li>常规情况下，给这个节点打上标签，标明这个是路由反射器。允许它更容易通过BGPPeer resource选择。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label node c76085.xiodi.cn route-reflector<span style=color:#f92672>=</span>true
</span></span></code></pre></div><ul><li>现在使用标签器很容易配置路由反射器节点和非路由反射器节点。比如：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kind: BGPPeer
</span></span><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: peer-with-route-reflectors
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  nodeSelector: all<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  peerSelector: route-reflector <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;true&#39;</span>
</span></span></code></pre></div><ul><li>针对一个节点查看BGP peering 状态
您可以使用calicoctl查看一个特定节点的边界网关协议连接的当前状态。这是用于确认您的配置是根据需要的行为。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo calicoctl node status
</span></span></code></pre></div><ul><li>改变默认的global AS number</li></ul><p>默认的，所有的calico 节点使用64512 autonomous system, 除非特殊指定。下面的命令把它改成64513.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>calicoctl patch bgpconfiguration default -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;asNumber&#34;: “64513”}}&#39;</span>
</span></span></code></pre></div><ul><li>针对特定的节点改变AS number,如下所示</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>calicoctl patch node node-1 -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;bgp&#34;: {“asNumber”: “64514”}}}&#39;</span>
</span></span></code></pre></div><h1 id=三ipinip模式>三、IPinIP模式
<a class=anchor href=#%e4%b8%89ipinip%e6%a8%a1%e5%bc%8f>#</a></h1><p>您可以配置每个IP池不同封装配置。然而,你不能一个IP池内混合封装类型。</p><ul><li>Configure IP in IP encapsulation for only cross subnet traffic</li><li>Configure IP in IP encapsulation for all inter workload traffic</li><li>Configure VXLAN encapsulation for only cross subnet traffic</li><li>Configure VXLAN encapsulation for all inter workload traffic</li></ul><ol><li>IPv4/6 地址支持</li></ol><p>IP in IP和 VXLAN只支持IPv4地址。</p><ol><li>最佳实践</li></ol><p>Calico 只有一个选项来选择性地封装流量 ,跨越子网边界。我们建议使用<code>IP in IP</code>的<code>cross subnet</code>选项把开销降到最低。</p><p>注意：切换封装模式会导到正在连接的进程中断。</p><ol><li>针对仅跨子网的流量配置IP in IP</li></ol><p>IP in IP封装可以选择性的执行， 并且仅用于通过子网边界的通信量 。</p><p>开启这个功能，设置<code>ipipMode</code>为<code>CrossSubnet</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: IPPool
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: ippool-ipip-cross-subnet-1
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cidr: 192.168.0.0/16
</span></span><span style=display:flex><span>  ipipMode: CrossSubnet
</span></span><span style=display:flex><span>  natOutgoing: true
</span></span></code></pre></div><ol><li>针对workload间的流量配置IP in IP的封装</li></ol><pre tabindex=0><code>ipipMode`设置`Always
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: IPPool
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: ippool-ipip-1
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cidr: 192.168.0.0/16
</span></span><span style=display:flex><span>  ipipMode: Always
</span></span><span style=display:flex><span>  natOutgoing: true
</span></span></code></pre></div><h1 id=四vxlan两种模式解析>四、vxlan两种模式解析
<a class=anchor href=#%e5%9b%9bvxlan%e4%b8%a4%e7%a7%8d%e6%a8%a1%e5%bc%8f%e8%a7%a3%e6%9e%90>#</a></h1><ol><li>针对仅跨越子网的流量 ，配置VXLAN封装</li></ol><ul><li>配置这个功能，设置vxlanMode为<code>CrossSubnet</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: IPPool
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: ippool-vxlan-cross-subnet-1
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cidr: 192.168.0.0/16
</span></span><span style=display:flex><span>  vxlanMode: CrossSubnet
</span></span><span style=display:flex><span>  natOutgoing: true
</span></span></code></pre></div><ul><li>针对workload间的流量 配置VXLAN的封装</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: IPPool
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: ippool-vxlan-1
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cidr: 192.168.0.0/16
</span></span><span style=display:flex><span>  vxlanMode: Always
</span></span><span style=display:flex><span>  natOutgoing: true
</span></span></code></pre></div><h1 id=五通过mtu增加网络性能>五、通过Mtu增加网络性能
<a class=anchor href=#%e4%ba%94%e9%80%9a%e8%bf%87mtu%e5%a2%9e%e5%8a%a0%e7%bd%91%e7%bb%9c%e6%80%a7%e8%83%bd>#</a></h1><h4 id=1-确定mtu的大小>1. 确定MTU的大小
<a class=anchor href=#1-%e7%a1%ae%e5%ae%9amtu%e7%9a%84%e5%a4%a7%e5%b0%8f>#</a></h4><p>下表针对Calico环境列出了常见的MTU大小。 因为MTU是endpoints间网络路径的全局属性， 你应该设定最低MTU的MTU包可能需要的任何路径。</p><h5 id=11-常见的mtu大小>1.1 常见的MTU大小
<a class=anchor href=#11-%e5%b8%b8%e8%a7%81%e7%9a%84mtu%e5%a4%a7%e5%b0%8f>#</a></h5><table><thead><tr><th>Network MTU</th><th>Calico MTU</th><th>Calico MTU with IP-in-IP (IPv4)</th><th>Calico MTU with VXLAN (IPv4)</th></tr></thead><tbody><tr><td>1500</td><td>1500</td><td>1480</td><td>1450</td></tr><tr><td>9000</td><td>9000</td><td>8980</td><td>8950</td></tr><tr><td>1460(GCE)</td><td>1460</td><td>1440</td><td>1410</td></tr><tr><td>9001(AWS jumbo)</td><td>9001</td><td>8981</td><td>8951</td></tr><tr><td>1450(OpenStack VXLAN)</td><td>1450</td><td>1430</td><td>1400</td></tr></tbody></table><h5 id=12-针对overlay网络推荐的mtu>1.2 针对overlay网络推荐的MTU
<a class=anchor href=#12-%e9%92%88%e5%af%b9overlay%e7%bd%91%e7%bb%9c%e6%8e%a8%e8%8d%90%e7%9a%84mtu>#</a></h5><p>额外的报头用于在IP和VXLAN IP协议,降低了最小的MTU大小头。在IP使用20-byte头(IP, VXLAN使用50-byte头)。因此,我们建议如下:</p><ul><li>如果你使用在Pod网络使用VXLAN,配置MTU大小“物理网络MTU大小- 50”。</li><li>假如你使用<code>IP in IP</code>, 配置MTU大小为“物理网络大小-20”</li><li>workload endpoint MTU和 tunnel MTU设置为相同的值。</li></ul><h5 id=13-针对flannel网络的mtu>1.3 针对flannel网络的MTU
<a class=anchor href=#13-%e9%92%88%e5%af%b9flannel%e7%bd%91%e7%bb%9c%e7%9a%84mtu>#</a></h5><p>当使用flannel的网络时，网络接口的MTU应该匹配flannel接口的MTU。 假如使用flannel的VXLAN， 使用上面的<code>calico MTU with VXLAN</code>列的大小。</p><h4 id=2-配置mtu针对workloads>2. 配置MTU针对workloads
<a class=anchor href=#2-%e9%85%8d%e7%bd%aemtu%e9%92%88%e5%af%b9workloads>#</a></h4><p>当你设置MTU,它适用于新工作负载。MTU变化应用于现有的工作负载,必须重新启动calico nodes。</p><ul><li>编辑calico-config ConfigMap FelixConfiguration设置值。例如:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch configmap/Calico-config -n kube-system --type merge <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -p <span style=color:#e6db74>&#39;{&#34;data&#34;:{&#34;veth_mtu&#34;: &#34;1440&#34;}}&#39;</span>
</span></span></code></pre></div><h4 id=3-针对overlay-网络配置mtu>3. 针对overlay 网络配置MTU
<a class=anchor href=#3-%e9%92%88%e5%af%b9overlay-%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%aemtu>#</a></h4><p>如果您使用的是IP in IP和/或VXLAN calico overlay 网络,设置隧道MTU匹配veth MTU配置的值。</p><ul><li>编辑calico-config ConfigMap设置MTU在FelixConfiguration隧道值。例如:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Configure the MTU to use</span>
</span></span><span style=display:flex><span>veth_mtu: <span style=color:#e6db74>&#34;1440&#34;</span> 
</span></span></code></pre></div><ul><li>查看当前tunnel MTU值</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ip link show
</span></span></code></pre></div><p>IP在IP隧道作为tunlx出现(例如,tunl0),连同MTU大小。例如:</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301202386.webp alt=img></p><p>mtu</p><h1 id=六calico网络地址转换>六、calico网络地址转换
<a class=anchor href=#%e5%85%adcalico%e7%bd%91%e7%bb%9c%e5%9c%b0%e5%9d%80%e8%bd%ac%e6%8d%a2>#</a></h1><h4 id=1-允许workloads-访问-internet私有ip地址>1. 允许workloads 访问 internet，私有IP地址
<a class=anchor href=#1-%e5%85%81%e8%ae%b8workloads-%e8%ae%bf%e9%97%ae-internet%e7%a7%81%e6%9c%89ip%e5%9c%b0%e5%9d%80>#</a></h4><p>允许工作负载使用私有IP地址访问互联网,你可以用你现有NAT功能,或者你可以在Calico IPPool上开启natOutgoing。</p><p>在以下的示例中,我们创建一个Calicco IPPool，并开启natOutgoing 。Outbound NAT是在节点本地执行的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: IPPool
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default-ipv4-ippool
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cidr: 192.168.0.0/16
</span></span><span style=display:flex><span>  natOutgoing: true
</span></span></code></pre></div><h4 id=2-仅去nat那些指定的ip地址范围>2. 仅去nat那些指定的IP地址范围
<a class=anchor href=#2-%e4%bb%85%e5%8e%bbnat%e9%82%a3%e4%ba%9b%e6%8c%87%e5%ae%9a%e7%9a%84ip%e5%9c%b0%e5%9d%80%e8%8c%83%e5%9b%b4>#</a></h4><p>您可以创建额外的IPPools不用于IP地址管理,防止NAT某些CIDR块。这是有用的,如果你想让节点NAT网络流量,但不是在某些内部ip范围。例如,如果您不想NAT流量10.0.0.0/8,您可以创建以下池。您必须确保集群之间的网络和10.0.0.0/8可路由。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: IPPool
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: no-nat-10.0.0.0-8
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cidr: 10.0.0.0/8
</span></span><span style=display:flex><span>  disabled: true
</span></span></code></pre></div><h1 id=七ip地址检测剖析>七、IP地址检测剖析
<a class=anchor href=#%e4%b8%83ip%e5%9c%b0%e5%9d%80%e6%a3%80%e6%b5%8b%e5%89%96%e6%9e%90>#</a></h1><p>针对calico节点配置IP自动检测，确保路由使用正确的P地址。</p><h4 id=1-值-1>1. 值
<a class=anchor href=#1-%e5%80%bc-1>#</a></h4><p>当你安装Calico在一个节点上时，一个IP地址和子网被自动检测。Calico提供几种方式去配置子网自动检测，和支持配置指定的IPs。</p><ul><li>拥有多个外部接口的主机</li><li>主机接口拥有多个IP地址</li><li>改变跨子网包的封装</li><li>改变主机IP地址</li></ul><h4 id=2-概念-1>2. 概念
<a class=anchor href=#2-%e6%a6%82%e5%bf%b5-1>#</a></h4><h5 id=21-自动检测节点ip地址和子网>2.1 自动检测节点IP地址和子网
<a class=anchor href=#21-%e8%87%aa%e5%8a%a8%e6%a3%80%e6%b5%8b%e8%8a%82%e7%82%b9ip%e5%9c%b0%e5%9d%80%e5%92%8c%e5%ad%90%e7%bd%91>#</a></h5><p>针对节点间的路由，每个calico节点必须配置一个IPv4地址 和/或 一个IPV6地址，当安装一个calico在一个节点上时，一个节点资源使用从主机检测到的路由信息自动创建。针对一些部署，你可能想要自动的更新检测，确保节点获取正确的IP地址。</p><ul><li>在安装后默认的节点资源案例</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: Node
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: node-hostname
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  bgp:
</span></span><span style=display:flex><span>    asNumber: <span style=color:#ae81ff>64512</span>
</span></span><span style=display:flex><span>    ipv4Address: 10.244.0.1/24
</span></span><span style=display:flex><span>    ipv6Address: 2000:db8:85a3::8a2e:370:7335/120
</span></span><span style=display:flex><span>    ipv4IPIPTunnelAddr: 192.168.0.1
</span></span></code></pre></div><h5 id=22-自动检测方法>2.2 自动检测方法
<a class=anchor href=#22-%e8%87%aa%e5%8a%a8%e6%a3%80%e6%b5%8b%e6%96%b9%e6%b3%95>#</a></h5><p>默认的，Calico使用<code>first-found</code>方法，也就是说第一个接口第一个有效的IP地址（排除local interface，因为它是docker bridge）.你可以使用以下方法的任一一种改变默认方法。</p><p>（1）使用一个能到达特定IP或domain的地址。</p><p>（2）使用正则的方式，去匹配接口（interface)</p><p>（3）使用正则的方式，去排除匹配的接口（skip interface）</p><h5 id=23-手动配置ip地址和子网>2.3 手动配置IP地址和子网
<a class=anchor href=#23-%e6%89%8b%e5%8a%a8%e9%85%8d%e7%bd%aeip%e5%9c%b0%e5%9d%80%e5%92%8c%e5%ad%90%e7%bd%91>#</a></h5><ul><li>有两种方式去手动的配置IP地址和子网</li></ul><p>(1) calico node container(start/restart),使用环境变量去设置节点的值</p><p>(2) 更新节点的资源</p><ul><li>使用环境变量和节点的资源</li></ul><p>因为你可以通过配置环境变量和节点资源，去更改IP地址和子网，下表描述了这些值如何同步的。</p><table><thead><tr><th>If this environment variable…</th><th>Is…</th><th>Then…</th></tr></thead><tbody><tr><td>IP/IP6</td><td>Explicitly set</td><td>The specified values are used, and the Node resource is updated.</td></tr><tr><td></td><td>Set to autodetect</td><td>The requested method is used (first-found, can-reach, interface, skip-interface), and the Node resource is updated.</td></tr><tr><td></td><td>Not set, but Node resource has IP/IP6 values</td><td>Node resource value is used.</td></tr><tr><td>IP</td><td>Not set, and there is no IP value in Node resource</td><td>Autodetects an IPv4 address and subnet, and updates Node resource.</td></tr><tr><td>IP6</td><td>Not set, and there is a notIP6 value in Node resource</td><td>No IP6 routing is performed on the node。</td></tr></tbody></table><h4 id=3-动作>3. 动作
<a class=anchor href=#3-%e5%8a%a8%e4%bd%9c>#</a></h4><h5 id=31-改变自动检测方法>3.1 改变自动检测方法
<a class=anchor href=#31-%e6%94%b9%e5%8f%98%e8%87%aa%e5%8a%a8%e6%a3%80%e6%b5%8b%e6%96%b9%e6%b3%95>#</a></h5><p>由于默认的自动检测方法是<code>first valid interface found</code>(first-found). 去使用不同的自动检测方法，使用<code>kubectl set env</code>命令指定方法。</p><ul><li>IPv4</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl set env daemonset/calico-node -n kube-system IP_AUTODETECTION_METHOD<span style=color:#f92672>=</span>&lt;autodetection-method&gt;
</span></span></code></pre></div><ul><li>IPv6</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl set env daemonset/calico-node -n kube-system IP6_AUTODETECTION_METHOD<span style=color:#f92672>=</span>&lt;autodetection-method&gt;
</span></span></code></pre></div><ul><li>设置检测方法基于情况</li></ul><p>（1）IP 或 domain name</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl set env daemonset/calico-node -n kube-system IP_AUTODETECTION_METHOD<span style=color:#f92672>=</span>can-reach<span style=color:#f92672>=</span>www.google.com
</span></span></code></pre></div><p>（2）包含匹配的接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl set env daemonset/calico-node -n kube-system IP_AUTODETECTION_METHOD<span style=color:#f92672>=</span>interface<span style=color:#f92672>=</span>eth.*
</span></span></code></pre></div><p>（3）排除匹配的接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl set env daemonset/calico-node -n kube-system IP_AUTODETECTION_METHOD<span style=color:#f92672>=</span>skip-interface<span style=color:#f92672>=</span>eth.*
</span></span></code></pre></div><h5 id=32-针对节点手动配置ip地址和子网>3.2 针对节点手动配置IP地址和子网
<a class=anchor href=#32-%e9%92%88%e5%af%b9%e8%8a%82%e7%82%b9%e6%89%8b%e5%8a%a8%e9%85%8d%e7%bd%aeip%e5%9c%b0%e5%9d%80%e5%92%8c%e5%ad%90%e7%bd%91>#</a></h5><p>在下列情况下,您可能需要配置一个特定的IP子网:</p><ul><li>主机拥有多个外部的接口</li><li>主机接口拥有多个IP地址</li><li>改变跨子网数据包的封装</li><li>改变主机IP地址</li></ul><ol><li>使用环境变量配置IP和子网</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl set env daemonset/calico-node -n kube-system IP<span style=color:#f92672>=</span>10.0.2.10/24 IP6<span style=color:#f92672>=</span>fd80:24e2:f998:72d6::/120
</span></span></code></pre></div><ol><li>使用节点资源配置IP和子网</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>calicoctl patch node kind-control-plane <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --patch<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;spec&#34;:{&#34;bgp&#34;: {&#34;ipv4Address&#34;: &#34;10.0.2.10/24&#34;, &#34;ipv6Address&#34;: &#34;fd80:24e2:f998:72d6::/120&#34;}}}&#39;</span>
</span></span></code></pre></div><p>八、IP地址及封装模式切换
针对安装Calico到kubernetes集群中的每个节点，每个manifest包含所有需要的资源。</p><p>它安装如下的kubernetes资源：</p><ul><li>在每个主机上使用Daemonset的方式安装<code>calico/node</code>容器。</li><li>在每个主机上使用Daemonset的方式安装Calico CNI和网络的配置。</li><li>使用deployment的方式运行<code>calico/kube-controllers</code></li><li><code>calico-etcd-secrets</code>secret, 它提供到etcd存储的TLS.</li><li><code>calico-config</code> ConfigMap. 它包含安装配置的参数。</li></ul><h4 id=1-配置pod-ip-范围>1. 配置pod IP 范围
<a class=anchor href=#1-%e9%85%8d%e7%bd%aepod-ip-%e8%8c%83%e5%9b%b4>#</a></h4><p>Calico IPAM从IP pools中分配 IP地址。</p><p>如果要修改pods使用的默认IP地址范围，那么修改calico.yaml清单中的<code>CALICO_IPV4POOL_CIDR</code>。</p><h4 id=2-配置ip-in-ip>2. 配置IP-in-IP
<a class=anchor href=#2-%e9%85%8d%e7%bd%aeip-in-ip>#</a></h4><p>默认情况下，清单支持跨子网的IP-in-IP封装。许多用户可能希望禁用IP-in-IP封装，例如在以下情况下。</p><ul><li>他们的集群运行在正确配置的AWS VPC中。</li><li>它们的所有Kubernetes节点都连接到同一个第2层网络。</li><li>他们打算使用BGP peer，使他们的基础设施意识到pod IP地址。</li></ul><p>如果要关闭IP-in-IP的封装，修改清单中的<code>CALICO-IPV4POOL_IPIP</code>.</p><h4 id=3-从ip-in-ip到vxlan的切换>3. 从IP-in-IP到VXLAN的切换
<a class=anchor href=#3-%e4%bb%8eip-in-ip%e5%88%b0vxlan%e7%9a%84%e5%88%87%e6%8d%a2>#</a></h4><p>默认情况下，Calico清单支持IP-in-IP封装。如果您所在的网络阻塞了ip中的ip，比如Azure，您可能希望切换到Calico的VXLAN封装模式。要做到这一点，在安装时(以便Calico创建默认的IP池与VXLAN和没有IP-in-IP配置必须撤消):</p><ul><li>启动<code>calico for policy and networking</code> 清单</li><li>使用<code>CALICO_IPV4POOL_VXLAN</code>取代<code>CALICO_IPV4POOL_IPIP</code>的名字。新的变量值同样保持为
<code>Always</code></li><li>完全的关闭Calico的基于BGP网络：<ul><li>使用<code>calico_backend: "vxlan"</code> 代替<code>calico_backend: "bird"</code>. 此步是关闭BIRD。</li><li>从calico/node readiness/liveness check中注释掉<code>--bird-ready</code>和<code>bird-live</code>行。（否则关闭BIRD，将会导致readniess/liveness检查失败）</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>          livenessProbe:
</span></span><span style=display:flex><span>            exec:
</span></span><span style=display:flex><span>              command:
</span></span><span style=display:flex><span>              - /bin/calico-node
</span></span><span style=display:flex><span>              - -felix-live
</span></span><span style=display:flex><span>             <span style=color:#75715e># - -bird-live</span>
</span></span><span style=display:flex><span>          readinessProbe:
</span></span><span style=display:flex><span>            exec:
</span></span><span style=display:flex><span>              command:
</span></span><span style=display:flex><span>              - /bin/calico-node
</span></span><span style=display:flex><span>              <span style=color:#75715e># - -bird-ready</span>
</span></span><span style=display:flex><span>              - -felix-ready
</span></span></code></pre></div><h1 id=k8s-操作>k8s 操作
<a class=anchor href=#k8s-%e6%93%8d%e4%bd%9c>#</a></h1><h3 id=1取消k8s-master节点不可调度>1.取消k8s master节点不可调度
<a class=anchor href=#1%e5%8f%96%e6%b6%88k8s-master%e8%8a%82%e7%82%b9%e4%b8%8d%e5%8f%af%e8%b0%83%e5%ba%a6>#</a></h3><pre tabindex=0><code>kubectl taint nodes k8s-master node-role.kubernetes.io/master:NoSchedule-
</code></pre><p>目录
<strong>Calico简介
Calico 网络Node之间通信网络
Calico网络模型主要工作组件</strong>
示例1:安装calico
<strong>calicoctl命令安装与使用</strong>
示例2:修改BGP网络</p><h3 id=calico简介>Calico简介
<a class=anchor href=#calico%e7%ae%80%e4%bb%8b>#</a></h3><p>Calico 是一种容器之间互通的网络方案。在虚拟化平台中，比如 OpenStack、Docker 等都需要实现 workloads 之间互连，但同时也需要对容器做隔离控制，就像在 Internet 中的服务仅开放80端口、公有云的多租户一样，提供隔离和管控机制。而在多数的虚拟化平台实现中，通常都使用二层隔离技术来实现容器的网络，这些二层的技术有一些弊端，比如需要依赖 VLAN、bridge 和隧道等技术，其中 bridge 带来了复杂性，vlan 隔离和 tunnel 隧道则消耗更多的资源并对物理环境有要求，随着网络规模的增大，整体会变得越加复杂。我们尝试把 Host 当作 Internet 中的路由器，同样使用 BGP 同步路由，并使用 iptables 来做安全访问策略，最终设计出了 Calico 方案。</p><p><strong>设计思想</strong>：Calico 不使用隧道或 NAT 来实现转发，而是巧妙的把所有二三层流量转换成三层流量，并通过 host 上路由配置完成跨 Host 转发</p><h4 id=设计优势>设计优势：
<a class=anchor href=#%e8%ae%be%e8%ae%a1%e4%bc%98%e5%8a%bf>#</a></h4><p>1.更优的资源利用
二层网络通讯需要依赖广播消息机制，广播消息的开销与 host 的数量呈指数级增长，Calico 使用的三层路由方法，则完全抑制了二层广播，减少了资源开销。</p><p>2.可扩展性
Calico 使用与 Internet 类似的方案，Internet 的网络比任何数据中心都大，Calico 同样天然具有可扩展性。</p><p>3.简单而更容易 debug
因为没有隧道，意味着 workloads 之间路径更短更简单，配置更少，在 host 上更容易进行 debug 调试。</p><p>4.更少的依赖
Calico 仅依赖三层路由可达。</p><p>5.可适配性
Calico 较少的依赖性使它能适配所有 VM、Container、白盒或者混合环境场景。</p><h4 id=calico-网络node之间通信网络>Calico 网络Node之间通信网络
<a class=anchor href=#calico-%e7%bd%91%e7%bb%9cnode%e4%b9%8b%e9%97%b4%e9%80%9a%e4%bf%a1%e7%bd%91%e7%bb%9c>#</a></h4><p><strong>IPIP(可跨网段通信)</strong>
从字面来理解，就是把一个IP数据包又套在一个IP包里，即把 IP 层封装到 IP 层的一个 tunnel。它的作用其实基本上就相当于一个基于IP层的网桥！一般来说，普通的网桥是基于mac层的，根本不需 IP，而这个 ipip 则是通过两端的路由做一个 tunnel，把两个本来不通的网络通过点对点连接起来。
类似vxlan 但封装开销比vxlan小 效率相对更高一些，但安全性也更差</p><p><strong>Vxlan(可跨网段通信)</strong>
与Flannel Vxlan原理相同</p><p><strong>BGP(二层网络通信)</strong>
边界网关协议（Border Gateway Protocol, BGP）是互联网上一个核心的去中心化自治路由协议。它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。BGP不使用传统的内部网关协议（IGP）的指标，而使用基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议。BGP，通俗的讲就是讲接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP，BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统
<strong>实际上，Calico 项目提供的 BGP 网络解决方案，与 Flannel 的 host-gw 模式几乎一样。也就是说，Calico也是基于路由表实现容器数据包转发，但不同于Flannel使用flanneld进程来维护路由信息的做法，而Calico项目使用BGP协议来自动维护整个集群的路由信息。</strong></p><p><strong>部署推荐方案:</strong>
BGP+Vxlan</p><p><strong>其中BGP在官方的推荐方案中 以50个节点为界区别了不同规模使用不同的部署方案</strong></p><ul><li>小规模网络:BGP peer 一对一网络：每个节点都是有N-1条路由，小型网络适用，当节点数N变多时，路由表更新及AIP-SERVER都需要承受很大的压力 类似网络拓扑结构中的 网状拓扑结构</li><li>大规模网络:BGP Reflector 路由反射器：选择一到多个节点做为Reflector，所有节点路由都汇总给Reflector，所有节点都路由都指向Reflector ，适合大型网络，类似网络拓扑结构中的星型网络</li></ul><h3 id=calico网络模型主要工作组件>Calico网络模型主要工作组件：###
<a class=anchor href=#calico%e7%bd%91%e7%bb%9c%e6%a8%a1%e5%9e%8b%e4%b8%bb%e8%a6%81%e5%b7%a5%e4%bd%9c%e7%bb%84%e4%bb%b6>#</a></h3><ol><li>Felix：运行在每一台 Host 的 agent 进程，主要负责网络接口管理和监听、路由、ARP 管理、ACL 管理和同步、状态上报等。</li><li>etcd：分布式键值存储，主要负责网络元数据一致性，确保Calico网络状态的准确性，可以与kubernetes共用；</li><li>BGP Client（BIRD）：Calico 为每一台 Host 部署一个 BGP Client，使用 BIRD 实现，BIRD 是一个单独的持续发展的项目，实现了众多动态路由协议比如 BGP、OSPF、RIP 等。在 Calico 的角色是监听 Host 上由 Felix 注入的路由信息，然后通过 BGP 协议广播告诉剩余 Host 节点，从而实现网络互通。</li><li>BGP Route Reflector：在大型网络规模中，如果仅仅使用 BGP client 形成 mesh 全网互联的方案就会导致规模限制，因为所有节点之间俩俩互联，需要 N^2 个连接，为了解决这个规模问题，可以采用 BGP 的 Router Reflector 的方法，使所有 BGP Client 仅与特定 RR 节点互联并做路由同步，从而大大减少连接数。</li></ol><h4 id=calico有两种运行方式>Calico有两种运行方式，
<a class=anchor href=#calico%e6%9c%89%e4%b8%a4%e7%a7%8d%e8%bf%90%e8%a1%8c%e6%96%b9%e5%bc%8f>#</a></h4><ol><li>是让calico/node独立运行于Kubernetes集群之外，但calico/kube-controllers依然需要以Pod资源运行中集群之上;</li><li>是以CNI插件方式配置Calico完全托管运行于Kubernetes集群之上，类似于我们前面曾经部署托管Flannel网络插件的方式。
对于后一种方式,Calico提供了在线的部署清单，它分别为50节点及以下规模和50节点以上规模的Kubernetes集群使用Kubernetes API作为Dabastore提供了不同的配置清单，也为使用独立的etcd集群提供了专用配置清单。但这3种类型的配置清单中,Calico默认启用的是基于IPIP隧道的叠加网络，因而它会在所有流量上使用IPIP隧道而不是BGP路由。以下配置定义在部署清单中DaemonSet/calico-node资源的Pod模板中的calico-node容器之上。</li></ol><p><strong>配置选项</strong>
在IPv4类型的地址池上启用的IPIP及其类型，支持3种可用值
Always(全局流量)、Cross-SubNet(跨子网流量)和Never3种可用值</p><ul><li>name: CALICO_IPV4POOL_IPIP
value: &ldquo;Always&rdquo;</li><li>是否在IPV4地址池上启用VXLAN隧道协议，取值及意义与Flannel的VXLAN后端相同;但在全局流量启用VXLAN时将完全不再需要BGP网络，建议将相关的组件禁用</li><li>name: CALICO_ IPV4POOL_VXLAN
value: &ldquo;Never&rdquo;</li><li>需要注意的是，Calico分配的地址池需要同Ktbernetes集群的Pod网络的定义保持一致。Pod网络通常由kubeadm init初始化集群时使用&ndash;pod-network-cidr选项指定的网络，而Calico在其默认的配置清单中默认使用192.168.0.0/16作为Pod网络，因而部署Kubernetes集群时应该规划好要使用的网络地址，并设定此二者相匹配。对于曾经使用了flannel的默认的10.244.0.0/16网络的环境而言,我们也可以选择修改资源清单中的定义，从而将其修改为其他网络地址,它定义在DaemonSet/calico-node资源的Pod模板中的calico-node容器之上。</li></ul><p>官网链接：</p><blockquote><p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.projectcalico.org%2Fgetting-started%2Fkubernetes%2Fself-managed-onprem%2Fonpremises">https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises</a></p></blockquote><h5 id=示例1安装calico>示例1:安装calico
<a class=anchor href=#%e7%a4%ba%e4%be%8b1%e5%ae%89%e8%a3%85calico>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget https://docs.projectcalico.org/manifests/calico.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># cd /etc/kubernetes/manifests/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master manifests<span style=color:#f92672>]</span><span style=color:#75715e># cat kube-controller-manager.yaml </span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>System Info:
</span></span><span style=display:flex><span>  Machine ID:                 32599e2a74704b2e95443e24ea15d4f6
</span></span><span style=display:flex><span>  System UUID:                34979a62-16de-4287-b149-2d4c2d8a70fb
</span></span><span style=display:flex><span>  Boot ID:                    f31de60e-4f89-4553-ba7a-99a46d049936
</span></span><span style=display:flex><span>  Kernel Version:             5.4.109-1.el7.elrepo.x86_64
</span></span><span style=display:flex><span>  OS Image:                   CentOS Linux <span style=color:#ae81ff>7</span> <span style=color:#f92672>(</span>Core<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Operating System:           linux
</span></span><span style=display:flex><span>  Architecture:               amd64
</span></span><span style=display:flex><span>  Container Runtime Version:  docker://20.10.7
</span></span><span style=display:flex><span>  Kubelet Version:            v1.19.9
</span></span><span style=display:flex><span>  Kube-Proxy Version:         v1.19.9
</span></span><span style=display:flex><span>PodCIDR:                      10.244.1.0/24  <span style=color:#75715e>#第个节点的地址块都是由K8S分配</span>
</span></span><span style=display:flex><span>PodCIDRs:                     10.244.1.0/24   
</span></span><span style=display:flex><span>Non-terminated Pods:          <span style=color:#f92672>(</span><span style=color:#ae81ff>17</span> in total<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl describe node k8s-node1</span>
</span></span><span style=display:flex><span>System Info:
</span></span><span style=display:flex><span>  Machine ID:                 32599e2a74704b2e95443e24ea15d4f6
</span></span><span style=display:flex><span>  System UUID:                34979a62-16de-4287-b149-2d4c2d8a70fb
</span></span><span style=display:flex><span>  Boot ID:                    f31de60e-4f89-4553-ba7a-99a46d049936
</span></span><span style=display:flex><span>  Kernel Version:             5.4.109-1.el7.elrepo.x86_64
</span></span><span style=display:flex><span>  OS Image:                   CentOS Linux <span style=color:#ae81ff>7</span> <span style=color:#f92672>(</span>Core<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Operating System:           linux
</span></span><span style=display:flex><span>  Architecture:               amd64
</span></span><span style=display:flex><span>  Container Runtime Version:  docker://20.10.7
</span></span><span style=display:flex><span>  Kubelet Version:            v1.19.9
</span></span><span style=display:flex><span>  Kube-Proxy Version:         v1.19.9
</span></span><span style=display:flex><span>PodCIDR:                      10.244.1.0/24   <span style=color:#75715e>#每个Node Pod都是由K8S分配IP</span>
</span></span><span style=display:flex><span>PodCIDRs:                     10.244.1.0/24
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master Network<span style=color:#f92672>]</span><span style=color:#75715e># vim calico.yaml</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;ipam&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;host-local&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;subnet&#34;</span>: <span style=color:#e6db74>&#34;usePodCidr&#34;</span>   <span style=color:#75715e>#使用k8s ipam插件分配地址 </span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;policy&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;k8s&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>- name: FELIX_WIREGUARDMTU
</span></span><span style=display:flex><span>              valueFrom:
</span></span><span style=display:flex><span>                configMapKeyRef:
</span></span><span style=display:flex><span>                  name: calico-config
</span></span><span style=display:flex><span>                  key: veth_mtu
</span></span><span style=display:flex><span>            <span style=color:#75715e># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># chosen from this range. Changing this value after installation will have</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># no effect. This should fall within `--cluster-cidr`.</span>
</span></span><span style=display:flex><span>            - name: CALICO_IPV4POOL_CIDR
</span></span><span style=display:flex><span>              value: <span style=color:#e6db74>&#34;10.244.0.0/16&#34;</span>  <span style=color:#75715e>#为了和之前的flannel 10.244.0.0/16适配</span>
</span></span><span style=display:flex><span>            - name: CALICO_IPV4POOL_BLOCK_SIZE  <span style=color:#75715e>#添加这一行修改默认块大小</span>
</span></span><span style=display:flex><span>              value: <span style=color:#e6db74>&#34;24&#34;</span>
</span></span><span style=display:flex><span>            - name: USE_POD_CIDR  <span style=color:#75715e>#使用K8S的分配的IP地址，不然calico和K8S分配的地址会不一样</span>
</span></span><span style=display:flex><span>              value: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><ul><li>安装calico</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master plugin<span style=color:#f92672>]</span><span style=color:#75715e># kubectl delete -f kube-flannel.yml</span>
</span></span><span style=display:flex><span>podsecuritypolicy.policy <span style=color:#e6db74>&#34;psp.flannel.unprivileged&#34;</span> deleted
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io <span style=color:#e6db74>&#34;flannel&#34;</span> deleted
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io <span style=color:#e6db74>&#34;flannel&#34;</span> deleted
</span></span><span style=display:flex><span>serviceaccount <span style=color:#e6db74>&#34;flannel&#34;</span> deleted
</span></span><span style=display:flex><span>configmap <span style=color:#e6db74>&#34;kube-flannel-cfg&#34;</span> deleted
</span></span><span style=display:flex><span>daemonset.apps <span style=color:#e6db74>&#34;kube-flannel-ds&#34;</span> deleted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master plugin<span style=color:#f92672>]</span><span style=color:#75715e># kubectl apply -f calico.yaml </span>
</span></span><span style=display:flex><span>configmap/calico-config created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
</span></span><span style=display:flex><span>customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/calico-node created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/calico-node created
</span></span><span style=display:flex><span>daemonset.apps/calico-node created
</span></span><span style=display:flex><span>serviceaccount/calico-node created
</span></span><span style=display:flex><span>deployment.apps/calico-kube-controllers created
</span></span><span style=display:flex><span>serviceaccount/calico-kube-controllers created
</span></span><span style=display:flex><span>poddisruptionbudget.policy/calico-kube-controllers created
</span></span></code></pre></div><ul><li>calico几个组件</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># ps aux|grep calico</span>
</span></span><span style=display:flex><span>root     <span style=color:#ae81ff>10867</span>  0.0  0.1 <span style=color:#ae81ff>112816</span>  <span style=color:#ae81ff>2156</span> pts/1    S+   13:51   0:00 grep --color<span style=color:#f92672>=</span>auto calico
</span></span><span style=display:flex><span>root     <span style=color:#ae81ff>20680</span>  0.0  2.3 <span style=color:#ae81ff>1215184</span> <span style=color:#ae81ff>35216</span> ?       Sl   10:27   0:06 calico-node -allocate-tunnel-addrs
</span></span><span style=display:flex><span>root     <span style=color:#ae81ff>20681</span>  0.0  2.1 <span style=color:#ae81ff>1215184</span> <span style=color:#ae81ff>32672</span> ?       Sl   10:27   0:06 calico-node -monitor-addresses
</span></span><span style=display:flex><span>root     <span style=color:#ae81ff>20682</span>  2.4  3.3 <span style=color:#ae81ff>1510624</span> <span style=color:#ae81ff>51636</span> ?       Sl   10:27   4:54 calico-node -felix
</span></span><span style=display:flex><span>root     <span style=color:#ae81ff>20683</span>  0.0  2.3 <span style=color:#ae81ff>1657832</span> <span style=color:#ae81ff>35496</span> ?       Sl   10:27   0:09 calico-node -confd
</span></span><span style=display:flex><span>root     <span style=color:#ae81ff>20686</span>  0.0  2.0 <span style=color:#ae81ff>1214928</span> <span style=color:#ae81ff>31628</span> ?       Sl   10:27   0:05 calico-node -monitor-token
</span></span></code></pre></div><ul><li>因为calico并没有使用k8s的ipam分配IP,所以节点会有2个IP,一个是K8S分配的IP 一个是calico分配的IP</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Kernel IP routing table
</span></span><span style=display:flex><span>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span style=display:flex><span>0.0.0.0         192.168.54.2    0.0.0.0         UG    <span style=color:#ae81ff>101</span>    <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> eth4
</span></span><span style=display:flex><span>172.17.0.0      0.0.0.0         255.255.0.0     U     <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> docker0
</span></span><span style=display:flex><span>192.168.4.0     0.0.0.0         255.255.255.0   U     <span style=color:#ae81ff>100</span>    <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> eth0
</span></span><span style=display:flex><span>192.168.12.0    192.168.4.172   255.255.255.0   UG    <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> tunl0  <span style=color:#75715e>#可以看到tunl0的路由信息</span>
</span></span><span style=display:flex><span>192.168.51.0    192.168.4.173   255.255.255.0   UG    <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> tunl0  <span style=color:#75715e>#同时可以看到节点的IP不像之前一定是连续的</span>
</span></span><span style=display:flex><span>192.168.54.0    0.0.0.0         255.255.255.0   U     <span style=color:#ae81ff>101</span>    <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> eth4
</span></span><span style=display:flex><span>192.168.113.0   192.168.4.171   255.255.255.0   UG    <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> tunl0  <span style=color:#75715e>#隧道接口</span>
</span></span><span style=display:flex><span>192.168.237.0   0.0.0.0         255.255.255.0   U     <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> *
</span></span><span style=display:flex><span>192.168.237.1   0.0.0.0         255.255.255.255 UH    <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> cali7c0fb624285
</span></span><span style=display:flex><span>192.168.237.2   0.0.0.0         255.255.255.255 UH    <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> caliedaf285d4ef
</span></span><span style=display:flex><span>192.168.237.3   0.0.0.0         255.255.255.255 UH    <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>        <span style=color:#ae81ff>0</span> cali854da94d42a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># ip route list</span>
</span></span><span style=display:flex><span>default via 192.168.54.2 dev eth4 proto static metric <span style=color:#ae81ff>101</span> 
</span></span><span style=display:flex><span>172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown 
</span></span><span style=display:flex><span>192.168.4.0/24 dev eth0 proto kernel scope link src 192.168.4.170 metric <span style=color:#ae81ff>100</span> 
</span></span><span style=display:flex><span>192.168.12.0/24 via 192.168.4.172 dev tunl0 proto bird onlink   <span style=color:#75715e>#可以看到tunl0的路由信息</span>
</span></span><span style=display:flex><span>192.168.51.0/24 via 192.168.4.173 dev tunl0 proto bird onlink    
</span></span><span style=display:flex><span>192.168.54.0/24 dev eth4 proto kernel scope link src 192.168.54.170 metric <span style=color:#ae81ff>101</span> 
</span></span><span style=display:flex><span>192.168.113.0/24 via 192.168.4.171 dev tunl0 proto bird onlink 
</span></span><span style=display:flex><span>blackhole 192.168.237.0/24 proto bird 
</span></span><span style=display:flex><span>192.168.237.1 dev cali7c0fb624285 scope link 
</span></span><span style=display:flex><span>192.168.237.2 dev caliedaf285d4ef scope link 
</span></span><span style=display:flex><span>192.168.237.3 dev cali854da94d42a scope link 
</span></span></code></pre></div><ul><li>192.168.51.0/24 via 192.168.4.173 dev tunl0 proto bird onlink 下面的路由表可以看到 calico会为每个节点分配网络地址段 并不是使用节点的网络地址</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-node1 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip route list</span>
</span></span><span style=display:flex><span>default via 192.168.54.2 dev eth4 proto static metric <span style=color:#ae81ff>101</span> 
</span></span><span style=display:flex><span>172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown 
</span></span><span style=display:flex><span>192.168.4.0/24 dev eth0 proto kernel scope link src 192.168.4.171 metric <span style=color:#ae81ff>100</span> 
</span></span><span style=display:flex><span>192.168.12.0/24 via 192.168.4.172 dev tunl0 proto bird onlink 
</span></span><span style=display:flex><span>192.168.51.0/24 via 192.168.4.173 dev tunl0 proto bird onlink 
</span></span><span style=display:flex><span>192.168.54.0/24 dev eth4 proto kernel scope link src 192.168.54.171 metric <span style=color:#ae81ff>101</span> 
</span></span><span style=display:flex><span>blackhole 192.168.113.0/24 proto bird   <span style=color:#75715e>#黑洞 代表自己网段 </span>
</span></span><span style=display:flex><span>192.168.237.0/24 via 192.168.4.170 dev tunl0 proto bird onlink
</span></span></code></pre></div><ul><li>查看目前工作模式</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># kubectl api-resources</span>
</span></span><span style=display:flex><span>NAME                              SHORTNAMES   APIGROUP                       NAMESPACED   KIND
</span></span><span style=display:flex><span>bgpconfigurations                              crd.projectcalico.org          false        BGPConfiguration
</span></span><span style=display:flex><span>bgppeers                                       crd.projectcalico.org          false        BGPPeer
</span></span><span style=display:flex><span>blockaffinities                                crd.projectcalico.org          false        BlockAffinity
</span></span><span style=display:flex><span>clusterinformations                            crd.projectcalico.org          false        ClusterInformation
</span></span><span style=display:flex><span>felixconfigurations                            crd.projectcalico.org          false        FelixConfiguration
</span></span><span style=display:flex><span>globalnetworkpolicies                          crd.projectcalico.org          false        GlobalNetworkPolicy
</span></span><span style=display:flex><span>globalnetworksets                              crd.projectcalico.org          false        GlobalNetworkSet
</span></span><span style=display:flex><span>hostendpoints                                  crd.projectcalico.org          false        HostEndpoint
</span></span><span style=display:flex><span>ipamblocks                                     crd.projectcalico.org          false        IPAMBlock
</span></span><span style=display:flex><span>ipamconfigs                                    crd.projectcalico.org          false        IPAMConfig
</span></span><span style=display:flex><span>ipamhandles                                    crd.projectcalico.org          false        IPAMHandle
</span></span><span style=display:flex><span>ippools                                        crd.projectcalico.org          false        IPPool  <span style=color:#75715e>#calico地址池</span>
</span></span><span style=display:flex><span>kubecontrollersconfigurations                  crd.projectcalico.org          false        KubeControllersConfiguration
</span></span><span style=display:flex><span>networkpolicies                                crd.projectcalico.org          true         NetworkPolicy
</span></span><span style=display:flex><span>networksets                                    crd.projectcalico.org          true         NetworkSet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get  ippools -o yaml</span>
</span></span><span style=display:flex><span>....
</span></span><span style=display:flex><span>  spec:
</span></span><span style=display:flex><span>    blockSize: <span style=color:#ae81ff>24</span>   <span style=color:#75715e>#掩码长度</span>
</span></span><span style=display:flex><span>    cidr: 192.168.0.0/16  <span style=color:#75715e>#地址池</span>
</span></span><span style=display:flex><span>    ipipMode: Always      <span style=color:#75715e>#可以看到目前为ipip模式</span>
</span></span><span style=display:flex><span>    natOutgoing: true
</span></span><span style=display:flex><span>    nodeSelector: all<span style=color:#f92672>()</span>
</span></span></code></pre></div><ul><li>访问抓包</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master PodControl<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod -o wide</span>
</span></span><span style=display:flex><span>NAME                              READY   STATUS    RESTARTS   AGE    IP             NODE        NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>deployment-demo-fb544c5d8-r7pc8   1/1     Running   <span style=color:#ae81ff>0</span>          8m3s   192.168.51.1   k8s-node3   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>deployment-demo-fb544c5d8-splfr   1/1     Running   <span style=color:#ae81ff>0</span>          8m3s   192.168.12.1   k8s-node2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master PodControl<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec deployment-demo-fb544c5d8-r7pc8 -it -- /bin/sh</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@deployment-demo-fb544c5d8-r7pc8 /<span style=color:#f92672>]</span><span style=color:#75715e># ifconfig</span>
</span></span><span style=display:flex><span>eth0      Link encap:Ethernet  HWaddr 16:96:97:3F:F3:C5  
</span></span><span style=display:flex><span>          inet addr:192.168.51.1  Bcast:192.168.51.1  Mask:255.255.255.255
</span></span><span style=display:flex><span>          UP BROADCAST RUNNING MULTICAST  MTU:1480  Metric:1
</span></span><span style=display:flex><span>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
</span></span><span style=display:flex><span>          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
</span></span><span style=display:flex><span>          collisions:0 txqueuelen:0 
</span></span><span style=display:flex><span>          RX bytes:0 <span style=color:#f92672>(</span>0.0 B<span style=color:#f92672>)</span>  TX bytes:0 <span style=color:#f92672>(</span>0.0 B<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lo        Link encap:Local Loopback  
</span></span><span style=display:flex><span>          inet addr:127.0.0.1  Mask:255.0.0.0
</span></span><span style=display:flex><span>          UP LOOPBACK RUNNING  MTU:65536  Metric:1
</span></span><span style=display:flex><span>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
</span></span><span style=display:flex><span>          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
</span></span><span style=display:flex><span>          collisions:0 txqueuelen:1000 
</span></span><span style=display:flex><span>          RX bytes:0 <span style=color:#f92672>(</span>0.0 B<span style=color:#f92672>)</span>  TX bytes:0 <span style=color:#f92672>(</span>0.0 B<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@deployment-demo-fb544c5d8-r7pc8 /<span style=color:#f92672>]</span><span style=color:#75715e># curl 192.168.12.1</span>
</span></span><span style=display:flex><span>iKubernetes demoapp v1.0 !! ClientIP: 192.168.51.1, ServerName: deployment-demo-fb544c5d8-splfr, ServerIP: 192.168.12.1!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@deployment-demo-fb544c5d8-r7pc8 /<span style=color:#f92672>]</span><span style=color:#75715e># curl 192.168.12.1</span>
</span></span><span style=display:flex><span>iKubernetes demoapp v1.0 !! ClientIP: 192.168.51.1, ServerName: deployment-demo-fb544c5d8-splfr, ServerIP: 192.168.12.1!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@deployment-demo-fb544c5d8-r7pc8 /<span style=color:#f92672>]</span><span style=color:#75715e># curl 192.168.12.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-node2 ~<span style=color:#f92672>]</span><span style=color:#75715e># tcpdump -i eth0 -nn ip host 192.168.4.172  and host 192.168.4.173</span>
</span></span><span style=display:flex><span>tcpdump: verbose output suppressed, use -v or -vv <span style=color:#66d9ef>for</span> full protocol decode
</span></span><span style=display:flex><span>listening on eth0, link-type EN10MB <span style=color:#f92672>(</span>Ethernet<span style=color:#f92672>)</span>, capture size <span style=color:#ae81ff>262144</span> bytes
</span></span><span style=display:flex><span>11:48:24.421003 IP 192.168.4.173 &gt; 192.168.4.172: IP 192.168.51.1.33436 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>S<span style=color:#f92672>]</span>, seq 3259804851, win 64800, options <span style=color:#f92672>[</span>mss 1440,sackOK,TS val <span style=color:#ae81ff>2008488248</span> ecr 0,nop,wscale 7<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11:48:24.421093 IP 192.168.4.172 &gt; 192.168.4.173: IP 192.168.12.1.80 &gt; 192.168.51.1.33436: Flags <span style=color:#f92672>[</span>S.<span style=color:#f92672>]</span>, seq 3234480084, ack 3259804852, win 64260, options <span style=color:#f92672>[</span>mss 1440,sackOK,TS val <span style=color:#ae81ff>1053230437</span> ecr 2008488248,nop,wscale 7<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>  <span style=color:#75715e>#可以看到(ipip-proto-4)为IPIP模式</span>
</span></span><span style=display:flex><span>11:48:24.422305 IP 192.168.4.173 &gt; 192.168.4.172: IP 192.168.51.1.33436 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, ack 1, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>2008488250</span> ecr 1053230437<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11:48:24.422308 IP 192.168.4.173 &gt; 192.168.4.172: IP 192.168.51.1.33436 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1:77, ack 1, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>2008488250</span> ecr 1053230437<span style=color:#f92672>]</span>, length 76: HTTP: GET / HTTP/1.1 <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11:48:24.422554 IP 192.168.4.172 &gt; 192.168.4.173: IP 192.168.12.1.80 &gt; 192.168.51.1.33436: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, ack 77, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1053230439</span> ecr 2008488250<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11:48:24.431688 IP 192.168.4.172 &gt; 192.168.4.173: IP 192.168.12.1.80 &gt; 192.168.51.1.33436: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1:18, ack 77, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1053230447</span> ecr 2008488250<span style=color:#f92672>]</span>, length 17: HTTP: HTTP/1.0 <span style=color:#ae81ff>200</span> OK <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11:48:24.432638 IP 192.168.4.172 &gt; 192.168.4.173: IP 192.168.12.1.80 &gt; 192.168.51.1.33436: Flags <span style=color:#f92672>[</span>FP.<span style=color:#f92672>]</span>, seq 18:276, ack 77, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1053230449</span> ecr 2008488250<span style=color:#f92672>]</span>, length 258: HTTP <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11:48:24.433660 IP 192.168.4.173 &gt; 192.168.4.172: IP 192.168.51.1.33436 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, ack 18, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>2008488261</span> ecr 1053230447<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11:48:24.437531 IP 192.168.4.173 &gt; 192.168.4.172: IP 192.168.51.1.33436 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>F.<span style=color:#f92672>]</span>, seq 77, ack 277, win 505, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>2008488261</span> ecr 1053230449<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11:48:24.437775 IP 192.168.4.172 &gt; 192.168.4.173: IP 192.168.12.1.80 &gt; 192.168.51.1.33436: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, ack 78, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1053230454</span> ecr 2008488261<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>ipip-proto-4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>IP 192.168.4.172 &gt; 192.168.4.173: IP 192.168.12.1.80 &gt; 192.168.51.1.33436 
</span></span></code></pre></div><ul><li>可以看到默认为ipip模式 也是经过封装在转发的 和Flannel很类似,但相对Flannel经过虚拟网桥CNI calico直接内核(内核的路由由 kube-proxy或IPVS生成)到在由tunl0传输想对Flannel少了一层交换机交换的过程,性能相比Flannel会快一些 但这并不是calico最佳的模式</li></ul><h3 id=calicoctl命令安装与使用>calicoctl命令安装与使用
<a class=anchor href=#calicoctl%e5%91%bd%e4%bb%a4%e5%ae%89%e8%a3%85%e4%b8%8e%e4%bd%bf%e7%94%a8>#</a></h3><p><strong>calicoctl安装的2种方式
第1种方式 calicoctl</strong></p><blockquote><p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.projectcalico.org%2Fgetting-started%2Fclis%2Fcalicoctl%2Finstall">https://docs.projectcalico.org/getting-started/clis/calicoctl/install</a></p></blockquote><ul><li>几种方式运行calicoctl 常用方式1:直接下载2进制calicoctl 直接运行</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -o calicoctl -O -L  &#34;https://github.com/projectcalico/calicoctl/releases/download/v3.20.0/calicoctl&#34;</span>
</span></span><span style=display:flex><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style=display:flex><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style=display:flex><span><span style=color:#ae81ff>100</span>   <span style=color:#ae81ff>615</span>  <span style=color:#ae81ff>100</span>   <span style=color:#ae81ff>615</span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>498</span>      <span style=color:#ae81ff>0</span>  0:00:01  0:00:01 --:--:--   <span style=color:#ae81ff>504</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>100</span> 43.2M  <span style=color:#ae81ff>100</span> 43.2M    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>   518k      <span style=color:#ae81ff>0</span>  0:01:25  0:01:25 --:--:--  920k
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># mv calicoctl /usr/bin/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># chmod +x /usr/bin/calicoctl </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl  --help</span>
</span></span><span style=display:flex><span>Usage:
</span></span><span style=display:flex><span>  calicoctl <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> &lt;command&gt; <span style=color:#f92672>[</span>&lt;args&gt;...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    create       Create a resource by file, directory or stdin.
</span></span><span style=display:flex><span>    replace      Replace a resource by file, directory or stdin.
</span></span><span style=display:flex><span>    apply        Apply a resource by file, directory or stdin.  This creates a resource
</span></span><span style=display:flex><span>                 <span style=color:#66d9ef>if</span> it does not exist, and replaces a resource <span style=color:#66d9ef>if</span> it does exists.
</span></span><span style=display:flex><span>    patch        Patch a pre-exisiting resource in place.
</span></span><span style=display:flex><span>    delete       Delete a resource identified by file, directory, stdin or resource type and
</span></span><span style=display:flex><span>                 name.
</span></span><span style=display:flex><span>    get          Get a resource identified by file, directory, stdin or resource type and
</span></span><span style=display:flex><span>                 name.
</span></span><span style=display:flex><span>    label        Add or update labels of resources.
</span></span><span style=display:flex><span>    convert      Convert config files between different API versions.
</span></span><span style=display:flex><span>    ipam         IP address management.
</span></span><span style=display:flex><span>    node         Calico node management.
</span></span><span style=display:flex><span>    version      Display the version of this binary.
</span></span><span style=display:flex><span>    export       Export the Calico datastore objects <span style=color:#66d9ef>for</span> migration
</span></span><span style=display:flex><span>    import       Import the Calico datastore objects <span style=color:#66d9ef>for</span> migration
</span></span><span style=display:flex><span>    datastore    Calico datastore management.
</span></span></code></pre></div><ul><li>calicoctl 命令使用</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>- calicoctl 默认会读取 ~/.kube/下文件加载认证信息,也可以通过配置文件指定认证信息位置
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /etc/calico/^C</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># cd /etc/calico/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># cat calicoctl.cfg </span>
</span></span><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: CalicoAPIConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  datastoreType: <span style=color:#e6db74>&#34;kubernetes&#34;</span>
</span></span><span style=display:flex><span>  kubeconfig: <span style=color:#e6db74>&#34;/etc/kubernetes/admin.conf&#34;</span> <span style=color:#75715e>#指定conf路径</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get ippools</span>
</span></span><span style=display:flex><span>NAME                  AGE
</span></span><span style=display:flex><span>default-ipv4-ippool   23h
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl get ippool  #可以用calicoctl直接访问 calico资源</span>
</span></span><span style=display:flex><span>NAME                  CIDR             SELECTOR   
</span></span><span style=display:flex><span>default-ipv4-ippool   192.168.0.0/16   all<span style=color:#f92672>()</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl get ippool default-ipv4-ippool -o yaml</span>
</span></span><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: IPPool
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  creationTimestamp: <span style=color:#e6db74>&#34;2021-08-29T14:33:53Z&#34;</span>
</span></span><span style=display:flex><span>  name: default-ipv4-ippool
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#e6db74>&#34;1305&#34;</span>
</span></span><span style=display:flex><span>  uid: c01d73f3-c0c9-4674-b27e-725a1eaa5717
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  blockSize: <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>  cidr: 192.168.0.0/16
</span></span><span style=display:flex><span>  ipipMode: Always
</span></span><span style=display:flex><span>  natOutgoing: true
</span></span><span style=display:flex><span>  nodeSelector: all<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  vxlanMode: Never
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl ipam --help  </span>
</span></span><span style=display:flex><span>Usage:
</span></span><span style=display:flex><span>  calicoctl <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>&lt;args&gt;...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -h --help                 Show this screen.
</span></span><span style=display:flex><span>  -c --config<span style=color:#f92672>=</span>&lt;config&gt;      Path to the file containing connection
</span></span><span style=display:flex><span>                            configuration in YAML or JSON format.
</span></span><span style=display:flex><span>                            <span style=color:#f92672>[</span>default: /etc/calico/calicoctl.cfg<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  --context<span style=color:#f92672>=</span>&lt;context&gt;       The name of the kubeconfig context to use.
</span></span><span style=display:flex><span>  -a
</span></span><span style=display:flex><span>  -A --all-namespaces
</span></span><span style=display:flex><span>     --as<span style=color:#f92672>=</span>&lt;AS_NUM&gt;
</span></span><span style=display:flex><span>     --backend<span style=color:#f92672>=(</span>bird|gobgp|none<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>     --dryrun
</span></span><span style=display:flex><span>     --export
</span></span><span style=display:flex><span>     --felix-config<span style=color:#f92672>=</span>&lt;CONFIG&gt;
</span></span><span style=display:flex><span>  -f --filename<span style=color:#f92672>=</span>&lt;FILENAME&gt;
</span></span><span style=display:flex><span>     --force
</span></span><span style=display:flex><span>     --from-report<span style=color:#f92672>=</span>&lt;REPORT&gt;
</span></span><span style=display:flex><span>     --ignore-validation
</span></span><span style=display:flex><span>     --init-system
</span></span><span style=display:flex><span>     --ip6-autodetection-method<span style=color:#f92672>=</span>&lt;IP6_AUTODETECTION_METHOD&gt;
</span></span><span style=display:flex><span>     --ip6<span style=color:#f92672>=</span>&lt;IP6&gt;
</span></span><span style=display:flex><span>     --ip-autodetection-method<span style=color:#f92672>=</span>&lt;IP_AUTODETECTION_METHOD&gt;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl ipam show</span>
</span></span><span style=display:flex><span>+----------+----------------+-----------+------------+--------------+
</span></span><span style=display:flex><span>| GROUPING |      CIDR      | IPS TOTAL | IPS IN USE |   IPS FREE   |
</span></span><span style=display:flex><span>+----------+----------------+-----------+------------+--------------+
</span></span><span style=display:flex><span>| IP Pool  | 192.168.0.0/16 |     <span style=color:#ae81ff>65536</span> | <span style=color:#ae81ff>9</span> <span style=color:#f92672>(</span>0%<span style=color:#f92672>)</span>     | <span style=color:#ae81ff>65527</span> <span style=color:#f92672>(</span>100%<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span>+----------+----------------+-----------+------------+--------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl ipam show  --show-blocks  #每个地址段使用了多少个</span>
</span></span><span style=display:flex><span>+----------+------------------+-----------+------------+--------------+
</span></span><span style=display:flex><span>| GROUPING |       CIDR       | IPS TOTAL | IPS IN USE |   IPS FREE   |
</span></span><span style=display:flex><span>+----------+------------------+-----------+------------+--------------+
</span></span><span style=display:flex><span>| IP Pool  | 192.168.0.0/16   |     <span style=color:#ae81ff>65536</span> | <span style=color:#ae81ff>9</span> <span style=color:#f92672>(</span>0%<span style=color:#f92672>)</span>     | <span style=color:#ae81ff>65527</span> <span style=color:#f92672>(</span>100%<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span>| Block    | 192.168.113.0/24 |       <span style=color:#ae81ff>256</span> | <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>0%<span style=color:#f92672>)</span>     | <span style=color:#ae81ff>255</span> <span style=color:#f92672>(</span>100%<span style=color:#f92672>)</span>   |
</span></span><span style=display:flex><span>| Block    | 192.168.12.0/24  |       <span style=color:#ae81ff>256</span> | <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>1%<span style=color:#f92672>)</span>     | <span style=color:#ae81ff>254</span> <span style=color:#f92672>(</span>99%<span style=color:#f92672>)</span>    |
</span></span><span style=display:flex><span>| Block    | 192.168.237.0/24 |       <span style=color:#ae81ff>256</span> | <span style=color:#ae81ff>4</span> <span style=color:#f92672>(</span>2%<span style=color:#f92672>)</span>     | <span style=color:#ae81ff>252</span> <span style=color:#f92672>(</span>98%<span style=color:#f92672>)</span>    |
</span></span><span style=display:flex><span>| Block    | 192.168.51.0/24  |       <span style=color:#ae81ff>256</span> | <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>1%<span style=color:#f92672>)</span>     | <span style=color:#ae81ff>254</span> <span style=color:#f92672>(</span>99%<span style=color:#f92672>)</span>    |
</span></span><span style=display:flex><span>+----------+------------------+-----------+------------+--------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl ipam show  --show-config  #查看配置信息</span>
</span></span><span style=display:flex><span>+--------------------+-------+
</span></span><span style=display:flex><span>|      PROPERTY      | VALUE |
</span></span><span style=display:flex><span>+--------------------+-------+
</span></span><span style=display:flex><span>| StrictAffinity     | false |
</span></span><span style=display:flex><span>| AutoAllocateBlocks | true  |
</span></span><span style=display:flex><span>| MaxBlocksPerHost   |     <span style=color:#ae81ff>0</span> |
</span></span><span style=display:flex><span>+--------------------+-------+
</span></span></code></pre></div><h5 id=第2种方式-以kubectl插件方式运行>第2种方式 以kubectl插件方式运行
<a class=anchor href=#%e7%ac%ac2%e7%a7%8d%e6%96%b9%e5%bc%8f-%e4%bb%a5kubectl%e6%8f%92%e4%bb%b6%e6%96%b9%e5%bc%8f%e8%bf%90%e8%a1%8c>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># cp -p /usr/bin/calicoctl  /usr/bin/kubectl-calico  #把之前的文件改个名字就可以了</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># kubectl calico</span>
</span></span><span style=display:flex><span>Usage:
</span></span><span style=display:flex><span>  kubectl-calico <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> &lt;command&gt; <span style=color:#f92672>[</span>&lt;args&gt;...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Invalid option: <span style=color:#e6db74>&#39;&#39;</span>. Use flag <span style=color:#e6db74>&#39;--help&#39;</span> to read about a specific subcommand
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># kubectl calico get nodes  #和第1种方式相比加kubectl</span>
</span></span><span style=display:flex><span>NAME         
</span></span><span style=display:flex><span>k8s-master   
</span></span><span style=display:flex><span>k8s-node1    
</span></span><span style=display:flex><span>k8s-node2    
</span></span><span style=display:flex><span>k8s-node3    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># kubectl calico ipam show</span>
</span></span><span style=display:flex><span>+----------+----------------+-----------+------------+--------------+
</span></span><span style=display:flex><span>| GROUPING |      CIDR      | IPS TOTAL | IPS IN USE |   IPS FREE   |
</span></span><span style=display:flex><span>+----------+----------------+-----------+------------+--------------+
</span></span><span style=display:flex><span>| IP Pool  | 192.168.0.0/16 |     <span style=color:#ae81ff>65536</span> | <span style=color:#ae81ff>9</span> <span style=color:#f92672>(</span>0%<span style=color:#f92672>)</span>     | <span style=color:#ae81ff>65527</span> <span style=color:#f92672>(</span>100%<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span>+----------+----------------+-----------+------------+--------------+
</span></span></code></pre></div><h5 id=示例2修改bgp网络>示例2:修改BGP网络
<a class=anchor href=#%e7%a4%ba%e4%be%8b2%e4%bf%ae%e6%94%b9bgp%e7%bd%91%e7%bb%9c>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#获取现有配置在此基础上修改</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># kubectl calico get ippool -o yaml &gt; default-ipv4-ippool.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># cat default-ipv4-ippool.yaml </span>
</span></span><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: IPPool
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default-ipv4-ippool
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  blockSize: <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>  cidr: 192.168.0.0/16
</span></span><span style=display:flex><span>  ipipMode: CrossSubnet <span style=color:#75715e>#跨节点子网时使用IPIP 没有跨子网使用BGP</span>
</span></span><span style=display:flex><span>  natOutgoing: true
</span></span><span style=display:flex><span>  nodeSelector: all<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  vxlanMode: Never  <span style=color:#75715e>#vxlanMode与ipipMode不能同时打开 必须有一个为Never</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>#通过ipipMode、vxlanMode不同选项可以使calico运行在纯GBP、ipip、vxlanMode或混合模式下</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#如:ipipMode: Never vxlanMode: Never 为纯BGP模式  ipipMode: Never vxlanMode: CrossSubnet 为BGP+vxlan模式</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl apply -f default-ipv4-ippool.yaml </span>
</span></span><span style=display:flex><span>Successfully applied <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#39;IPPool&#39;</span> resource<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#在来看路由信息 已经没有之前的tunl0 直接从节点网络出去</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># ip route list</span>
</span></span><span style=display:flex><span>default via 192.168.54.2 dev eth4 proto static metric <span style=color:#ae81ff>101</span> 
</span></span><span style=display:flex><span>172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown 
</span></span><span style=display:flex><span>192.168.4.0/24 dev eth0 proto kernel scope link src 192.168.4.170 metric <span style=color:#ae81ff>100</span> 
</span></span><span style=display:flex><span>192.168.12.0/24 via 192.168.4.172 dev eth0 proto bird 
</span></span><span style=display:flex><span>192.168.51.0/24 via 192.168.4.173 dev eth0 proto bird     <span style=color:#75715e>#已经没有之前的tunl0隧道</span>
</span></span><span style=display:flex><span>192.168.54.0/24 dev eth4 proto kernel scope link src 192.168.54.170 metric <span style=color:#ae81ff>101</span> 
</span></span><span style=display:flex><span>192.168.113.0/24 via 192.168.4.171 dev eth0 proto bird 
</span></span><span style=display:flex><span>blackhole 192.168.237.0/24 proto bird 
</span></span><span style=display:flex><span>192.168.237.1 dev cali7c0fb624285 scope link 
</span></span><span style=display:flex><span>192.168.237.2 dev caliedaf285d4ef scope link 
</span></span><span style=display:flex><span>192.168.237.3 dev cali854da94d42a scope link 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># </span>
</span></span></code></pre></div><p>抓包测试</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod -o wide</span>
</span></span><span style=display:flex><span>NAME                              READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>deployment-demo-fb544c5d8-r7pc8   1/1     Running   <span style=color:#ae81ff>0</span>          10h   192.168.51.1   k8s-node3   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>deployment-demo-fb544c5d8-splfr   1/1     Running   <span style=color:#ae81ff>0</span>          10h   192.168.12.1   k8s-node2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#从节点3访问节点3 </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec deployment-demo-fb544c5d8-r7pc8 -it -- /bin/sh</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@deployment-demo-fb544c5d8-r7pc8 /<span style=color:#f92672>]</span><span style=color:#75715e># curl 192.168.12.1</span>
</span></span><span style=display:flex><span>iKubernetes demoapp v1.0 !! ClientIP: 192.168.51.1, ServerName: deployment-demo-fb544c5d8-splfr, ServerIP: 192.168.12.1!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@deployment-demo-fb544c5d8-r7pc8 /<span style=color:#f92672>]</span><span style=color:#75715e># curl 192.168.12.1</span>
</span></span><span style=display:flex><span>iKubernetes demoapp v1.0 !! ClientIP: 192.168.51.1, ServerName: deployment-demo-fb544c5d8-splfr, ServerIP: 192.168.12.1!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#直接抓Pod IP的包 因为没有封装 所以是Pod IP直接通信 没有外层IP</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-node2 ~<span style=color:#f92672>]</span><span style=color:#75715e># tcpdump -i eth0 -nn ip host 192.168.51.1  and host 192.168.12.1</span>
</span></span><span style=display:flex><span>tcpdump: verbose output suppressed, use -v or -vv <span style=color:#66d9ef>for</span> full protocol decode
</span></span><span style=display:flex><span>listening on eth0, link-type EN10MB <span style=color:#f92672>(</span>Ethernet<span style=color:#f92672>)</span>, capture size <span style=color:#ae81ff>262144</span> bytes
</span></span><span style=display:flex><span>22:11:54.704770 IP 192.168.51.1.33464 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>S<span style=color:#f92672>]</span>, seq 4075444778, win 64800, options <span style=color:#f92672>[</span>mss 1440,sackOK,TS val <span style=color:#ae81ff>2045898534</span> ecr 0,nop,wscale 7<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>22:11:54.705866 IP 192.168.12.1.80 &gt; 192.168.51.1.33464: Flags <span style=color:#f92672>[</span>S.<span style=color:#f92672>]</span>, seq 402120893, ack 4075444779, win 64260, options <span style=color:#f92672>[</span>mss 1440,sackOK,TS val <span style=color:#ae81ff>1090640722</span> ecr 2045898534,nop,wscale 7<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>22:11:54.706670 IP 192.168.51.1.33464 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, ack 1, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>2045898537</span> ecr 1090640722<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>22:11:54.707077 IP 192.168.51.1.33464 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1:77, ack 1, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>2045898537</span> ecr 1090640722<span style=color:#f92672>]</span>, length 76: HTTP: GET / HTTP/1.1
</span></span><span style=display:flex><span>22:11:54.707132 IP 192.168.12.1.80 &gt; 192.168.51.1.33464: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, ack 77, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1090640723</span> ecr 2045898537<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>22:11:54.737231 IP 192.168.12.1.80 &gt; 192.168.51.1.33464: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1:18, ack 77, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1090640754</span> ecr 2045898537<span style=color:#f92672>]</span>, length 17: HTTP: HTTP/1.0 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>22:11:54.738439 IP 192.168.51.1.33464 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, ack 18, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>2045898568</span> ecr 1090640754<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>22:11:54.739117 IP 192.168.12.1.80 &gt; 192.168.51.1.33464: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 18:155, ack 77, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1090640755</span> ecr 2045898568<span style=color:#f92672>]</span>, length 137: HTTP
</span></span><span style=display:flex><span>22:11:54.739630 IP 192.168.12.1.80 &gt; 192.168.51.1.33464: Flags <span style=color:#f92672>[</span>FP.<span style=color:#f92672>]</span>, seq 155:276, ack 77, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1090640756</span> ecr 2045898568<span style=color:#f92672>]</span>, length 121: HTTP
</span></span><span style=display:flex><span>22:11:54.739810 IP 192.168.51.1.33464 &gt; 192.168.12.1.80: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, ack 155, win 506, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>2045898570</span> ecr 1090640755<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl  node status </span>
</span></span><span style=display:flex><span>Calico process is running.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IPv4 BGP status  <span style=color:#75715e>#可以看到已经BGP模式了 这里看到是除去自己其它的3个节点</span>
</span></span><span style=display:flex><span>+---------------+-------------------+-------+----------+-------------+
</span></span><span style=display:flex><span>| PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |
</span></span><span style=display:flex><span>+---------------+-------------------+-------+----------+-------------+
</span></span><span style=display:flex><span>| 192.168.4.171 | node-to-node mesh | up    | 02:27:59 | Established |
</span></span><span style=display:flex><span>| 192.168.4.172 | node-to-node mesh | up    | 02:27:58 | Established |
</span></span><span style=display:flex><span>| 192.168.4.173 | node-to-node mesh | up    | 02:27:58 | Established |
</span></span><span style=display:flex><span>+---------------+-------------------+-------+----------+-------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IPv6 BGP status
</span></span><span style=display:flex><span>No IPv6 peers found.
</span></span></code></pre></div><ul><li>到目前为止 如果是小规模的集群 比如50台以下 就可以直接使用了</li><li>如果是大规模集群 部署reflector路由反射器，避免过多的路由表更新 减轻AIP-SERVER压力</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#把maseter配置成reflector节点</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># cat reflector-node.yaml </span>
</span></span><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: Node
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    route-reflector: true
</span></span><span style=display:flex><span>  name: k8s-master   <span style=color:#75715e>#节点名</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  bgp:
</span></span><span style=display:flex><span>    ipv4Address: 192.168.4.170/24  <span style=color:#75715e>#Master IP</span>
</span></span><span style=display:flex><span>    ipv4IPIPTunnelAddr: 192.168.237.0  <span style=color:#75715e>#tunl0网络地址</span>
</span></span><span style=display:flex><span>    routeReflectorClusterID: 1.1.1.1  <span style=color:#75715e>#ID信息 如果有多个node 不能和其它重复就行</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl apply -f reflector-node.yaml </span>
</span></span><span style=display:flex><span>Successfully applied <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#39;Node&#39;</span> resource<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>配置所有节点与reflector节点通信</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># cat bgppeer-demo.yaml</span>
</span></span><span style=display:flex><span>kind: BGPPeer
</span></span><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bgppeer-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  nodeSelector: all<span style=color:#f92672>()</span>   <span style=color:#75715e>#所有节点</span>
</span></span><span style=display:flex><span>  peerSelector: route-reflector<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#75715e>#与有这个标签的节点通信</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl apply -f bgppeer-demo.yaml </span>
</span></span><span style=display:flex><span>Successfully applied <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#39;BGPPeer&#39;</span> resource<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl node status</span>
</span></span><span style=display:flex><span>Calico process is running.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IPv4 BGP status
</span></span><span style=display:flex><span>+---------------+-------------------+-------+----------+-------------+
</span></span><span style=display:flex><span>| PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |
</span></span><span style=display:flex><span>+---------------+-------------------+-------+----------+-------------+
</span></span><span style=display:flex><span>| 192.168.4.171 | node-to-node mesh | up    | 02:27:59 | Established |<span style=color:#75715e>#之前的mesh工作模式还在</span>
</span></span><span style=display:flex><span>| 192.168.4.172 | node-to-node mesh | up    | 02:27:58 | Established |
</span></span><span style=display:flex><span>| 192.168.4.173 | node-to-node mesh | up    | 02:27:58 | Established |
</span></span><span style=display:flex><span>| 192.168.4.171 | node specific     | start | 14:36:40 | Idle        |<span style=color:#75715e>#基于reflector工作模式</span>
</span></span><span style=display:flex><span>| 192.168.4.172 | node specific     | start | 14:36:40 | Idle        |
</span></span><span style=display:flex><span>| 192.168.4.173 | node specific     | start | 14:36:40 | Idle        |
</span></span><span style=display:flex><span>+---------------+-------------------+-------+----------+-------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IPv6 BGP status
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#关掉mesh 点对点的工作模式</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># cat  default-bgpconfiguration.yaml </span>
</span></span><span style=display:flex><span>apiVersion: projectcalico.org/v3
</span></span><span style=display:flex><span>kind: BGPConfiguration
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  logSeverityScreen: Info
</span></span><span style=display:flex><span>  nodeToNodeMeshEnabled: false  <span style=color:#75715e>#是赤允许点对点通信</span>
</span></span><span style=display:flex><span>  asNumber : <span style=color:#ae81ff>63400</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl apply -f default-bgpconfiguration.yaml </span>
</span></span><span style=display:flex><span>Successfully applied <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#39;BGPConfiguration&#39;</span> resource<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@k8s-master calico<span style=color:#f92672>]</span><span style=color:#75715e># calicoctl node status</span>
</span></span><span style=display:flex><span>Calico process is running.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IPv4 BGP status
</span></span><span style=display:flex><span>+---------------+---------------+-------+----------+-------------+
</span></span><span style=display:flex><span>| PEER ADDRESS  |   PEER TYPE   | STATE |  SINCE   |    INFO     |
</span></span><span style=display:flex><span>+---------------+---------------+-------+----------+-------------+
</span></span><span style=display:flex><span>| 192.168.4.171 | node specific | up    | 14:45:26 | Established |
</span></span><span style=display:flex><span>| 192.168.4.172 | node specific | up    | 14:45:26 | Established |
</span></span><span style=display:flex><span>| 192.168.4.173 | node specific | up    | 14:45:26 | Established |
</span></span><span style=display:flex><span>+---------------+---------------+-------+----------+-------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IPv6 BGP status
</span></span><span style=display:flex><span>No IPv6 peers found.
</span></span></code></pre></div><h2 id=概述>概述
<a class=anchor href=#%e6%a6%82%e8%bf%b0>#</a></h2><p>Calico 是一种开源网络和网络安全解决方案，适用于容器，虚拟机和基于主机的本机工作负载。Calico 支持广泛的平台，包括 Kubernetes，docker，OpenStack 和裸机服务。Calico 后端支持多种网络模式。</p><ul><li>BGP 模式：将节点做为虚拟路由器通过 BGP 路由协议来实现集群内容器之间的网络访问。</li><li>IPIP 模式：在原有 IP 报文中封装一个新的 IP 报文，新的 IP 报文中将源地址 IP 和目的地址 IP 都修改为对端宿主机 IP。</li><li>cross-subnet：Calico-ipip 模式和 calico-bgp 模式都有对应的局限性，对于一些主机跨子网而又无法使网络设备使用 BGP 的场景可以使用 cross-subnet 模式，实现同子网机器使用 calico-BGP 模式，跨子网机器使用 calico-ipip 模式。</li></ul><p><img src=https://pic3.zhimg.com/80/v2-0e507f0e4280c97401d9e0f15fb13cb2_720w.webp alt=img></p><h2 id=calico-切换-bgp-模式>calico 切换 BGP 模式
<a class=anchor href=#calico-%e5%88%87%e6%8d%a2-bgp-%e6%a8%a1%e5%bc%8f>#</a></h2><p><img src=https://pic3.zhimg.com/80/v2-c317c0e8bb9d9a7a94b0db7aa7798856_720w.webp alt=img></p><p>部署完成后默认使用 calico-ipip 的模式，通过在节点的路由即可得知，通往其他节点路由通过 tunl0 网卡出去</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309555.png alt=img></p><p>修改为 BGP 网络模式，在 system 项目中修改 calico-node daemonset</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309969.webp alt=img></p><p><img src=https://pic3.zhimg.com/80/v2-01b13e0b942ce3efc8924711339ef77e_720w.webp alt=img></p><p>修改<code>CALICO_IPV4POOL_IPIP</code>改为 off，添加新环境变量<code>FELIX_IPINIPENABLED</code>为 false</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309475.png alt=img></p><p>修改完成后对节点进行重启，等待恢复后查看主机路由，与 ipip 最大区别在于去往其他节点的路由，由 Tunnel0 走向网络网卡。</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309471.webp alt=img></p><h2 id=calico-切换-cross-subnet-模式>calico 切换 cross-subnet 模式
<a class=anchor href=#calico-%e5%88%87%e6%8d%a2-cross-subnet-%e6%a8%a1%e5%bc%8f>#</a></h2><p>Calico-ipip 模式和 calico-bgp 模式都有对应的局限性，对于一些主机跨子网而又无法使网络设备使用 BGP 的场景可以使用 cross-subnet 模式，实现同子网机器使用 calico-BGP 模式，跨子网机器使用 calico-ipip 模式。</p><p>部署集群网络选择 calico 网络插件</p><p><img src=https://pic1.zhimg.com/80/v2-58f0a09c739dd5f2c9613d5de23b010c_720w.webp alt=img></p><p>默认部署出来是 calico 的 ip-in-ip 的模式 查看宿主机网卡，会发现多了个 tunl0 网卡，这个是建立 ip 隧道的网卡</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309957.png alt=img></p><p>去其他主机的路由都是走 tunl0 网卡出去</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309217.webp alt=img></p><p>切换到 cross-subnet 模式</p><pre tabindex=0><code>kubectleditipPool/default-ipv4-ippool
</code></pre><p>将 ipipMode 改为 crossSubnet</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309104.png alt=img></p><p>在 UI 将 calico-node 的 POD 删了重建</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309853.png alt=img></p><p>重启检查 calico 网络</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309990.webp alt=img></p><p>可以看见同子网的主机出口走的是 bgp，不同子网主机走的是 tunl0 网卡走 ipip 模式</p><p>创建应用测试跨主机网络，在不同主机上互相 ping 测试，看看跨主机网络是否正常。</p><h2 id=配置-route-reflector>配置 Route reflector
<a class=anchor href=#%e9%85%8d%e7%bd%ae-route-reflector>#</a></h2><h3 id=安装-calicoctl>安装 calicoctl
<a class=anchor href=#%e5%ae%89%e8%a3%85-calicoctl>#</a></h3><p>安装方式有以下几种</p><ul><li>Single host 上面 binary 安装</li><li>Single host 上面 continer 安装</li><li>作为 k8s pod 运行</li></ul><p>实际经验：</p><p>Binary 方式在集群里面的一台 worker 节点安装（比如 RR），calicoctl 会检测 bird/felix 的运行状态。在非 calico node 节点运行只能使用部分命令，不能运行 calico node 相关命令。</p><p>通过配置 calicoctl 来对 calico 进行控制，通常情况下建议将</p><pre tabindex=0><code>curl-O-Lhttps://github.com/projectcalico/calicoctl/releases/download/v3.13.3/calicoctl
</code></pre><p>配置可执行权限</p><pre tabindex=0><code>chmod+xcalicoctl
</code></pre><p>复制的/usr/bin/目录</p><pre tabindex=0><code>cpcalicoctl/usr/bin/
</code></pre><p>配置 calicoctl 连接 Kubernetes 集群</p><pre tabindex=0><code>exportCALICO_DATASTORE_TYPE=kubernetes exportCALICO_KUBECONFIG=~/.kube/config calicoctlnodestatus
</code></pre><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309015.webp alt=img></p><h3 id=calico-node-to-node-mesh>calico node-to-node mesh
<a class=anchor href=#calico-node-to-node-mesh>#</a></h3><p>默认情况下 calico 采用 node-to-node mesh 方式 ，为了防止 BGP 路由环路，BGP 协议规定在一个 AS（自治系统）内部，IBGP 路由器之间只能传一跳路由信息，所以在一个 AS 内部，IBGP 路由器之间为了学习路由信息需要建立全互联的对等体关系，但是当一个 AS 规模很大的时候，这种全互联的对等体关系维护会大量消耗网络和 CPU 资源，所以这种情况下就需要建立路由反射器以减少 IBGP 路由器之间的对等体关系数量。</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309122.webp alt=img></p><h3 id=route-reflector-角色介绍>Route reflector 角色介绍
<a class=anchor href=#route-reflector-%e8%a7%92%e8%89%b2%e4%bb%8b%e7%bb%8d>#</a></h3><p>早期 calico 版本提供专门的 route reflector 镜像，在新版本 calico node 内置集成 route reflector 功能。Route reflector 可以是以下角色：</p><ul><li>集群内部的 node 节点</li><li>集群外部节点运行 calico node</li><li>其他支持 route reflector 的软件或者设备。</li></ul><p>这里以一个集群内部的 node 节点为例：</p><h4 id=关闭-node-to-node-mesh>关闭 node-to-node mesh
<a class=anchor href=#%e5%85%b3%e9%97%ad-node-to-node-mesh>#</a></h4><pre tabindex=0><code>cat&lt;&lt;EOF|calicoctlapply-f- apiVersion:projectcalico.org/v3 kind:BGPConfiguration metadata: name:default spec: logSeverityScreen:Info nodeToNodeMeshEnabled:false asNumber:63400 EOF
</code></pre><h3 id=设置-route-reflector>设置 Route reflector
<a class=anchor href=#%e8%ae%be%e7%bd%ae-route-reflector>#</a></h3><p>配置 Route reflector 支持多种配置方式如：1、支持配置全局 BGP peer，。2、支持针对单个节点进行配置 BGP Peer。也可以将 calico 节点充当 Route reflector 这里以配置 calico 节点充当 Router reflector 为例。</p><p>配置节点充当 BGP Route Reflector</p><p>可将 Calico 节点配置为充当路由反射器。为此，要用作路由反射器的每个节点必须具有群集 ID-通常是未使用的 IPv4 地址。</p><p>要将节点配置为集群 ID 为 244.0.0.1 的路由反射器，请运行以下命令。这里将节点名为 rke-node4 的节点配置为 Route Reflector，若一个集群中要配置主备 rr，为了防止 rr 之间的路由环路，需要将集群 ID 配置成一样</p><pre tabindex=0><code>calicoctlpatchnoderke-node4-p&#39;{&#34;spec&#34;:{&#34;bgp&#34;:{&#34;routeReflectorClusterID&#34;:&#34;244.0.0.1&#34;}}}&#39;
</code></pre><p>给节点打上对应的 label 标记该节点以表明它是 Route Reflector，从而允许 BGPPeer 资源选择它。</p><pre tabindex=0><code>kubectllabelnoderke-node4route-reflector=true
</code></pre><p>创建 BGPPeer</p><pre tabindex=0><code>exportCALICO_DATASTORE_TYPE=kubernetes exportCALICO_KUBECONFIG=~/.kube/config cat&lt;&lt;EOF|calicoctlapply-f- kind:BGPPeer apiVersion:projectcalico.org/v3 metadata: name:peer-with-route-reflectors spec: nodeSelector:all() peerSelector:route-reflector==&#39;true&#39; EOF
</code></pre><h4 id=查看-bgp-节点状态>查看 BGP 节点状态
<a class=anchor href=#%e6%9f%a5%e7%9c%8b-bgp-%e8%8a%82%e7%82%b9%e7%8a%b6%e6%80%81>#</a></h4><p>node 上查看，peer type 由 node-to-node mesh 变为 node specific</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309271.webp alt=img></p><p>Route Reflector 上节点查看，节点已正常建立连接</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309330.webp alt=img></p><h2 id=设置-veth-网卡-mtu>设置 veth 网卡 mtu
<a class=anchor href=#%e8%ae%be%e7%bd%ae-veth-%e7%bd%91%e5%8d%a1-mtu>#</a></h2><p>通常，通过使用最高 MTU 值（不会在路径上引起碎片或丢包）来实现最高性能。对于给定的流量速率，最大带宽增加，CPU 消耗可能下降。对于一些支持 jumbo frames 的网络设备，可以配置 calico 支持使用。</p><p>下表列举了，常见几种 MTU 配置下 calico 对应的网卡 mtu 的配置</p><p><img src=https://pic3.zhimg.com/80/v2-fa85f864b2350f86b434c70628722be2_720w.webp alt=img></p><p>IPIP 和 VXLAN 协议中的 IP 中使用的额外报文头，通过头的大小减小了最小 MTU。（IP 中的 IP 使用 20 字节的标头，而 VXLAN 使用 50 字节的标头）。</p><p>如果在 Pod 网络中的任何地方使用 VXLAN，请将 MTU 大小配置为“物理网络 MTU 大小减去 50”。如果仅在 IP 中使用 IP，则将 MTU 大小配置为“物理网络 MTU 大小减去 20” 。</p><h3 id=将工作负载端点-mtu-和隧道-mtu-设置为相同的值>将工作负载端点 MTU 和隧道 MTU 设置为相同的值
<a class=anchor href=#%e5%b0%86%e5%b7%a5%e4%bd%9c%e8%b4%9f%e8%bd%bd%e7%ab%af%e7%82%b9-mtu-%e5%92%8c%e9%9a%a7%e9%81%93-mtu-%e8%ae%be%e7%bd%ae%e4%b8%ba%e7%9b%b8%e5%90%8c%e7%9a%84%e5%80%bc>#</a></h3><p>配置方法：</p><p>升级集群</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309406.webp alt=img></p><p>配置网卡 MTU，此时通过 system 项目下 calico-config 文件可以看见对应的 mtu 设置</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309451.webp alt=img></p><p>创建 workload 查看 POD 网卡 MTU 为 9001</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309472.webp alt=img></p><h2 id=设置全局-as-号>设置全局 AS 号
<a class=anchor href=#%e8%ae%be%e7%bd%ae%e5%85%a8%e5%b1%80-as-%e5%8f%b7>#</a></h2><p>默认情况下，除非已为节点指定每个节点的 AS，否则所有 Calico 节点都使用 64512 自治系统。可以通过修改默认的 BGPConfiguration 资源来更改所有节点的全局默认值。以下示例命令将全局默认 AS 编号设置为 64513。</p><pre tabindex=0><code>cat&lt;&lt;EOF|calicoctlapply-f- apiVersion:projectcalico.org/v3 kind:BGPConfiguration metadata: name:default spec: logSeverityScreen:Info nodeToNodeMeshEnabled:false asNumber:64513 EOF
</code></pre><h2 id=设置单个主机和-as-号>设置单个主机和 AS 号
<a class=anchor href=#%e8%ae%be%e7%bd%ae%e5%8d%95%e4%b8%aa%e4%b8%bb%e6%9c%ba%e5%92%8c-as-%e5%8f%b7>#</a></h2><p>例如，以下命令将名为 node-1 的节点更改为属于 AS 64514。</p><pre tabindex=0><code>calicoctlpatchnodenode-1-p&#39;{&#34;spec&#34;:{&#34;bgp&#34;:{“asNumber”:“64514”}}}&#39;
</code></pre><h2 id=修改节点地址范围>修改节点地址范围
<a class=anchor href=#%e4%bf%ae%e6%94%b9%e8%8a%82%e7%82%b9%e5%9c%b0%e5%9d%80%e8%8c%83%e5%9b%b4>#</a></h2><p>此操作建议在部署完集群后立刻进行。</p><p>默认情况下 calico 在集群层面分配一个 10.42.0.0/16 的 CIDR 网段，在这基础上在单独为每个主机划分一个单独子网采用 26 位子网掩码对应的集群支持的节点数为 2^10=1024 节点，单个子网最大支持 64 个 POD，当单个子网对应 IP 消耗后，calico 会重新在本机上划分一个新的子网如下，在集群对端主机可以看见对应的多个 CIDR 路由信息。</p><p><img src=https://picture-base.oss-cn-hangzhou.aliyuncs.com/picture/202306301309552.png alt=img></p><blockquote><p>注意：块大小将影响节点 POD 的 IP 地址分配和路由条目数量，如果主机在一个 CIDR 中分配所有地址，则将为其分配一个附加 CIDR。如果没有更多可用的块，则主机可以从分配给其他主机的 CIDR 中获取地址。为借用的地址添加了特定的路由，这会影响路由表的大小。</p></blockquote><p>将块大小从默认值增加（例如，使用/24 则为每个块提供 256 个地址）意味着每个主机更少的块，会减少路由。但是对应的集群可容纳主机数也对应减少为 2^8。</p><p>从默认值减小 CIDR 大小（例如，使用/28 为每个块提供 16 个地址）意味着每个主机有更多 CIDR，因此会有更多路由。</p><p>calico 允许用户修改对应的 IP 池和集群 CIDR</p><p>创建和替换步骤</p><blockquote><p>注意：删除 Pod 时，应用程序会出现暂时不可用</p></blockquote><ul><li>添加一个新的 IP 池。</li><li>注意：新 IP 池必须在同一群集 CIDR 中。</li><li>禁用旧的 IP 池（注意：禁用 IP 池只会阻止分配新的 IP 地址。它不会影响现有 POD 的联网）</li><li>从旧的 IP 池中删除 Pod。</li><li>验证新的 Pod 是否从新的 IP 池中获取地址。</li><li>删除旧的 IP 池。</li></ul><p>定义 ippool 资源</p><pre tabindex=0><code>apiVersion:projectcalico.org/v3 kind:IPPool metadata: name:my-ippool spec: blockSize:24 cidr:192.0.0.0/16 ipipMode:Always natOutgoing:true
</code></pre><p>修改对应的 blockSize 号</p><p>创建新的</p><pre tabindex=0><code>calicoctlapply-fpool.yaml
</code></pre><p>将旧的 ippool 禁用</p><pre tabindex=0><code>calicoctlpatchippooldefault-ipv4-ippool-p&#39;{&#34;spec&#34;:{&#34;disabled&#34;:“true”}}&#39;
</code></pre><p>创建 workload 测试</p><h2 id=根据节点标签定义对应的-ippool>根据节点标签定义对应的 ippool
<a class=anchor href=#%e6%a0%b9%e6%8d%ae%e8%8a%82%e7%82%b9%e6%a0%87%e7%ad%be%e5%ae%9a%e4%b9%89%e5%af%b9%e5%ba%94%e7%9a%84-ippool>#</a></h2><p>Calico 能够进行配置，为不同拓扑指定 IP 地址池。例如可能希望某些机架、地区、或者区域能够从同一个 IP 池中获取地址。这对于降低路由数量或者配合防火墙策略的要求会很有帮助。</p><p>给节点配置对应 label</p><pre tabindex=0><code>kubectllabelnodeskube-node-0rack=0 kubectllabelnodeskube-node-1rack=1
</code></pre><p>通过标签定义对应的节点 IPpool</p><pre tabindex=0><code>calicoctlcreate-f-&lt;&lt;EOF apiVersion:projectcalico.org/v3 kind:IPPool metadata: name:rack-0-ippool spec: cidr:192.168.0.0/24 ipipMode:Always natOutgoing:true nodeSelector:rack==&#34;0&#34; EOF calicoctlcreate-f-&lt;&lt;EOF apiVersion:projectcalico.org/v3 kind:IPPool metadata: name:rack-1-ippool spec: cidr:192.168.1.0/24 ipipMode:Always natOutgoing:true nodeSelector:rack==&#34;1&#34; EOF
</code></pre><h2 id=关闭-snat>关闭 SNAT
<a class=anchor href=#%e5%85%b3%e9%97%ad-snat>#</a></h2><p>默认情况下，calico 访问集群外网络是通过 SNAT 成宿主机 ip 方式，在一些金融客户环境中为了能实现防火墙规则，需要直接针对 POD ip 进行进行规则配置，所以需要关闭 natOutgoing</p><pre tabindex=0><code>kubectleditippool/default-ipv4-ippool
</code></pre><p>将<code>natOutgoing: true</code>修改为<code>natOutgoing: false</code></p><p>此时，calico 网络访问集群外的 ip 源 ip 就不会 snat 成 宿主机的 ip 地址。</p><h2 id=固定-pod-ip>固定 POD IP
<a class=anchor href=#%e5%9b%ba%e5%ae%9a-pod-ip>#</a></h2><p>固定单个 ip</p><pre tabindex=0><code>apiVersion:apps/v1 kind:Deployment metadata: name:nginx-test spec: selector: matchLabels: app:nginx replicas:1#tellsdeploymenttorun1podsmatchingthetemplate template: metadata: labels: app:nginx annotations: &#34;cni.projectcalico.org/ipAddrs&#34;:&#34;[\&#34;10.42.210.135\&#34;]&#34; spec: containers: -name:nginx image:nginx:1.7.9 ports: -containerPort:80
</code></pre><p>固定多个 ip，只能通过 ippool 的方式</p><pre tabindex=0><code>catippool1.yaml apiVersion:projectcalico.org/v3 kind:IPPool metadata: name:pool-1 spec: blockSize:31 cidr:10.21.0.0/31 ipipMode:Never natOutgoing:true apiVersion:apps/v1 kind:Deployment metadata: name:nginx-test spec: selector: matchLabels: app:nginx replicas:1#tellsdeploymenttorun1podsmatchingthetemplate template: metadata: labels: app:nginx annotations: &#34;cni.projectcalico.org/ipv4pools&#34;:&#34;[\&#34;pool-1\&#34;]&#34; spec: containers: -name:nginx image:nginx:1.7.9 ports: -containerPort:80
</code></pre><pre tabindex=0><code>/lib/modules
/var/run/calico
/var/lib/calico
/run/xtables.lock
/opt/cni/bin
/etc/cni/net.d
/var/log/calico/cni
/var/lib/cni/networks
/var/run/nodeagent
/usr/libexec/kubernetes/kubelet-plugins/volume/exec/nodeagent~uds


rm -rf /var/lib/cni
rm -rf /etc/cni/net.d

rm /var/lib/cni/ -rf &amp;&amp; rm -f /etc/cni/net.d/*
systemctl restart  docker containerd kubelet
</code></pre></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li></li></ul></li></ul><ul><li><ul><li><a href=#1取消k8s-master节点不可调度>1.取消k8s master节点不可调度</a></li><li><a href=#calico简介>Calico简介</a></li><li><a href=#calico网络模型主要工作组件>Calico网络模型主要工作组件：###</a></li><li><a href=#calicoctl命令安装与使用>calicoctl命令安装与使用</a></li></ul></li><li><a href=#概述>概述</a></li><li><a href=#calico-切换-bgp-模式>calico 切换 BGP 模式</a></li><li><a href=#calico-切换-cross-subnet-模式>calico 切换 cross-subnet 模式</a></li><li><a href=#配置-route-reflector>配置 Route reflector</a><ul><li><a href=#安装-calicoctl>安装 calicoctl</a></li><li><a href=#calico-node-to-node-mesh>calico node-to-node mesh</a></li><li><a href=#route-reflector-角色介绍>Route reflector 角色介绍</a></li><li><a href=#设置-route-reflector>设置 Route reflector</a></li></ul></li><li><a href=#设置-veth-网卡-mtu>设置 veth 网卡 mtu</a><ul><li><a href=#将工作负载端点-mtu-和隧道-mtu-设置为相同的值>将工作负载端点 MTU 和隧道 MTU 设置为相同的值</a></li></ul></li><li><a href=#设置全局-as-号>设置全局 AS 号</a></li><li><a href=#设置单个主机和-as-号>设置单个主机和 AS 号</a></li><li><a href=#修改节点地址范围>修改节点地址范围</a></li><li><a href=#根据节点标签定义对应的-ippool>根据节点标签定义对应的 ippool</a></li><li><a href=#关闭-snat>关闭 SNAT</a></li><li><a href=#固定-pod-ip>固定 POD IP</a></li></ul></nav></div></aside></main></body></html>