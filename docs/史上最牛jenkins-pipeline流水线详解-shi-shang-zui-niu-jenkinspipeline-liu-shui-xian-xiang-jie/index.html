<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  一、什么是流水线
  #

jenkins 有 2 种流水线分为声明式流水线与脚本化流水线，脚本化流水线是 jenkins 旧版本使用的流水线脚本，新版本 Jenkins 推荐使用声明式流水线。文档只介绍声明流水线。

  1.1 声明式流水线
  #

在声明式流水线语法中，流水线过程定义在 Pipeline{}中，Pipeline 块定义了整个流水线中完成的所有工作，比如
参数说明：

agent any：在任何可用的代理上执行流水线或它的任何阶段，也就是执行流水线过程的位置，也可以指定到具体的节点
stage：定义流水线的执行过程（相当于一个阶段），比如下文所示的 Build、Test、Deploy， 但是这个名字是根据实际情况进行定义的，并非固定的名字
steps：执行某阶段具体的步骤。

//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
    stages {
      stage('Build') {
        steps {
          echo 'Build'
        }
      }
      stage('Test') {
        steps {
          echo 'Test'
        }
      }
      stage('Deploy') {
        steps {
          echo 'Deploy'
      }
    }
  }
}

  1.2 脚本化流水线
  #

在脚本化流水线语法中，会有一个或多个 Node（节点）块在整个流水线中执行核心工作
参数说明:

node：在任何可用的代理上执行流水线或它的任何阶段，也可以指定到具体的节点
stage：和声明式的含义一致，定义流水线的阶段。Stage 块在脚本化流水线语法中是可选的，然而在脚本化流水线中实现 stage 块，可以清楚地在 Jenkins UI 界面中显示每个 stage 的任务子集。

//Jenkinsfile (Scripted Pipeline)
node {
  stage('Build') {
    echo 'Build'
  }
  stage('Test') {
    echo 'Test'
  }
  stage('Deploy') {
    echo 'Deploy'
  }
}

  二、声明式流水线
  #

声明式流水线必须包含在一个 Pipeline 块中，比如是一个 Pipeline 块的格式"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://qq547475331.github.io/docs/%E5%8F%B2%E4%B8%8A%E6%9C%80%E7%89%9Bjenkins-pipeline%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%A6%E8%A7%A3-shi-shang-zui-niu-jenkinspipeline-liu-shui-xian-xiang-jie/"><meta property="og:site_name" content="Guichen's Blog"><meta property="og:title" content="2024-08-02 史上最牛jenkins pipeline流水线详解"><meta property="og:description" content="一、什么是流水线 # jenkins 有 2 种流水线分为声明式流水线与脚本化流水线，脚本化流水线是 jenkins 旧版本使用的流水线脚本，新版本 Jenkins 推荐使用声明式流水线。文档只介绍声明流水线。
1.1 声明式流水线 # 在声明式流水线语法中，流水线过程定义在 Pipeline{}中，Pipeline 块定义了整个流水线中完成的所有工作，比如
参数说明：
agent any：在任何可用的代理上执行流水线或它的任何阶段，也就是执行流水线过程的位置，也可以指定到具体的节点 stage：定义流水线的执行过程（相当于一个阶段），比如下文所示的 Build、Test、Deploy， 但是这个名字是根据实际情况进行定义的，并非固定的名字 steps：执行某阶段具体的步骤。 //Jenkinsfile (Declarative Pipeline) pipeline { agent any stages { stage('Build') { steps { echo 'Build' } } stage('Test') { steps { echo 'Test' } } stage('Deploy') { steps { echo 'Deploy' } } } } 1.2 脚本化流水线 # 在脚本化流水线语法中，会有一个或多个 Node（节点）块在整个流水线中执行核心工作
参数说明:
node：在任何可用的代理上执行流水线或它的任何阶段，也可以指定到具体的节点 stage：和声明式的含义一致，定义流水线的阶段。Stage 块在脚本化流水线语法中是可选的，然而在脚本化流水线中实现 stage 块，可以清楚地在 Jenkins UI 界面中显示每个 stage 的任务子集。 //Jenkinsfile (Scripted Pipeline) node { stage('Build') { echo 'Build' } stage('Test') { echo 'Test' } stage('Deploy') { echo 'Deploy' } } 二、声明式流水线 # 声明式流水线必须包含在一个 Pipeline 块中，比如是一个 Pipeline 块的格式"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>2024-08-02 史上最牛jenkins pipeline流水线详解 | Guichen's Blog</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://qq547475331.github.io/docs/%E5%8F%B2%E4%B8%8A%E6%9C%80%E7%89%9Bjenkins-pipeline%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%A6%E8%A7%A3-shi-shang-zui-niu-jenkinspipeline-liu-shui-xian-xiang-jie/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.4c8d54c6a3dc43d4b12b0b0a8953faeef995cda46ccfd5c21b6e81efdba2893f.js integrity="sha256-TI1UxqPcQ9SxKwsKiVP67vmVzaRsz9XCG26B79uiiT8=" crossorigin=anonymous></script></head><script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){mermaid.initialize({startOnLoad:!0});let e=document.querySelectorAll("pre > code.language-mermaid");e.forEach(e=>{let t=document.createElement("div");t.classList.add("mermaid"),t.innerHTML=e.innerText,e.parentNode.replaceWith(t)}),mermaid.init(void 0,document.querySelectorAll(".mermaid"))})</script><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Guichen's Blog</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/docs/2025-3-8-k8s%E5%88%A0%E9%99%A4pod-deployment%E7%9A%84%E6%B5%81%E7%A8%8B%E5%9B%BE%E8%AF%A6%E8%A7%A3/>2025-3-8 k8s删除pod deployment的流程图详解</a></li><li><a href=/docs/2025-3-8-k8s%E5%88%9B%E5%BB%BApod-deployment%E6%B5%81%E7%A8%8B%E5%9B%BE%E8%AF%A6%E8%A7%A3/>2025-3-8 k8s创建pod 流程图详解</a></li><li><a href=/docs/2025-3-18-5w-pod%E5%8E%8B%E6%B5%8B%E5%A4%8D%E7%9B%98/>2025-3-18 5w pod压测复盘</a></li><li><a href=/docs/2025-3-14-%E7%81%AB%E5%B1%B1%E4%BA%91%E8%BF%81%E7%A7%BB%E5%B7%A5%E7%A8%8B%E5%B8%88%E9%9D%A2%E8%AF%95%E8%AE%B0%E5%BD%95/>2025-3-14 火山云迁移工程师面试记录</a></li><li><a href=/docs/2025-3-13-istio%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/>2025-3-13 istio流量分析</a></li><li><a href=/docs/2025-3-13-calico%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%B5%81%E9%87%8F%E4%BC%A0%E8%BE%93%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90/>2025-3-13 calico三种模式下流量传输</a></li><li><a href=/docs/2025-3-12-%E5%A1%94%E8%B5%9E%E9%9D%A2%E8%AF%95/>2025-3-12 塔赞面试</a></li><li><a href=/docs/2025-3-12-%E8%BF%BD%E8%A7%85%E9%9D%A2%E8%AF%95/>2025-3-12 追觅面试</a></li><li><a href=/docs/2025-2-7-%E8%AE%A1%E5%88%922/>2025-2-7 美国码农计划</a></li><li><a href=/docs/2025-2-7-%E8%AE%A1%E5%88%92/>2025-2-7 美国码农薪酬</a></li><li><a href=/docs/2025-2-7-k8s%E7%BB%84%E4%BB%B6/>2025-2-7 k8s组件</a></li><li><a href=/docs/2025-2-28-prometheus/>2025-2-28 prometheus 面试题</a></li><li><a href=/docs/2025-2-26-%E9%9D%A2%E8%AF%950225/>2025-2-25 面试0225</a></li><li><a href=/docs/2025-2-24-%E9%AB%98%E7%BA%A7%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98_ai_linux%E9%83%A8%E5%88%86/>2025-2-24 高级运维面试题-linux部分</a></li><li><a href=/docs/2025-2-24-%E4%B8%AD%E7%BA%A7%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98_%E9%A2%98%E7%9B%AE/>2025-2-24 中级运维面试题</a></li><li><a href=/docs/2025-2-24-%E9%9D%A2%E8%AF%950224/>2025-2-24 0224面试</a></li><li><a href=/docs/2025-2-20-%E9%9D%A2%E8%AF%950220/>2025-2-20 面试0220</a></li><li><a href=/docs/2025-2-19-%E9%9D%A2%E8%AF%950219/>2025-2-19 面试0219</a></li><li><a href=/docs/2025-2-18-%E9%9D%A2%E8%AF%95/>2025-2-18 面试2025-0218</a></li><li><a href=/docs/2025-2-26-k8s%E7%9B%B8%E5%85%B3/>2025-2-16 k8s题目</a></li><li><a href=/docs/2025-2-12-%E9%9D%A2%E8%AF%950212/>2025-2-12 面试0212</a></li><li><a href=/docs/2025-2-11-%E9%9D%A2%E8%AF%950211/>2025-2-11 面试2025-02-11</a></li><li><a href=/docs/2024-3-4-k8s%E6%B5%81%E9%87%8F%E9%93%BE%E8%B7%AF%E5%89%96%E6%9E%90/>2025-1-16 k8s流量链路剖析</a></li><li><a href=/docs/2025-1-16-k8s%E5%B8%B8%E8%A7%81%E6%95%85%E9%9A%9C%E6%8C%87%E5%8D%97/>2025-1-16 k8s常见故障指南</a></li><li><a href=/docs/2024-3-4-k8s-csi%E5%89%96%E6%9E%90/>2025-1-16 CSI剖析演进</a></li><li><a href=/docs/2025-1-1-%E8%A6%81%E4%B8%8D%E8%A6%81%E5%88%9B%E4%B8%9A/>2025-1-1 要不要创业</a></li><li><a href=/docs/2025-1-1-%E6%97%A9%E6%9C%9F%E6%A8%A1%E5%BC%8F/>2025-1-1 早期模式</a></li><li><a href=/docs/2025-1-1-%E5%A4%A7%E5%A0%B0%E6%B2%B3-%E6%88%91%E7%9A%84%E4%BF%9D%E5%A7%86/>2025-1-1 大堰河-我的保姆</a></li><li><a href=/docs/2025-1-1-%E5%88%9D%E5%88%9B%E5%85%AC%E5%8F%B8/>2025-1-1 初创公司</a></li><li><a href=/docs/2025-1-1-%E5%88%9B%E4%B8%9A%E8%80%85%E4%BA%A4%E6%B5%81/>2025-1-1 创业者交流</a></li><li><a href=/docs/2025-1-1-%E5%88%9B%E4%B8%9A%E7%82%B9%E5%AD%90/>2025-1-1 创业点子</a></li><li><a href=/docs/2025-1-1-sealos%E8%8E%B7%E6%8A%95/>2025-1-1 sealos获投</a></li><li><a href=/docs/2024-8-1-linux%E8%BF%90%E7%BB%B4%E5%B7%A5%E7%A8%8B%E5%B8%8850%E4%B8%AA%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/>2024-8-1 linux面试题</a></li><li><a href=/docs/2024-8-1-%E5%B8%B8%E8%A7%81linux%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98%E6%89%BE%E5%B7%A5%E4%BD%9C%E7%9A%84%E5%BF%85%E7%9C%8B/>2024-8-1 linux运维面试题</a></li><li><a href=/docs/2024-8-1-kubernetes%E9%9D%A2%E8%AF%95%E9%A2%98/>2024-8-1 k8s面试题</a></li><li><a href=/docs/2024-5-14-%E5%8D%95master%E5%8D%95etcd%E6%94%B9%E9%80%A0/>2024-5-1 单master单etcd改造为3master3etcd</a></li><li><a href=/docs/2024-4-17-%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/>2024-4-17 面试总结</a></li><li><a href=/docs/2024-3-8-%E9%9D%A2%E8%AF%950308/>2024-3-8 面试</a></li><li><a href=/docs/2024-3-4-cni%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B/>2024-3-4 CNI剖析演进</a></li><li><a href=/docs/2024-3-19-%E4%B8%A4%E5%BC%A0%E5%9B%BE%E5%85%A8%E9%9D%A2%E7%90%86%E8%A7%A3k8s%E5%8E%9F%E7%90%86/>2024-3-19 两张图全面理解k8s原理</a></li><li><a href=/docs/2025-3-14-vivo%E9%9D%A2%E8%AF%95/>2024-3-14 vivo面试</a></li><li><a href=/docs/2024-2-26-%E9%9D%A2%E8%AF%95/>2024-2-26 面试</a></li><li><a href=/docs/2024-2-22-k8s%E9%9D%A2%E8%AF%95%E5%AE%9D%E5%85%B8/>2024-2-22 k8s面试宝典</a></li><li><a href=/docs/2024-2-22-k8s%E6%9E%B6%E6%9E%84%E5%B8%88%E9%9D%A2%E8%AF%95%E5%A4%A7%E5%85%A8/>2024-2-22 k8s架构师面试大全</a></li><li><a href=/docs/2024-12-10-docker-registrry/>2024-12-10 docker registrry</a></li><li><a href=/docs/2024-12-09-openstack-ssh%E8%BF%9E%E6%8E%A5/>2024-12-09 openstack ssh连接</a></li><li><a href=/docs/2024-12-08-mutilpass%E9%83%A8%E7%BD%B2openstack/>2024-12-09 mutilpass部署openstack devstack形式</a></li><li><a href=/docs/2024-12-09-helmchart-%E9%83%A8%E7%BD%B2flask%E5%BA%94%E7%94%A8/>2024-12-09 helmchart 部署flask应用</a></li><li><a href=/docs/2024-12-09-docker-daemon.json/>2024-12-09 docker daemon.json</a></li><li><a href=/docs/2024-12-08-%E5%9D%97%E5%AD%98%E5%82%A8%E5%92%8C%E5%AF%B9%E8%B1%A1%E5%82%A8%E5%AD%98%E5%8C%BA%E5%88%AB/>2024-12-08 块存储和对象储存区别</a></li><li><a href=/docs/2024-12-08-openstack%E9%9C%80%E8%A6%81%E5%87%A0%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA/>2024-12-08 openstack需要几台虚拟机</a></li><li><a href=/docs/2024-12-08-openstack%E5%92%8Ckubernetes%E5%8C%BA%E5%88%AB/>2024-12-08 openstack和kubernetes区别</a></li><li><a href=/docs/2024-12-08-nano%E6%93%8D%E4%BD%9C/>2024-12-08 nano操作</a></li><li><a href=/docs/2024-12-08-mutilpass%E6%93%8D%E4%BD%9C/>2024-12-08 mutilpass操作</a></li><li><a href=/docs/2024-12-08-devstack/>2024-12-08 devstack</a></li><li><a href=/docs/2024-12-07-microk8s/>2024-12-07 microk8s</a></li><li><a href=/docs/2024-12-05-kubeasz%E9%83%A8%E7%BD%B2k8s/>2024-12-05 kubeasz部署k8s</a></li><li><a href=/docs/2024-10-20-%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/>2024-10-20 使用 Keepalived 和 HAproxy 创建高可用 Kubernetes 集群</a></li><li><a href=/docs/%E9%A1%B6%E7%BA%A7devops%E5%B7%A5%E5%85%B7%E5%A4%A7%E7%9B%98%E7%82%B9-ding-ji-devops-gong-ju-da-pan-dian/>2024-08-02 顶级devops工具大盘点</a></li><li><a href=/docs/%E6%B8%85%E7%90%86docker%E9%95%9C%E5%83%8F-qing-li-docker-jing-xiang/>2024-08-02 清理docker镜像</a></li><li><a href=/docs/%E6%9E%84%E5%BB%BA%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%88%A9%E5%99%A8buildkit-gou-jian-rong-qi-jing-xiang-li-qi-buildkit/>2024-08-02 构建容器镜像利器buildkit</a></li><li><a href=/docs/%E6%98%AF%E6%8A%80%E6%9C%AF%E5%A4%A7%E7%A5%9E%E8%BF%98%E6%98%AF%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E9%83%A8%E7%9A%84%E7%A5%B8%E5%AE%B3-shi-ji-shu-da-shen-hai-shi-ji-chu-jia-gou-bu-de-huo-hai/>2024-08-02 是技术大神还是基础架构部的祸害</a></li><li><a href=/docs/%E6%90%AD%E4%B8%AA%E6%97%A5%E5%BF%97%E6%89%8B%E6%9C%BA%E7%B3%BB%E7%BB%9F%E4%B8%8D%E9%A6%99%E5%90%97-da-ge-ri-zhi-shou-ji-xi-tong-bu-xiang-ma/>2024-08-02 搭个日志手机系统不香吗</a></li><li><a href=/docs/%E6%88%91%E5%8F%AA%E6%83%B3%E5%81%9A%E6%8A%80%E6%9C%AF-%E8%B5%B0%E6%8A%80%E6%9C%AF%E8%B7%AF%E7%BA%BF-wo-zhi-xiang-zuo-ji-shu-zou-ji-shu-lu-xian/>2024-08-02 我只想做技术 走技术路线</a></li><li><a href=/docs/%E5%B8%B8%E8%A7%81linux%E8%BF%90%E7%BB%B4%E9%9D%A2%E8%AF%95%E9%A2%98-chang-jian-linux-yun-wei-mian-shi-ti/>2024-08-02 常见linux运维面试题</a></li><li><a href=/docs/%E5%A4%A7%E5%8E%82%E6%80%BB%E7%BB%93nginx%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E7%AC%94%E8%AE%B0-da-chang-zong-jie-nginx-gao-bing-fa-you-hua-bi-ji/>2024-08-02 大厂总结nginx高并发优化笔记</a></li><li><a href=/docs/%E5%8F%B2%E4%B8%8A%E6%9C%80%E7%89%9Bjenkins-pipeline%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%A6%E8%A7%A3-shi-shang-zui-niu-jenkinspipeline-liu-shui-xian-xiang-jie/ class=active>2024-08-02 史上最牛jenkins pipeline流水线详解</a></li><li><a href=/docs/teg%E4%B8%8Eistio%E9%9B%86%E6%88%90-teg-yu-istio-ji-cheng/>2024-08-02 TEG与istio集成</a></li><li><a href=/docs/prometheus-stack-prometheus-stack/>2024-08-02 prometheus-stack</a></li><li><a href=/docs/pixie-pixie/>2024-08-02 pixie</a></li><li><a href=/docs/nginx%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%83%8A%E7%BE%A4%E6%95%88%E5%BA%94-nginx-ru-he-jie-jue-jing-qun-xiao-ying/>2024-08-02 nginx如何解决惊群效应</a></li><li><a href=/docs/netctl%E6%A3%80%E6%B5%8B%E9%9B%86%E7%BE%A4pod%E9%97%B4%E8%BF%9E%E9%80%9A%E6%80%A7-netctl-jian-ce-ji-qun-pod-jian-lian-tong-xing/>2024-08-02 netctl检测集群pod间连通性</a></li><li><a href=/docs/linux%E8%BF%90%E7%BB%B4%E5%B7%A5%E7%A8%8B%E5%B8%8850%E4%B8%AA%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-linux-yun-wei-gong-cheng-shi-50-ge-chang-jian-mian-shi-ti/>2024-08-02 linux运维工程师50个常见面试题</a></li><li><a href=/docs/linux%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E4%B8%83%E4%B8%AA%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C-linux-xi-tong-xing-neng-you-hua-qi-ge-shi-zhan-jing-yan/>2024-08-02 linux系统性能优化 七个实战经验</a></li><li><a href=/docs/linux-awk%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E5%99%A8-8%E4%B8%AA%E6%A1%88%E4%BE%8B-linuxawk-wen-ben-chu-li-qi-8-ge-an-li/>2024-08-02 linux awk文本处理器 8个案例</a></li><li><a href=/docs/kubewharf-kubewharf/>2024-08-02 kubewharf</a></li><li><a href=/docs/kruise%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7%E8%A7%A3%E6%9E%90-kruise-yuan-de-sheng-ji-jie-xi/>2024-08-02 kruise原地升级解析</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E9%A2%98-k8s-mian-shi-ti/>2024-08-02 K8S面试题</a></li><li><a href=/docs/k8s%E8%83%8C%E5%90%8Eservice%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84-k8s-bei-hou-service-shi-ru-he-gong-zuo-de/>2024-08-02 k8s背后service是如何工作的</a></li><li><a href=/docs/k8s%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E5%9D%97%E6%8B%BC%E5%9B%BE-dbpaas-k8s-de-zui-hou-yi-kuai-pin-tu-dbpaas/>2024-08-02 K8S的最后一块拼图</a></li><li><a href=/docs/istio%E9%83%A8%E7%BD%B2-istio-bu-shu/>2024-08-02 istio部署</a></li><li><a href=/docs/istio-ingress-gateway-istio-ingress-gateway/>2024-08-02 istio-ingress-gateway</a></li><li><a href=/docs/godel-scheduler-godel-scheduler/>2024-08-02 godel-scheduler</a></li><li><a href=/docs/dockerfile%E5%AE%9A%E5%88%B6%E4%B8%93%E5%B1%9E%E9%95%9C%E5%83%8F-dockerfile-ding-zhi-zhuan-shu-jing-xiang/>2024-08-02 dockerfile定制专属镜像</a></li><li><a href=/docs/33%E6%AC%BEgitops%E4%B8%8Edevops%E4%B8%BB%E6%B5%81%E7%B3%BB%E7%BB%9F-33-kuan-gitops-yu-devops-zhu-liu-xi-tong/>2024-08-02 33款gitops与devops主流系统</a></li><li><a href=/docs/openkruise%E8%AF%A6%E7%BB%86%E8%A7%A3%E9%87%8A%E4%BB%A5%E5%8F%8A%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7%E5%8F%8A%E5%85%A8%E9%93%BE%E8%B7%AF%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%E6%96%B9%E6%A1%88-openkruise-xiang-xi-jie-shi-yi-ji-yuan-de-sheng-ji-ji-quan-lian-lu-hui-du-fa-bu-fang-an/>2024-07-22 OpenKruise详细解释以及原地升级及全链路灰度发布方案</a></li><li><a href=/docs/k8s%E4%B9%8Bingress-nginx%E5%8E%9F%E7%90%86%E5%8F%8A%E9%85%8D%E7%BD%AE-k8s-zhi-ingress-nginx-yuan-li-ji-pei-zhi/>2024-07-05 K8S之ingress-nginx原理及配置</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8cloudflarecf%E6%90%AD%E5%BB%BAdockerhub%E4%BB%A3%E7%90%86-shi-yong-cloudflarecf-da-jian-dockerhub-dai-li/>2024-06-28 使用cloudflare(CF)搭建dockerhub代理</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E4%B8%BAk8s%E4%BF%9D%E9%A9%BE%E6%8A%A4%E8%88%AA-ru-he-wei-k8s-bao-jia-hu-hang/>2024-04-16 如何为K8S保驾护航</a></li><li><a href=/docs/k8s%E5%A6%82%E4%BD%95%E8%8E%B7%E5%BE%97-ip-k8s-ru-he-huo-de-ip/>2024-04-16 K8S如何获得 IP</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_setgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_set_status_updatego%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetstatusupdatego-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set_status_update.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_set_controlgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulsetcontrolgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_set_control.go源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bstateful_pod_controlgo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-statefulpodcontrolgo-yuan-ma-jie-du/>2024-04-10 K8S控制器之stateful_pod_control.go源码解读</a></li><li><a href=/docs/k8s%E8%B0%83%E5%BA%A6%E5%99%A8-extendergo-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-diao-du-qi-extendergo-yuan-ma-jie-du/>2024-04-09 K8S调度器 extender.go 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Bsyncgo-%E5%90%8C%E6%AD%A5-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-syncgo-tong-bu-yuan-ma-jie-du/>2024-04-09 K8S控制器之sync.go 同步 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Brollbackgo-%E5%9B%9E%E6%BB%9A-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-rollbackgo-hui-gun-yuan-ma-jie-du/>2024-04-09 K8S控制器之rollback.go 回滚 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Brecreatego-%E9%87%8D%E5%BB%BA-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-recreatego-zhong-jian-yuan-ma-jie-du/>2024-04-09 K8S控制器之recreate.go 重建 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-schedulergo-%E8%B0%83%E5%BA%A6%E5%99%A8-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-schedulergo-diao-du-qi-yuan-ma-jie-du/>2024-04-09 K8S控制器之 scheduler.go 调度器 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-rollinggo-%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-rollinggo-gun-dong-geng-xin-yuan-ma-jie-du/>2024-04-09 K8S控制器之 rolling.go 滚动更新 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-progressgo-%E8%BF%9B%E5%BA%A6-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-progressgo-jin-du-yuan-ma-jie-du/>2024-04-09 K8S控制器之 progress.go 进度 源码解读</a></li><li><a href=/docs/k8s%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8B-deployment_controllergo%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-kong-zhi-qi-zhi-deploymentcontrollergo-yuan-ma-jie-du/>2024-04-09 K8S控制器之 deployment_controller.go源码解读</a></li><li><a href=/docs/k8s-%E8%B0%83%E5%BA%A6%E5%99%A8-scheduler_onego-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-diao-du-qi-scheduleronego-yuan-ma-jie-du/>2024-04-09 K8S 调度器 scheduler_one.go 源码解读</a></li><li><a href=/docs/%E5%BD%BB%E6%82%9F%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C-che-wu-rong-qi-wang-luo/>2024-04-07 彻悟容器网络</a></li><li><a href=/docs/%E9%9D%A2%E8%AF%95%E7%94%A8-golang-%E6%89%8B%E6%92%B8-lru-mian-shi-yong-golang-shou-lu-lru/>2024-04-03 面试用 Golang 手撸 LRU</a></li><li><a href=/docs/%E8%87%AA%E5%8A%A8%E5%B1%8F%E8%94%BDip%E6%94%BB%E5%87%BB-zi-dong-ping-bi-ip-gong-ji/>2024-04-03 自动屏蔽IP攻击</a></li><li><a href=/docs/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85kubephere-li-xian-an-zhuang-kubephere/>2024-04-03 离线安装kubephere</a></li><li><a href=/docs/%E7%A3%81%E7%9B%98%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D-ci-pan-shu-ju-hui-fu/>2024-04-03 磁盘数据恢复</a></li><li><a href=/docs/%E6%B8%85%E7%90%86%E6%AE%8B%E7%95%99%E7%9A%84calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6-qing-li-can-liu-de-calico-wang-luo/>2024-04-03 清理残留的calico网络插件</a></li><li><a href=/docs/%E6%B5%81%E9%87%8F%E4%BD%95%E5%A4%84%E6%9D%A5%E4%BD%95%E5%A4%84%E5%8E%BB-liu-liang-he-chu-lai-he-chu-qu/>2024-04-03 流量何处来何处去</a></li><li><a href=/docs/%E6%9E%81%E5%A4%A7%E6%8F%90%E9%AB%98%E5%B7%A5%E4%BD%9C%E6%95%88%E7%8E%87%E7%9A%84-linux-%E5%91%BD%E4%BB%A4-ji-da-ti-gao-gong-zuo-xiao-lv-de-linux-ming-ling/>2024-04-03 极大提高工作效率的 Linux 命令</a></li><li><a href=/docs/%E6%96%87%E5%AD%A6%E7%9A%84%E6%95%85%E4%B9%A1-wen-xue-de-gu-xiang/>2024-04-03 文学的故乡</a></li><li><a href=/docs/%E6%90%9E%E6%87%82k8s%E9%89%B4%E6%9D%83-gao-dong-k8s-jian-quan/>2024-04-03 搞懂K8S鉴权</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86-rong-qi-wang-luo-yuan-li/>2024-04-03 容器网络原理</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%80-overlayfs-%E5%8E%9F%E7%90%86-rong-qi-de-wen-jian-xi-tong--yi-overlayfs-yuan-li/>2024-04-03 容器的文件系统 OverlayFS 原理</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E5%8E%9F%E7%90%86-rong-qi-yuan-li/>2024-04-03 容器原理</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E5%86%85%E7%9A%84-1-%E5%8F%B7%E8%BF%9B%E7%A8%8B-rong-qi-nei-de-1-hao-jin-cheng/>2024-04-03 容器内的 1 号进程</a></li><li><a href=/docs/%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E4%BB%A5%E5%8F%8A%E4%B8%8D%E5%90%8Cdnspolicy%E5%AF%B9%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E7%9A%84%E5%BD%B1%E5%93%8D-rong-qi-zhong-yu-ming-jie-xi-yi-ji-bu-tong-dnspolicy-dui-yu-ming-jie-xi-de-ying-xiang/>2024-04-03 容器中域名解析以及不同dnspolicy对域名解析的影响</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95-crash-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C-ru-he-diao-shi-crash-rong-qi-de-wang-luo/>2024-04-03 如何调试 crash 容器的网络</a></li><li><a href=/docs/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8tekton%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BAcicd%E5%B9%B3%E5%8F%B0-ru-he-shi-yong-tekton-kuai-su-da-jian-cicd-ping-tai/>2024-04-03 如何使用tekton快速搭建CI/CD平台</a></li><li><a href=/docs/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%B9%B6%E5%8F%91%E4%B8%8B%E5%A6%82%E4%BD%95%E5%8A%A0%E5%BF%AB-pod-%E5%90%AF%E5%8A%A8%E9%80%9F%E5%BA%A6-da-gui-mo-bing-fa-xia-ru-he-jia-kuai-pod-qi-dong-su-du/>2024-04-03 大规模并发下如何加快 Pod 启动速度</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8kubernees-leases-%E8%BD%BB%E6%9D%BE%E5%AE%9E%E7%8E%B0leader-election-shi-yong-kuberneesleases-qing-song-shi-xian-leaderelection/>2024-04-03 使用kubernees leases 轻松实现leader election</a></li><li><a href=/docs/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2k8s%E5%8A%A0%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C-er-jin-zhi-bu-shu-k8s-jia-jie-dian-cao-zuo/>2024-04-03 二进制部署K8S加节点操作</a></li><li><a href=/docs/%E4%B8%A4%E5%BC%A0%E5%9B%BE%E5%85%A8%E9%9D%A2%E7%90%86%E8%A7%A3k8s%E5%8E%9F%E7%90%86-liang-zhang-tu-quan-mian-li-jie-k8s-yuan-li/>2024-04-03 两张图全面理解K8S原理</a></li><li><a href=/docs/ssl%E8%AF%81%E4%B9%A6%E8%87%AA%E7%AD%BE%E5%8F%91-ssl-zheng-shu-zi-qian-fa/>2024-04-03 ssl证书自签发</a></li><li><a href=/docs/prometheus%E4%BC%81%E4%B8%9A%E7%BA%A7%E7%9B%91%E6%8E%A7%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93-prometheus-qi-ye-ji-jian-kong-shi-yong-zong-jie/>2024-04-03 prometheus企业级监控使用总结</a></li><li><a href=/docs/metallb-l2-%E5%8E%9F%E7%90%86-metallbl2-yuan-li/>2024-04-03 MetalLB L2 原理</a></li><li><a href=/docs/linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%A4%A7%E5%85%A8-linux-xing-neng-you-hua-da-quan/>2024-04-03 Linux 性能优化大全</a></li><li><a href=/docs/kubernetes-%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3%E9%89%B4%E6%9D%83-kubernetes-zheng-shu-xiang-jie--jian-quan-/>2024-04-03 Kubernetes 证书详解(鉴权)</a></li><li><a href=/docs/kubernetes-%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3%E8%AE%A4%E8%AF%81-kubernetes-zheng-shu-xiang-jie--ren-zheng-/>2024-04-03 Kubernetes 证书详解(认证)</a></li><li><a href=/docs/kubernetes-%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84-kubernetes-yuan-ma-jie-gou/>2024-04-03 Kubernetes 源码结构</a></li><li><a href=/docs/kubernetes-api-kubernetesapi/>2024-04-03 Kubernetes API</a></li><li><a href=/docs/kubekey%E6%B7%BB%E5%8A%A0%E6%96%B0%E8%8A%82%E7%82%B9-kubekey-tian-jia-xin-jie-dian/>2024-04-03 kubekey添加新节点</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E5%AE%9D%E5%85%B8-k8s-mian-shi-bao-dian/>2024-04-03 K8S面试宝典</a></li><li><a href=/docs/k8s%E9%9D%A2%E8%AF%95%E5%A4%A7%E5%85%A8-k8s-mian-shi-da-quan/>2024-04-03 K8S面试大全</a></li><li><a href=/docs/k8s%E8%BF%90%E7%BB%B4%E4%B9%8B%E6%B8%85%E7%90%86%E7%A3%81%E7%9B%98-k8s-yun-wei-zhi-qing-li-ci-pan/>2024-04-03 k8s运维之清理磁盘</a></li><li><a href=/docs/k8s%E8%B0%83%E8%AF%95pod-k8s-diao-shi-pod/>2024-04-03 K8S调试POD</a></li><li><a href=/docs/k8s%E7%9A%84pod%E7%B1%BB%E5%9E%8B-k8s-de-pod-lei-xing/>2024-04-03 K8S的POD类型</a></li><li><a href=/docs/k8s%E5%BA%94%E7%94%A8%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-k8s-ying-yong-de-zui-jia-shi-jian/>2024-04-03 k8s应用的最佳实践</a></li><li><a href=/docs/k8s%E5%91%BD%E4%BB%A4%E6%8C%87%E5%8D%97-k8s-ming-ling-zhi-nan/>2024-04-03 K8S命令指南</a></li><li><a href=/docs/k8s%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7-k8s-yuan-de-sheng-ji/>2024-04-03 K8S原地升级</a></li><li><a href=/docs/k8s-%E6%8E%A2%E9%92%88%E5%8E%9F%E7%90%86-k8s-tan-zhen-yuan-li/>2024-04-03 K8S 探针原理</a></li><li><a href=/docs/k8s-%E5%BC%80%E5%8F%91%E5%8F%AF%E4%B8%8D%E6%AD%A2-crud-k8s-kai-fa-ke-bu-zhi-crud/>2024-04-03 K8S 开发可不止 CRUD</a></li><li><a href=/docs/k8s-gpt-k8sgpt/>2024-04-03 K8S GPT</a></li><li><a href=/docs/k8s-csi-openebs%E5%8E%9F%E7%90%86-k8scsiopenebs-yuan-li/>2024-04-03 K8S csi openebs原理</a></li><li><a href=/docs/helm-chart%E5%92%8Crepo-helmchart-he-repo/>2024-04-03 helm chart和repo</a></li><li><a href=/docs/flanel%E7%BD%91%E7%BB%9C-flanel-wang-luo/>2024-04-03 flanel网络</a></li><li><a href=/docs/etcd%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%8F%8A%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5-etcd-wen-ding-xing-ji-xing-neng-you-hua-shi-jian/>2024-04-03 ETCD稳定性及性能优化实践</a></li><li><a href=/docs/etcd%E5%A4%87%E4%BB%BD-etcd-bei-fen/>2024-04-03 ETCD备份</a></li><li><a href=/docs/docker%E9%87%8D%E8%A6%81%E7%9A%84%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E7%82%B9-docker-zhong-yao-de-wang-luo-zhi-shi-dian/>2024-04-03 Docker重要的网络知识点</a></li><li><a href=/docs/dockerfile%E7%9A%84copy%E5%92%8Cadd%E7%9A%84%E5%8C%BA%E5%88%AB-dockerfile-de-copy-he-add-de-qu-bie/>2024-04-03 dockerfile的copy和add的区别</a></li><li><a href=/docs/coredns%E4%B9%8B%E5%85%89-coredns-zhi-guang/>2024-04-03 COREDNS之光</a></li><li><a href=/docs/containerd-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-containerd-ji-ben-cao-zuo/>2024-04-03 Containerd 基本操作</a></li><li><a href=/docs/cni%E6%8F%92%E4%BB%B6%E9%80%89%E5%9E%8B-cni-cha-jian-xuan-xing/>2024-04-03 CNI插件选型</a></li><li><a href=/docs/client-go-%E6%9E%B6%E6%9E%84-client-go-jia-gou/>2024-04-03 Client-go 架构</a></li><li><a href=/docs/client-go-%E5%9B%9B%E7%A7%8D%E5%AE%A2%E6%88%B7%E7%AB%AF-client-go-si-zhong-ke-hu-duan/>2024-04-03 Client-go 四种客户端</a></li><li><a href=/docs/cicd%E6%80%9D%E8%80%83-cicd-si-kao/>2024-04-03 CICD思考</a></li><li><a href=/docs/calico%E7%BD%91%E7%BB%9C%E8%87%AA%E5%AE%9A%E4%B9%89-calico-wang-luo-zi-ding-yi/>2024-04-03 Calico网络自定义</a></li><li><a href=/docs/acme%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E8%AF%81%E4%B9%A6-acme-zi-dong-geng-xin-zheng-shu/>2024-04-03 acme自动更新证书</a></li><li><a href=/docs/16%E4%B8%AA%E6%A6%82%E5%BF%B5%E5%B8%A6%E4%BD%A0%E5%85%A5%E9%97%A8-kubernetes-16-ge-gai-nian-dai-ni-ru-men-kubernetes/>2024-04-03 16个概念带你入门 Kubernetes</a></li><li><a href=/docs/%E9%9D%A2%E8%AF%950308-mian-shi-0308/>2024-04-03 面试0308</a></li><li><a href=/docs/600%E6%9D%A1%E6%9C%80%E5%BC%BAlinux%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-600-tiao-zui-qiang-linux-ming-ling-zong-jie/>2024-04-03 600条最强linux命令总结</a></li><li><a href=/docs/16%E5%BC%A0%E7%A1%AC%E6%A0%B8%E5%9B%BE%E8%A7%A3k8s%E7%BD%91%E7%BB%9C-16-zhang-ying-he-tu-jie-k8s-wang-luo/>2024-04-03 16张硬核图解k8s网络</a></li><li><a href=/docs/k8s%E4%B9%8Bkubelet%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-k8s-zhi-kubelet-yuan-ma-jie-du/>2024-03-28 k8s之kubelet源码解读</a></li><li><a href=/docs/k8s-%E6%B5%81%E9%87%8F%E9%93%BE%E8%B7%AF%E5%89%96%E6%9E%90-k8s-liu-liang-lian-lu-pou-xi/>2024-03-04 K8S 流量链路剖析</a></li><li><a href=/docs/k8s-csi%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B-k8scsi-pou-xi-yan-jin/>2024-03-04 K8S CSI剖析演进</a></li><li><a href=/docs/k8s-cni%E5%89%96%E6%9E%90%E6%BC%94%E8%BF%9B-k8scni-pou-xi-yan-jin/>2024-03-04 K8S CNI剖析演进</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8-openfunction-%E5%9C%A8%E4%BB%BB%E4%BD%95%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E4%B8%8A%E8%BF%90%E8%A1%8C%E6%97%A0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD-shi-yong-openfunction-zai-ren-he-ji-chu-she-shi-shang-yun-xing-wu-fu-wu-qi-gong-zuo-fu-zai/>2024-01-21 使用 OpenFunction 在任何基础设施上运行无服务器工作负载</a></li><li><a href=/docs/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4-li-xian-an-zhuang-ji-qun/>2023-09-28 离线安装集群</a></li><li><a href=/docs/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%B4%E6%98%8E-cao-zuo-xi-tong-shuo-ming/>2023-09-28 操作系统说明</a></li><li><a href=/docs/%E5%BF%AB%E9%80%9F%E6%8C%87%E5%8D%97-kuai-su-zhi-nan/>2023-09-28 快速指南</a></li><li><a href=/docs/%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8-cilium-kai-shi-shi-yong-cilium/>2023-09-28 开始使用 cilium</a></li><li><a href=/docs/%E5%A4%9A%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81-duo-jia-gou-zhi-chi/>2023-09-28 多架构支持</a></li><li><a href=/docs/%E5%85%AC%E6%9C%89%E4%BA%91%E4%B8%8A%E9%83%A8%E7%BD%B2-kubeasz-gong-you-yun-shang-bu-shu-kubeasz/>2023-09-28 公有云上部署</a></li><li><a href=/docs/%E4%B8%AA%E6%80%A7%E5%8C%96%E9%9B%86%E7%BE%A4%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE-ge-xing-hua-ji-qun-can-shu-pei-zhi/>2023-09-28 个性化集群参数配置</a></li><li><a href=/docs/network-check-network-check/>2023-09-28 network-check</a></li><li><a href=/docs/kube-router-%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-kube-router-wang-luo-zu-jian/>2023-09-28 kube-router 网络组件</a></li><li><a href=/docs/ezctl-%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BB%8B%E7%BB%8D-ezctl-ming-ling-xing-jie-shao/>2023-09-28 ezctl 命令行介绍</a></li><li><a href=/docs/ex-lb-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%83%A8%E7%BD%B2-ex-lb-fu-zai-jun-heng-bu-shu/>2023-09-28 EX-LB 负载均衡部署</a></li><li><a href=/docs/calico-%E9%85%8D%E7%BD%AE-bgp-route-reflectors-calico-pei-zhi-bgproutereflectors/>2023-09-28 calico 配置 BGP Route Reflectors</a></li><li><a href=/docs/07-%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4%E4%B8%BB%E8%A6%81%E6%8F%92%E4%BB%B6-07--an-zhuang-ji-qun-zhu-yao-cha-jian/>2023-09-28 15:26:42.651 07-安装集群主要插件</a></li><li><a href=/docs/08-k8s-%E9%9B%86%E7%BE%A4%E5%AD%98%E5%82%A8--k8s-ji-qun-cun-chu/>2023-09-28 08-K8S 集群存储</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-wang-luo-zu-jian/>2023-09-28 06-安装网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85kube-ovn%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-kube-ovn-wang-luo-zu-jian/>2023-09-28 06-安装kube-ovn网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85flannel%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-flannel-wang-luo-zu-jian/>2023-09-28 06-安装flannel网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85cilium%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-cilium-wang-luo-zu-jian/>2023-09-28 06-安装cilium网络组件</a></li><li><a href=/docs/06-%E5%AE%89%E8%A3%85calico%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-06--an-zhuang-calico-wang-luo-zu-jian/>2023-09-28 06-安装calico网络组件</a></li><li><a href=/docs/02-%E5%AE%89%E8%A3%85etcd%E9%9B%86%E7%BE%A4-02--an-zhuang-etcd-ji-qun/>2023-09-28 02-安装etcd集群</a></li><li><a href=/docs/00-%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%92%8C%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E8%AE%BE%E5%AE%9A-00--ji-qun-gui-hua-he-ji-chu-can-shu-she-ding/>2023-09-28 00-集群规划和基础参数设定</a></li><li><a href=/docs/05-%E5%AE%89%E8%A3%85kube_node%E8%8A%82%E7%82%B9-05--an-zhuang-kubenode-jie-dian/>2023-09-28 05-安装kube_node节点</a></li><li><a href=/docs/04-%E5%AE%89%E8%A3%85kube_master%E8%8A%82%E7%82%B9-04--an-zhuang-kubemaster-jie-dian/>2023-09-28 04-安装kube_master节点</a></li><li><a href=/docs/03-%E5%AE%89%E8%A3%85%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6-03--an-zhuang-rong-qi-yun-xing-shi/>2023-09-28 03-安装容器运行时</a></li><li><a href=/docs/01-%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6%E5%92%8C%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-01--chuang-jian-zheng-shu-he-huan-jing-zhun-bei/>2023-09-28 01-创建证书和环境准备</a></li><li><a href=/docs/%E6%9C%89%E8%BF%993%E4%B8%AA%E8%BF%B9%E8%B1%A1%E4%BD%A0%E5%B0%B1%E8%AF%A5%E7%A6%BB%E8%81%8C%E4%BA%86-you-zhe-3-ge-ji-xiang--ni-jiu-gai-li-zhi-le/>2023-09-21 思考</a></li><li><a href=/docs/%E4%BD%BF%E7%94%A8-keepalived-%E5%92%8C-haproxy-%E5%88%9B%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8-kubernetes-%E9%9B%86%E7%BE%A4-shi-yong-keepalived-he-haproxy-chuang-jian-gao-ke-yong-kubernetes-ji-qun/>2023-04-12 使用 Keepalived 和 HAproxy 创建高可用 Kubernetes 集群</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>2024-08-02 史上最牛jenkins pipeline流水线详解</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#11-声明式流水线>1.1 声明式流水线</a></li><li><a href=#12-脚本化流水线>1.2 脚本化流水线</a></li></ul><ul><li><a href=#21-sections>2.1 Sections</a><ul><li><a href=#1agent>1.Agent</a></li><li><a href=#2agent-的配置示例>2.agent 的配置示例</a></li><li><a href=#3post>3.Post</a></li><li><a href=#4sepes>4.sepes</a></li></ul></li><li><a href=#22-directives>2.2 Directives</a><ul><li><a href=#1environment>1.Environment</a></li><li><a href=#2options>2.Options</a></li><li><a href=#3parameters>3.Parameters</a></li><li><a href=#4triggers>4.Triggers</a></li><li><a href=#5input>5.Input</a></li><li><a href=#6when>6.when</a></li></ul></li><li><a href=#23-parallel>2.3 Parallel</a></li></ul><ul><li><a href=#31-环境变量>3.1 环境变量</a><ul><li><a href=#1静态变量>1.静态变量</a></li><li><a href=#2动态变量>2.动态变量</a></li></ul></li><li><a href=#32-凭证管理>3.2 凭证管理</a><ul><li><a href=#1加密文本>1.加密文本</a></li><li><a href=#2用户名密码>2.用户名密码</a></li><li><a href=#3加密文件>3.加密文件</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=一什么是流水线>一、什么是流水线
<a class=anchor href=#%e4%b8%80%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%81%e6%b0%b4%e7%ba%bf>#</a></h1><p>jenkins 有 2 种流水线分为声明式流水线与脚本化流水线，脚本化流水线是 jenkins 旧版本使用的流水线脚本，新版本 Jenkins 推荐使用声明式流水线。文档只介绍声明流水线。</p><h2 id=11-声明式流水线>1.1 声明式流水线
<a class=anchor href=#11-%e5%a3%b0%e6%98%8e%e5%bc%8f%e6%b5%81%e6%b0%b4%e7%ba%bf>#</a></h2><p>在声明式流水线语法中，流水线过程定义在 Pipeline{}中，Pipeline 块定义了整个流水线中完成的所有工作，比如</p><p><strong>参数说明</strong>：</p><ul><li>agent any：在任何可用的代理上执行流水线或它的任何阶段，也就是执行流水线过程的位置，也可以指定到具体的节点</li><li>stage：定义流水线的执行过程（相当于一个阶段），比如下文所示的 Build、Test、Deploy， 但是这个名字是根据实际情况进行定义的，并非固定的名字</li><li>steps：执行某阶段具体的步骤。</li></ul><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
    stages {
      stage(&#39;Build&#39;) {
        steps {
          echo &#39;Build&#39;
        }
      }
      stage(&#39;Test&#39;) {
        steps {
          echo &#39;Test&#39;
        }
      }
      stage(&#39;Deploy&#39;) {
        steps {
          echo &#39;Deploy&#39;
      }
    }
  }
}
</code></pre><h2 id=12-脚本化流水线>1.2 脚本化流水线
<a class=anchor href=#12-%e8%84%9a%e6%9c%ac%e5%8c%96%e6%b5%81%e6%b0%b4%e7%ba%bf>#</a></h2><p>在脚本化流水线语法中，会有一个或多个 Node（节点）块在整个流水线中执行核心工作</p><p><strong>参数说明</strong>:</p><ul><li>node：在任何可用的代理上执行流水线或它的任何阶段，也可以指定到具体的节点</li><li>stage：和声明式的含义一致，定义流水线的阶段。Stage 块在脚本化流水线语法中是可选的，然而在脚本化流水线中实现 stage 块，可以清楚地在 Jenkins UI 界面中显示每个 stage 的任务子集。</li></ul><pre tabindex=0><code>//Jenkinsfile (Scripted Pipeline)
node {
  stage(&#39;Build&#39;) {
    echo &#39;Build&#39;
  }
  stage(&#39;Test&#39;) {
    echo &#39;Test&#39;
  }
  stage(&#39;Deploy&#39;) {
    echo &#39;Deploy&#39;
  }
}
</code></pre><h1 id=二声明式流水线>二、声明式流水线
<a class=anchor href=#%e4%ba%8c%e5%a3%b0%e6%98%8e%e5%bc%8f%e6%b5%81%e6%b0%b4%e7%ba%bf>#</a></h1><p>声明式流水线必须包含在一个 Pipeline 块中，比如是一个 Pipeline 块的格式</p><pre tabindex=0><code>pipeline {
  /* insert Declarative Pipeline here */
}
</code></pre><p>在声明式流水线中有效的基本语句和表达式遵循与 Groovy 的语法同样的规则，但有以下例外</p><ul><li>流水线顶层必须是一个 block，即 <code>pipeline{}</code></li><li>分隔符可以不需要分号，但是每条语句都必须在自己的行上</li><li>块只能由 Sections、Directives、Steps 或 assignment statements 组成</li><li>属性引用语句被当做是无参数的方法调用，比如 input 会被当做 input()。</li></ul><h2 id=21-sections>2.1 Sections
<a class=anchor href=#21-sections>#</a></h2><p>声明式流水线中的 Sections 不是一个关键字或指令，而是包含一个或多个 Agent、Stages、 post、Directives 和 Steps 的代码区域块。</p><h3 id=1agent>1.Agent
<a class=anchor href=#1agent>#</a></h3><p>Agent 表示整个流水线或特定阶段中的步骤和命令执行的位置，该部分必须在 pipeline 块的顶层被定义，也可以在 stage 中再次定义，但是 stage 级别是可选的。</p><h4 id=any>any
<a class=anchor href=#any>#</a></h4><p>在任何可用的代理上执行流水线，配置语法</p><pre tabindex=0><code>pipeline {
  agent any
}
</code></pre><h4 id=none>none
<a class=anchor href=#none>#</a></h4><p>表示该 Pipeline 脚本没有全局的 agent 配置。当顶层的 agent 配置为 none 时， 每个 stage 部分都需要包含它自己的 agent。配置语法</p><pre tabindex=0><code>pipeline {
  agent none
  stages {
    stage(&#39;Stage For Build&#39;){
      agent any
    }
  }
}
</code></pre><h4 id=label>label
<a class=anchor href=#label>#</a></h4><p>以节点标签形式选择某个具体的节点执行 Pipeline 命令，例如：agent { label &lsquo;my-defined-label&rsquo; }。节点需要提前配置标签。</p><pre tabindex=0><code>pipeline {
  agent none
    stages {
      stage(&#39;Stage For Build&#39;){
        agent { label &#39;role-master&#39; }
        steps {
          echo &#34;role-master&#34;
        }
      }
    }
}
</code></pre><h4 id=node>node
<a class=anchor href=#node>#</a></h4><p>和 label 配置类似，只不过是可以添加一些额外的配置，比如 customWorkspace(设置默认工作目录)</p><pre tabindex=0><code>pipeline {
  agent none
    stages {
      stage(&#39;Stage For Build&#39;){
        agent {
          node {
            label &#39;role-master&#39;
            customWorkspace &#34;/tmp/zhangzhuo/data&#34;
          }
        }
        steps {
          sh &#34;echo role-master &gt; 1.txt&#34;
        }
      }
    }
}
</code></pre><h4 id=dockerfile>dockerfile
<a class=anchor href=#dockerfile>#</a></h4><p>使用从源码中包含的 Dockerfile 所构建的容器执行流水线或 stage。此时对应的 agent 写法如下</p><pre tabindex=0><code>agent {
   dockerfile {
     filename &#39;Dockerfile.build&#39;  //dockerfile文件名称
     dir &#39;build&#39;                  //执行构建镜像的工作目录
     label &#39;role-master&#39;          //执行的node节点，标签选择
     additionalBuildArgs &#39;--build-arg version=1.0.2&#39; //构建参数
   }
}
</code></pre><h4 id=docker>docker
<a class=anchor href=#docker>#</a></h4><p>相当于 dockerfile，可以直接使用 docker 字段指定外部镜像即可，可以省去构建的时间。比如使用 maven 镜像进行打包，同时可以指定 args</p><pre tabindex=0><code>agent{
  docker{
    image &#39;192.168.10.15/kubernetes/alpine:latest&#39;   //镜像地址
    label &#39;role-master&#39; //执行的节点，标签选择
    args &#39;-v /tmp:/tmp&#39;      //启动镜像的参数
  }
}
</code></pre><h4 id=kubernetes>kubernetes
<a class=anchor href=#kubernetes>#</a></h4><p>需要部署 kubernetes 相关的插件，官方文档：</p><blockquote><p><a href=https://github.com/jenkinsci/kubernetes-plugin/>https://github.com/jenkinsci/kubernetes-plugin/</a></p></blockquote><p>Jenkins 也支持使用 Kubernetes 创建 Slave，也就是常说的动态 Slave。配置示例如下</p><ul><li><p>cloud: Configure Clouds 的名称，指定到其中一个 k8s</p></li><li><p>slaveConnectTimeout: 连接超时时间</p></li><li><p>yaml: pod 定义文件，jnlp 容器的配置必须有配置无需改变，其余 containerd 根据自己情况指定</p></li><li><p>workspaceVolume：持久化 jenkins 的工作目录。</p></li><li><ul><li>persistentVolumeClaimWorkspaceVolume：挂载已有 pvc。</li></ul></li></ul><pre tabindex=0><code>workspaceVolume persistentVolumeClaimWorkspaceVolume(claimName: &#34;jenkins-agent&#34;, mountPath: &#34;/&#34;, readOnly: &#34;false&#34;)
</code></pre><ul><li>nfsWorkspaceVolume：挂载 nfs 服务器目录</li></ul><pre tabindex=0><code>workspaceVolume nfsWorkspaceVolume(serverAddress: &#34;192.168.10.254&#34;, serverPath: &#34;/nfs&#34;, readOnly: &#34;false&#34;)
</code></pre><ul><li>dynamicPVC：动态申请 pvc，任务执行结束后删除</li></ul><pre tabindex=0><code>workspaceVolume dynamicPVC(storageClassName: &#34;nfs-client&#34;, requestsSize: &#34;1Gi&#34;, accessModes: &#34;ReadWriteMany&#34;)
</code></pre><ul><li>emptyDirWorkspaceVolume：临时目录，任务执行结束后会随着 pod 删除被删除，主要功能多个任务 container 共享 jenkins 工作目录。</li></ul><pre tabindex=0><code>workspaceVolume emptyDirWorkspaceVolume()
</code></pre><ul><li>hostPathWorkspaceVolume：挂载 node 节点本机目录，注意挂载本机目录注意权限问题，可以先创建设置 777 权限，否则默认 kubelet 创建的目录权限为 755 默认其他用户没有写权限，执行流水线会报错。</li></ul><pre tabindex=0><code>workspaceVolume hostPathWorkspaceVolume(hostPath: &#34;/opt/workspace&#34;, readOnly: false)
</code></pre><p><strong>示例</strong></p><pre tabindex=0><code>agent {
  kubernetes {
      cloud &#39;kubernetes&#39;
      slaveConnectTimeout 1200
      workspaceVolume emptyDirWorkspaceVolume()
      yaml &#39;&#39;&#39;
kind: Pod
metadata:
  name: jenkins-agent
spec:
  containers:
  - args: [\&#39;$(JENKINS_SECRET)\&#39;, \&#39;$(JENKINS_NAME)\&#39;]
    image: &#39;192.168.10.15/kubernetes/jnlp:alpine&#39;
    name: jnlp
    imagePullPolicy: IfNotPresent
  - command:
      - &#34;cat&#34;
    image: &#34;192.168.10.15/kubernetes/alpine:latest&#34;
    imagePullPolicy: &#34;IfNotPresent&#34;
    name: &#34;date&#34;
    tty: true
  restartPolicy: Never
&#39;&#39;&#39;
  }
}
</code></pre><h3 id=2agent-的配置示例>2.agent 的配置示例
<a class=anchor href=#2agent-%e7%9a%84%e9%85%8d%e7%bd%ae%e7%a4%ba%e4%be%8b>#</a></h3><h4 id=kubernetes-示例>kubernetes 示例
<a class=anchor href=#kubernetes-%e7%a4%ba%e4%be%8b>#</a></h4><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwNTM5Njk3Mw==&amp;mid=2247506725&amp;idx=2&amp;sn=cb0395b93925ce3a06edf60d7ca7d2c1&amp;chksm=9b1fdba7ac6852b182a5907c301fc9df85497315989ee99c4fbc2a88fad84a6032783b3524b0&amp;scene=21#wechat_redirect">Docker+K8s+Jenkins 主流技术全解视频资料【干货免费分享】</a></p><pre tabindex=0><code>pipeline {
  agent {
    kubernetes {
      cloud &#39;kubernetes&#39;
      slaveConnectTimeout 1200
      workspaceVolume emptyDirWorkspaceVolume()
      yaml &#39;&#39;&#39;
kind: Pod
metadata:
  name: jenkins-agent
spec:
  containers:
  - args: [\&#39;$(JENKINS_SECRET)\&#39;, \&#39;$(JENKINS_NAME)\&#39;]
    image: &#39;192.168.10.15/kubernetes/jnlp:alpine&#39;
    name: jnlp
    imagePullPolicy: IfNotPresent
  - command:
      - &#34;cat&#34;
    image: &#34;192.168.10.15/kubernetes/alpine:latest&#34;
    imagePullPolicy: &#34;IfNotPresent&#34;
    name: &#34;date&#34;
    tty: true
  - command:
      - &#34;cat&#34;
    image: &#34;192.168.10.15/kubernetes/kubectl:apline&#34;
    imagePullPolicy: &#34;IfNotPresent&#34;
    name: &#34;kubectl&#34;
    tty: true
  restartPolicy: Never
&#39;&#39;&#39;
    }
  }
  environment {
    MY_KUBECONFIG = credentials(&#39;kubernetes-cluster&#39;)
  }
  stages {
    stage(&#39;Data&#39;) {
      steps {
        container(name: &#39;date&#39;) {
          sh &#34;&#34;&#34;
            date
          &#34;&#34;&#34;
        }
      }
    }
    stage(&#39;echo&#39;) {
      steps {
        container(name: &#39;date&#39;) {
          sh &#34;&#34;&#34;
            echo &#39;k8s is pod&#39;
          &#34;&#34;&#34;
        }
      }
    }
    stage(&#39;kubectl&#39;) {
      steps {
        container(name: &#39;kubectl&#39;) {
          sh &#34;&#34;&#34;
            kubectl get pod -A  --kubeconfig $MY_KUBECONFIG
          &#34;&#34;&#34;
        }
      }
    }
  }
}
</code></pre><h4 id=docker-的示例>docker 的示例
<a class=anchor href=#docker-%e7%9a%84%e7%a4%ba%e4%be%8b>#</a></h4><pre tabindex=0><code>pipeline {
  agent none
  stages {
    stage(&#39;Example Build&#39;) {
      agent { docker &#39;maven:3-alpine&#39; }
      steps {
        echo &#39;Hello, Maven&#39;
        sh &#39;mvn --version&#39;
      }
    }
    stage(&#39;Example Test&#39;) {
      agent { docker &#39;openjdk:8-jre&#39; }
      steps {
        echo &#39;Hello, JDK&#39;
        sh &#39;java -version&#39;
      }
    }
  }
}
</code></pre><h3 id=3post>3.Post
<a class=anchor href=#3post>#</a></h3><ol><li>Post 一般用于流水线结束后的进一步处理，比如错误通知等。Post 可以针对流水线不同的结果做出不同的处理，就像开发程序的错误处理，比如 Python 语言的 try catch。</li><li>Post 可以定义在 Pipeline 或 stage 中，目前支持以下条件</li><li>always：无论 Pipeline 或 stage 的完成状态如何，都允许运行该 post 中定义的指令；</li><li>changed：只有当前 Pipeline 或 stage 的完成状态与它之前的运行不同时，才允许在该 post 部分运行该步骤；</li><li>fixed：当本次 Pipeline 或 stage 成功，且上一次构建是失败或不稳定时，允许运行该 post 中定义的指令；</li><li>regression：当本次 Pipeline 或 stage 的状态为失败、不稳定或终止，且上一次构建的 状态为成功时，允许运行该 post 中定义的指令；</li><li>failure：只有当前 Pipeline 或 stage 的完成状态为失败（failure），才允许在 post 部分运行该步骤，通常这时在 Web 界面中显示为红色</li><li>success：当前状态为成功（success），执行 post 步骤，通常在 Web 界面中显示为蓝色 或绿色</li><li>unstable：当前状态为不稳定（unstable），执行 post 步骤，通常由于测试失败或代码 违规等造成，在 Web 界面中显示为黄色</li><li>aborted：当前状态为终止（aborted），执行该 post 步骤，通常由于流水线被手动终止触发，这时在 Web 界面中显示为灰色；</li><li>unsuccessful：当前状态不是 success 时，执行该 post 步骤；</li><li>cleanup：无论 pipeline 或 stage 的完成状态如何，都允许运行该 post 中定义的指令。和 always 的区别在于，cleanup 会在其它执行之后执行。</li></ol><h4 id=示例>示例
<a class=anchor href=#%e7%a4%ba%e4%be%8b>#</a></h4><p>一般情况下 post 部分放在流水线的底部，比如本实例，无论 stage 的完成状态如何，都会输出一条 I will always say Hello again!信息</p><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
  stages {
    stage(&#39;Example1&#39;) {
      steps {
        echo &#39;Hello World1&#39;
      }
    }
    stage(&#39;Example2&#39;) {
      steps {
        echo &#39;Hello World2&#39;
      }
    }
  }
  post {
    always {
      echo &#39;I will always say Hello again!&#39;
    }
  }
}
</code></pre><p>也可以将 post 写在 stage，下面示例表示 Example1 执行失败执行 post。</p><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
  stages {
    stage(&#39;Example1&#39;) {
      steps {
        sh &#39;ip a&#39;
      }
      post {
        failure {
          echo &#39;I will always say Hello again!&#39;
        }
      }
    }
  }
}
</code></pre><h3 id=4sepes>4.sepes
<a class=anchor href=#4sepes>#</a></h3><p>Steps 部分在给定的 stage 指令中执行的一个或多个步骤，比如在 steps 定义执行一条 shell 命令</p><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
  stages {
    stage(&#39;Example&#39;) {
      steps {
        echo &#39;Hello World&#39;
      }
    }
  }
}
</code></pre><p>或者是使用 sh 字段执行多条指令</p><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
  stages {
    stage(&#39;Example&#39;) {
      steps {
        sh &#34;&#34;&#34;
           echo &#39;Hello World1&#39;
           echo &#39;Hello World2&#39;
        &#34;&#34;&#34;
      }
    }
  }
}
</code></pre><h2 id=22-directives>2.2 Directives
<a class=anchor href=#22-directives>#</a></h2><p>Directives 可用于一些执行 stage 时的条件判断或预处理一些数据，和 Sections 一致，Directives 不是一个关键字或指令，而是包含了 environment、options、parameters、triggers、stage、tools、 input、when 等配置。</p><h3 id=1environment>1.Environment
<a class=anchor href=#1environment>#</a></h3><p>Environment 主要用于在流水线中配置的一些环境变量，根据配置的位置决定环境变量的作用域。可以定义在 pipeline 中作为全局变量，也可以配置在 stage 中作为该 stage 的环境变量。该指令支持一个特殊的方法 <code>credentials()</code>，该方法可用于在 Jenkins 环境中通过标识符访问预定义的凭证。对于类型为 Secret Text 的凭证，<code>credentials()</code>可以将该 Secret 中的文本内容赋值给环境变量。对于类型为标准的账号密码型的凭证，指定的环境变量为 username 和 password，并且也会定义两个额外的环境变量，分别为<code>MYVARNAME_USR</code>和<code>MYVARNAME_PSW</code>。</p><h4 id=基本变量使用>基本变量使用
<a class=anchor href=#%e5%9f%ba%e6%9c%ac%e5%8f%98%e9%87%8f%e4%bd%bf%e7%94%a8>#</a></h4><pre tabindex=0><code>//示例
pipeline {
  agent any
  environment {   //全局变量，会在所有stage中生效
    NAME= &#39;zhangzhuo&#39;
  }
  stages {
    stage(&#39;env1&#39;) {
      environment { //定义在stage中的变量只会在当前stage生效，其他的stage不会生效
        HARBOR = &#39;https://192.168.10.15&#39;
      }
      steps {
        sh &#34;env&#34;
      }
    }
    stage(&#39;env2&#39;) {
      steps {
        sh &#34;env&#34;
      }
    }
  }
}
</code></pre><h4 id=使用变量引用-secret-的凭证>使用变量引用 secret 的凭证
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e5%8f%98%e9%87%8f%e5%bc%95%e7%94%a8-secret-%e7%9a%84%e5%87%ad%e8%af%81>#</a></h4><pre tabindex=0><code>//这里使用k8s的kubeconfig文件示例
pipeline {
  agent any
  environment {
    KUBECONFIG = credentials(&#39;kubernetes-cluster&#39;)
  }
  stages {
    stage(&#39;env&#39;) {
      steps {
        sh &#34;env&#34;  //默认情况下输出的变量内容会被加密
      }
    }
  }
}
</code></pre><h4 id=使用变量引用类型为标准的账号密码型的凭证>使用变量引用类型为标准的账号密码型的凭证
<a class=anchor href=#%e4%bd%bf%e7%94%a8%e5%8f%98%e9%87%8f%e5%bc%95%e7%94%a8%e7%b1%bb%e5%9e%8b%e4%b8%ba%e6%a0%87%e5%87%86%e7%9a%84%e8%b4%a6%e5%8f%b7%e5%af%86%e7%a0%81%e5%9e%8b%e7%9a%84%e5%87%ad%e8%af%81>#</a></h4><p>这里使用 HARBOR 变量进行演示，默认情况下账号密码型的凭证会自动创建 3 个变量</p><ul><li>HARBOR_USR:会把凭证中 username 值赋值给这个变量</li><li>HARBOR_PSW:会把凭证中 password 值赋值给这个变量</li><li>HARBOR:默认情况下赋值的值为<code>usernamme:password</code></li></ul><pre tabindex=0><code>//这里使用k8s的kubeconfig文件示例
pipeline {
  agent any
  environment {
    HARBOR = credentials(&#39;harbor-account&#39;)
  }
  stages {
    stage(&#39;env&#39;) {
      steps {
        sh &#34;env&#34;
      }
    }
  }
}
</code></pre><h3 id=2options>2.Options
<a class=anchor href=#2options>#</a></h3><p>Jenkins 流水线支持很多内置指令，比如 retry 可以对失败的步骤进行重复执行 n 次，可以根据不同的指令实现不同的效果。比较常用的指令如下:</p><ul><li>buildDiscarder ：保留多少个流水线的构建记录</li><li>disableConcurrentBuilds：禁止流水线并行执行，防止并行流水线同时访问共享资源导致流水线失败。</li><li>disableResume ：如果控制器重启，禁止流水线自动恢复。</li><li>newContainerPerStage：agent 为 docker 或 dockerfile 时，每个阶段将在同一个节点的新容器中运行，而不是所有的阶段都在同一个容器中运行。</li><li>quietPeriod：流水线静默期，也就是触发流水线后等待一会在执行。</li><li>retry：流水线失败后重试次数。</li><li>timeout：设置流水线的超时时间，超过流水线时间，job 会自动终止。如果不加 unit 参数默认为 1 分。</li><li>timestamps：为控制台输出时间戳。</li></ul><h4 id=定义在-pipeline-中>定义在 pipeline 中
<a class=anchor href=#%e5%ae%9a%e4%b9%89%e5%9c%a8-pipeline-%e4%b8%ad>#</a></h4><pre tabindex=0><code>pipeline {
  agent any
  options {
    timeout(time: 1, unit: &#39;HOURS&#39;)  //超时时间1小时，如果不加unit参数默认为1分
    timestamps()                     //所有输出每行都会打印时间戳
    buildDiscarder(logRotator(numToKeepStr: &#39;3&#39;)) //保留三个历史构建版本
    quietPeriod(10)  //注意手动触发的构建不生效
    retry(3)    //流水线失败后重试次数
  }
  stages {
    stage(&#39;env1&#39;) {
      steps {
        sh &#34;env&#34;
        sleep 2
      }
    }
    stage(&#39;env2&#39;) {
      steps {
        sh &#34;env&#34;
      }
    }
  }
}
</code></pre><h4 id=定义在-stage-中>定义在 stage 中
<a class=anchor href=#%e5%ae%9a%e4%b9%89%e5%9c%a8-stage-%e4%b8%ad>#</a></h4><p>Option 除了写在 Pipeline 顶层，还可以写在 stage 中，但是写在 stage 中的 option 仅支持 retry、 timeout、timestamps，或者是和 stage 相关的声明式选项，比如 skipDefaultCheckout。处于 stage 级别的 options 写法如下</p><pre tabindex=0><code>pipeline {
  agent any
  stages {
    stage(&#39;env1&#39;) {
      options {   //定义在这里这对这个stage生效
        timeout(time: 2, unit: &#39;SECONDS&#39;) //超时时间2秒
        timestamps()                     //所有输出每行都会打印时间戳
        retry(3)    //流水线失败后重试次数
      }
      steps {
        sh &#34;env &amp;&amp; sleep 2&#34;
      }
    }
    stage(&#39;env2&#39;) {
      steps {
        sh &#34;env&#34;
      }
    }
  }
}
</code></pre><h3 id=3parameters>3.Parameters
<a class=anchor href=#3parameters>#</a></h3><p>Parameters 提供了一个用户在触发流水线时应该提供的参数列表，这些用户指定参数的值可以通过 params 对象提供给流水线的 step（步骤）。只能定义在 pipeline 顶层。</p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzU5NDYwNA==&amp;mid=2247501042&amp;idx=1&amp;sn=d72cf96b451ddecc591ce62954183c11&amp;chksm=a696297191e1a067bc8291e4c781c839bd7d35aa960116c7a7b5ac97f143a9fced73a480b823&amp;scene=21#wechat_redirect"><strong>目前支持的参数类型如下</strong></a></p><ul><li>string：字符串类型的参数。</li><li>text：文本型参数，一般用于定义多行文本内容的变量。</li><li>booleanParam：布尔型参数。</li><li>choice：选择型参数，一般用于给定几个可选的值，然后选择其中一个进行赋值。</li><li>password：密码型变量，一般用于定义敏感型变量，在 Jenkins 控制台会输出为*。</li></ul><p><strong>插件 Parameters</strong></p><ul><li>imageTag：镜像 tag，需要安装 Image Tag Parameter 插件后使用</li><li>gitParameter：获取 git 仓库分支，需要 Git Parameter 插件后使用</li></ul><p><strong>示例</strong></p><pre tabindex=0><code>pipeline {
  agent any
  parameters {
    string(name: &#39;DEPLOY_ENV&#39;, defaultValue:  &#39;staging&#39;, description: &#39;1&#39;)   //执行构建时需要手动配置字符串类型参数，之后赋值给变量
    text(name:  &#39;DEPLOY_TEXT&#39;, defaultValue: &#39;One\nTwo\nThree\n&#39;, description: &#39;2&#39;)  //执行构建时需要提供文本参数，之后赋值给变量
    booleanParam(name: &#39;DEBUG_BUILD&#39;,  defaultValue: true, description: &#39;3&#39;)   //布尔型参数
    choice(name: &#39;CHOICES&#39;, choices: [&#39;one&#39;, &#39;two&#39;, &#39;three&#39;], description: &#39;4&#39;)  //选择形式列表参数
    password(name: &#39;PASSWORD&#39;, defaultValue: &#39;SECRET&#39;, description: &#39;A  secret password&#39;)  //密码类型参数，会进行加密
    imageTag(name: &#39;DOCKER_IMAGE&#39;, description: &#39;&#39;, image: &#39;kubernetes/kubectl&#39;, filter: &#39;.*&#39;, defaultTag: &#39;&#39;, registry: &#39;https://192.168.10.15&#39;, credentialId: &#39;harbor-account&#39;, tagOrder: &#39;NATURAL&#39;)   //获取镜像名称与tag
    gitParameter(branch: &#39;&#39;, branchFilter: &#39;origin/(.*)&#39;, defaultValue: &#39;&#39;, description: &#39;Branch for build and deploy&#39;, name: &#39;BRANCH&#39;, quickFilterEnabled: false, selectedValue: &#39;NONE&#39;, sortMode: &#39;NONE&#39;,  tagFilter: &#39;*&#39;, type: &#39;PT_BRANCH&#39;)
  }  //获取git仓库分支列表，必须有git引用
  stages {
    stage(&#39;env1&#39;) {
      steps {
        sh &#34;env&#34;
      }
    }
    stage(&#39;git&#39;) {
      steps {
        git branch: &#34;$BRANCH&#34;, credentialsId: &#39;gitlab-key&#39;, url: &#39;git@192.168.10.14:root/env.git&#39;   //使用gitParameter，必须有这个
      }
    }
  }
}
</code></pre><h3 id=4triggers>4.Triggers
<a class=anchor href=#4triggers>#</a></h3><p>在 Pipeline 中可以用 triggers 实现自动触发流水线执行任务，可以通过 Webhook、Cron、 pollSCM 和 upstream 等方式触发流水线。</p><h4 id=cron>Cron
<a class=anchor href=#cron>#</a></h4><p>定时构建假如某个流水线构建的时间比较长，或者某个流水线需要定期在某个时间段执行构建，可以 使用 cron 配置触发器，比如周一到周五每隔四个小时执行一次</p><p>注意：H 的意思不是 HOURS 的意思，而是 Hash 的缩写。主要为了解决多个流水线在同一时间同时运行带来的系统负载压力。</p><pre tabindex=0><code>pipeline {
  agent any
  triggers {
    cron(&#39;H */4 * * 1-5&#39;)   //周一到周五每隔四个小时执行一次
    cron(&#39;H/12 * * * *&#39;)   //每隔12分钟执行一次
    cron(&#39;H * * * *&#39;)   //每隔1小时执行一次
  }
  stages {
    stage(&#39;Example&#39;) {
      steps {
        echo &#39;Hello World&#39;
      }
    }
  }
}
</code></pre><h4 id=upstream>Upstream
<a class=anchor href=#upstream>#</a></h4><p>Upstream 可以根据上游 job 的执行结果决定是否触发该流水线。比如当 job1 或 job2 执行成功时触发该流水线</p><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwNTM5Njk3Mw==&amp;mid=2247506725&amp;idx=2&amp;sn=cb0395b93925ce3a06edf60d7ca7d2c1&amp;chksm=9b1fdba7ac6852b182a5907c301fc9df85497315989ee99c4fbc2a88fad84a6032783b3524b0&amp;scene=21#wechat_redirect">Docker+K8s+Jenkins 主流技术全解视频资料【干货免费分享】</a></p><p>目前支持的状态有 SUCCESS、UNSTABLE、FAILURE、NOT_BUILT、ABORTED 等。</p><pre tabindex=0><code>pipeline {
  agent any
  triggers {
    upstream(upstreamProjects: &#39;env&#39;, threshold: hudson.model.Result.SUCCESS)  //当env构建成功时构建这个流水线
  }
  stages {
    stage(&#39;Example&#39;) {
      steps {
        echo &#39;Hello World&#39;
      }
    }
  }
}
</code></pre><h3 id=5input>5.Input
<a class=anchor href=#5input>#</a></h3><p>Input 字段可以实现在流水线中进行交互式操作，比如选择要部署的环境、是否继续执行某个阶段等。</p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzU5NDYwNA==&amp;mid=2247500578&amp;idx=1&amp;sn=4b56ad52e9f19f5c3dd955eeeb08a092&amp;chksm=a6962ea191e1a7b7c476fbe4c45827441d6a47a37a5830a45ad57853e588447bab6cb50a97de&amp;scene=21#wechat_redirect"><strong>配置 Input 支持以下选项</strong></a></p><ul><li>message：必选，需要用户进行 input 的提示信息，比如：“是否发布到生产环境？”；</li><li>id：可选，input 的标识符，默认为 stage 的名称；</li><li>ok：可选，确认按钮的显示信息，比如：“确定”、“允许”；</li><li>submitter：可选，允许提交 input 操作的用户或组的名称，如果为空，任何登录用户均可提交 input；</li><li>parameters：提供一个参数列表供 input 使用。</li></ul><p>假如需要配置一个提示消息为“还继续么”、确认按钮为“继续”、提供一个 PERSON 的变量的参数，并且只能由登录用户为 alice 和 bob 提交的 input 流水线</p><pre tabindex=0><code>pipeline {
  agent any
  stages {
    stage(&#39;Example&#39;) {
      input {
        message &#34;还继续么?&#34;
        ok &#34;继续&#34;
        submitter &#34;alice,bob&#34;
        parameters {
          string(name: &#39;PERSON&#39;, defaultValue: &#39;Mr Jenkins&#39;, description: &#39;Who should I say hello to?&#39;)
        }
      }
      steps {
        echo &#34;Hello, ${PERSON}, nice to meet you.&#34;
      }
    }
  }
}
</code></pre><h3 id=6when>6.when
<a class=anchor href=#6when>#</a></h3><p>When 指令允许流水线根据给定的条件决定是否应该执行该 stage，when 指令必须包含至少 一个条件。如果 when 包含多个条件，所有的子条件必须都返回 True，stage 才能执行。</p><p>When 也可以结合 not、allOf、anyOf 语法达到更灵活的条件匹配。</p><p><strong>目前比较常用的内置条件如下</strong></p><ul><li>branch：当正在构建的分支与给定的分支匹配时，执行这个 stage。注意，branch 只适用于多分支流水线</li><li>changelog：匹配提交的 changeLog 决定是否构建，例如:<code>when { changelog '.*^\\[DEPENDENCY\\] .+$' }</code></li><li>environment：当指定的环境变量和给定的变量匹配时，执行这个 stage，例如：when { environment name: &lsquo;DEPLOY_TO&rsquo;, value: &lsquo;production&rsquo; }</li><li>equals：当期望值和实际值相同时，执行这个 stage，例如：when { equals expected: 2, actual: currentBuild.number }；</li><li>expression：当指定的 Groovy 表达式评估为 True，执行这个 stage，例如：when { expression { return params.DEBUG_BUILD } }；</li><li>tag：如果 TAG_NAME 的值和给定的条件匹配，执行这个 stage，例如：when { tag &ldquo;release-&rdquo; }；</li><li>not：当嵌套条件出现错误时，执行这个 stage，必须包含一个条件，例如：when { not { branch &lsquo;master&rsquo; } }；</li><li>allOf：当所有的嵌套条件都正确时，执行这个 stage，必须包含至少一个条件，例如：when { allOf { branch &lsquo;master&rsquo;; environment name: &lsquo;DEPLOY_TO&rsquo;, value: &lsquo;production&rsquo; } }；</li><li>anyOf：当至少有一个嵌套条件为 True 时，执行这个 stage，例如：when { anyOf { branch &lsquo;master&rsquo;; branch &lsquo;staging&rsquo; } }。</li></ul><p><strong>示例：当分支为 main 时执行 Example Deploy 步骤</strong></p><pre tabindex=0><code>pipeline {
  agent any
  stages {
    stage(&#39;Example Build&#39;) {
      steps {
        echo &#39;Hello World&#39;
      }
    }
    stage(&#39;Example Deploy&#39;) {
      when {
        branch &#39;main&#39; //多分支流水线，分支为才会执行。
      }
      steps {
        echo &#39;Deploying&#39;
      }
    }
  }
}
</code></pre><p>也可以同时配置多个条件，比如分支是 production，而且 DEPLOY_TO 变量的值为 main 时，才执行 Example Deploy</p><pre tabindex=0><code>pipeline {
  agent any
  environment {
    DEPLOY_TO = &#34;main&#34;
  }
  stages {
    stage(&#39;Example Deploy&#39;) {
      when {
        branch &#39;main&#39;
        environment name: &#39;DEPLOY_TO&#39;, value: &#39;main&#39;
      }
      steps {
        echo &#39;Deploying&#39;
      }
    }
  }
}
</code></pre><p>也可以使用 anyOf 进行匹配其中一个条件即可，比如分支为 main 或 DEPLOY_TO 为 main 或 master 时执行 Deploy</p><pre tabindex=0><code>pipeline {
  agent any
  stages {
    stage(&#39;Example Deploy&#39;) {
      when {
        anyOf {
          branch &#39;main&#39;
          environment name: &#39;DEPLOY_TO&#39;, value: &#39;main&#39;
          environment name: &#39;DEPLOY_TO&#39;, value: &#39;master&#39;
        }
      }
      steps {
        echo &#39;Deploying&#39;
      }
    }
  }
}
</code></pre><p>也可以使用 expression 进行正则匹配，比如当 BRANCH_NAME 为 main 或 master，并且 DEPLOY_TO 为 master 或 main 时才会执行 Example Deploy</p><pre tabindex=0><code>pipeline {
  agent any
  stages {
    stage(&#39;Example Deploy&#39;) {
      when {
        expression { BRANCH_NAME ==~ /(main|master)/ }
        anyOf {
          environment name: &#39;DEPLOY_TO&#39;, value: &#39;main&#39;
          environment name: &#39;DEPLOY_TO&#39;, value: &#39;master&#39;
        }
      }
      steps {
        echo &#39;Deploying&#39;
      }
    }
  }
}
</code></pre><p>默认情况下，如果定义了某个 stage 的 agent，在进入该 stage 的 agent 后，该 stage 的 when 条件才会被评估，但是可以通过一些选项更改此选项。比如在进入 stage 的 agent 前评估 when， 可以使用 beforeAgent，当 when 为 true 时才进行该 stage</p><p><strong>目前支持的前置条件如下</strong></p><ul><li>beforeAgent：如果 beforeAgent 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入该 stage</li><li>beforeInput：如果 beforeInput 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入到 input 阶段；</li><li>beforeOptions：如果 beforeInput 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入到 options 阶段；</li></ul><p><strong>beforeOptions 优先级大于 beforeInput 大于 beforeAgent</strong></p><p>示例</p><pre tabindex=0><code>pipeline {
  agent none
  stages {
    stage(&#39;Example Build&#39;) {
      steps {
        echo &#39;Hello World&#39;
      }
    }
    stage(&#39;Example Deploy&#39;) {
      when {
        beforeAgent true
        branch &#39;main&#39;
      }
      steps {
        echo &#39;Deploying&#39;
      }
    }
  }
}
</code></pre><h2 id=23-parallel>2.3 Parallel
<a class=anchor href=#23-parallel>#</a></h2><p>在声明式流水线中可以使用 Parallel 字段，即可很方便的实现并发构建，比如对分支 A、B、 C 进行并行处理</p><pre tabindex=0><code>pipeline {
  agent any
  stages {
    stage(&#39;Non-Parallel Stage&#39;) {
      steps {
        echo &#39;This stage will be executed first.&#39;
      }
    }
    stage(&#39;Parallel Stage&#39;) {
      failFast true         //表示其中只要有一个分支构建执行失败，就直接推出不等待其他分支构建
      parallel {
        stage(&#39;Branch A&#39;) {
          steps {
            echo &#34;On Branch A&#34;
          }
        }
        stage(&#39;Branch B&#39;) {
          steps {
            echo &#34;On Branch B&#34;
          }
        }
        stage(&#39;Branch C&#39;) {
          stages {
            stage(&#39;Nested 1&#39;) {
              steps {
                echo &#34;In stage Nested 1 within Branch C&#34;
              }
            }
            stage(&#39;Nested 2&#39;) {
              steps {
               echo &#34;In stage Nested 2 within Branch C&#34;
              }
            }
          }
        }
      }
    }
  }
}
</code></pre><h1 id=三jenkinsfile-的使用>三、Jenkinsfile 的使用
<a class=anchor href=#%e4%b8%89jenkinsfile-%e7%9a%84%e4%bd%bf%e7%94%a8>#</a></h1><p>上面讲过流水线支持两种语法，即声明式和脚本式，这两种语法都支持构建持续交付流水线。并且都可以用来在 Web UI 或 Jenkinsfile 中定义流水线，不过通常将 Jenkinsfile 放置于代码仓库中（当然也可以放在单独的代码仓库中进行管理）。</p><p>创建一个 Jenkinsfile 并将其放置于代码仓库中，有以下好处</p><ul><li>方便对流水线上的代码进行复查/迭代</li><li>对管道进行审计跟踪</li><li>流水线真正的源代码能够被项目的多个成员查看和编辑</li></ul><h2 id=31-环境变量>3.1 环境变量
<a class=anchor href=#31-%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f>#</a></h2><h3 id=1静态变量>1.静态变量
<a class=anchor href=#1%e9%9d%99%e6%80%81%e5%8f%98%e9%87%8f>#</a></h3><p>Jenkins 有许多内置变量可以直接在 Jenkinsfile 中使用，可以通过 <code>JENKINS_URL/pipeline/syntax/globals#env</code> 获取完整列表。目前比较常用的环境变量如下</p><ul><li><p>BUILD_ID：当前构建的 ID，与 Jenkins 版本 1.597+中的 BUILD_NUMBER 完全相同</p></li><li><p>BUILD_NUMBER：当前构建的 ID，和 BUILD_ID 一致</p></li><li><p>BUILD_TAG：用来标识构建的版本号，格式为：<code>jenkins-${JOB_NAME}-${BUILD_NUMBER}</code>， 可以对产物进行命名，比如生产的 jar 包名字、镜像的 TAG 等；</p></li><li><p>BUILD_URL：本次构建的完整 URL，比如：</p><blockquote><p>http://buildserver/jenkins/job/MyJobName/17/%EF%BC%9B</p></blockquote></li><li><p>JOB_NAME：本次构建的项目名称</p></li><li><p>NODE_NAME：当前构建节点的名称；</p></li><li><p>JENKINS_URL：Jenkins 完整的 URL，需要在 SystemConfiguration 设置；</p></li><li><p>WORKSPACE：执行构建的工作目录。</p></li></ul><p>示例如果一个流水线名称为<code>print_env</code>，第 2 次构建，各个变量的值。</p><pre tabindex=0><code>BUILD_ID：2
BUILD_NUMBER：2
BUILD_TAG：jenkins-print_env-2
BUILD_URL：http://192.168.10.16:8080/job/print_env/2/
JOB_NAME：print_env
NODE_NAME：built-in
JENKINS_URL：http://192.168.10.16:8080/
WORKSPACE：/bitnami/jenkins/home/workspace/print_env
</code></pre><p>上述变量会保存在一个 Map 中，可以使用 env.BUILD_ID 或 env.JENKINS_URL 引用某个内置变量</p><pre tabindex=0><code>pipeline {
  agent any
  stages {
    stage(&#39;print env&#39;) {
      parallel {
        stage(&#39;BUILD_ID&#39;) {
          steps {
            echo &#34;$env.BUILD_ID&#34;
          }
        }
        stage(&#39;BUILD_NUMBER&#39;) {
          steps {
            echo &#34;$env.BUILD_NUMBER&#34;
          }
        }
        stage(&#39;BUILD_TAG&#39;) {
          steps {
            echo &#34;$env.BUILD_TAG&#34;
          }
        }
      }
    }
  }
}
</code></pre><h3 id=2动态变量>2.动态变量
<a class=anchor href=#2%e5%8a%a8%e6%80%81%e5%8f%98%e9%87%8f>#</a></h3><p>动态变量是根据某个指令的结果进行动态赋值，变量的值根据指令的执行结果而不同。如下所示</p><ul><li>returnStdout：将命令的执行结果赋值给变量，比如下述的命令返回的是 clang，此时 CC 的值为“clang”。</li><li>returnStatus：将命令的执行状态赋值给变量，比如下述命令的执行状态为 1，此时 EXIT_STATUS 的值为 1。</li></ul><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
  environment {
    // 使用 returnStdout
    CC = &#34;&#34;&#34;${sh(
         returnStdout: true,
         script: &#39;echo -n &#34;clang&#34;&#39;   //如果使用shell命令的echo赋值变量最好加-n取消换行
         )}&#34;&#34;&#34;
    // 使用 returnStatus
    EXIT_STATUS = &#34;&#34;&#34;${sh(
         returnStatus: true,
         script: &#39;exit 1&#39;
         )}&#34;&#34;&#34;
  }
  stages {
    stage(&#39;Example&#39;) {
      environment {
        DEBUG_FLAGS = &#39;-g&#39;
      }
      steps {
        sh &#39;printenv&#39;
      }
    }
  }
}
</code></pre><h2 id=32-凭证管理>3.2 凭证管理
<a class=anchor href=#32-%e5%87%ad%e8%af%81%e7%ae%a1%e7%90%86>#</a></h2><p>Jenkins 的声明式流水线语法有一个 credentials()函数，它支持 secret text（加密文本）、username 和 password（用户名和密码）以及 secret file（加密文件）等。接下来看一下一些常用的凭证处理方法。</p><h3 id=1加密文本>1.加密文本
<a class=anchor href=#1%e5%8a%a0%e5%af%86%e6%96%87%e6%9c%ac>#</a></h3><p>本实例演示将两个 Secret 文本凭证分配给单独的环境变量来访问 Amazon Web 服务，需要 提前创建这两个文件的 credentials（实践的章节会有演示），Jenkinsfile 文件的内容如下</p><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
  environment {
    AWS_ACCESS_KEY_ID = credentials(&#39;txt1&#39;)
    AWS_SECRET_ACCESS_KEY = credentials(&#39;txt2&#39;)
  }
  stages {
    stage(&#39;Example stage 1&#39;) {
      steps {
        echo &#34;$AWS_ACCESS_KEY_ID&#34;
      }
    }
    stage(&#39;Example stage 2&#39;) {
      steps {
        echo &#34;$AWS_SECRET_ACCESS_KEY&#34;
      }
    }
  }
}
</code></pre><h3 id=2用户名密码>2.用户名密码
<a class=anchor href=#2%e7%94%a8%e6%88%b7%e5%90%8d%e5%af%86%e7%a0%81>#</a></h3><p>本示例用来演示 credentials 账号密码的使用，比如使用一个公用账户访问 Bitbucket、GitLab、 Harbor 等。假设已经配置完成了用户名密码形式的 credentials，凭证 ID 为 harbor-account</p><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent any
  environment {
    BITBUCKET_COMMON_CREDS = credentials(&#39;harbor-account&#39;)
  }
  stages {
    stage(&#39;printenv&#39;) {
      steps {
        sh &#34;env&#34;
      }
    }
}
</code></pre><p><strong>上述的配置会自动生成 3 个环境变量</strong></p><ul><li>BITBUCKET_COMMON_CREDS：包含一个以冒号分隔的用户名和密码，格式为 username:password</li><li>BITBUCKET_COMMON_CREDS_USR：仅包含用户名的附加变量</li><li>BITBUCKET_COMMON_CREDS_PSW：仅包含密码的附加变量。</li></ul><h3 id=3加密文件>3.加密文件
<a class=anchor href=#3%e5%8a%a0%e5%af%86%e6%96%87%e4%bb%b6>#</a></h3><p>需要加密保存的文件，也可以使用 credential，比如链接到 Kubernetes 集群的 kubeconfig 文件等。</p><p>假如已经配置好了一个 kubeconfig 文件，此时可以在 Pipeline 中引用该文件</p><pre tabindex=0><code>//Jenkinsfile (Declarative Pipeline)
pipeline {
  agent {
    kubernetes {
      cloud &#39;kubernetes&#39;
      slaveConnectTimeout 1200
      workspaceVolume emptyDirWorkspaceVolume()
      yaml &#39;&#39;&#39;
kind: Pod
metadata:
  name: jenkins-agent
spec:
  containers:
  - args: [\&#39;$(JENKINS_SECRET)\&#39;, \&#39;$(JENKINS_NAME)\&#39;]
    image: &#39;192.168.10.15/kubernetes/jnlp:alpine&#39;
    name: jnlp
    imagePullPolicy: IfNotPresent
  - command:
      - &#34;cat&#34;
    image: &#34;192.168.10.15/kubernetes/kubectl:apline&#34;
    imagePullPolicy: &#34;IfNotPresent&#34;
    name: &#34;kubectl&#34;
    tty: true
  restartPolicy: Never
&#39;&#39;&#39;
    }
  }
  environment {
    MY_KUBECONFIG = credentials(&#39;kubernetes-cluster&#39;)
  }
  stages {
    stage(&#39;kubectl&#39;) {
      steps {
        container(name: &#39;kubectl&#39;) {
          sh &#34;&#34;&#34;
            kubectl get pod -A  --kubeconfig $MY_KUBECONFIG
          &#34;&#34;&#34;
        }
      }
    }
  }
}
</code></pre><p>- END -</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#11-声明式流水线>1.1 声明式流水线</a></li><li><a href=#12-脚本化流水线>1.2 脚本化流水线</a></li></ul><ul><li><a href=#21-sections>2.1 Sections</a><ul><li><a href=#1agent>1.Agent</a></li><li><a href=#2agent-的配置示例>2.agent 的配置示例</a></li><li><a href=#3post>3.Post</a></li><li><a href=#4sepes>4.sepes</a></li></ul></li><li><a href=#22-directives>2.2 Directives</a><ul><li><a href=#1environment>1.Environment</a></li><li><a href=#2options>2.Options</a></li><li><a href=#3parameters>3.Parameters</a></li><li><a href=#4triggers>4.Triggers</a></li><li><a href=#5input>5.Input</a></li><li><a href=#6when>6.when</a></li></ul></li><li><a href=#23-parallel>2.3 Parallel</a></li></ul><ul><li><a href=#31-环境变量>3.1 环境变量</a><ul><li><a href=#1静态变量>1.静态变量</a></li><li><a href=#2动态变量>2.动态变量</a></li></ul></li><li><a href=#32-凭证管理>3.2 凭证管理</a><ul><li><a href=#1加密文本>1.加密文本</a></li><li><a href=#2用户名密码>2.用户名密码</a></li><li><a href=#3加密文件>3.加密文件</a></li></ul></li></ul></nav></div></aside></main></body></html>